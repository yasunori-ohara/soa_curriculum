# 05 ãƒ¢ãƒ‡ãƒ«ã®ä¸€éƒ¨ã‚’ã‚³ãƒ¼ãƒ‰åŒ–

# ã‚¹ãƒ†ãƒƒãƒ—ï¼•ï¼šãƒ¢ãƒ‡ãƒ«ã®ä¸€éƒ¨ã‚’ã‚³ãƒ¼ãƒ‰åŒ– (UseCaseã¨Main) âš™ï¸ğŸš€

ã“ã‚Œã¾ã§ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®šç¾©ãƒ»å®Ÿè£…ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆ`VehicleControl`é›†ç´„ã€å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€`ControlCalculationService`ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã¨ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ã£ã¦ã€ã„ã‚ˆã„ã‚ˆã‚·ã‚¹ãƒ†ãƒ ã®ã‚³ã‚¢ã¨ãªã‚‹**UseCase**ã‚’å®Ÿè£…ã—ã€ãã‚Œã‚’[**main.py**](http://main.py/)ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã€è¨ˆç”»å®Ÿè¡Œã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

---

## âš™ï¸ 1. å¢ƒç•Œã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ (Boundary) ã®è¿½åŠ  - ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿

ğŸ“ **èª²é¡Œ**: `VehicleControl` é›†ç´„ï¼ˆã¾ãŸã¯ãã‚Œã‚’å‘¼ã³å‡ºã™ UseCaseï¼‰ã¯ã€è¨ˆç®—ã•ã‚ŒãŸ `ActuatorCommand`ï¼ˆã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°æŒ‡ç¤ºã€ã‚¹ãƒ­ãƒƒãƒˆãƒ«æŒ‡ç¤ºï¼‰ã‚’å®Ÿéš›ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ï¼ˆã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ï¼‰ã«é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã€UseCase ã‚„ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãŒå…·ä½“çš„ãªãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡æ–¹æ³•ï¼ˆCANé€šä¿¡ãªã©ï¼‰ã‚’çŸ¥ã‚‹ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ğŸ’¡ **è§£æ±ºç­–**: ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¸ã®å‡ºåŠ›ã‚’æŠ½è±¡åŒ–ã™ã‚‹**ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ (`ActuatorInterface`)** ã‚’ `application/boundaries.py` ã«å®šç¾©ã—ã¾ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«:** `control_context/application/boundaries.py` (è¿½è¨˜)

```python
# control_context/application/boundaries.py
from abc import ABC, abstractmethod
# (Repository interfaces...)
from control_context.domain.aggregates import VehicleControl
from typing import Optional
# ğŸ‘ˆ åˆ¶å¾¡æŒ‡ç¤ºã®Value Objectã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from control_context.domain.value_objects import SteeringCommand, ThrottleBrakeCommand

# (VehicleControlRepositoryInterface definition...)

# -----------------------------------------------------------------------------
# Actuator Interface (Output Boundary)
# - DDDæˆ¦è¡“çš„è¨­è¨ˆã® Interface (Port)
# - CAã® Application å±¤ (å¢ƒç•Œå®šç¾©)
# -----------------------------------------------------------------------------
class ActuatorInterface(ABC):
    """è»Šä¸¡ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿(ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°ã€ã‚¹ãƒ­ãƒƒãƒˆãƒ«/ãƒ–ãƒ¬ãƒ¼ã‚­)ã¸ã®æŒ‡ç¤ºã‚’æŠ½è±¡åŒ–ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹"""
    @abstractmethod
    async def send_steering_command(self, command: SteeringCommand):
        """ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°ã¸ã®æŒ‡ç¤ºã‚’é€ä¿¡ã™ã‚‹ (éåŒæœŸ)"""
        raise NotImplementedError

    @abstractmethod
    async def send_throttle_brake_command(self, command: ThrottleBrakeCommand):
        """ã‚¹ãƒ­ãƒƒãƒˆãƒ«/ãƒ–ãƒ¬ãƒ¼ã‚­ã¸ã®æŒ‡ç¤ºã‚’é€ä¿¡ã™ã‚‹ (éåŒæœŸ)"""
        raise NotImplementedError

# (UseCase Input Boundary definition...)
class ExecuteParkingStepInputBoundary(ABC): # UseCase I/Fåã‚‚å…·ä½“çš„ã«
    @abstractmethod
    async def handle(self, vehicle_id: str, current_vehicle_state: 'VehicleState', plan_command: 'ControlCommand'):
        raise NotImplementedError # æˆ»ã‚Šå€¤ã¯void (ã‚³ãƒãƒ³ãƒ‰ãªã®ã§)

```

---

## âš™ï¸ 2. ã‚¢ãƒ€ãƒ—ã‚¿ (Adapter) ã®å®Ÿè£… - ã‚¹ã‚¿ãƒ–ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿

ğŸ“ **èª²é¡Œ**: `ActuatorInterface` ã®å…·ä½“çš„ãªå®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚å®Ÿéš›ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡ã¯è¤‡é›‘ã§ã™ãŒã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ã¯ç°¡å˜ãªä»£æ›¿ç‰©ï¼ˆã‚¹ã‚¿ãƒ–ï¼‰ãŒå¿…è¦ã§ã™ã€‚

ğŸ’¡ **è§£æ±ºç­–**: `ActuatorInterface` ã‚’å®Ÿè£…ã™ã‚‹ `StubActuatorAdapter` ã‚’ `adapters` ãƒ•ã‚©ãƒ«ãƒ€ã«ä½œæˆã—ã¾ã™ã€‚ã“ã‚Œã¯å—ã‘å–ã£ãŸã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã ã‘ã®ç°¡å˜ãªå®Ÿè£…ã§ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«:** `control_context/adapters/stub_actuator.py` (æ–°è¦ä½œæˆã¾ãŸã¯è¿½è¨˜)

```python
# control_context/adapters/stub_actuator.py
from control_context.application.boundaries import ActuatorInterface
from control_context.domain.value_objects import SteeringCommand, ThrottleBrakeCommand
import asyncio

# -----------------------------------------------------------------------------
# Stub Actuator Adapter Implementation
# - DDDæˆ¦è¡“çš„è¨­è¨ˆã® Adapter Implementation
# - CAã® Adapters å±¤
# -----------------------------------------------------------------------------
class StubActuatorAdapter(ActuatorInterface):
    """
    ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã®ãƒ€ãƒŸãƒ¼ï¼ˆã‚¹ã‚¿ãƒ–ï¼‰ã€‚
    å—ã‘å–ã£ãŸã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã€‚
    """
    async def send_steering_command(self, command: SteeringCommand):
        """ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°æŒ‡ç¤ºã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ› (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)"""
        print(f"[Adapter] StubActuator: -> STEER Target Angle = {command.target_angle.degrees:.1f} deg")
        await asyncio.sleep(0.01) # ã‚ãšã‹ãªI/Oæ™‚é–“ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ

    async def send_throttle_brake_command(self, command: ThrottleBrakeCommand):
        """ã‚¹ãƒ­ãƒƒãƒˆãƒ«/ãƒ–ãƒ¬ãƒ¼ã‚­æŒ‡ç¤ºã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ› (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)"""
        print(f"[Adapter] StubActuator: -> THROTTLE/BRAKE Target Accel = {command.acceleration_mps2:.2f} m/s^2")
        await asyncio.sleep(0.01) # ã‚ãšã‹ãªI/Oæ™‚é–“ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ

```

---

## âš™ï¸ 3. UseCase ã®å®Ÿè£… - è¨ˆç”»å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼

ğŸ“ **èª²é¡Œ**: ã€Œç¾åœ¨ã®è»Šä¸¡çŠ¶æ…‹ã¨ã€é§è»Šè¨ˆç”»ã®æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆ`ControlCommand`ï¼‰ã‚’å—ã‘å–ã‚Šã€`VehicleControl` é›†ç´„ã‚’ä½¿ã£ã¦é©åˆ‡ãªã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿æŒ‡ç¤ºã‚’è¨ˆç®—ã—ã€ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹çµŒç”±ã§æŒ‡ç¤ºã‚’é€ä¿¡ã—ã€è»Šä¸¡çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦ä¿å­˜ã™ã‚‹ã€ã¨ã„ã†**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®ãƒ•ãƒ­ãƒ¼**ãŒå¿…è¦ã§ã™ã€‚

ğŸ’¡ **è§£æ±ºç­–**: ã“ã®ãƒ•ãƒ­ãƒ¼ã®è²¬ä»»ã‚’æŒã¤ã€ŒUseCaseã€ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ãƒªãƒã‚¸ãƒˆãƒªã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆé›†ç´„çµŒç”±ã§åˆ©ç”¨ï¼‰ã€ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ä¾å­˜ã—ã¾ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«:** `control_context/application/use_cases.py` (æ–°è¦ä½œæˆã¾ãŸã¯è¿½è¨˜)

```python
# control_context/application/use_cases.py
from control_context.application.boundaries import ( # ğŸ‘ˆ å¿…è¦ãªå¢ƒç•Œã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    VehicleControlRepositoryInterface,
    ActuatorInterface,
    ExecuteParkingStepInputBoundary # UseCaseè‡ªèº«ã®I/F
)
from control_context.domain.aggregates import VehicleControl
from control_context.domain.value_objects import VehicleState, ControlCommand # å…¥åŠ›VO
from control_context.domain.services import ControlCalculationService # ğŸ‘ˆ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
from typing import Tuple, Optional

# -----------------------------------------------------------------------------
# Execute Parking Step Use Case
# - CAã® Use Cases å±¤ã¨åŒã˜å½¹å‰²
# - é§è»Šè¨ˆç”»ã®1ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã™ã‚‹ãƒ•ãƒ­ãƒ¼ã‚’æ‹…å½“
# -----------------------------------------------------------------------------
class ExecuteParkingStepUseCase(ExecuteParkingStepInputBoundary):
    """é§è»Šè¨ˆç”»ã®1ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹"""
    def __init__(self,
                 vehicle_control_repo: VehicleControlRepositoryInterface, # æ°¸ç¶šåŒ–ã®çª“å£
                 control_calculator: ControlCalculationService,        # è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (DI)
                 actuator_interface: ActuatorInterface):               # å‡ºåŠ›ã®çª“å£ (DI)
        self._vehicle_control_repo = vehicle_control_repo
        self._control_calculator = control_calculator # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä¿æŒ
        self._actuator_interface = actuator_interface

    async def handle(self, vehicle_id: str, current_vehicle_state: VehicleState, plan_command: ControlCommand):
        """
        ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
        Args:
            vehicle_id: å¯¾è±¡è»Šä¸¡ã®ID
            current_vehicle_state: æœ€æ–°ã®è»Šä¸¡çŠ¶æ…‹ (ã‚»ãƒ³ã‚µãƒ¼ç­‰ã‹ã‚‰ã®å…¥åŠ›)
            plan_command: å®Ÿè¡Œã™ã‚‹è¨ˆç”»ã‚³ãƒãƒ³ãƒ‰ (ParkingPlanã‹ã‚‰å–å¾—)
        Raises:
            ValueError: ã‚·ã‚¹ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆãªã©
            Exception: ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã¸ã®é€ä¿¡å¤±æ•—ãªã©
        """
        print(f"[UseCase] Executing parking step for vehicle {vehicle_id}...")
        print(f"  Input State: Speed={current_vehicle_state.speed.meters_per_second:.1f}, Steer={current_vehicle_state.steering_angle.degrees:.1f}")
        print(f"  Plan Command: Action={plan_command.action}, Value={plan_command.value}")

        # --- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã®é–‹å§‹ (æ¦‚å¿µ) ---
        try:
            # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ã£ã¦é›†ç´„(VehicleControl)ã‚’å–å¾—
            vehicle_control = self._vehicle_control_repo.find_by_vehicle_id(vehicle_id)
            if not vehicle_control:
                raise ValueError(f"VehicleControl aggregate for {vehicle_id} not found.")

            # 2. æœ€æ–°ã®è»Šä¸¡çŠ¶æ…‹ã§é›†ç´„å†…éƒ¨ã®çŠ¶æ…‹ã‚’æ›´æ–°
            #    (ã“ã‚Œã¯ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãæ¯å›è¡Œã†)
            vehicle_control.update_current_state(current_vehicle_state)

            # 3. é›†ç´„ãƒ«ãƒ¼ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿æŒ‡ç¤ºã‚’è¨ˆç®—
            #    (é›†ç´„ã¯å†…éƒ¨ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹(control_calculator)ã‚’åˆ©ç”¨)
            steer_cmd, throttle_brake_cmd = vehicle_control.execute_plan_step(
                plan_command, self._control_calculator
            )

            # --- ã“ã“ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’åŒºåˆ‡ã‚‹ã“ã¨ã‚‚å¯èƒ½ ---
            # (çŠ¶æ…‹æ›´æ–°ã¨ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã‚’åˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã™ã‚‹ãªã©)

            # 4. ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹çµŒç”±ã§æŒ‡ç¤ºã‚’é€ä¿¡ (å‰¯ä½œç”¨)
            print("[UseCase] Sending commands to actuators...")
            await self._actuator_interface.send_steering_command(steer_cmd)
            await self._actuator_interface.send_throttle_brake_command(throttle_brake_cmd)

            # 5. (ã‚‚ã—å¿…è¦ãªã‚‰) æ›´æ–°ã•ã‚ŒãŸé›†ç´„ã‚’ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ã£ã¦ä¿å­˜
            #    (çŠ¶æ…‹æ›´æ–°ãŒæ°¸ç¶šåŒ–å¿…è¦ãªã‚‰ã“ã“ã§è¡Œã†)
            # self._vehicle_control_repo.save(vehicle_control)
            # ä»Šå›ã¯InMemoryRepoãªã®ã§update_current_stateã ã‘ã§ãƒ¡ãƒ¢ãƒªä¸Šã¯æ›´æ–°ã•ã‚Œã‚‹ãŒã€
            # DBã‚’ä½¿ã†å ´åˆã¯æ˜ç¤ºçš„ãªsaveãŒå¿…è¦ã€‚
            print(f"[UseCase] (Skipping save in this example, state updated in memory for aggregate {vehicle_id})")

            # --- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚³ãƒŸãƒƒãƒˆ (æ¦‚å¿µ) ---
            print("[UseCase] Parking step execution successful.")

        except ValueError as e: # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«é•åãªã©
             print(f"[UseCase] Domain rule violation during execution: {e}")
             # --- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ (æ¦‚å¿µ) ---
             raise
        except Exception as e: # äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ (ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿é€šä¿¡å¤±æ•—ãªã©)
            print(f"[UseCase] Error during parking step execution: {e}")
            # --- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ (æ¦‚å¿µ) ---
            raise

```

âœ… **ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒã‚¤ãƒ³ãƒˆ**:

- UseCase ã¯ CA ã¨åŒã˜ãã€**ãƒ“ã‚¸ãƒã‚¹ãƒ•ãƒ­ãƒ¼ã®èª¿æ•´å½¹**ã§ã™ã€‚
- **ãƒªãƒã‚¸ãƒˆãƒª**ã‚’ä½¿ã£ã¦ `VehicleControl` é›†ç´„ã‚’å–å¾—ï¼ˆã—ã€å¿…è¦ãªã‚‰ä¿å­˜ï¼‰ã€‚
- **é›†ç´„ã®ãƒ¡ã‚½ãƒƒãƒ‰**ã‚’å‘¼ã³å‡ºã—ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåˆ¶å¾¡æŒ‡ç¤ºè¨ˆç®—ï¼‰ã‚’å®Ÿè¡Œã•ã›ã¾ã™ï¼ˆé›†ç´„ã¯å†…éƒ¨ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ï¼‰ã€‚
- **ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**ã‚’é€šã˜ã¦ã€è¨ˆç®—ã•ã‚ŒãŸæŒ‡ç¤ºã‚’å¤–éƒ¨ï¼ˆãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ï¼‰ã«é€ä¿¡ã—ã¾ã™ã€‚

---

## ğŸš€ 4. å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ« ([main.py](http://main.py/)) ã®ä½œæˆ - å…¨ä½“ã®çµ„ã¿ç«‹ã¦ã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

ğŸ“ **èª²é¡Œ**: ä½œæˆã—ãŸ UseCase ã‚’å®Ÿè¡Œã—ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ï¼ˆåˆ¶å¾¡éƒ¨åˆ†ï¼‰ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€Œèµ·ç‚¹ã€ãŒå¿…è¦ã§ã™ã€‚é§è»Šè¨ˆç”» (`ParkingPlan`) ãŒå­˜åœ¨ã—ã€è»Šä¸¡çŠ¶æ…‹ (`VehicleState`) ãŒå¤‰åŒ–ã™ã‚‹çŠ¶æ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã€‚

ğŸ’¡ **è§£æ±ºç­–**: `main.py` ã§ã€å…·ä½“çš„ãªãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚¹ã‚¿ãƒ–ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ç”Ÿæˆã—ã€ãã‚Œã‚‰ã‚’ UseCase ã«æ³¨å…¥ï¼ˆDIï¼‰ã—ã¦ã€è¨ˆç”»ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é †ç•ªã« UseCase ã«æ¸¡ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

**ãƒ•ã‚¡ã‚¤ãƒ«:** `control_context/main.py`

```python
# control_context/main.py
# ğŸ‘ˆ å®Ÿè£…ã€UseCaseã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã©ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from adapters.repositories import InMemoryVehicleControlRepository
from adapters.stub_actuator import StubActuatorAdapter
from application.use_cases import ExecuteParkingStepUseCase
from domain.aggregates import VehicleControl
from domain.services import ControlCalculationService
from domain.value_objects import ( # å¿…è¦ãªVOã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    ParkingPlan, ControlCommand, VehicleState, Speed, SteeringAngle
)
from datetime import datetime, timedelta
import asyncio

# -----------------------------------------------------------------------------
# Main Application / Composition Root
# - CAã®æœ€ã‚‚å¤–å´ã®å±¤ (Frameworks & Drivers) ã¨åŒã˜å½¹å‰²
# - ä¾å­˜é–¢ä¿‚ã®è§£æ±º (DI) ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã‚’è¡Œã†
# -----------------------------------------------------------------------------

async def execute_parking_simulation(use_case: ExecuteParkingStepUseCase, repo: InMemoryVehicleControlRepository, vehicle_id: str, plan: ParkingPlan):
    """é§è»Šè¨ˆç”»ã‚’æŒ‡å®šã•ã‚ŒãŸUseCaseã§å®Ÿè¡Œã™ã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°"""
    print(f"\\n--- Executing Parking Plan ({len(plan.commands)} steps) ---")

    # å®Ÿè¡Œå‰ã®è»Šä¸¡çŠ¶æ…‹ã‚’å–å¾— (ã‚ã‚‹ã„ã¯åˆæœŸåŒ–)
    vehicle_control = repo.find_by_vehicle_id(vehicle_id)
    if not vehicle_control:
         print(f"Error: VehicleControl for {vehicle_id} not found.")
         return
    current_state = vehicle_control.current_state # åˆæœŸçŠ¶æ…‹

    # è¨ˆç”»ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é †ç•ªã«å®Ÿè¡Œ
    for i, command in enumerate(plan.commands):
        print(f"\\n--- Step {i+1}: Executing Command {command.action}={command.value} for {command.duration}s ---")

        # --- ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰ã®è»Šä¸¡çŠ¶æ…‹å…¥åŠ› (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³) ---
        # (æœ¬æ¥ã¯ã“ã“ã§å®Ÿéš›ã®ã‚»ãƒ³ã‚µãƒ¼å€¤ã‚’å–å¾—ã™ã‚‹)
        # ä»Šå›ã¯ã€å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®åˆ¶å¾¡çµæœã‚’åæ˜ ã—ãŸã€Œä»®ã®ã€çŠ¶æ…‹ã‚’ä½¿ã† (è¶…ç°¡æ˜“)
        # æ™‚é–“çµŒéã‚‚è€ƒæ…®
        current_time = current_state.timestamp + timedelta(seconds=command.duration / 2.0) # ã‚³ãƒãƒ³ãƒ‰ä¸­é–“ã®æ™‚é–“ã‚’ä»®å®š
        # (é€Ÿåº¦ã‚„èˆµè§’ã‚‚å‰ã®ã‚³ãƒãƒ³ãƒ‰çµæœã‹ã‚‰ç°¡æ˜“çš„ã«æ›´æ–°)
        simulated_state = VehicleState(
             timestamp=current_time,
             speed=current_state.speed, # é€Ÿåº¦ã¯ç°¡å˜ã®ãŸã‚å¤‰åŒ–ã—ãªã„ã¨ã™ã‚‹
             steering_angle=current_state.steering_angle # èˆµè§’ã‚‚ç°¡å˜ã®ãŸã‚å¤‰åŒ–ã—ãªã„ã¨ã™ã‚‹
        )
        print(f"[Simulation] Input State: Speed={simulated_state.speed.meters_per_second:.1f}, Steer={simulated_state.steering_angle.degrees:.1f}")

        # --- UseCaseã®å®Ÿè¡Œ ---
        try:
            await use_case.handle(vehicle_id, simulated_state, command)

            # --- UseCaseå®Ÿè¡Œå¾Œã®çŠ¶æ…‹ã‚’å–å¾— (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨) ---
            # (å®Ÿéš›ã«ã¯æ¬¡ã®ã‚»ãƒ³ã‚µãƒ¼å…¥åŠ›ã§æ›´æ–°ã•ã‚Œã‚‹)
            updated_control = repo.find_by_vehicle_id(vehicle_id) # ä¿å­˜ã•ã‚ŒãŸæœ€æ–°çŠ¶æ…‹ã‚’å–å¾—
            if updated_control:
                 current_state = updated_control.current_state # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥åŠ›çŠ¶æ…‹ã¨ã™ã‚‹
                 print(f"[Simulation] State potentially updated in Repo (for next step).")

            # ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œæ™‚é–“å¾…æ©Ÿ (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
            print(f"[Simulation] Waiting for command duration: {command.duration}s...")
            await asyncio.sleep(command.duration)

        except Exception as e:
            print(f"Execution failed at step {i+1}: {e}")
            break # ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯ä¸­æ–­

    print("\\n--- Parking Plan Execution Finished ---")

if __name__ == "__main__":
    print("--- Automated Parking Control Example ---")

    # --- ä¾å­˜é–¢ä¿‚ã®è§£æ±º (Dependency Injection) ---
    print("\\n--- Wiring dependencies (DI) ---")
    vehicle_control_repo = InMemoryVehicleControlRepository()
    control_calculator = ControlCalculationService()
    actuator_adapter = StubActuatorAdapter()
    execute_step_use_case = ExecuteParkingStepUseCase(
        vehicle_control_repo, control_calculator, actuator_adapter
    )
    print("--- Dependencies wired successfully ---")

    # --- åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ (VehicleControlé›†ç´„ã®åˆæœŸåŒ–) ---
    print("\\n--- Setting up initial vehicle state ---")
    vehicle_id = "parking-car-01"
    initial_control = VehicleControl.initialize(vehicle_id)
    vehicle_control_repo.save(initial_control)
    print(f"VehicleControl initialized for {vehicle_id}. Initial state: Speed={initial_control.current_state.speed.meters_per_second}, Steer={initial_control.current_state.steering_angle.degrees}")

    # --- é§è»Šè¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ (ãƒ€ãƒŸãƒ¼) ---
    # (æœ¬æ¥ã¯çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹(Planning Context)ã‹ã‚‰å—ã‘å–ã‚‹)
    print("\\n--- Preparing dummy Parking Plan ---")
    plan_ts = datetime.now()
    dummy_plan = ParkingPlan(
        timestamp=plan_ts,
        commands=[
            ControlCommand(action='steer', value=-30.0, duration=1.5), # å·¦ã«åˆ‡ã‚‹
            ControlCommand(action='throttle', value=-0.8, duration=3.0),# ãƒãƒƒã‚¯(åŠ é€Ÿåº¦æŒ‡å®š)
            ControlCommand(action='steer', value=0.0, duration=1.0),  # ã¾ã£ã™ãã«æˆ»ã™
            ControlCommand(action='throttle', value=-0.2, duration=2.0),# ã‚†ã£ãã‚Šãƒãƒƒã‚¯
            ControlCommand(action='throttle', value=0.0, duration=0.5), # åœæ­¢ (åŠ é€Ÿåº¦0)
        ]
    )
    print(f"Plan created with {len(dummy_plan.commands)} steps.")

    # --- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ ---
    # asyncio.run()ã‚’ä½¿ã£ã¦éåŒæœŸé–¢æ•°ã‚’å®Ÿè¡Œ
    asyncio.run(execute_parking_simulation(execute_step_use_case, vehicle_control_repo, vehicle_id, dummy_plan))

    # --- æœ€çµ‚çµæœã®ç¢ºèª ---
    print("\\n--- Verifying Final State ---")
    final_control = vehicle_control_repo.find_by_vehicle_id(vehicle_id)
    if final_control:
        final_state = final_control.current_state
        print(f"Vehicle {vehicle_id}'s final state (@{final_state.timestamp.isoformat()}):")
        # (æ³¨æ„: ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯Stateã®æ›´æ–°ã¯ç°¡æ˜“çš„ãªã®ã§ã€
        #  æœ€çµ‚çŠ¶æ…‹ãŒç‰©ç†çš„ã«æ­£ç¢ºã‹ã¯ä¿è¨¼ã•ã‚Œãªã„)
        print(f"  Speed: {final_state.speed.meters_per_second:.1f} m/s")
        print(f"  Steering Angle: {final_state.steering_angle.degrees:.1f} deg")

```

âœ… **ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒã‚¤ãƒ³ãƒˆ**:

- `main.py` ãŒä¾å­˜é–¢ä¿‚ã‚’çµ„ã¿ç«‹ã¦ã€`ExecuteParkingStepUseCase` ã‚’å‘¼ã³å‡ºã—ã¾ã—ãŸã€‚
- `execute_parking_simulation` é–¢æ•°å†…ã§ã€ãƒ€ãƒŸãƒ¼ã®é§è»Šè¨ˆç”» (`ParkingPlan`) ã‚’ç”¨æ„ã—ã€ãã®ã‚³ãƒãƒ³ãƒ‰ã‚’**ãƒ«ãƒ¼ãƒ—**ã§ä¸€ã¤ãšã¤ UseCase ã«æ¸¡ã—ã¦å®Ÿè¡Œã™ã‚‹**ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’è¡Œã„ã¾ã—ãŸã€‚
- å„ã‚¹ãƒ†ãƒƒãƒ—ã§ UseCase ãŒã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã‚¢ãƒ€ãƒ—ã‚¿ (`StubActuatorAdapter`) ã‚’å‘¼ã³å‡ºã—ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«åˆ¶å¾¡æŒ‡ç¤ºãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚
- è»Šä¸¡çŠ¶æ…‹ (`VehicleState`) ã®æ›´æ–°ã‚’ç°¡æ˜“çš„ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥åŠ›ã¨ã—ã¦ã„ã¾ã™ï¼ˆã‚ˆã‚Šç¾å®Ÿã«è¿‘ã¥ã‘ã‚‹ã«ã¯ç‰©ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒå¿…è¦ï¼‰ã€‚

---

## ğŸ“ ã“ã®æ¼”ç¿’ã®ã¾ã¨ã‚

ã“ã®æ¼”ç¿’ã§ã¯ã€ã€Œè‡ªå‹•é§è»Šã‚·ã‚¹ãƒ†ãƒ ã€ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆç‰¹ã«åˆ¶å¾¡éƒ¨åˆ†ï¼‰ã‚’é¡Œæã«ã€ç¬¬4ãƒ»5å·¡ã§ã®å®Ÿè£…ã‚’ DDD ã®è¦–ç‚¹ã‹ã‚‰å†è©•ä¾¡ãƒ»æ´—ç·´ã—ã¾ã—ãŸã€‚

1. **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨é›†ç´„**: ã€Œèªè­˜ã€ã€ŒçµŒè·¯è¨ˆç®—ã€ã€Œåˆ¶å¾¡ã€ã¨ã„ã†ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²ã®å¦¥å½“æ€§ã‚’ç¢ºèªã—ã€ã€Œåˆ¶å¾¡ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä¸­å¿ƒã« `VehicleControl` é›†ç´„ã‚’ç½®ãã¾ã—ãŸã€‚`WorldModel` ã‚„ `ParkingPlan` ã¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé–“ã®å¥‘ç´„ï¼ˆå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ/DTOï¼‰ã¨ä½ç½®ã¥ã‘ã¾ã—ãŸã€‚
2. **å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**: `VehicleState`, `Speed`, `SteeringAngle`, `ActuatorCommand` ãªã©ã‚’å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å®šç¾©ã—ã€å‹å®‰å…¨æ€§ã¨ä¸å¤‰æ€§ã‚’é«˜ã‚ã¾ã—ãŸã€‚
3. **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹**: è¤‡é›‘ãªåˆ¶å¾¡è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ `ControlCalculationService` ã«åˆ†é›¢ã—ã€é›†ç´„ (`VehicleControl`) ã®è²¬å‹™ã‚’æ˜ç¢ºåŒ–ã—ã¾ã—ãŸã€‚
4. **ãƒªãƒã‚¸ãƒˆãƒª**: `VehicleControl` é›†ç´„ã®æ°¸ç¶šåŒ–ã‚’æŠ½è±¡åŒ–ã—ã¾ã—ãŸã€‚
5. **UseCase**: ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã€ãƒªãƒã‚¸ãƒˆãƒªã€ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã€è¨ˆç”»å®Ÿè¡Œã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‡¦ç†ã™ã‚‹ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

ç¬¬4ãƒ»5å·¡ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£/SOAã®å®Ÿè£…ã«DDDã®æˆ¦è¡“çš„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã‚„æ§‹é€ ãŒã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚Šæ˜ç¢ºã«è¡¨ç¾ã•ã‚Œã€å„éƒ¨å“ã®è²¬å‹™ãŒã•ã‚‰ã«æ´—ç·´ã•ã‚Œã‚‹ã“ã¨ã‚’ä½“é¨“ã§ããŸã‹ã¨æ€ã„ã¾ã™ã€‚

---

## âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¼”ç¿’ (5/5) å®Œäº†ï¼

ã“ã‚Œã§ã€5ã¤ã®é¡Œæã™ã¹ã¦ã«å¯¾ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ¼”ç¿’ãŒä¸€åŒºåˆ‡ã‚Šã¨ãªã‚Šã¾ã™ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼
ã“ã‚Œã‚‰ã®æ¼”ç¿’ã‚’é€šã˜ã¦ã€DDDã®è€ƒãˆæ–¹ï¼ˆç‰¹ã«æˆ¦è¡“ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã‚’æ§˜ã€…ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã«é©ç”¨ã™ã‚‹æ„Ÿè¦šã‚’æ´ã‚€ã“ã¨ãŒã§ããŸã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚