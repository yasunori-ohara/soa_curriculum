# 03 集約/Read Modelの発見

## ステップ３：集約/Read Modelの発見 🧱📖

Step 2 で `{会議室を予約する}` コマンドが `[会議室が予約された]` イベントを引き起こす流れを見ました。このステップでは、このコマンドが*どの「モノ」（集約）**に対して実行され、状態を変更するのか、また、コマンド実行前に**参照される情報（Read Model）*は何かを考えます。

## 🤔 コマンドは何を操作する？：集約 (Aggregate)

`{会議室を予約する}` コマンドは、最終的に**新しい予約情報**を作成し、永続化する必要があります。Step 2-2 で検討したように、「予約 (`Reservation`)」は自身のライフサイクルと一貫性を管理する**集約**としてモデル化するのが適切でした。

したがって、`{会議室を予約する}` コマンドは、新しい `Reservation` 集約を**生成**する操作であると考えられます。

```
                             +-----------------------+
                             | RoomID, UserID, TimeRange |
                             +-----------|-----------+
                                         v
(利用者) -- {会議室を予約する} --+--> <Reservation> (Create New)
                               |
                               +--> [会議室が予約された]

```

**読み方**:

1. `(利用者)` が `{会議室を予約する}` コマンドを実行すると、
2. 新しい `<Reservation>` 集約が**生成され**、
3. その結果として `[会議室が予約された]` イベントが発生する。

*(補足: 予約変更 `{予約を変更する}` コマンドなら、既存の `<Reservation>` 集約を操作することになります)*

---

## 📖 コマンド実行に必要な情報は？：Read Model / 他の集約

`{会議室を予約する}` コマンドを実行する前に、システムはいくつかの**チェック**を行う必要があります。

1. 指定された `RoomID` の**会議室が存在するか？**
2. 指定された `TimeRange` が、その会議室の**予約可能ルール（営業時間など）に合致するか？**
3. 指定された `RoomID` と `TimeRange` に、**既に他の予約が存在しないか？** (重複チェック)

これらのチェックを行うためには、コマンドの入力パラメータ（`RoomID`, `UserID`, `TimeRange`）以外に、以下の情報源を参照する必要があります。

- **会議室の情報**: `MeetingRoom` 集約の情報が必要です。特に予約可能ルールに関する情報（`can_book()` メソッドなど）。
- **既存の予約情報**: 指定された会議室と時間帯の既存の `Reservation` 集約の情報が必要です。

これらは、コマンドを実行する**前**に参照される情報（**Read Model**）と考えることができます。あるいは、コマンドを実行する `UseCase` が、対応する**リポジトリ** (`MeetingRoomRepository`, `ReservationRepository`) を使ってこれらの情報を取得すると考えられます。

イベントストーミングでは、これらの参照情報を `{{Read Model名}}` のように書き加えることがあります。

```
   +------------------------------------+
   | {{会議室情報 (MeetingRoom Agg.)}}   |
   | {{既存予約情報 (Reservation Agg.)}} |
   +----------------|-------------------+
                    v (参照 / Check)
(利用者) -- {会議室を予約する} --+--> <Reservation> (Create New)
         (RoomID, UserID, TimeRange) |
                                   +--> [会議室が予約された]

```

**読み方**:

1. `(利用者)` が `{会議室を予約する}` コマンドを実行する際、
2. システムは `{{会議室情報}}` と `{{既存予約情報}}` を**参照**して、予約が可能かどうかを**チェック**し、
3. （チェックが通れば）新しい `<Reservation>` 集約を**生成**し、
4. その結果として `[会議室が予約された]` イベントが発生する。

---

## 📝 まとめ

このステップでは、`{会議室を予約する}` コマンドが操作する対象として `<Reservation>` **集約**を特定しました。

また、コマンドを実行する前に必要な**チェック**のために、`{{会議室情報}}` や `{{既存予約情報}}` といった情報（**Read Model** または他の**集約**の状態）を参照する必要があることも明確になりました。

これにより、コマンド（操作）、イベント（結果）、集約（操作対象）、Read Model（参照情報）の関係性が見えてきました。

---

## ➡️ 次へ

次は、「**(Step 4) アクター/外部システム/ポリシーの特定**」に進み、コマンドを実行するアクターの詳細や、イベントによって引き起こされる可能性のある副作用（ポリシー）などを考えてみましょう。