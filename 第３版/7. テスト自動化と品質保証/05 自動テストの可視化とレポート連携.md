## 第5章：自動テストの可視化とレポート連携


## 🎯 この章の目的

1. **テスト結果の「見える化」**を行い、チーム全体の品質状況を把握する
2. **失敗要因をすぐに特定できるレポート基盤**を構築する
3. **CI/CDパイプラインとレポートの自動連携**を設計できるようにする

---

## 🧩 1. なぜテスト可視化が必要なのか

📘 テスト自動化の最終目標は「継続的な品質保証」です。
しかし、テストが成功・失敗しただけでは**“品質の全体像”が分かりません**。

💡 よくある課題：

| 課題          | 影響           |
| ----------- | ------------ |
| テスト結果がログだけ  | 失敗箇所を特定しづらい  |
| CIログが流れてしまう | 分析や追跡ができない   |
| チーム全体が見えない  | 修正優先度の判断が遅れる |

✅ 対策は、「テスト結果を**視覚的に・履歴として**残す」ことです。

---

## 🧩 2. JUnit XMLレポートの基本

📘 ほとんどのCI/CDツールは **JUnit形式のXMLレポート**をサポートしています。
pytestでは `--junitxml` オプションで自動出力できます。

💻 例：

```bash
pytest --junitxml=reports/test-results.xml
```

💡 出力ファイルの一部（例）：

```xml
<testsuite name="pytest" tests="5" failures="1">
  <testcase classname="test_api" name="test_ok" time="0.1" />
  <testcase classname="test_api" name="test_fail" time="0.2">
    <failure message="AssertionError">Expected 200</failure>
  </testcase>
</testsuite>
```

💡 このXMLをGitHub Actions・GitLab CI・Jenkinsが自動解析して
「テスト成功率」や「失敗ケース一覧」を可視化できます。

---

## 🧩 3. HTMLレポート（pytest-html）

📘 開発チームがブラウザで閲覧しやすい形式を作るなら、
`pytest-html` が便利です。

💻 実行例：

```bash
pytest --html=reports/report.html --self-contained-html
```

💡 出力される内容：

* 総テスト数／失敗数／スキップ数
* 実行時間グラフ
* スタックトレース（失敗箇所のクリック展開）
* スクリーンショット（E2E連携時）

💡 効果：

> ログを読まなくても「どこが・どの条件で失敗したか」が一目でわかる。

---

## 🧩 4. Allureによる高度なテストレポート

📘 Allureは、よりリッチな**グラフィカルテストダッシュボード**を提供します。
CI/CD環境と組み合わせると、「履歴＋トレンド」まで把握可能です。

💻 セットアップ例：

```bash
pip install allure-pytest
pytest --alluredir=allure-results
allure serve allure-results
```

💡 特徴：

* 実行履歴（過去回との比較）
* テスト階層別（機能別・タグ別）
* 失敗スクリーンショットや添付ファイル
* REST API連携によるダッシュボード自動生成

💡 結果イメージ（テキスト版）：

```
Allure Report Summary
----------------------
✔ Passed: 152 tests
✘ Failed: 3 tests
⚠ Skipped: 5 tests
Avg Duration: 1.2s
Top Failed Module: test_payment_api.py
```

---

## 🧩 5. GitHub Actionsとの統合表示

📘 GitHub Actionsでは、テスト結果を直接UIに表示できます。

💻 Workflow例：

```yaml
name: Pytest Report
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install
        run: pip install -r requirements.txt
      - name: Run tests
        run: pytest --junitxml=reports/results.xml
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: reports/
```

💡 成果：

* Actionsページでテスト結果が一覧表示
* 成功／失敗テスト数・所要時間が可視化
* `Upload Artifact` によりHTMLレポートもダウンロード可能

---

## 🧩 6. 履歴比較と品質トレンドの可視化

📘 テストは「一度成功」よりも「継続的に安定」することが重要。
AllureやReportPortal.ioなどのツールで履歴を残すと、
**品質の“傾向”を数値で追跡**できます。

💡 例（品質トレンド表示）：

| 期間         | 成功率 | 平均実行時間 | 新規失敗数 |
| ---------- | --- | ------ | ----- |
| 2025/09/01 | 98% | 12.4s  | 0     |
| 2025/09/10 | 95% | 14.8s  | 3     |
| 2025/09/20 | 99% | 11.9s  | 0     |

💡 チームで「今の品質はどうか？」を即判断できる状態を目指します。

---

## 🧩 7. E2Eテストのスクリーンショット連携

📘 UIテスト（Playwright / Selenium）では、
失敗時に**自動スクリーンショット**を取ると原因特定が劇的に早くなります。

💻 例（Playwright + pytest）：

```python
def test_ui_flow(page):
    page.goto("http://localhost:8080")
    try:
        page.click("#submit")
        assert page.url.endswith("/done")
    except Exception:
        page.screenshot(path="reports/fail.png")
        raise
```

💡 結果：
HTMLレポートやAllure上で「失敗時の画面」が表示され、
再現性確認が容易になる。

---

## 🧩 8. 自動通知と共有

📘 テスト結果をチームに自動で共有すると、
失敗対応のスピードが格段に上がります。

💡 通知連携例：

| 手段        | ツール                          | 内容            |
| --------- | ---------------------------- | ------------- |
| チャット通知    | Slack / Microsoft Teams      | テスト成功率・失敗テスト名 |
| レポートURL共有 | Allure Server / GitHub Pages | 最新結果へのリンク     |
| メール送信     | CIツール標準機能                    | 日次レポート配信      |

💻 例（Slack通知）：

```yaml
- name: Notify Slack
  uses: slackapi/slack-github-action@v2
  with:
    payload: |
      {
        "text": "✅ Pytest完了: 成功=${{ steps.pytest.outputs.passed }}, 失敗=${{ steps.pytest.outputs.failed }}"
      }
```

💡 「結果を早く知る → 早く直す」が品質向上の最短ループです。

---

## 🧩 9. ベストプラクティス

| 観点     | ベストプラクティス                  |
| ------ | -------------------------- |
| フォーマット | JUnit XMLを基本形式にする          |
| 可視化    | pytest-html・Allureで視覚化     |
| CI統合   | 成果物をGitHub Actionsに添付      |
| 履歴管理   | AllureやReportPortalでトレンド分析 |
| 通知     | Slack等で自動連携                |
| スクショ   | UIテストで失敗時自動保存              |

💡 テストの「成功率」ではなく「**改善の軌跡**」を見えるようにする。

---

## ✅ まとめ

| 要点   | 内容                      |
| ---- | ----------------------- |
| 可視化  | テスト結果をHTMLやダッシュボードで表示   |
| 自動化  | CI/CDと一体化して常時更新         |
| 通知   | 失敗を即共有し、修正サイクルを短縮       |
| 履歴管理 | 過去結果と比較し、品質の推移を分析       |
| 成果   | チーム全員が“今の品質”を理解できる状態を実現 |

---

## 🔜 次章予告：「第6章　AIによるテスト生成と自動修正」

次章では、AIを活用した**テスト生成・自動修正**の最新手法を扱います。
コード変更を検知してAIが自動的に新テストを提案し、
**人間とAIが協調する品質保証の未来像**を示します。


