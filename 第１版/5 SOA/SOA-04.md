# SOA-04 : ğŸŸ¡ `interface_adapters/inventory_service_adapter.py` (ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼)

`SOA-02` ã§å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆåœ¨åº«ç®¡ç†ï¼‰ã‚’å®šç¾©ã—ã€`SOA-03` ã§ç§ãŸã¡ã® `Use Case` ãŒè¦æ±‚ã™ã‚‹ã€Œç†æƒ³ã®éµç©´ï¼ˆ`IInventoryServicePort`ï¼‰ã€ã‚’å®šç¾©ã—ã¾ã—ãŸã€‚

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€ãã®ã€Œéµç©´ã€ã«ã´ã£ãŸã‚Šåˆã†ã€Œ**å…·ä½“çš„ãªéµï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰**ã€ã‚’ `Interface Adapters` ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å®Ÿè£…ã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãŒã€ç§ãŸã¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã¤ãªãã€Œ**å¤‰æ›ãƒ—ãƒ©ã‚°**ã€ã®å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚

## ğŸ¯ ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«

  * `Interface Adapters` ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã€å†…éƒ¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¥ç¶šã™ã‚‹ã€Œã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã€ã§ã‚ã‚‹ã“ã¨ã‚’ç†è§£ã™ã‚‹ã€‚
  * `use_cases` ã§å®šç¾©ã—ãŸã€ŒæŠ½è±¡ï¼ˆãƒãƒ¼ãƒˆï¼‰ã€ã‚’ã€ã€Œå…·è±¡ï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¹ï¼‰ã€ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã€‚
  * ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãŒã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’**ä¾å­˜æ€§ã®æ³¨å…¥ (DI)** ã§å—ã‘å–ã‚‹ã“ã¨ã‚’å­¦ã¶ã€‚
  * ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®ä¸»ãªå½¹å‰²ãŒã€è¦æ±‚ã‚’å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«ã€Œ**å§”è­² (Delegate)**ã€ã™ã‚‹ã“ã¨ã§ã‚ã‚‹ã“ã¨ã‚’ç†è§£ã™ã‚‹ã€‚

-----

## ğŸ”Œ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ï¼šå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã€Œå¤‰æ›ãƒ—ãƒ©ã‚°ã€

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `Interface Adapters` ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å±ã—ã¾ã™ã€‚ãã®åã®é€šã‚Šã€ã¾ã•ã«ã€Œã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã€ã¨ã—ã¦ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚

`Use Cases` ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®šç¾©ã—ãŸ `IInventoryServicePort` ã¨ã„ã†æˆ‘ã€…ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…éƒ¨ã®ã€Œã‚³ãƒ³ã‚»ãƒ³ãƒˆã®å½¢ï¼ˆéµç©´ï¼‰ã€ã¨ã€`external_services` ãŒæä¾›ã™ã‚‹ `InventoryService` ã¨ã„ã†å¤–éƒ¨ã®ã€Œç‰¹æ®Šãªå½¢çŠ¶ã®ãƒ—ãƒ©ã‚°ï¼ˆAPIï¼‰ã€ã‚’ã€ã†ã¾ãé©åˆã•ã›ã‚‹ãŸã‚ã®**å¤‰æ›ãƒ—ãƒ©ã‚°**ã ã¨è€ƒãˆã¦ãã ã•ã„ ğŸ”Œã€‚

ã“ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®ãŠã‹ã’ã§ã€`Use Case` ã¯æ¥ç¶šå…ˆãŒ `SOA-02` ã®æ¨¡æ“¬ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚ã†ã¨ã€å®Ÿéš›ã® `REST API` ã§ã‚ã‚ã†ã¨ã€å¸¸ã«æ¨™æº–çš„ãªã‚³ãƒ³ã‚»ãƒ³ãƒˆï¼ˆ`IInventoryServicePort`ï¼‰ã«æ¥ç¶šã™ã‚‹ã ã‘ã§æ¸ˆã‚€ã®ã§ã™ã€‚

-----

## ğŸ’» ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®è©³ç´°è§£èª¬

### `InventoryServiceAdapter(IInventoryServicePort)`: å¥‘ç´„ã®å±¥è¡Œ

ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€`SOA-03` ã® `use_cases/interfaces.py` ã§å®šç¾©ã•ã‚ŒãŸ `IInventoryServicePort` ã¨ã„ã†å¥‘ç´„æ›¸ã«ã€Œç½²åã€ã—ã¦ã„ã¾ã™ (`implements` ã®æ„å‘³)ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®ã‚¯ãƒ©ã‚¹ãŒ `check_stock` ã¨ `reduce_stock` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¿…ãšå®Ÿè£…ã™ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚

### `__init__(self, inventory_service: InventoryService)`: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®æ³¨å…¥

ã“ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¯ã€è‡ªèº«ã§å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆ`InventoryService`ï¼‰ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€å¤–éƒ¨ï¼ˆ`main.py`ï¼‰ã‹ã‚‰\*\*å®Œæˆå“ã§ã‚ã‚‹ `InventoryService` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ³¨å…¥ï¼ˆDIï¼‰\*\*ã•ã‚Œã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¨å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®çµåˆã‚‚ç–ã«ä¿ãŸã‚Œã€ãƒ†ã‚¹ãƒˆæ™‚ã«ã¯å½ç‰©ã® `InventoryService` ã«å·®ã—æ›¿ãˆã‚‹ã“ã¨ã‚‚å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### `check_stock(...)` ã¨ `reduce_stock(...)`: å‡¦ç†ã®å§”è­²

ã“ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®ä»•äº‹ã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚`Use Case` ã‹ã‚‰å—ã‘å–ã£ãŸè¦æ±‚ï¼ˆ`check_stock` ã®å‘¼ã³å‡ºã—ï¼‰ã‚’ã€å†…éƒ¨ã§ä¿æŒã—ã¦ã„ã‚‹\*\*æœ¬ç‰©ã® `inventory_service` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã€ãã®ã¾ã¾æ¨ªæµã—ï¼ˆå§”è­²ï¼šDelegateï¼‰\*\*ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

ã‚‚ã—ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰åãŒæˆ‘ã€…ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ç•°ãªã£ã¦ã„ãŸå ´åˆï¼ˆä¾‹ï¼šå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒ `decrease_stock` ã¨ã„ã†åå‰ã ã£ãŸå ´åˆï¼‰ã€ã“ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãŒãã®åå‰ã®é•ã„ã‚’å¸åã—ã€ã€Œ**ç¿»è¨³**ã€ã™ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚ä»Šå›ã¯åå‰ãŒåŒã˜ãªã®ã§ã€å˜ç´”ãªå§”è­²ã¨ãªã£ã¦ã„ã¾ã™ã€‚

-----

## ğŸ›ï¸ ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é‰„å‰‡ï¼ˆå†ç¢ºèªï¼‰

1.  **å¥‘ç´„æ›¸ã‚’å¿…ãšå±¥è¡Œã™ã‚‹:** `Use Cases` ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å®šç¾©ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆ`IInventoryServicePort`ï¼‰ã‚’å¿…ãšå®Ÿè£…ã—ã¾ã™ã€‚
2.  **ä¾å­˜ã®æ–¹å‘:** ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å†…å´ã® `use_cases.interfaces` ã¨ã€å¤–éƒ¨ã® `external_services.inventory_service` ã«ä¾å­˜ã—ã¾ã™ã€‚**ã—ã‹ã—ã€è‡ªèº«ã®å­˜åœ¨ã‚’å†…å´ã® `Use Case` ã«çŸ¥ã‚‰ã›ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚** (`UseCase` ã¯ `IInventoryServicePort` ã—ã‹çŸ¥ã‚‰ãªã„)ã€‚
3.  **ç¿»è¨³è€…ãƒ»å§”è­²è€…ã§ã‚ã‚Œ:** è‡ªèº«ã®è²¬å‹™ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å¤‰æ›ã¨å‡¦ç†ã®å§”è­²ã«å¾¹ã—ã¾ã™ã€‚ã“ã“ã«**ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã„ã¦ã¯ã„ã‘ã¾ã›ã‚“**ã€‚

-----

## ğŸ“„ `interface_adapters/inventory_service_adapter.py` ã®å®Ÿè£…

```python:interface_adapters/inventory_service_adapter.py
# ä¾å­˜æ€§ã®ãƒ«ãƒ¼ãƒ«:
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ Interface Adapters ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å±ã—ã¾ã™ã€‚
# - å†…å´ã® use_cases.interfaces (IInventoryServicePort) ã«ä¾å­˜ã—ã¾ã™ã€‚
# - å¤–éƒ¨ã® external_services (InventoryService) ã«ä¾å­˜ã—ã¾ã™ã€‚

# ã€Œå†…å´ã€ã® use_cases ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ãƒãƒ¼ãƒˆï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from use_cases.interfaces import IInventoryServicePort

# ã€Œå¤–éƒ¨ã€ã®ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä»Šå›ã¯æ¨¡æ“¬ï¼‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from external_services.inventory_service import InventoryService

class InventoryServiceAdapter(IInventoryServicePort):
    """
    ã€Interface Adaptersãƒ¬ã‚¤ãƒ¤ãƒ¼ / Adapterã€‘
    IInventoryServicePort ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å…·ä½“çš„ãªå®Ÿè£…ã‚¯ãƒ©ã‚¹ã€‚
    
    ã“ã®ã‚¯ãƒ©ã‚¹ã®è²¬å‹™ã¯ã€æˆ‘ã€…ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…éƒ¨ã®è¦æ±‚ï¼ˆãƒãƒ¼ãƒˆã¸ã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ï¼‰ã‚’ã€
    å¤–éƒ¨ã®åœ¨åº«ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã®APIå‘¼ã³å‡ºã—ã¸ã¨ã€Œå¤‰æ›ã€ã—ã€ã€Œå§”è­²ã€ã™ã‚‹ã“ã¨ã€‚
    """
    def __init__(self, inventory_service: InventoryService):
        """
        å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§å—ã‘å–ã‚‹ï¼ˆä¾å­˜æ€§ã®æ³¨å…¥ï¼‰ã€‚
        ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¯ç‰¹å®šã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…ã«ä¾å­˜ã—ã¤ã¤ã‚‚ã€
        Use Case ã‹ã‚‰ã¯ãã®å®Ÿè£…ã‚’éš è”½ã§ãã‚‹ã€‚
        """
        self.inventory_service = inventory_service
        print("ğŸ”Œ Inventory Service Adapter initialized.")

    def check_stock(self, product_id: str, quantity: int) -> bool:
        """
        ã€å®Ÿè£…ã€‘IInventoryServicePort ã®å¥‘ç´„ã«å¾“ã„ã€check_stock ã‚’å®Ÿè£…ã€‚
        å‡¦ç†ã‚’å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ (inventory_service) ã®åŒåãƒ¡ã‚½ãƒƒãƒ‰ã«å§”è­²ã™ã‚‹ã€‚
        """
        print(f"ğŸ”Œ Adapter: Forwarding check_stock request for {product_id} to external service.")
        try:
            # å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã™ (ç¾å®Ÿãªã‚‰ã“ã“ã§ HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãªã©)
            result = self.inventory_service.check_stock(product_id, quantity)
            return result
        except Exception as e:
            # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° (ä¾‹: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã‚‹å ´åˆãªã©)
            print(f"ğŸ”Œ Adapter ERROR: Failed to check stock - {e}")
            # Use Case ã«ã¯å˜ç´”ãª False ã‚’è¿”ã™ (ã‚¨ãƒ©ãƒ¼è©³ç´°ã¯ä¼ãˆãªã„)
            return False

    def reduce_stock(self, product_id: str, quantity: int):
        """
        ã€å®Ÿè£…ã€‘IInventoryServicePort ã®å¥‘ç´„ã«å¾“ã„ã€reduce_stock ã‚’å®Ÿè£…ã€‚
        å‡¦ç†ã‚’å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ (inventory_service) ã®åŒåãƒ¡ã‚½ãƒƒãƒ‰ã«å§”è­²ã™ã‚‹ã€‚
        """
        print(f"ğŸ”Œ Adapter: Forwarding reduce_stock request for {product_id} to external service.")
        try:
            # å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã™
            self.inventory_service.reduce_stock(product_id, quantity)
        except ValueError as e:
            # å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒæŠ•ã’ãŸåœ¨åº«ä¸è¶³ã‚¨ãƒ©ãƒ¼(ValueError)ã‚’ãã®ã¾ã¾ Use Case ã«ä¼ãˆã‚‹
            print(f"ğŸ”Œ Adapter INFO: Stock reduction failed (handled by external service) - {e}")
            raise e # Use Case ã«ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼
        except Exception as e:
            # ãã®ä»–ã®äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼
            print(f"ğŸ”Œ Adapter ERROR: Failed to reduce stock - {e}")
            # Use Case ã«ã¯ã‚ˆã‚Šæ±ç”¨çš„ãªä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹ (è©³ç´°ã¯éš è”½)
            raise RuntimeError(f"Failed to communicate with inventory service: {e}")

```

ã“ã‚Œã§ã€ã€Œç†æƒ³ã®éµç©´ï¼ˆ`IInventoryServicePort`ï¼‰ã€ã«åˆã†ã€Œå…·ä½“çš„ãªéµï¼ˆ`InventoryServiceAdapter`ï¼‰ã€ãŒå®Œæˆã—ã¾ã—ãŸã€‚
æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆ`SOA-05`ï¼‰ã§ã¯ã€ã„ã‚ˆã„ã‚ˆ `Use Case`ï¼ˆ`ProcessOrderUseCase`ï¼‰ã‚’ä¿®æ­£ã—ã€ã“ã®æ–°ã—ã„ã€Œéµã€ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚