# CA-03: 🟢 Use Cases レイヤー (1/2)
### インターフェース (use\_cases/interfaces.py)

`CA-02` で「宝物（エンティティ）」を `domain` レイヤーに定義しました。
次に、その一つ外側の **Use Cases（ユースケース）** レイヤーを実装します。

このレイヤーは2つの部分から構成されます。

1.  **インターフェース (Port):** 外部（DBなど）に「要求」する「契約書」。（今回 `CA-03` で実装）
2.  **ロジック (Use Case):** その「契約書」だけを使って実装される、純粋なビジネスフロー。（次回 `CA-04` で実装）

まずは、`use_cases/interfaces.py` を作成し、「契約書」を定義します。

## 🎯 この章のゴール

  * クリーンアーキテクチャの「ポート（Port）」としてのインターフェースの役割を理解する。
  * `OOP-09` で学んだ「コンセントの鍵穴」が、このインターフェース定義のことであると学ぶ。
  * ユースケースが「具象（DBなど）」ではなく「抽象（インターフェース）」に依存する仕組みを実装する。

-----

## 🔌 このファイルの役割：外部世界との「契約書 (ポート)」

この `use_cases/interfaces.py` ファイルは、`Use Cases` レイヤー（内側）が、`Interface Adapters` レイヤー（外側、DB実装など）に「こういう機能を提供してほしい」と\*\*要求する「契約書」\*\*を定義する場所です。

`OOP-09` の「コンセントのアナロジー」を思い出してください。

  * \*\*壁（`Use Cases`）\*\*は、家電（`DB`）が「ドライヤー」か「iPhone充電器」かを知りません。
  * 壁はただ、「この形の\*\*鍵穴（インターフェース）\*\*に合うプラグを差し込めば、電力を供給する」と宣言します。

このファイルは、まさにその「**鍵穴（＝インターフェース）**」の形を定義する場所です。`Use Cases` は「私（ユースケース）は、`IProductRepository` という『鍵穴』の形に合う『何か』が接続される必要がある」と宣言します。

このインターフェースは、内側の世界と外側の世界をつなぐ「**ポート（Port）**」と呼ばれます。

-----

## 🏛️ このレイヤーの鉄則

1.  **内側の要求によって定義される:**
    このインターフェース（`IProductRepository`）は、ユースケースが「商品IDで商品を見つけたい」と**要求したから**存在します。外側のデータベースの都合で定義されるのではありません。
2.  **内側のレイヤーにのみ依存する:**
    `import`文を見てください。このファイルは、自分より内側の `domain` レイヤーから `Product` や `Order` をインポートしていますが、外側の `interface_adapters` レイヤーから何かをインポートすることは決してありません。
3.  **ドメインオブジェクトをやり取りする:**
    インターフェースのメソッドが受け渡しするデータは、データベースの生データ（辞書など）ではなく、`Product` や `Order` のような純粋な「エンティティ」です。これにより、レイヤー間の境界がクリーンに保たれます。

-----

## 📄 `use_cases/interfaces.py` の実装

`OOP-05` で定義した `IOrderRepository` や、`OOP-07` の `ProductFactory` の代わりとなる `IProductRepository` を、このファイルに集約します。

```python:use_cases/interfaces.py
# 依存性のルール:
# このファイルは Use Cases レイヤーに属します。
# したがって、自分より内側のレイヤー（domain）にのみ依存することが許されます。
# 外側のレイヤー（interface_adapters, infrastructure など）から何かを
# インポートすることは、固く禁じられています。

from abc import ABC, abstractmethod
from typing import List

# 内側の「domain」レイヤーからエンティティをインポートする
from domain.product import Product
from domain.order import Order

class IProductRepository(ABC):
    """
    【Use Casesレイヤー / Port】
    商品の永続化（保存、読み込みなど）を担当するリポジトリの「契約書」。
    
    Use Caseレイヤーは、この「抽象的な契約」にのみ依存します。
    この契約を実際にどうやって実現するか（メモリ上か、MySQLかなど）は、
    外側の Interface Adapters レイヤーの責任です。
    """
    @abstractmethod
    def find_by_id(self, product_id: str) -> Product | None:
        """【契約】商品IDを元に、単一の商品エンティティを検索する"""
        pass
    
    @abstractmethod
    def save(self, product: Product):
        """
        【契約】商品エンティティの状態を永続化（保存・更新）する
        
        (補足: OOPで使った Factory も、実際には
         DBからデータを取得してエンティティを「再構築」する役割を
         このリポジトリが担うことになります)
        """
        pass

class IOrderRepository(ABC):
    """
    【Use Casesレイヤー / Port】
    注文の永続化を担当するリポジトリの「契約書」。
    (OOP-05で定義したインターフェースと同じ)
    """
    @abstractmethod
    def save(self, order: Order):
        """【契約】注文(Order)エンティティを永続化する"""
        pass
    
    @abstractmethod
    def get_all(self) -> List[Order]:
        """【契約】すべての注文履歴（Orderエンティティのリスト）を取得する"""
        pass

```

これで「鍵穴」の準備が整いました。
次のステップ（`CA-04`）では、この「鍵穴」だけを使って、アプリケーションのロジック（ユースケース）を実装します。