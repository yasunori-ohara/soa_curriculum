# 10 ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

# ğŸ”§ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼šã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼å±¤ã®ã•ã‚‰ãªã‚‹æ´—ç·´

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚ãªãŸã¯è‡ªå‹•è²©å£²æ©Ÿã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹æˆã™ã‚‹å…¨ã¦ã®éƒ¨å“ã‚’ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åŸå‰‡ã«å¾“ã£ã¦ä½œã‚Šä¸Šã’ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ã“ã®ã¾ã¾ã§ã‚‚å®Œå…¨ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚

ã—ã‹ã—ã€å„ªã‚ŒãŸè¨­è¨ˆè€…ã¯å¸¸ã«å•ã„ç¶šã‘ã¾ã™ã€‚ã€Œã‚‚ã£ã¨è‰¯ãã§ããªã„ã ã‚ã†ã‹ï¼Ÿã€ã¨ã€‚

ã“ã®ç« ã§ã¯ã€ä¸€åº¦å®Œæˆã—ãŸ`Adapters`å±¤ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ç›´ã—ã€**ã€Œé–¢å¿ƒã®åˆ†é›¢ã€ã®åŸå‰‡ã‚’ã‚ˆã‚Šå³å¯†ã«é©ç”¨ã™ã‚‹**ã“ã¨ã§ã€ã•ã‚‰ã«å …ç‰¢ã§ã€ãƒ†ã‚¹ãƒˆã—ã‚„ã™ãã€ç¾ã—ã„è¨­è¨ˆã¸ã¨æ˜‡è¯ã•ã›ã‚‹ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½“é¨“ã—ã¾ã™ã€‚

## ğŸ¯ ã“ã®ç« ã®ç›®çš„

- ã€Œå‹•ãã‚³ãƒ¼ãƒ‰ã€ã¨ã€Œè‰¯ã„è¨­è¨ˆã®ã‚³ãƒ¼ãƒ‰ã€ã®é•ã„ã‚’ç†è§£ã™ã‚‹ã€‚
- ã€Œã‚³ãƒ¼ãƒ‰ã®åŒ‚ã„ï¼ˆCode Smellï¼‰ã€ã‚’ç‰¹å®šã—ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åŸå‰‡ã«åŸºã¥ã„ã¦ãã‚Œã‚’è§£æ¶ˆã™ã‚‹ã‚¹ã‚­ãƒ«ã‚’èº«ã«ã¤ã‘ã‚‹ã€‚
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã£ã¦ã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è²¬å‹™ãŒã„ã‹ã«æ˜ç¢ºã«ãªã‚Šã€ãƒ†ã‚¹ãƒˆãŒã•ã‚‰ã«å®¹æ˜“ã«ãªã‚‹ã‹ã‚’ä½“æ„Ÿã™ã‚‹ã€‚

![ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](../ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.png)

## âœ… æ”¹å–„ç‚¹1ï¼š`View`ã‹ã‚‰çŠ¶æ…‹ç®¡ç†ã‚’åˆ†é›¢ã™ã‚‹ (`PaymentManager`ã®ãƒªãƒã‚¸ãƒˆãƒªåŒ–)

### å—…ãã¤ã‘ã‚‹ã¹ãã€ŒåŒ‚ã„ã€

ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€`ConsoleView`ãŒ`PaymentManager`ã¨ã„ã†çŠ¶æ…‹ã‚’æŒã¤`Entity`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆãƒ»ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ã€Œ`View`ã¯æ„šç›´ã§ã‚ã‚‹ã¹ãã€ã¨ã„ã†åŸå‰‡ã«å°‘ã—åã—ã¦ãŠã‚Šã€ã€ŒUIãŒãƒ“ã‚¸ãƒã‚¹ã®çŠ¶æ…‹ã‚’çŸ¥ã‚Šã™ãã¦ã„ã‚‹ã€ã¨ã„ã†ã€ŒåŒ‚ã„ã€ãŒã—ã¾ã™ã€‚

### è§£æ±ºç­–ï¼šãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©ç”¨

`Item`ã¨åŒæ§˜ã«ã€`PaymentManager`ã‚‚ãƒªãƒã‚¸ãƒˆãƒªã‚’é€šã˜ã¦`UseCase`ãŒç®¡ç†ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`View`ã¯çŠ¶æ…‹ç®¡ç†ã®è²¬å‹™ã‹ã‚‰å®Œå…¨ã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚

### ğŸ’» å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´

**1. å¢ƒç•Œï¼ˆBoundaryï¼‰ã®è¿½åŠ **

```python
# application/boundaries.py
class PaymentManagerAccessInterface(ABC):
    @abstractmethod
    def get(self) -> PaymentManager:
        raise NotImplementedError
    @abstractmethod
    def save(self, payment_manager: PaymentManager):
        raise NotImplementedError

```

**2. DataAccessã®å®Ÿè£…è¿½åŠ **
(â€»ã“ã‚Œã¯`DataAccess`ã®ç« ã§å…ˆã«è¿½åŠ ã—ãŸã‚‚ã®ã§ã™)

```python
# adapters/data_access.py
class InMemoryPaymentManagerAccess(PaymentManagerAccessInterface):
    _instance: PaymentManager = PaymentManager()
    def get(self) -> PaymentManager: return self._instance
    def save(self, payment_manager: PaymentManager): self._instance = payment_manager

```

**3. UseCaseã®ä¿®æ­£**`UseCase`ãŒ`PaymentManager`ã‚’ãƒªãƒã‚¸ãƒˆãƒªçµŒç”±ã§å–å¾—ãƒ»ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```python
# application/use_cases/select_item.py
class SelectItemUseCase:
    # __init__ã§PaymentManagerRepositoryã‚’å—ã‘å–ã‚‹
    def __init__(self, ..., pm_repository: PaymentManagerAccessInterface):
        # ...
        self._pm_repository = pm_repository

    # handleãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰payment_managerå¼•æ•°ã‚’å‰Šé™¤
    def handle(self, input_data: SelectItemInputData):
        # UseCaseè‡ªèº«ãŒãƒªãƒã‚¸ãƒˆãƒªçµŒç”±ã§PaymentManagerã‚’å–å¾—ãƒ»ä¿å­˜ã™ã‚‹
        payment_manager = self._pm_repository.get()
        item = self._item_repository.find_by_slot_id(input_data.slot_id)
        # ...
        change = payment_manager.process_purchase(item)
        # ...
        self._pm_repository.save(payment_manager)
        # ...

```

**4. Controllerã¨Viewã®å˜ç´”åŒ–**`Controller`ã¨`View`ã¯`PaymentManager`ã®å­˜åœ¨ã‚’çŸ¥ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚

```python
# adapters/controller.py
class VendingMachineController:
    # select_itemãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰payment_managerå¼•æ•°ã‚’å‰Šé™¤
    def select_item(self, slot_id: str):
        input_data = SelectItemInputData(slot_id=slot_id)
        self._select_item_use_case.handle(input_data)

# adapters/view.py
class ConsoleView:
    def run(self):
        # â˜…â˜…â˜… PaymentManagerã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†ãŒViewã‹ã‚‰æ¶ˆãˆã‚‹ï¼ â˜…â˜…â˜…
        while True:
            # ...
            if action == 's':
                slot_id = input("è³¼å…¥ã™ã‚‹å•†å“ã®ã‚¹ãƒ­ãƒƒãƒˆID: ")
                # Controllerã‚’å‘¼ã³å‡ºã™ã ã‘
                self._controller.select_item(slot_id)
            # ...

```

### âœ¨ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ¡ãƒªãƒƒãƒˆ

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€`View`ã¯UIã®å…¥å‡ºåŠ›ã¨ã„ã†æœ¬æ¥ã®è²¬å‹™ã«å°‚å¿µã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“ã®è¦‹é€šã—ãŒã•ã‚‰ã«ã‚ˆããªã‚Šã¾ã—ãŸã€‚

## âœ… æ”¹å–„ç‚¹2ï¼šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ´—ç·´

### å—…ãã¤ã‘ã‚‹ã¹ãã€ŒåŒ‚ã„ã€

ç¾åœ¨ã®`View`ã¯ã€`UseCase`ã‹ã‚‰é€å‡ºã•ã‚Œã‚‹`ValueError`ã‚’`try-except`ã§æ•æ‰ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€UIãŒãƒ“ã‚¸ãƒã‚¹ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’çŸ¥ã£ã¦ã—ã¾ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã‚ã‚Šã€çµåˆåº¦ã‚’é«˜ã‚ã‚‹åŸå› ã¨ãªã‚Šã¾ã™ã€‚

### è§£æ±ºç­–ï¼šæˆåŠŸ/å¤±æ•—ãƒ«ãƒ¼ãƒˆã®åˆ†é›¢

ç¬¬äºŒå·¡ã¨åŒæ§˜ã«ã€`Presenter`ã«ã‚¨ãƒ©ãƒ¼å°‚ç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨æ„ã—ã€`UseCase`ãŒãƒ“ã‚¸ãƒã‚¹ã‚¨ãƒ©ãƒ¼ã‚’å†…éƒ¨ã§å‡¦ç†ã—ã¦`Presenter`ã«é€šçŸ¥ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### ğŸ’» å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´

**1. å¢ƒç•Œï¼ˆBoundaryï¼‰ã®æ›´æ–°**

```python
# application/boundaries.py
class SelectItemOutputBoundary(ABC):
    @abstractmethod
    def present_success(self, output_data: SelectItemOutputData): pass
    @abstractmethod
    def present_failure(self, error_message: str): pass

```

**2. UseCaseã®æ›´æ–°**

```python
# application/use_cases/select_item.py
class SelectItemUseCase:
    def handle(self, input_data: SelectItemInputData):
        try:
            # ... å¾“æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ ...
            self._presenter.present_success(output_data)
        except ValueError as e:
            # â˜…ä¾‹å¤–ã‚’æ•æ‰ã—ã€å¤±æ•—ãƒ«ãƒ¼ãƒˆã§Presenterã‚’å‘¼ã¶
            self._presenter.present_failure(str(e))

```

**3. Presenterã®æ›´æ–°**

```python
# adapters/presenter.py
class VendingMachinePresenter(SelectItemOutputBoundary):
    # ...
    def present_success(self, output_data: SelectItemOutputData):
        # ... æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çµ„ã¿ç«‹ã¦ã‚‹ ...
        self._view_model.display_text = message

    def present_failure(self, error_message: str):
        # â˜…å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çµ„ã¿ç«‹ã¦ã‚‹
        self._view_model.display_text = f"ã‚¨ãƒ©ãƒ¼: {error_message}"

```

**4. Viewã®å˜ç´”åŒ–**`View`ã¯ãƒ“ã‚¸ãƒã‚¹ã‚¨ãƒ©ãƒ¼ã‚’æ°—ã«ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã€ç´”ç²‹ãªå…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼ˆ`int`ã¸ã®å¤‰æ›å¤±æ•—ãªã©ï¼‰ã ã‘ã‚’æ°—ã«ã™ã‚Œã°ã‚ˆããªã‚Šã¾ã™ã€‚

```python
# adapters/view.py
class ConsoleView:
    def run(self):
        # ...
        try:
            # ... Controllerã‚’å‘¼ã³å‡ºã™ ...
        except ValueError: # ã“ã®exceptã¯ã€'int(coin_str)'ã®ã‚ˆã†ãªUIèµ·å› ã®ã‚¨ãƒ©ãƒ¼ã®ã¿ã‚’æ•æ‰
            self._view_model.display_text = "ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªå…¥åŠ›ã§ã™ã€‚"
        # ...

```

### âœ¨ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ¡ãƒªãƒƒãƒˆ

`View`ãŒ`UseCase`ã®å†…éƒ¨å®Ÿè£…ï¼ˆã©ã‚“ãªä¾‹å¤–ã‚’æŠ•ã’ã‚‹ã‹ï¼‰ã‚’çŸ¥ã‚‹å¿…è¦ãŒãªããªã‚Šã€ã‚ˆã‚Šç–çµåˆã§å …ç‰¢ãªã‚·ã‚¹ãƒ†ãƒ ã«ãªã‚Šã¾ã—ãŸã€‚

## âœ… æ”¹å–„ç‚¹3ï¼š`Hardware Adapter`ã‚’ã‚ˆã‚Šãƒªãƒƒãƒã«ã™ã‚‹

ã“ã‚Œã¯å°ã•ãªæ”¹å–„ã§ã™ãŒã€ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®å½¹å‰²ã‚’ã‚ˆã‚Šæ˜ç¢ºã«ã—ã¾ã™ã€‚

- **å¤‰æ›´å‰**: `dispense_item(slot_id: str)`
- **å¤‰æ›´å¾Œ**: `dispense_item(item: Item)`

`UseCase`ã¯`Item`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’çŸ¥ã£ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’ãã®ã¾ã¾æ¸¡ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`ConsoleHardwareAdapter`ã¯ã€Œï¼ˆã‚¬ã‚³ãƒ³ãƒƒï¼ã€ãŠèŒ¶ã€ã‚’æ’å‡ºã—ã¾ã—ãŸï¼‰ã€ã®ã‚ˆã†ã«ã€ã‚ˆã‚Šãƒªãƒƒãƒãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## ğŸ›¡ï¸ ã¾ã¨ã‚ï¼šãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã®ä¸–ç•Œ

ã“ã‚Œã‚‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’é€šã˜ã¦ã€ç§ãŸã¡ã¯ä»¥ä¸‹ã®åŸå‰‡ã‚’ã‚ˆã‚Šæ·±ãã‚³ãƒ¼ãƒ‰ã«åæ˜ ã•ã›ã¾ã—ãŸã€‚

- **å˜ä¸€è²¬ä»»ã®åŸå‰‡**: `View`ã¯UIã®ã“ã¨ã«ã€`UseCase`ã¯ãƒ“ã‚¸ãƒã‚¹ã®ã“ã¨ã«ã€ãã‚Œãã‚ŒãŒã‚ˆã‚Šé›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
- **ä¾å­˜æ€§åè»¢ã®åŸå‰‡**: `View`ãŒ`Entity`ã«ç›´æ¥ä¾å­˜ã™ã‚‹ç®‡æ‰€ãŒãªããªã‚Šã€ä¾å­˜é–¢ä¿‚ãŒã‚ˆã‚Šã‚¯ãƒªãƒ¼ãƒ³ã«ãªã‚Šã¾ã—ãŸã€‚

å‹•ãã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ã¯ç¬¬ä¸€æ­©ã§ã™ã€‚ã—ã‹ã—ã€ãã®ã‚³ãƒ¼ãƒ‰ã‚’åŸå‰‡ã«ç…§ã‚‰ã—åˆã‚ã›ã¦è¦‹ç›´ã—ã€ã‚ˆã‚Šè‰¯ã„è¨­è¨ˆã¸ã¨æ”¹å–„ã—ç¶šã‘ã‚‹ã“ã¨ã“ããŒã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å®Ÿè·µã™ã‚‹ä¸Šã§æœ€ã‚‚é‡è¦ãªã‚¹ã‚­ãƒ«ãªã®ã§ã™ã€‚