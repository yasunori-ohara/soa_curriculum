# 02 Use Case Interactor

# ğŸ‘¨â€ğŸ« Use Case Interactor
### `vending_machine/usecase/select_item_usecase.py`

`Entity` ãŒã€Œæ­£ã—ã„çŠ¶æ…‹ã¨ãƒ«ãƒ¼ãƒ«ã€ã‚’å®ˆã‚‹éƒ¨å“ã ã¨ã™ã‚‹ã¨ã€
`UseCase` ã¯ãã‚Œã‚‰ã®éƒ¨å“ã‚’çµ„ã¿åˆã‚ã›ã¦ã€Œå®Ÿéš›ã®æ“ä½œã®æµã‚Œã€ã‚’å®Ÿç¾ã™ã‚‹å½¹ç›®ã§ã™ã€‚

ã“ã“ã§ã¯ã€è‡ªå‹•è²©å£²æ©Ÿã®ä¸­æ ¸ã¨ãªã‚‹ã‚·ãƒŠãƒªã‚ªã§ã‚ã‚‹
**ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå•†å“ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å•†å“ã‚’è³¼å…¥ã™ã‚‹ã€** ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’æ‰±ã„ã¾ã™ã€‚

ã“ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’æ‹…å½“ã™ã‚‹ã®ãŒ `SelectItemUseCase` ã§ã™ã€‚

![ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](../ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.png)

---

## ğŸ¯ ã“ã®ã‚¯ãƒ©ã‚¹ã®å½¹å‰²

`SelectItemUseCase` ã¯ã€è‡ªå‹•è²©å£²æ©Ÿã®ã€Œé ­è„³ï¼å¸ä»¤å¡”ã€ã§ã™ã€‚
ã²ã¨ã¤ã®ã€Œè³¼å…¥ã€ã¨ã„ã†ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å…¨ä½“ã‚’æ­£ã—ã„é †ç•ªã§é€²ã‚ã‚‹è²¬ä»»ãŒã‚ã‚Šã¾ã™ã€‚

ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã‚’äººé–“ã®è¨€è‘‰ã§ã„ã†ã¨ã“ã†ã§ã™ï¼š

1. æŠ¼ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®ã‚¹ãƒ­ãƒƒãƒˆç•ªå·ã‹ã‚‰å•†å“ã‚’ç‰¹å®šã™ã‚‹
2. æŠ•å…¥ã•ã‚ŒãŸé‡‘é¡ã§ãã‚ŒãŒè²·ãˆã‚‹ã‹ç¢ºèªã™ã‚‹
3. å•é¡Œãªã‘ã‚Œã°

   * å•†å“ã‚’æ’å‡ºã™ã‚‹ã‚ˆã†ã«ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã«æŒ‡ç¤º
   * ãŠé‡£ã‚ŠãŒã‚ã‚Œã°è¿”ã™ã‚ˆã†ã«æŒ‡ç¤º
   * åœ¨åº«ã‚’1æœ¬æ¸›ã‚‰ã—ã¦ä¿å­˜ã™ã‚‹
4. æœ€çµ‚çš„ãªçµæœï¼ˆå‡ºã—ãŸå•†å“åã¨ãŠé‡£ã‚Šï¼‰ã‚’ç”»é¢å´ã«ä¼ãˆã‚‹

é‡è¦ãªã®ã¯ã€UseCaseãŒè‡ªåˆ†ã§ç´°ã‹ã„ã“ã¨ã¯ã—ãªã„ã“ã¨ã§ã™ã€‚
å…·ä½“çš„ã«ã¯ï¼š

* ã€Œåœ¨åº«ã¯ã‚ã‚‹ï¼Ÿã€ã®æ­£ã—ã„åˆ¤æ–­ã¯ `Item` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒæŒã¤ãƒ«ãƒ¼ãƒ«ã«ä»»ã›ã‚‹
* ã€ŒãŠé‡‘ã¯è¶³ã‚Šã‚‹ï¼ŸãŠé‡£ã‚Šã¯ï¼Ÿã€ã®æ­£ã—ã„è¨ˆç®—ã¯ `PaymentManager` ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ä»»ã›ã‚‹
* ã€Œãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚’ã©ã†å›ã™ï¼Ÿã€ã®ã‚ˆã†ãªãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã®è©³ç´°ã¯ã‚¢ãƒ€ãƒ—ã‚¿å±¤ã«ä»»ã›ã‚‹
* ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã©ã‚“ãªæ–‡è¨€ã§è¡¨ç¤ºã™ã‚‹ï¼Ÿã€ã¯Presenterã«ä»»ã›ã‚‹

UseCaseã¯ã‚ãã¾ã§ã€Œæ¬¡ã«ä½•ã‚’ã•ã›ã‚‹ã¹ãã‹ã€ã‚’é †åºã ã¦ã¦æŒ‡ç¤ºã™ã‚‹ã ã‘ã€ã¨ã„ã†ç«‹å ´ã§ã™ã€‚

---

## âœ… ã“ã®ã‚¯ãƒ©ã‚¹ã«ã‚ã‚‹ã¹ãå‡¦ç† / ã‚ã£ã¦ã¯ã„ã‘ãªã„å‡¦ç†

### â­• å«ã‚ã‚‹ã¹ãå‡¦ç†

* **è¤‡æ•°ã®Entityã‚’ã¾ãŸã„ã æµã‚Œã®åˆ¶å¾¡ï¼ˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰**
  ä¾‹ï¼š
  `item_repository` ã‹ã‚‰å•†å“ã‚’å–å¾—ã™ã‚‹ â†’
  `payment_manager` ã«æ±ºæ¸ˆã•ã›ã‚‹ â†’
  `hardware` ã«æ’å‡ºã•ã›ã‚‹ â†’
  `item` ã®åœ¨åº«ã‚’æ¸›ã‚‰ã™ â†’
  `item_repository` ã«ä¿å­˜ã™ã‚‹

* **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®æŒ¯ã‚‹èˆã„**
  ã€ŒãŠé‡‘ãŒè¶³ã‚Šãªã‹ã£ãŸã‚‰å•†å“ã‚’å‡ºã—ã¦ã¯ã„ã‘ãªã„ã€
  ã€Œåœ¨åº«ãŒæ¸›ã£ãŸã‚‰ä¿å­˜ã—ç›´ã™ã€ãªã©ã€‚

* **ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã”ã¨ã®å…¥å‡ºåŠ›ã®æ•´å½¢**
  `SelectItemInputData`ï¼ˆå…¥åŠ›DTOï¼‰ã‚’å—ã‘å–ã‚Šã€
  `SelectItemOutputData`ï¼ˆå‡ºåŠ›DTOï¼‰ã«ã¾ã¨ã‚ã¦Presenterã«æ¸¡ã™ã€‚

### âŒ å«ã‚ã¦ã¯ã„ã‘ãªã„å‡¦ç†

* **Entityæœ¬æ¥ã®ãƒ«ãƒ¼ãƒ«ã‚’é‡è¤‡å®Ÿè£…ã™ã‚‹ã“ã¨**
  ä¾‹ï¼š`if item.stock > 0:` ã®ã‚ˆã†ãªåœ¨åº«ãƒã‚§ãƒƒã‚¯ã¯ `Item.dispense()` ã«ä»»ã›ã‚‹ã¹ãã§ã™ã€‚
  UseCaseãŒå‹æ‰‹ã«ã‚„ã‚‹ã¨ãƒ«ãƒ¼ãƒ«ãŒåˆ†æ•£ã—ã¦å±é™ºã«ãªã‚Šã¾ã™ã€‚

* **ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã®è©³ç´°ã‚„ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã®ã‚„ã‚Šæ–¹**
  ã©ã®ãƒãƒ¼ãƒˆã‚’å©ãã¨ãƒ¢ãƒ¼ã‚¿ãƒ¼ãŒå›ã‚‹ã‹ã€DBãŒä½•ã‚’ä½¿ã£ã¦ã‚‹ã‹ã€ãªã©ã¯ã“ã“ã§ã¯çŸ¥ã‚‰ãªã„ãƒ»æ›¸ã‹ãªã„ã€‚

* **UIã®è¦‹ãŸç›®ã‚„æ–‡å­—åˆ—ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**
  ã€Œç”»é¢ã«ã©ã†è¡¨ç¤ºã™ã‚‹ã‹ã€ã¯ Presenter ã¨ View ã®ä»•äº‹ã§ã™ã€‚


## ğŸ’» ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ

```text
vending_machine/
â”œâ”€ domain/
â”‚   â”œâ”€ entities.py          # Item, PaymentManager ãªã©
â”‚   â”œâ”€ errors.py            # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«é•åä¾‹å¤–
â”‚   â””â”€ repositories.py      # DataAccessInterface / HardwareInterface
â”‚
â”œâ”€ usecase/
â”‚   â”œâ”€ dto.py               # InputData / OutputData / ErrorData / ViewModel
â”‚   â”œâ”€ boundaries.py        # InputBoundary / OutputBoundary
â”‚   â”œâ”€ insert_coin_usecase.py    <- ã„ã¾ã“ã“
â”‚   â””â”€ select_item_usecase.py    <- ã„ã¾ã“ã“
```

## ğŸ’» ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆ`SelectItemUseCase`ï¼‰

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ã‚¯ãƒ©ã‚¹ã‚’å‰æã«ã—ã¦ã„ã¾ã™ï¼š

* `usecase/dto.py`

  * `SelectItemInputData`
  * `SelectItemOutputData`
* `usecase/boundaries.py`

  * `SelectItemInputBoundary`
  * `SelectItemOutputBoundary`
  * `ItemDataAccessInterface`
  * `HardwareInterface`
* `domain/entities.py`

  * `Item`
  * `PaymentManager`

ã§ã¯ã€å®Œæˆå½¢ã‚’è¦‹ã¦ã„ãã¾ã™ğŸ‘‡

```python
# vending_machine/usecase/select_item_usecase.py

# -----------------------------------------------------------------------------
# å¿…è¦ãªå‹ï¼ˆå¥‘ç´„ï¼‰ã‚„ãƒ‡ãƒ¼ã‚¿ã®å®šç¾©ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# -----------------------------------------------------------------------------
from vending_machine.usecase.boundaries import (
    SelectItemInputBoundary,
    SelectItemOutputBoundary,
    ItemDataAccessInterface,
    HardwareInterface,
)
from vending_machine.usecase.dto import (
    SelectItemInputData,
    SelectItemOutputData,
)
from vending_machine.domain.entities import Item, PaymentManager


# -----------------------------------------------------------------------------
# SelectItemUseCase
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: UseCase
# - åŒå¿ƒå††å›³ã®ä½ç½®: Use Casesï¼ˆå†…å´ã‹ã‚‰2ç•ªç›®ã®å††ï¼‰
#
# ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€Œã‚ã‚‹ã‚¹ãƒ­ãƒƒãƒˆã®å•†å“ã‚’è²·ã„ãŸã„ã€ã¨ã„ã†1ã¤ã®è¦æ±‚ã‚’å‡¦ç†ã™ã‚‹ã€‚
# Controller ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹æƒ³å®šã€‚
# -----------------------------------------------------------------------------
class SelectItemUseCase(SelectItemInputBoundary):
    """
    ã€Œå•†å“ã‚’é¸æŠã—ã¦è³¼å…¥ã™ã‚‹ã€ã¨ã„ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿè£…ã€‚

    ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€Œåˆ¶å¾¡ã®æµã‚Œã€ã‚’æŒã¤ãŒã€
    å®Ÿéš›ã®å‡¦ç†ã®è©³ç´°ã¯ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å§”ã­ã‚‹ã€‚
        - ãŠé‡‘ã®æ­£ã—ã•: PaymentManager
        - åœ¨åº«æ›´æ–°ãƒ«ãƒ¼ãƒ«: Item
        - ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡: HardwareInterfaceå®Ÿè£…
        - ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–: ItemDataAccessInterfaceå®Ÿè£…
        - å‡ºåŠ›ã®æ•´å½¢: Presenter
    """

    def __init__(
        self,
        presenter: SelectItemOutputBoundary,
        item_repository: ItemDataAccessInterface,
        hardware: HardwareInterface,
    ):
        """
        [ä¾å­˜æ€§ã®æ³¨å…¥ / Dependency Injection]

        UseCaseã¯ã€è‡ªåˆ†ãŒç›´æ¥newã—ã¾ã›ã‚“ã€‚
        ä»£ã‚ã‚Šã«ã€Œã“ã†ã„ã†èƒ½åŠ›ã‚’æŒã£ãŸç›¸æ‰‹ãŒæ¬²ã—ã„ã€ã¨ã ã‘å®£è¨€ã—ã€
        å®Ÿéš›ã«èª°ãŒæ¥ã‚‹ã‹ã¯å¤–å´ (main.py ãªã©) ã§æ±ºã‚ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚

        - presenter:
            çµæœã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºç”¨ã®å½¢å¼ã«å¤‰æ›ã™ã‚‹å½¹ (Presenter)
        - item_repository:
            å•†å“æƒ…å ±ãƒ»åœ¨åº«ã‚’å–å¾—/ä¿å­˜ã—ã¦ãã‚Œã‚‹å½¹
        - hardware:
            ã€Œå•†å“ã‚’ç‰©ç†çš„ã«æ’å‡ºã—ã¦ã€ã€ŒãŠé‡£ã‚Šå‡ºã—ã¦ã€ã¨æŒ‡ç¤ºã§ãã‚‹ç›¸æ‰‹
        """
        self._presenter = presenter
        self._item_repository = item_repository
        self._hardware = hardware

    def handle(self, input_data: SelectItemInputData, payment_manager: PaymentManager):
        """
        [ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹æœ¬ä½“ / ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼ç®¡ç†]

        Controller ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹å…¥ã‚Šå£ã€‚
        ã“ã“ã§ã€Œè³¼å…¥ã€ã¨ã„ã†ä¸€é€£ã®æµã‚Œã‚’ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã€‚

        å¼•æ•°:
            input_data: ControllerãŒçµ„ã¿ç«‹ã¦ãŸå…¥åŠ›DTO
                        ä¾‹: SelectItemInputData(slot_id="A1")
            payment_manager: ç¾åœ¨ã®æŠ•å…¥é‡‘é¡ãªã©ã‚’ä¿æŒã—ã¦ã„ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€‚
                             åŒã˜è³¼å…¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é–“ã ã‘ä½¿ã‚ã‚Œã‚‹ã€‚

        æˆ»ã‚Šå€¤:
            ãªã—ï¼ˆãŸã ã—æœ€å¾Œã«Presenterã¸çµæœã‚’æ¸¡ã™ï¼‰
        """

        # ---------------------------------------------------------
        # æ‰‹é †1. ã‚¹ãƒ­ãƒƒãƒˆIDã‹ã‚‰å•†å“ã‚’å–å¾—ã™ã‚‹
        # ---------------------------------------------------------
        item = self._item_repository.find_by_slot_id(input_data.slot_id)
        if not item:
            # å•†å“è‡ªä½“ãŒå­˜åœ¨ã—ãªã„/å£²ã‚Šåˆ‡ã‚Œã‚±ãƒ¼ã‚¹ã¯ã€æ­£å¼ã«ã¯å°‚ç”¨ã®ã‚¨ãƒ©ãƒ¼å‹ã«ã—ã¦ã‚‚ã‚ˆã„ã€‚
            raise ValueError("æŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆã«å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")

        # ---------------------------------------------------------
        # æ‰‹é †2. æ±ºæ¸ˆå‡¦ç†ï¼ˆãŠé‡‘ã¾ã‚ã‚Šã®ãƒ«ãƒ¼ãƒ«ã¯PaymentManagerã«ä»»ã›ã‚‹ï¼‰
        #   - ååˆ†ãªãŠé‡‘ãŒå…¥ã£ã¦ã„ãªã‘ã‚Œã°ä¾‹å¤–ãŒå‡ºã‚‹
        #   - ãŠé‡£ã‚Šã®è¨ˆç®—ã‚‚ã“ã“ã§è¡Œã‚ã‚Œã‚‹
        #   - æˆåŠŸã—ãŸã‚‰æŠ•å…¥é‡‘é¡ã¯0ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹
        # ---------------------------------------------------------
        change = payment_manager.process_purchase(item)

        # ---------------------------------------------------------
        # æ‰‹é †3. ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¸ã®æŒ‡ç¤ºï¼ˆUseCaseã¯ã€Œä½•ã‚’ã—ã¦ã»ã—ã„ã‹ã€ã ã‘è¨€ã†ï¼‰
        #   a. å•†å“ã‚’ç‰©ç†çš„ã«æ’å‡ºã—ã¦ã»ã—ã„
        #   b. ãŠé‡£ã‚ŠãŒã‚ã‚‹ãªã‚‰è¿”ã—ã¦ã»ã—ã„
        #   å…·ä½“çš„ã«ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚’ã©ã†å›ã™ã‹ç­‰ã¯HardwareInterfaceå®Ÿè£…å´ã®è²¬å‹™
        # ---------------------------------------------------------
        self._hardware.dispense_item(item.slot_id)

        if change > 0:
            self._hardware.return_change(change)

        # ---------------------------------------------------------
        # æ‰‹é †4. åœ¨åº«ã‚’1æœ¬æ¸›ã‚‰ã™ï¼ˆåœ¨åº«ã®å¦¥å½“æ€§ãƒ«ãƒ¼ãƒ«ã¯Itemè‡ªèº«ãŒæŒã£ã¦ã„ã‚‹ï¼‰
        #   - Item.dispense() å†…ã§ã€Œåœ¨åº«ãŒç„¡ã„ãªã‚‰å£²ã£ã¡ã‚ƒãƒ€ãƒ¡ã€ãŒä¿è¨¼ã•ã‚Œã‚‹
        # ---------------------------------------------------------
        item.dispense()

        # ---------------------------------------------------------
        # æ‰‹é †5. å¤‰æ›´å¾Œã®å•†å“ã®çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹
        #   - ã©ã†ä¿å­˜ã™ã‚‹ã‹(DB? ãƒ¡ãƒ¢ãƒª? ãƒ•ã‚¡ã‚¤ãƒ«?) ã¯
        #     item_repositoryã®å®Ÿè£…å´ãŒæ±ºã‚ã‚‹
        # ---------------------------------------------------------
        self._item_repository.save(item)

        # ---------------------------------------------------------
        # æ‰‹é †6. çµæœã‚’Presenterã«æ¸¡ã™
        #   - UseCaseã¯ã€Œã©ã®å•†å“åã‚’å‡ºã—ã¦ã€ã„ãã‚‰ãŠé‡£ã‚ŠãŒå‡ºãŸã‹ã€ã ã‘ä¼ãˆã‚‹
        #   - æ–‡è¨€ã‚„è¦‹ãŸç›®ã®æ•´å½¢ã¯Presenterå´ã®è²¬å‹™
        # ---------------------------------------------------------
        output_data = SelectItemOutputData(
            item_name=item.name,
            change=change,
        )
        self._presenter.present(output_data)
```

---

## ğŸ” ã‚³ãƒ¼ãƒ‰ã®èª­ã¿ã©ã“ã‚

* `class SelectItemUseCase(SelectItemInputBoundary):`
  â†’ ã“ã‚Œã¯ã€Œã“ã®ã‚¯ãƒ©ã‚¹ã¯ `SelectItemInputBoundary`ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å…¥ã‚Šå£ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã‚’æº€ãŸã™æ­£è¦ã®å®Ÿè£…ã§ã™ã‚ˆã€ã¨ã„ã†å®£è¨€ã§ã™ã€‚
  ã¤ã¾ã‚Šã€ã€Œãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿä½“ã€ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤ºã—ã¦ã„ã¾ã™ã€‚

* `__init__()`
  UseCaseã¯ `presenter`, `item_repository`, `hardware` ã«ä¾å­˜ã—ã¦ã„ã¾ã™ãŒã€
  ã©ã‚Œã‚‚ã€Œã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¶Šã—ã€ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚
  ãªã®ã§ã€ã“ã®ã‚¯ãƒ©ã‚¹ã¯ç‰¹å®šã®DBã‚„ç‰¹å®šã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã«ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã•ã‚Œã¾ã›ã‚“ã€‚

* `handle()`
  1ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­ã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã®ã€Œè²·ã†ã€ã¨ã„ã†ç‰©èªã®ã™ã¹ã¦ãŒã¾ã¨ã¾ã£ã¦ã„ã¾ã™ã€‚
  ãŸã ã—ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«è‡ªä½“ã¯Entityã«å§”è­²ã—ã¦ã„ã¾ã™ã€‚
  UseCaseã¯â€œé †ç•ªã¨é€£æºâ€ã«é›†ä¸­ã—ã¾ã™ã€‚

---

## ğŸ’¡ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®è€ƒãˆæ–¹

UseCaseã¯ã€ã™ã¹ã¦ã®å¤–éƒ¨ä¾å­˜ï¼ˆDBã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã€è¡¨ç¤ºï¼‰ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹çµŒç”±ã§æ‰±ã„ã¾ã™ã€‚

ã¤ã¾ã‚Šãƒ†ã‚¹ãƒˆã§ã¯ã€ãã‚Œã‚‰ã‚’ã€Œå½ç‰©ï¼ˆãƒ•ã‚§ã‚¤ã‚¯ï¼ãƒ¢ãƒƒã‚¯ï¼‰ã€ã«ç½®ãæ›ãˆã‚‹ã ã‘ã§ã€
ç‰©ç†ãƒãƒ¼ãƒ‰ã‚‚æœ¬ç‰©DBã‚‚ãªã—ã§ãƒ­ã‚¸ãƒƒã‚¯å…¨ä½“ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚

```python
# tests/usecase/test_select_item_usecase.py ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ä¾‹

def test_ãŠé‡‘ãŒè¶³ã‚Šã¦ã„ã‚Œã°å•†å“ã¨ãŠé‡£ã‚ŠãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹():
    # 1. Arrange: ä¾å­˜å…ˆã®ã€Œå½ç‰©ã€ã‚’æº–å‚™ã™ã‚‹
    fake_presenter = FakePresenter()
    fake_item_repo = FakeItemRepository({
        "A1": Item(slot_id="A1", name="ãŠèŒ¶", price=120, stock=10)
    })
    fake_hardware = FakeHardwareAdapter()

    # æŠ•å…¥é‡‘é¡ãŒååˆ†ã«ã‚ã‚‹çŠ¶æ…‹ã«ã™ã‚‹
    payment_manager = PaymentManager(current_amount=500)

    # ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹æœ¬ä½“ã‚’ä½œã‚‹
    use_case = SelectItemUseCase(
        presenter=fake_presenter,
        item_repository=fake_item_repo,
        hardware=fake_hardware,
    )

    # 2. Act: è³¼å…¥ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
    input_data = SelectItemInputData(slot_id="A1")
    use_case.handle(input_data, payment_manager)

    # 3. Assert: æ­£ã—ãæŒ‡æ®ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ
    assert fake_hardware.dispensed_slot_id == "A1"
    assert fake_hardware.returned_change == 380  # 500 - 120
    assert fake_item_repo.find_by_slot_id("A1").stock == 9
    assert payment_manager.current_amount == 0
    assert fake_presenter.last_output.item_name == "ãŠèŒ¶"
```

ãƒã‚¤ãƒ³ãƒˆã¯ã€ŒUseCaseãã®ã‚‚ã®ã¯ã€printã‚‚ã—ãªã„ã—ã€DBã«ã‚‚è§¦ã‚Œãªã„ã—ã€GPIOã‚‚å©ã‹ãªã„ã€ã¨ã„ã†ã“ã¨ã€‚
UseCaseã‚’ãƒ†ã‚¹ãƒˆã§ãã‚‹ãªã‚‰ã€ã‚ãªãŸã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã»ã¼å®‰å…¨ã«è‚²ã¦ã‚‰ã‚Œã‚‹ã€ã¨ã„ã†ã“ã¨ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚

---

## ğŸ Python vs ğŸ”§ Cè¨€èªã§ã‚‚ã†ä¸€åº¦

* ğŸ Pythonå´ã§ã¯ã€`SelectItemUseCase` ãŒ `HardwareInterface` ã«å‘½ä»¤ã—ã¾ã™ã€‚
  ã“ã®æ™‚ç‚¹ã§ã¯ã€Œå•†å“ã‚’æ’å‡ºã—ã¦ã€ã¨ã„ã†æŠ½è±¡çš„ãªãŠé¡˜ã„ã—ã‹ã—ã¾ã›ã‚“ã€‚

* ğŸ”§ Cã£ã½ã„æ›¸ãæ–¹ã ã¨ã€æ¬¡ã®ã‚ˆã†ãªå±é™ºãŒèµ·ããŒã¡ã§ã™ï¼š

  * `PORTB |= (1 << PB3);` ã®ã‚ˆã†ãªã€ç‰¹å®šãƒ”ãƒ³ã‚’ç›´æ¥å©ãå‘½ä»¤ãŒãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã©çœŸã‚“ä¸­ã«ç”Ÿãˆã¦ãã‚‹ã€‚
  * ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒå¤‰ã‚ã£ãŸç¬é–“ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’æ›¸ãæ›ãˆã‚‹ãƒãƒ¡ã«ãªã‚‹ã€‚

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯é€†ã«ã—ã¾ã™ã€‚

> ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè²·ã†ã¨ã„ã†è¡Œç‚ºï¼‰ã¯ä¸å¤‰ã§ã‚ã‚‹ã¹ãã€‚
> ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ï¼ˆã©ã†æ’å‡ºã™ã‚‹ã‹ï¼‰ã¯äº¤æ›å¯èƒ½ãªè©³ç´°ã§ã‚ã‚‹ã¹ãã€‚

UseCaseã¯ãã®åˆ†é›¢ã‚’å¾¹åº•ã™ã‚‹å ´æ‰€ã§ã™ã€‚

---

## ğŸ›¡ï¸ ã“ã®ã‚¯ãƒ©ã‚¹ã®é‰„å‰‡

> ãƒ“ã‚¸ãƒã‚¹ã®æµã‚Œã‚’æŒ‡æ®ã›ã‚ˆã€‚
> ãŸã ã—ç´°éƒ¨ã®ã‚„ã‚Šæ–¹ã«ã¯å£ã‚’å‡ºã™ãªã€‚
> (Orchestrate the business flow, but delegate the details.)

* UseCaseã¯ã€Œã©ã®é †ç•ªã§ãƒ»ä½•ã‚’ã™ã‚‹ã‹ã€ã‚’æ±ºã‚ã‚‹ã€‚
* ã§ã‚‚ã€å®Ÿéš›ã®ã‚„ã‚Šæ–¹ï¼ˆåœ¨åº«ã®æ­£å½“æ€§ãƒã‚§ãƒƒã‚¯ã‚„ã€ãƒãƒ¼ãƒ‰ã‚’ã©ã†å‹•ã‹ã™ã‹ã€è¡¨ç¤ºã‚’ã©ã†ã™ã‚‹ã‹ï¼‰ã¯ã€ãã‚Œãã‚Œã®æ‹…å½“ï¼ˆEntityã‚„Adapterï¼‰ã«ä»»ã›ã‚‹ã€‚
* ã“ã®åˆ†é›¢ã®ãŠã‹ã’ã§ã€åŒã˜ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’GUIã§ã‚‚CLIã§ã‚‚ç‰©ç†ç­ä½“ã§ã‚‚ä½¿ã„å›ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

---

ã“ã® `SelectItemUseCase` ã‚’è»¸ã«ã€
æ¬¡ã¯ `usecase/dto.py` ã¨ `usecase/boundaries.py` ã‚’æ­£å¼ã«å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚
DTOã¯ã€Œã©ã‚“ãªå½¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘æ¸¡ã™ã‹ã€ã€boundariesã¯ã€Œèª°ãŒã©ã‚“ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã‚Œã°å”åŠ›ã§ãã‚‹ã®ã‹ã€ã¨ã„ã†å¥‘ç´„æ›¸ã§ã™ã€‚
