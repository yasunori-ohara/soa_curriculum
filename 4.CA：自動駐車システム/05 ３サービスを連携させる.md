# 05 ï¼“ã‚µãƒ¼ãƒ“ã‚¹ã‚’é€£æºã•ã›ã‚‹

# ğŸš€ æœ€çµ‚çµ±åˆï¼š3ã‚µãƒ¼ãƒ“ã‚¹ã‚’é€£æºã•ã›ã‚‹

ã“ã‚Œã¾ã§ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã€è‡ªå‹•é§è»Šã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹æˆã™ã‚‹3ã¤ã®ç‹¬ç«‹ã—ãŸå°‚é–€å®¶ãƒãƒ¼ãƒ ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã‚’ã€ãã‚Œãã‚Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«åŸºã¥ã„ã¦æ§‹ç¯‰ã—ã¾ã—ãŸã€‚

1. **ğŸ‘€ èªè­˜ã‚µãƒ¼ãƒ“ã‚¹**: ä¸–ç•Œãƒ¢ãƒ‡ãƒ«ï¼ˆ`world_model.json`ï¼‰ã‚’\*\*å…¬é–‹ï¼ˆPublishï¼‰\*\*ã™ã‚‹
2. **ğŸ§  çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹**: `world_model.json` ã‚’\*\*è³¼èª­ï¼ˆSubscribeï¼‰**ã—ã€é§è»Šè¨ˆç”»ï¼ˆ`plan.json`ï¼‰ã‚’**å…¬é–‹ï¼ˆPublishï¼‰\*\*ã™ã‚‹
3. **ğŸ¦¾ è»Šä¸¡åˆ¶å¾¡ã‚µãƒ¼ãƒ“ã‚¹**: `plan.json` ã‚’\*\*è³¼èª­ï¼ˆSubscribeï¼‰\*\*ã—ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’åˆ¶å¾¡ã™ã‚‹

ã“ã®æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€ã“ã‚Œã‚‰3ã¤ã®ç‹¬ç«‹ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’**åŒæ™‚ã«èµ·å‹•**ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`world_model.json`, `plan.json`ï¼‰ã‚’ä»‹ã—ã¦éåŒæœŸçš„ã«é€£æºã•ã›ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã¨ã—ã¦ã€Œè‡ªå‹•é§è»Šã€ã‚’å®Ÿè¡Œã•ã›ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚

---

## ğŸ—ºï¸ çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å…¨ä½“åƒï¼ˆå¾©ç¿’ï¼‰

ç§ãŸã¡ãŒæ§‹ç¯‰ã—ãŸã‚·ã‚¹ãƒ†ãƒ ã¯ã€SOAï¼ˆã‚µãƒ¼ãƒ“ã‚¹æŒ‡å‘ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å„ã‚µãƒ¼ãƒ“ã‚¹ã¯ç‹¬ç«‹ã—ã¦ãŠã‚Šã€æ±ºã‚ã‚‰ã‚ŒãŸã€Œå¥‘ç´„ã€ã§ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJSONï¼‰ã‚’ä»‹ã—ã¦ã®ã¿æƒ…å ±ã‚’äº¤æ›ã—ã¾ã™ã€‚

| ã‚µãƒ¼ãƒ“ã‚¹ | å…¥åŠ›ï¼ˆè³¼èª­ / Subscribeï¼‰ | å‡ºåŠ›ï¼ˆå…¬é–‹ / Publishï¼‰ |
| --- | --- | --- |
| **ğŸ‘€ èªè­˜ã‚µãƒ¼ãƒ“ã‚¹** | ã‚»ãƒ³ã‚µãƒ¼ï¼ˆHWï¼‰ | `world_model.json` |
| **ğŸ§  çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹** | `world_model.json` | `plan.json` |
| **ğŸ¦¾ è»Šä¸¡åˆ¶å¾¡ã‚µãƒ¼ãƒ“ã‚¹** | `plan.json` | åˆ¶å¾¡ä¿¡å·ï¼ˆHWï¼‰ |

---

## ğŸ¯ èª²é¡Œï¼šã©ã†ã‚„ã£ã¦ã€ŒåŒæ™‚ã«ã€å‹•ã‹ã™ã‹ï¼Ÿ

ã“ã‚Œã¾ã§ã®3ãƒšãƒ¼ã‚¸ã§ã¯ã€å„ã‚µãƒ¼ãƒ“ã‚¹ã® `main.py` ã‚’å€‹åˆ¥ã«å®Ÿè¡Œã—ã¦ã€Œ1å›ã ã‘ã€å‹•ä½œã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ã—ã‹ã—ã€å®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€Œå‹•ãç¶šã‘ã‚‹ã€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€å‘¨å›²ã®çŠ¶æ³ã‚’**ç¶™ç¶šçš„ã«**ç›£è¦–ã—ã€`world_model.json` ã‚’æ›´æ–°ã—ç¶šã‘ã‚‹ã€‚
- çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€`world_model.json` ã®æ›´æ–°ã‚’**ç¶™ç¶šçš„ã«**ãƒã‚§ãƒƒã‚¯ã—ã€`plan.json` ã‚’æ›´æ–°ã—ç¶šã‘ã‚‹ã€‚
- è»Šä¸¡åˆ¶å¾¡ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€`plan.json` ã®æ›´æ–°ã‚’**ç¶™ç¶šçš„ã«**ãƒã‚§ãƒƒã‚¯ã—ã€è»Šã‚’åˆ¶å¾¡ã—ç¶šã‘ã‚‹ã€‚

ã“ã‚Œã¯ã€æœ¬æ ¼çš„ãªSOAï¼ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã§ã¯ã€å„ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ã—ãŸãƒ—ãƒ­ã‚»ã‚¹ï¼ˆä¾‹ï¼šDockerã‚³ãƒ³ãƒ†ãƒŠï¼‰ã¨ã—ã¦ã€Œå¸¸é§ã€ã—ã€é€šä¿¡ï¼ˆMQTTã‚„gRPCï¼‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚„ã‚Šå–ã‚Šã™ã‚‹ã“ã¨ã§å®Ÿç¾ã•ã‚Œã¾ã™ã€‚

ä»Šå›ã¯ã€Pythonã® `asyncio`ï¼ˆéåŒæœŸI/Oï¼‰ã‚’ä½¿ã„ã€ã“ã‚Œã‚‰3ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€Œå¸¸é§ã€ã•ã›ã€**1ã¤ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼ˆãƒ—ãƒ­ã‚»ã‚¹ï¼‰ã§ä¸¦è¡Œã«å®Ÿè¡Œã™ã‚‹**æ–¹æ³•ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã€‚

---

## ğŸ§© ã‚¹ãƒ†ãƒƒãƒ—1ï¼šå„ã‚µãƒ¼ãƒ“ã‚¹ã® `main.py` ã‚’ã€Œå¸¸é§åŒ–ã€ã™ã‚‹

ã¾ãšã€å„ã‚µãƒ¼ãƒ“ã‚¹ã® `main.py` ãŒ1å›å®Ÿè¡Œã—ãŸã‚‰çµ‚ã‚ã£ã¦ã—ã¾ã†ã®ã‚’é˜²ããŸã‚ã€`UseCase` ã®å®Ÿè¡Œéƒ¨åˆ†ã‚’ `while True:` ã®ç„¡é™ãƒ«ãƒ¼ãƒ—ã§å›²ã¿ã€ã€Œå¸¸é§ã‚µãƒ¼ãƒ“ã‚¹ã€ã®ã‚ˆã†ã«æŒ¯ã‚‹èˆã†ã‚ˆã†å¤‰æ›´ã—ã¾ã™ã€‚

ï¼ˆâ€»å¤‰æ›´ã™ã‚‹ã®ã¯ `main.py` ã® `main()` é–¢æ•°ã®ä¸­ã ã‘ã§ã™ã€‚UseCaseã‚„Adaptersã¯ä¸€åˆ‡å¤‰æ›´ã—ã¾ã›ã‚“ã€‚ï¼‰

### 1. èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ (`perception_service/main.py` ã®ä¿®æ­£)

`UseCase` ã®å®Ÿè¡Œï¼ˆ`await use_case.handle()`ï¼‰ã‚’ `while True:` ã§å›²ã¿ã€1ç§’ã”ã¨ï¼ˆ`asyncio.sleep(1)`ï¼‰ã«çŠ¶æ³ã‚’æ›´æ–°ã—ç¶šã‘ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```python
# perception_service/main.py (ä¿®æ­£å¾Œ)
import asyncio
from application.use_cases import UpdateWorldModelUseCase
from adapters.stub_sensor import StubSensorAdapter
from adapters.repositories import InMemoryWorldModelRepository
from adapters.file_publisher import FileWorldModelPublisher

# ( ... ä¾å­˜é–¢ä¿‚ã®æ³¨å…¥(DI)éƒ¨åˆ†ã¯çœç•¥ ... )

async def main():
    """
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã€ä¾å­˜é–¢ä¿‚ã‚’æ³¨å…¥ (DI) ã—ã€
    ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œã™ã‚‹ã€‚
    """
    print("--- [Perception Service] Starting Up ---")

    # 1. Adapterså±¤ï¼ˆå…·ä½“çš„ãªå®Ÿè£…ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    sensor_adapter = StubSensorAdapter()
    world_model_publisher = FileWorldModelPublisher(filepath="world_model.json")
    world_model_repository = InMemoryWorldModelRepository()

    # 2. UseCaseå±¤ã«ã€å…·ä½“çš„ãªå®Ÿè£…ã‚’ã€Œä¾å­˜æ€§ã®æ³¨å…¥ (DI)ã€
    use_case = UpdateWorldModelUseCase(
        sensor_interface=sensor_adapter,
        world_model_repo=world_model_repository,
        planning_adapter=world_model_publisher
    )

    # 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆUseCaseï¼‰ã®ã€ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œã€‘
    print("\\n--- [Perception Service] Running in loop (Press Ctrl+C to stop) ---")
    while True:
        try:
            # UseCaseã®handleãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
            await use_case.handle()

            # 1ç§’å¾…æ©Ÿï¼ˆ1ç§’ã”ã¨ã«ä¸–ç•Œã‚’èªè­˜ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
            await asyncio.sleep(1)

        except Exception as e:
            print(f"--- [Perception Service] Error in loop: {e} ---")
            await asyncio.sleep(5) # ã‚¨ãƒ©ãƒ¼æ™‚ã¯5ç§’å¾…æ©Ÿ

# ( if __name__ == "__main__": ... ã®éƒ¨åˆ†ã¯å¤‰æ›´ãªã—)

```

### 2. çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ (`planning_service/main.py` ã®ä¿®æ­£)

åŒæ§˜ã«ã€çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã‚‚1ç§’ã”ã¨ã« `world_model.json` ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ`handle()` ã‚’å®Ÿè¡Œï¼‰ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```python
# planning_service/main.py (ä¿®æ­£å¾Œ)
import asyncio
from application.use_cases import CalculateParkingPlanUseCase
from adapters.file_subscriber import FileWorldModelSubscriber
from adapters.repositories import InMemoryPlanRepository
from adapters.file_publisher import FilePlanPublisher

async def main():
    """
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã€ä¾å­˜é–¢ä¿‚ã‚’æ³¨å…¥ (DI) ã—ã€
    ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œã™ã‚‹ã€‚
    """
    print("--- [Planning Service] Starting Up ---")

    # 1. Adapterså±¤ï¼ˆå…·ä½“çš„ãªå®Ÿè£…ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    world_model_subscriber = FileWorldModelSubscriber(filepath="world_model.json")
    plan_publisher = FilePlanPublisher(filepath="plan.json")
    plan_repository = InMemoryPlanRepository()

    # 2. UseCaseå±¤ã«ã€å…·ä½“çš„ãªå®Ÿè£…ã‚’ã€Œä¾å­˜æ€§ã®æ³¨å…¥ (DI)ã€
    use_case = CalculateParkingPlanUseCase(
        world_model_sub=world_model_subscriber,
        plan_repo=plan_repository,
        plan_pub=plan_publisher
    )

    # 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆUseCaseï¼‰ã®ã€ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œã€‘
    print("\\n--- [Planning Service] Running in loop (Press Ctrl+C to stop) ---")
    while True:
        try:
            # UseCaseã®handleãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
            await use_case.handle()

            # 1ç§’å¾…æ©Ÿï¼ˆ1ç§’ã”ã¨ã«è¨ˆç”»ã‚’è¦‹ç›´ã™ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
            await asyncio.sleep(1)

        except Exception as e:
            print(f"--- [Planning Service] Error in loop: {e} ---")
            await asyncio.sleep(5)

# ( if __name__ == "__main__": ... ã®éƒ¨åˆ†ã¯å¤‰æ›´ãªã—)

```

### 3. è»Šä¸¡åˆ¶å¾¡ã‚µãƒ¼ãƒ“ã‚¹ (`control_service/main.py` ã®ä¿®æ­£)

è»Šä¸¡åˆ¶å¾¡ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€`handle()` ã®å†…éƒ¨ã§æ—¢ã«è¨ˆç”»ï¼ˆ`plan.json`ï¼‰ã®å…¨ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«ãªã£ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€ã€Œæ–°ã—ã„è¨ˆç”»ãŒæ¥ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã€æ¥ã¦ã„ã‚Œã°å®Ÿè¡Œã™ã‚‹ã€ã¨ã„ã†å‹•ä½œã‚’1ç§’ã”ã¨ã«ç¹°ã‚Šè¿”ã™ã‚ˆã†å¤‰æ›´ã—ã¾ã™ã€‚

```python
# control_service/main.py (ä¿®æ­£å¾Œ)
import asyncio
from application.use_cases import ExecutePlanUseCase
from adapters.file_subscriber import FilePlanSubscriber
from adapters.repositories import InMemoryVehicleStateRepository
from adapters.stub_actuator import StubActuatorAdapter

async def main():
    """
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã€ä¾å­˜é–¢ä¿‚ã‚’æ³¨å…¥ (DI) ã—ã€
    ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œã™ã‚‹ã€‚
    """
    print("--- [Control Service] Starting Up ---")

    # 1. Adapterså±¤ï¼ˆå…·ä½“çš„ãªå®Ÿè£…ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    plan_subscriber = FilePlanSubscriber(filepath="plan.json")
    state_repository = InMemoryVehicleStateRepository()
    actuator_adapter = StubActuatorAdapter()

    # 2. UseCaseå±¤ã«ã€å…·ä½“çš„ãªå®Ÿè£…ã‚’ã€Œä¾å­˜æ€§ã®æ³¨å…¥ (DI)ã€
    use_case = ExecutePlanUseCase(
        plan_sub=plan_subscriber,
        state_repo=state_repository,
        actuator=actuator_adapter
    )

    # 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆUseCaseï¼‰ã®ã€ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œã€‘
    print("\\n--- [Control Service] Running in loop (Press Ctrl+C to stop) ---")
    while True:
        try:
            # UseCaseã®handleãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
            # (handleå†…ã§ plan.json ãŒãªã‘ã‚Œã°å³åº§ã«ãƒªã‚¿ãƒ¼ãƒ³ã•ã‚Œã‚‹)
            await use_case.handle()

            # 1ç§’å¾…æ©Ÿï¼ˆ1ç§’ã”ã¨ã«æ–°ã—ã„è¨ˆç”»ãŒãªã„ã‹ç¢ºèªã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
            await asyncio.sleep(1)

        except Exception as e:
            print(f"--- [Control Service] Error in loop: {e} ---")
            await asyncio.sleep(5)

# ( if __name__ == "__main__": ... ã®éƒ¨åˆ†ã¯å¤‰æ›´ãªã—)

```

---

## ğŸš€ ã‚¹ãƒ†ãƒƒãƒ—2ï¼šçµ±åˆèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

ã“ã‚Œã§ã€3ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒãã‚Œãã‚Œã€Œå¸¸é§ã€ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
æœ€å¾Œã«ã€ã“ã‚Œã‚‰3ã¤ã® `main()` é–¢æ•°ã‚’**ä¸¦è¡Œ**ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã€çµ±åˆèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆï¼ˆ`perception_service/` ãªã©ã¨åŒã˜éšå±¤ï¼‰ã«ä½œæˆã—ã¾ã™ã€‚

```python
# run_all_services.py (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«æ–°è¦ä½œæˆ)
import asyncio
import sys
import os

# --- å„ã‚µãƒ¼ãƒ“ã‚¹ã®mainé–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ---
# (PythonãŒå„ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã€ãƒ‘ã‚¹ã‚’è¿½åŠ )
sys.path.append(os.path.abspath('./perception_service'))
sys.path.append(os.path.abspath('./planning_service'))
sys.path.append(os.path.abspath('./control_service'))

from perception_service.main import main as perception_main
from planning_service.main import main as planning_main
from control_service.main import main as control_main

# -----------------------------------------------------------------------------
# çµ±åˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: - (ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®èµ·å‹•å½¹)
# - åŒå¿ƒå††å›³ã®ä½ç½®: æœ€ã‚‚å¤–å´ (OS / ç’°å¢ƒ)
# -----------------------------------------------------------------------------
async def run_system():
    """
    3ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆã®mainé–¢æ•°ï¼‰ã‚’ä¸¦è¡Œå®Ÿè¡Œã™ã‚‹
    """
    print("=========================================")
    print("=== AUTONOMOUS PARKING SYSTEM STARTUP ===")
    print("=========================================\\n")

    try:
        # asyncio.gather ã‚’ä½¿ã†ã¨ã€è¤‡æ•°ã®éåŒæœŸé–¢æ•°ã‚’
        # åŒæ™‚ã«ï¼ˆä¸¦è¡Œã—ã¦ï¼‰å®Ÿè¡Œã§ãã‚‹ã€‚
        await asyncio.gather(
            perception_main(),
            planning_main(),
            control_main()
        )
    except KeyboardInterrupt:
        print("\\n\\n========================================")
        print("=== AUTONOMOUS PARKING SYSTEM SHUTDOWN ===")
        print("========================================")

if __name__ == "__main__":
    # çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè¡Œ
    asyncio.run(run_system())

```

---

## ğŸ’¡ å®Ÿè¡Œçµæœï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

ã“ã® `run_all_services.py` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ã¯3ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ãŒ\*\*éåŒæœŸï¼ˆãƒãƒ©ãƒãƒ©ï¼‰\*\*ã«è¡¨ç¤ºã•ã‚Œå§‹ã‚ã¾ã™ã€‚

```bash
$ python run_all_services.py
=========================================
=== AUTONOMOUS PARKING SYSTEM STARTUP ===
=========================================

--- [Perception Service] Starting Up ---
[Adapter] InMemoryRepo: Initialized.
--- [Perception Service] Running in loop (Press Ctrl+C to stop) ---

--- [Planning Service] Starting Up ---
[Adapter] InMemoryRepo: Initialized.
--- [Planning Service] Running in loop (Press Ctrl+C to stop) ---

--- [Control Service] Starting Up ---
[Adapter] InMemoryRepo: Initialized.
--- [Control Service] Running in loop (Press Ctrl+C to stop) ---

# --- 1ç§’å¾Œ ---
[Adapter] StubSensor: Generating dummy image data...
[Adapter] StubSensor: Generating dummy sonar data...
[Adapter] InMemoryRepo: Getting WorldModel from memory.
[Adapter] InMemoryRepo: Saving WorldModel to memory.
[Adapter] FilePublisher: World Model saved to world_model.json   # <- èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ãŒæ›¸ãè¾¼ã¿
[UseCase] World Model not found. Skipping plan calculation.      # <- çµŒè·¯è¨ˆç®—ã¯ã¾ã  world_model.json ãŒç„¡ã‹ã£ãŸ
[Adapter] FileSubscriber: Parking Plan file not found.           # <- åˆ¶å¾¡ã¯ã¾ã  plan.json ãŒç„¡ã„
[UseCase] Parking Plan not found. Skipping execution.

# --- 2ç§’å¾Œ ---
[Adapter] StubSensor: Generating dummy image data...
[Adapter] StubSensor: Generating dummy sonar data...
[Adapter] InMemoryRepo: Getting WorldModel from memory.
[Adapter] InMemoryRepo: Saving WorldModel to memory.
[Adapter] FilePublisher: World Model saved to world_model.json
[Adapter] FileSubscriber: Reading World Model from world_model.json... # <- çµŒè·¯è¨ˆç®—ãŒ world_model.json ã‚’ç™ºè¦‹ï¼
[UseCase] Calculating parking plan...
[Adapter] InMemoryRepo: Saving ParkingPlan to memory.
[Adapter] FilePublisher: Parking Plan saved to plan.json         # <- çµŒè·¯è¨ˆç®—ãŒ plan.json ã‚’æ›¸ãè¾¼ã¿
[Adapter] FileSubscriber: Parking Plan file not found.           # <- åˆ¶å¾¡ã¯ã¾ã  plan.json ãŒç„¡ã„
[UseCase] Parking Plan not found. Skipping execution.

# --- 3ç§’å¾Œ ---
[Adapter] StubSensor: Generating dummy image data...
...
[Adapter] FilePublisher: World Model saved to world_model.json
[Adapter] FileSubscriber: Reading World Model from world_model.json...
[UseCase] Calculating parking plan...
[Adapter] InMemoryRepo: Saving ParkingPlan to memory.
[Adapter] FilePublisher: Parking Plan saved to plan.json
[Adapter] FileSubscriber: Reading Parking Plan from plan.json... # <- åˆ¶å¾¡ãŒ plan.json ã‚’ç™ºè¦‹ï¼
[UseCase] Executing plan with 3 commands...
[Adapter] InMemoryRepo: Getting VehicleState from memory.
[UseCase] Executing command: steer=-30.0 for 2.0s
[Adapter] StubActuator: STEER set to -30.0 degrees              # <- åˆ¶å¾¡ãŒãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ï¼ˆã‚¹ã‚¿ãƒ–ï¼‰ã‚’å®Ÿè¡Œï¼
... (2ç§’å¾…æ©Ÿ) ...
[Adapter] InMemoryRepo: Getting VehicleState from memory.
[UseCase] Executing command: throttle=-0.5 for 5.0s
[Adapter] StubActuator: THROTTLE set to -0.5 m/s^2             # <- åˆ¶å¾¡ãŒãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ï¼ˆã‚¹ã‚¿ãƒ–ï¼‰ã‚’å®Ÿè¡Œï¼
...

```

ï¼ˆâ€»å®Ÿéš›ã«ã¯ `asyncio.sleep` ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã‚Šã€ãƒ­ã‚°ã®é †ç•ªã¯å®Ÿè¡Œã”ã¨ã«å¤šå°‘å‰å¾Œã—ã¾ã™ï¼‰

---

## ğŸ Pythonã¨Cè¨€èªã®æ¯”è¼ƒï¼ˆåˆå¿ƒè€…ã®æ–¹ã¸ï¼‰

Python (éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°): `asyncio.gather` ã‚’ä½¿ã†ã“ã¨ã§ã€OSã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ï¼ˆåŸºæœ¬çš„ã«ã¯ï¼‰1ã¤ã—ã‹ä½¿ã‚ãªãã¦ã‚‚ã€è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ãŒI/Oå¾…ã¡ï¼ˆ`await asyncio.sleep()`ãªã©ï¼‰ã®é–“ã«å‡¦ç†ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã§ã€ä¸¦è¡Œå‹•ä½œã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

Cè¨€èª (ãƒãƒ«ãƒãƒ—ãƒ­ã‚»ã‚¹/ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰): åŒæ§˜ã®ã“ã¨ã‚’Cè¨€èªã§å®Ÿç¾ã™ã‚‹ã«ã¯ã€`fork()`ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’3ã¤ã«åˆ†å²ã•ã›ãŸã‚Šã€`pthread_create()`ã§3ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ãŸã‚Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã¯OSã®æ©Ÿèƒ½ã‚’ç›´æ¥åˆ©ç”¨ã™ã‚‹ãŸã‚å¼·åŠ›ã§ã™ãŒã€ãƒ—ãƒ­ã‚»ã‚¹é–“ãƒ»ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã®å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿å…±æœ‰ã‚„åŒæœŸï¼ˆMutex, Semaphoreï¼‰ã¨ã„ã£ãŸã€ã‚ˆã‚Šè¤‡é›‘ãªæ’ä»–åˆ¶å¾¡ã®çŸ¥è­˜ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ›¡ï¸ ã“ã®ç¬¬å››å·¡ã®ã‚´ãƒ¼ãƒ«ï¼ˆSOAã®å‹˜æ‰€ï¼‰

ã“ã®ç¬¬å››å·¡ã€Œè‡ªå‹•é§è»Šã‚·ã‚¹ãƒ†ãƒ ã€ã§ã€ç§ãŸã¡ã¯æœ€ã‚‚é‡è¦ãªã“ã¨ã‚’å­¦ã³ã¾ã—ãŸã€‚

1. **ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®é–¢å¿ƒã®åˆ†é›¢**:
ã€Œèªè­˜ã€ã€Œè¨ˆç”»ã€ã€Œåˆ¶å¾¡ã€ã¨ã„ã†ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’æ§‹æˆã™ã‚‹å¤§ããªé–¢å¿ƒäº‹ã‚’ã€ç‹¬ç«‹ã—ãŸã€Œã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã—ã¦åˆ†é›¢ã—ã¾ã—ãŸã€‚
2. **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆå¥‘ç´„ï¼‰ã®é‡è¦æ€§**:
ã‚µãƒ¼ãƒ“ã‚¹é–“ãŒå”¯ä¸€ä¾å­˜ã™ã‚‹ã‚‚ã®ã¯ã€`world_model.json` ã‚„ `plan.json` ã®ã€Œä¸­èº«ã®æ§‹é€ ï¼ˆã‚¹ã‚­ãƒ¼ãƒï¼‰ã€ã ã‘ã§ã‚ã‚‹ã€ã¨ã„ã†ã“ã¨ã‚’å­¦ã³ã¾ã—ãŸã€‚ã“ã®ã€Œå¥‘ç´„ã€ã“ããŒã€SOAï¼ˆAPIï¼‰è¨­è¨ˆã®æ ¸å¿ƒã§ã™ã€‚
3. **ã‚¢ãƒ€ãƒ—ã‚¿ã«ã‚ˆã‚‹æŠ€è¡“è©³ç´°ã®éš”é›¢**:
ã‚µãƒ¼ãƒ“ã‚¹é–“ã®é€£æºæ–¹æ³•ãŒã€ä»Šå›ã®ã‚ˆã†ãªã€Œãƒ•ã‚¡ã‚¤ãƒ«I/Oã€ã§ã‚ã£ã¦ã‚‚ã€å°†æ¥ã€ŒMQTTã€ã‚„ã€ŒgRPCã€ã¨ã„ã£ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã«å¤‰ã‚ã£ã¦ã‚‚ã€`FilePublisher` ã‚’ `MQTTPublisher` ã«å·®ã—æ›¿ãˆã‚‹ï¼ˆï¼ã‚¢ãƒ€ãƒ—ã‚¿ã‚’äº¤æ›ã™ã‚‹ï¼‰ã ã‘ã§ã€UseCaseã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ä¸€åˆ‡å¤‰æ›´ã—ãªãã¦è‰¯ã„ã€ã¨ã„ã†ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æœ€å¤§ã®åˆ©ç‚¹ã‚’å†ç¢ºèªã—ã¾ã—ãŸã€‚

ã“ã®ç¬¬å››å·¡ã¯ã€ã“ã‚Œã¾ã§ã®ä¸‰å·¡ã§å­¦ã‚“ã ã€Œéƒ¨å“ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰ã€ã®ä½œã‚Šæ–¹ã‚’å¿œç”¨ã—ã€ã€Œã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ï¼ˆSOAï¼‰ã€ã®è¨­è¨ˆå›³ã‚’æããŸã‚ã®ã€éå¸¸ã«é‡è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã§ã—ãŸã€‚

---

ï¼ˆã“ã‚Œã§ç¬¬å››å·¡ã¯å®Œäº†ã§ã™ã€‚æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¾ã‚Œã¾ã™ã‹ï¼Ÿï¼‰