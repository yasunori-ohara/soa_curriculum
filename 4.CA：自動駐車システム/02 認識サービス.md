# 02 èªè­˜ã‚µãƒ¼ãƒ“ã‚¹

# ğŸ‘€ èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ (Perception Service)

è‡ªå‹•é§è»Šã‚·ã‚¹ãƒ†ãƒ ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ‹…å½“ã™ã‚‹ã€Œèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã€ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ã€Œç›®ã€ã¨ã—ã¦ã€å‘¨å›²ã®çŠ¶æ³ã‚’æŠŠæ¡ã—ã€ãã‚Œã‚’å¾Œç¶šã®ã‚µãƒ¼ãƒ“ã‚¹ãŒç†è§£ã§ãã‚‹å½¢ã«ç¿»è¨³ã™ã‚‹è²¬ä»»ã‚’æŒã¡ã¾ã™ã€‚

---

## ğŸ—ºï¸ ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã®å…¨ä½“åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¨ä¾å­˜é–¢ä¿‚ï¼‰

ã“ã®ã€Œèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚‚ã€ã“ã‚Œã¾ã§ã®ä¸‰å·¡ã§å­¦ã‚“ã ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦è¨­è¨ˆã•ã‚Œã¾ã™ã€‚
UseCaseï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ã‚’ä¸­å¿ƒï¼ˆå†…å´ï¼‰ã«ç½®ãã€å…·ä½“çš„ãªå®Ÿè£…ï¼ˆã‚»ãƒ³ã‚µãƒ¼ã€ãƒ•ã‚¡ã‚¤ãƒ«å…¥å‡ºåŠ›ãªã©ï¼‰ã‚’**Adapterså±¤**ï¼ˆå¤–å´ï¼‰ã«é…ç½®ã—ã¾ã™ã€‚

![ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](../ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.png)

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

ã“ã®ä¾å­˜é–¢ä¿‚ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ã‚©ãƒ«ãƒ€åˆ†ã‘ã—ã¾ã™ã€‚ã”æŒ‡æ‘˜ã«åŸºã¥ãã€å…·ä½“çš„ãªå®Ÿè£…ã¯ã™ã¹ã¦ `adapters/` ãƒ•ã‚©ãƒ«ãƒ€ã«çµ±ä¸€ã—ã¾ã™ã€‚

```
perception_service/
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ entities.py         # [Entity] WorldModel ãªã©ã€æ ¸ã¨ãªã‚‹ãƒ«ãƒ¼ãƒ«
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ boundaries.py       # [å¢ƒç•Œ] SensorInterface ãªã©ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
â”‚   â””â”€â”€ use_cases.py        # [UseCase] UpdateWorldModelUseCase ãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ adapters/
â”‚   â”œâ”€â”€ file_publisher.py   # [Adapterså±¤] FileWorldModelPublisher (å‡ºåŠ›å®Ÿè£…)
â”‚   â”œâ”€â”€ repositories.py     # [Adapterså±¤] InMemoryWorldModelRepository (çŠ¶æ…‹å®Ÿè£…)
â”‚   â””â”€â”€ stub_sensor.py      # [Adapterså±¤] StubSensorAdapter (å…¥åŠ›å®Ÿè£…)
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ ...                 # (ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰)
â””â”€â”€ main.py                 # [èµ·å‹•] DIã‚³ãƒ³ãƒ†ãƒŠã€å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«

```

---

## ğŸ¯ è²¬å‹™ï¼šä¸–ç•Œã‚’ç†è§£ã—ã€ãƒ¢ãƒ‡ãƒ«åŒ–ã™ã‚‹

èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®å”¯ä¸€ã®è²¬å‹™ã¯ã€ã€Œã‚»ãƒ³ã‚µãƒ¼ï¼ˆç›®ï¼‰ã‹ã‚‰å…¥ã£ã¦ãã‚‹ç”Ÿã®æƒ…å ±ã‚’è§£é‡ˆã—ã€ã‚·ã‚¹ãƒ†ãƒ ï¼ˆé ­è„³ï¼‰ãŒç†è§£ã§ãã‚‹æŠ½è±¡åŒ–ã•ã‚ŒãŸ\_ä¸–ç•Œãƒ¢ãƒ‡ãƒ«\_ã‚’ä½œæˆã™ã‚‹ã“ã¨ã€ã§ã™ã€‚

```
[ ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ (å…¥åŠ›) ] --------> [ èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ ] --------> [ ä¸–ç•Œãƒ¢ãƒ‡ãƒ« (ãƒ‡ãƒ¼ã‚¿) ]
(ã‚«ãƒ¡ãƒ©ã€ã‚½ãƒŠãƒ¼)                  (Perception)              (é§è»Šã‚¹ãƒšãƒ¼ã‚¹ä½ç½®ãªã©)
                                - ã‚»ãƒ³ã‚µãƒ¼è§£é‡ˆ
                                - ç’°å¢ƒãƒãƒƒãƒ—ä½œæˆ

```

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ã‚«ãƒ¡ãƒ©æ˜ åƒã‹ã‚‰ç™½ç·šã‚’èªè­˜ã—ãŸã‚Šã€ã‚½ãƒŠãƒ¼ã®è·é›¢ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰éšœå®³ç‰©ã‚’æ¤œå‡ºã—ãŸã‚Šã¨ã„ã£ãŸã€é«˜åº¦ãªã‚»ãƒ³ã‚µãƒ¼ãƒ•ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ³ã‚„èªè­˜ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆä»Šå›ã¯è©³ç´°ã‚’çœç•¥ï¼‰ã‚’å®Ÿè¡Œã—ã€ãã®çµæœã‚’æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚

---

## ğŸ§© ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ç‹¬ç«‹ã—ãŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚ç¬¬å››å·¡ã§ã¯ã€Entityã¨UseCaseã®å½¹å‰²ã‚’å†ç¢ºèªã—ã¤ã¤ã€å¢ƒç•Œã®è¨­è¨ˆã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚

### ä¸»è¦ãªEntities

ãƒ“ã‚¸ãƒã‚¹ã®æ ¸ã¨ãªã‚‹æ¦‚å¿µã¨ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚

- **DetectedObject**: æ¤œå‡ºã•ã‚ŒãŸç‰©ä½“ï¼ˆä»–ã®è»Šã€æ­©è¡Œè€…ã€å£ãªã©ï¼‰ã®ä½ç½®ã€å½¢çŠ¶ã€é€Ÿåº¦ãªã©ã®å±æ€§ã‚’æŒã¡ã¾ã™ã€‚
- **ParkingSpace**: æ¤œå‡ºã•ã‚ŒãŸé§è»Šã‚¹ãƒšãƒ¼ã‚¹ã®ä½ç½®ã€ã‚µã‚¤ã‚ºã€å‘ããªã©ã®å±æ€§ã‚’æŒã¡ã¾ã™ã€‚`is_available()`ã®ã‚ˆã†ãªçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ã“ã¨ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
- **WorldModel**: èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®ä¸­å¿ƒã¨ãªã‚‹Entityã€‚`DetectedObject`ã‚„`ParkingSpace`ã®ãƒªã‚¹ãƒˆã‚’ä¿æŒã—ã€ã€Œç¾åœ¨ã®ç’°å¢ƒãƒãƒƒãƒ—ã€å…¨ä½“ã‚’è¡¨ç¾ã—ã¾ã™ã€‚`update_objects()`ã‚„`find_nearest_space()`ã®ã‚ˆã†ãªã€ãƒãƒƒãƒ—ã‚’æ“ä½œãƒ»å•ã„åˆã‚ã›ã‚‹ãŸã‚ã®ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’æŒã¡ã¾ã™ã€‚

<!-- end list -->

```python
# domain/entities.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…)
from dataclasses import dataclass, field
from datetime import datetime
from typing import List

# (DetectedObject, ParkingSpace, RawImageData, SonarReading ãªã©ã®å®šç¾© ... çœç•¥)

# -----------------------------------------------------------------------------
# WorldModel Entity
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: Entities
# - åŒå¿ƒå††å›³ã®ä½ç½®: Entities (æœ€ã‚‚å†…å´)
# -----------------------------------------------------------------------------
@dataclass
class WorldModel:
    timestamp: datetime
    objects: List[DetectedObject] = field(default_factory=list)
    parking_spaces: List[ParkingSpace] = field(default_factory=list)

    def update_objects(self, new_objects: List[DetectedObject]):
        """[ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«] æ¤œå‡ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹"""
        # (ä¾‹: IDãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ›´æ–°ã€æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ ã€æ¶ˆãˆãŸã‚‚ã®ã‚’å‰Šé™¤ãªã©)
        self.objects = new_objects
        self.timestamp = datetime.now()

    # ... ä»–ã®ãƒãƒƒãƒ—æ“ä½œãƒ¡ã‚½ãƒƒãƒ‰ ...

```

### ä¸»è¦ãªUseCase

ç‰¹å®šã®ã‚·ãƒŠãƒªã‚ªã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ“ã‚¸ãƒã‚¹ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚

- **UpdateWorldModelUseCase**: ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰ã®æ–°ã—ã„æƒ…å ±ï¼ˆ`RawImageData`, `SonarReading`ãªã©ï¼‰ã‚’å—ã‘å–ã‚Šã€èªè­˜ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè¡Œã—ã€ãã®çµæœã‚’ä½¿ã£ã¦`WorldModel` Entityã‚’æ›´æ–°ã—ã€æœ€å¾Œã«æ›´æ–°ã•ã‚ŒãŸ`WorldModel`ã‚’å¤–éƒ¨ï¼ˆæ¬¡ã®ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã«å…¬é–‹ã™ã‚‹ã€ã¨ã„ã†ä¸€é€£ã®æµã‚Œã‚’æ‹…å½“ã—ã¾ã™ã€‚

<!-- end list -->

```python
# application/use_cases/update_world_model.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…)
from application.boundaries import (
    SensorInterface,
    WorldModelRepositoryInterface,
    PlanningServiceAdapterInterface,
    UpdateWorldModelInputBoundary # InputBoundaryã‚‚boundaries.pyã§å®šç¾©æƒ³å®š
)

# -----------------------------------------------------------------------------
# Use Case
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: UseCase
# - åŒå¿ƒå††å›³ã®ä½ç½®: Use Cases
# -----------------------------------------------------------------------------
class UpdateWorldModelUseCase(UpdateWorldModelInputBoundary):
    def __init__(self,
                 sensor_interface: SensorInterface,
                 world_model_repo: WorldModelRepositoryInterface, # WorldModelæ°¸ç¶šåŒ–ç”¨
                 planning_adapter: PlanningServiceAdapterInterface):
        # DIã«ã‚ˆã‚Šã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹(æŠ½è±¡)ã®ã¿ã‚’å—ã‘å–ã‚‹
        self._sensor_interface = sensor_interface
        self._world_model_repo = world_model_repo
        self._planning_adapter = planning_adapter

    async def handle(self):
        # 1. ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (éåŒæœŸI/O)
        #    (å…·ä½“çš„ãªã‚»ãƒ³ã‚µãƒ¼ã®å®Ÿè£…ã¯çŸ¥ã‚‰ãªã„)
        image_data = await self._sensor_interface.get_camera_image()
        sonar_data = await self._sensor_interface.get_sonar_readings()

        # 2. èªè­˜ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè¡Œ (ä»Šå›ã¯è©³ç´°çœç•¥)
        #    (ç”Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰DetectedObjectã‚„ParkingSpaceã‚’ç”Ÿæˆã™ã‚‹å‡¦ç†)
        new_objects = self._run_object_detection(image_data, sonar_data)
        new_spaces = self._run_space_detection(image_data) # (ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä»®)

        # 3. WorldModel Entityã‚’å–å¾—ã—ã€æ›´æ–°
        #    (å…·ä½“çš„ãªDBã‚„ãƒ¡ãƒ¢ãƒªã®å®Ÿè£…ã¯çŸ¥ã‚‰ãªã„)
        current_world_model = self._world_model_repo.get()
        current_world_model.update_objects(new_objects)
        # current_world_model.update_spaces(new_spaces) # (ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä»®)

        # 4. æ›´æ–°ã•ã‚ŒãŸWorldModelã‚’æ°¸ç¶šåŒ–ï¼ˆå†…éƒ¨çŠ¶æ…‹ã®ä¿å­˜ï¼‰
        self._world_model_repo.save(current_world_model)

        # 5. çµæœã‚’æ¬¡ã®ã‚µãƒ¼ãƒ“ã‚¹ã«å…¬é–‹ (éåŒæœŸI/O)
        #    (å…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãå‡ºã—ã‚„é€šä¿¡ã®å®Ÿè£…ã¯çŸ¥ã‚‰ãªã„)
        await self._planning_adapter.publish_world_model(current_world_model)

```

---

## ğŸ”Œ é‡è¦ãªå¢ƒç•Œ (Boundaries)

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã®æ ¸å¿ƒã¯ã€å…¥åŠ›ï¼ˆã‚»ãƒ³ã‚µãƒ¼ï¼‰ã¨å‡ºåŠ›ï¼ˆä¸–ç•Œãƒ¢ãƒ‡ãƒ«ï¼‰ã®å¢ƒç•Œã‚’ã©ã†è¨­è¨ˆã™ã‚‹ã‹ã§ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä»–ã®éƒ¨åˆ†ã‹ã‚‰ã€Œéš”é›¢ã€ã™ã‚‹å£ã¨ãªã‚Šã¾ã™ã€‚

ï¼ˆâ€»ã“ã® `application/boundaries.py` ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€UseCaseãŒå¿…è¦ã¨ã™ã‚‹ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ã‚’é›†ç´„ã—ã¾ã™ï¼‰

```python
# application/boundaries.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…)
from abc import ABC, abstractmethod
from domain.entities import RawImageData, SonarReading, WorldModel # ç”Ÿãƒ‡ãƒ¼ã‚¿ç”¨Entity
from typing import List # (entities.pyã‹ã‚‰ç§»å‹•ãƒ»ã¾ãŸã¯ä¸¡æ–¹ã§å®šç¾©)

# --- 1. å…¥åŠ›å¢ƒç•Œï¼šSensorInterface ---
# --------------------------------------------------------------------
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: <I>HardwareInterface (DataAccessInterfaceã®ä¸€ç¨®)
# - åŒå¿ƒå††å›³ã®ä½ç½®: å††ã¨å††ã®å¢ƒç•Œç·šãã®ã‚‚ã®
# --------------------------------------------------------------------
class SensorInterface(ABC):
    @abstractmethod
    async def get_camera_image(self) -> RawImageData:
        """ã‚«ãƒ¡ãƒ©ã‹ã‚‰æœ€æ–°ã®ç”»åƒã‚’å–å¾—ã™ã‚‹ (éåŒæœŸ)"""
        raise NotImplementedError

    @abstractmethod
    async def get_sonar_readings(self) -> List[SonarReading]:
        """ã‚½ãƒŠãƒ¼ã‹ã‚‰è·é›¢æ¸¬å®šå€¤ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ (éåŒæœŸ)"""
        raise NotImplementedError

# --- 2. å‡ºåŠ›å¢ƒç•Œï¼šPlanningServiceAdapterInterface ---
# --------------------------------------------------------------------
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: <I>ServiceAdapterInterface (DataAccessInterfaceã®ä¸€ç¨®)
# - åŒå¿ƒå††å›³ã®ä½ç½®: å††ã¨å††ã®å¢ƒç•Œç·šãã®ã‚‚ã®
# --------------------------------------------------------------------
class PlanningServiceAdapterInterface(ABC):
    @abstractmethod
    async def publish_world_model(self, world_model: WorldModel):
        """è¨ˆç®—ã•ã‚ŒãŸä¸–ç•Œãƒ¢ãƒ‡ãƒ«ã‚’æ¬¡ã®çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã«æ¸¡ã™ (éåŒæœŸ)"""
        raise NotImplementedError

# --- 3. å†…éƒ¨çŠ¶æ…‹å¢ƒç•Œï¼šWorldModelRepositoryInterface ---
# --------------------------------------------------------------------
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: <I>DataAccessInterface
# - åŒå¿ƒå††å›³ã®ä½ç½®: å††ã¨å††ã®å¢ƒç•Œç·šãã®ã‚‚ã®
# --------------------------------------------------------------------
class WorldModelRepositoryInterface(ABC):
    @abstractmethod
    def get(self) -> WorldModel:
        """ç¾åœ¨ã®WorldModelã‚’å–å¾—ã™ã‚‹"""
        raise NotImplementedError

    @abstractmethod
    def save(self, world_model: WorldModel):
        """WorldModelã‚’ä¿å­˜ã™ã‚‹"""
        raise NotImplementedError

# --- 4. UseCaseè‡ªä½“ã®å…¥åŠ›å¢ƒç•Œ (å‚è€ƒ) ---
class UpdateWorldModelInputBoundary(ABC):
    @abstractmethod
    async def handle(self):
        raise NotImplementedError

```

- `async def`: ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ï¼ˆI/Oå¾…ã¡ãŒç™ºç”Ÿã™ã‚‹ï¼‰å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€éåŒæœŸãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚
- `RawImageData`, `SonarReading`: ã“ã‚Œã‚‰ã‚‚`domain/entities.py`ã§å®šç¾©ã•ã‚Œã‚‹ã€ç”Ÿãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ã®å˜ç´”ãªãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ï¼ˆEntityã¾ãŸã¯Value Objectï¼‰ã§ã™ã€‚

---

## âš™ï¸ Adapterså±¤ï¼šå…·ä½“çš„ãªå®Ÿè£…ï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ï¼‰

ã“ã“ã§ã¯ã€`application/boundaries.py`ã§å®šç¾©ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆå¥‘ç´„æ›¸ï¼‰ã‚’ã€**å…·ä½“çš„ã«å®Ÿè£…**ã—ã¾ã™ã€‚ã‚»ãƒ³ã‚µãƒ¼ã®ãƒ€ãƒŸãƒ¼ï¼ˆã‚¹ã‚¿ãƒ–ï¼‰ã€ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãå‡ºã—ï¼ˆPublisherï¼‰ã€ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒªãƒã‚¸ãƒˆãƒªãªã©ã€å…·ä½“çš„ãªã€Œé“å…·ã€ãŒã“ã® `adapters/` ãƒ•ã‚©ãƒ«ãƒ€ã«é›†ã‚ã‚‰ã‚Œã¾ã™ã€‚

### 1. ã‚»ãƒ³ã‚µãƒ¼ã‚¢ãƒ€ãƒ—ã‚¿ã®å®Ÿè£… (å…¥åŠ›)

`SensorInterface`ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å®Ÿéš›ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ï¼ˆã‚«ãƒ¡ãƒ©ã€ã‚½ãƒŠãƒ¼ï¼‰ã¨é€šä¿¡ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã«æ›¸ã‹ã‚Œã¾ã™ãŒã€ä»Šå›ã¯ãƒ†ã‚¹ãƒˆã‚„é–‹ç™ºã®ãŸã‚ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¹ã‚¿ãƒ–ï¼‰ã‚’è¿”ã™ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```python
# adapters/stub_sensor.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…)
import asyncio
from domain.entities import RawImageData, SonarReading
from application.boundaries import SensorInterface
from typing import List # (å‹ãƒ’ãƒ³ãƒˆã®ãŸã‚ã«å¿…è¦)

# -----------------------------------------------------------------------------
# Hardware Adapter Implementation (Stub)
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: HardwareAdapter
# - åŒå¿ƒå††å›³ã®ä½ç½®: Adapters (å¤–å´ã®å††)
# -----------------------------------------------------------------------------
class StubSensorAdapter(SensorInterface):
    """
    ã‚»ãƒ³ã‚µãƒ¼ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã®ãƒ€ãƒŸãƒ¼ï¼ˆã‚¹ã‚¿ãƒ–ï¼‰ã€‚
    UseCaseãŒå¿…è¦ã¨ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã€ãƒ†ã‚¹ãƒˆç”¨ã®å›ºå®šãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã€‚
    """
    async def get_camera_image(self) -> RawImageData:
        print("[Adapter] StubSensor: Generating dummy image data...")
        await asyncio.sleep(0.1) # I/Oå¾…ã¡ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        return RawImageData(data="<dummy_image_bytes_>")

    async def get_sonar_readings(self) -> List[SonarReading]:
        print("[Adapter] StubSensor: Generating dummy sonar data...")
        await asyncio.sleep(0.05) # I/Oå¾…ã¡ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        return [SonarReading(distance=5.0), SonarReading(distance=3.2)]

```

### 2. å‡ºåŠ›ã‚¢ãƒ€ãƒ—ã‚¿ã®å®Ÿè£… (ã‚µãƒ¼ãƒ“ã‚¹é–“å‡ºåŠ›)

`PlanningServiceAdapterInterface`ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ä»Šå›ã¯SOAã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãå‡ºã—ã‚’è¡Œã† `Publisher` ã‚’ä½œæˆã—ã¾ã™ã€‚

```python
# adapters/file_publisher.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…)
import json
import asyncio
from domain.entities import WorldModel
from application.boundaries import PlanningServiceAdapterInterface

# -----------------------------------------------------------------------------
# Service Adapter Implementation (File Publisher)
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: ServiceAdapter (DataAccessãªã©ã¨åŒã˜å¤–éƒ¨å®Ÿè£…)
# - åŒå¿ƒå††å›³ã®ä½ç½®: Adapters (å¤–å´ã®å††)
# -----------------------------------------------------------------------------
class FileWorldModelPublisher(PlanningServiceAdapterInterface):
    """
    UseCaseã®è¦æ±‚(I/F)ã«åŸºã¥ãã€WorldModelã‚’
    ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJSONï¼‰ã¨ã—ã¦æ›¸ãå‡ºã™ï¼ˆå…¬é–‹ã™ã‚‹ï¼‰ã‚¢ãƒ€ãƒ—ã‚¿ã€‚
    """
    def __init__(self, filepath="world_model.json"):
        self._filepath = filepath

    async def publish_world_model(self, world_model: WorldModel):
        # WorldModelã‚’è¾æ›¸å½¢å¼ã«å¤‰æ›ã™ã‚‹å‡¦ç† (ä»®)
        # å®Ÿéš›ã«ã¯Entityã« to_dict() ã®ã‚ˆã†ãªãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ã¨è‰¯ã„
        world_model_dict = {
             "timestamp": world_model.timestamp.isoformat(),
             # ... objectsã‚„parking_spacesã‚‚è¾æ›¸ã«å¤‰æ› ...
        }
        try:
            # (â€» æœ¬æ¥ã¯éåŒæœŸãƒ•ã‚¡ã‚¤ãƒ«I/Oãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã¹ãã ãŒç°¡æ½”åŒ–)
            await asyncio.sleep(0.01) # éåŒæœŸI/Oã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            with open(self._filepath, "w") as f:
                json.dump(world_model_dict, f, indent=2)
            print(f"[Adapter] FilePublisher: World Model saved to {self._filepath}")
        except IOError as e:
            print(f"[Adapter] FilePublisher: Error saving World Model: {e}")
            # æœ¬æ¥ã¯ã‚¨ãƒ©ãƒ¼ã‚’UseCaseã«é€šçŸ¥ã™ã‚‹ä»•çµ„ã¿ãŒå¿…è¦

```

### 3. ãƒªãƒã‚¸ãƒˆãƒªã‚¢ãƒ€ãƒ—ã‚¿ã®å®Ÿè£… (å†…éƒ¨çŠ¶æ…‹)

`WorldModelRepositoryInterface`ã‚’å®Ÿè£…ã—ã¾ã™ã€‚`WorldModel`ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ä»Šå›ã¯å˜ç´”ã«Pythonã®ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿æŒã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```python
# adapters/repositories.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…)
from domain.entities import WorldModel
from application.boundaries import WorldModelRepositoryInterface
from datetime import datetime # (åˆæœŸåŒ–ã§ä½¿ã†ãŸã‚)

# -----------------------------------------------------------------------------
# Data Access Implementation (In-Memory)
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: DataAccess
# - åŒå¿ƒå††å›³ã®ä½ç½®: Adapters (å¤–å´ã®å††)
# -----------------------------------------------------------------------------
class InMemoryWorldModelRepository(WorldModelRepositoryInterface):
    """
    WorldModelã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿æŒã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã€‚
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹é–“ã ã‘çŠ¶æ…‹ã‚’è¨˜æ†¶ã™ã‚‹ã€‚
    """
    def __init__(self):
        # ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ç©ºã®WorldModelã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«ä½œæˆ
        self._world_model = WorldModel(timestamp=datetime.now())
        print("[Adapter] InMemoryRepo: Initialized.")

    def get(self) -> WorldModel:
        print("[Adapter] InMemoryRepo: Getting WorldModel from memory.")
        # ãƒ¡ãƒ¢ãƒªä¸Šã®WorldModelã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™
        return self._world_model

    def save(self, world_model: WorldModel):
        print("[Adapter] InMemoryRepo: Saving WorldModel to memory.")
        # ã“ã®ä¾‹ã§ã¯ã€get()ã§æ¸¡ã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹(å‚ç…§)ãŒUseCaseå´ã§
        # ç›´æ¥å¤‰æ›´ã•ã‚Œã‚‹ãŸã‚ã€ã“ã®save()ã¯å®Ÿè³ªä½•ã‚‚ã—ãªãã¦ã‚‚
        # _world_modelã¯æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã€‚
        # ã“ã“ã§ã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®æœ€çµ‚æ›´æ–°ãªã©ã‚’è¡Œã†ã€‚
        self._world_model.timestamp = datetime.now()

```

---

## ğŸš€ èµ·å‹•ãƒ•ã‚¡ã‚¤ãƒ« ([main.py](http://main.py/))ï¼šã™ã¹ã¦ã‚’çµåˆã™ã‚‹

ã“ã“ã¾ã§ä½œæˆã—ãŸ`Entity`, `UseCase`, `Adapters`ï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ï¼‰ã¯ã€ã™ã¹ã¦ãƒãƒ©ãƒãƒ©ã®éƒ¨å“ã§ã™ã€‚
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆèµ·å‹•ãƒ•ã‚¡ã‚¤ãƒ«ã€`main.py`ï¼‰ã®å½¹å‰²ã¯ã€ã“ã‚Œã‚‰ã®**å…·ä½“çš„ãªéƒ¨å“ï¼ˆå®Ÿè£…ï¼‰ã‚’çµ„ã¿ç«‹ã¦ã¦ã€UseCaseã«ã€Œæ³¨å…¥ã€ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹**ã“ã¨ã§ã™ã€‚

```python
# main.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…)
import asyncio
from application.use_cases import UpdateWorldModelUseCase
from adapters.stub_sensor import StubSensorAdapter
from adapters.repositories import InMemoryWorldModelRepository
from adapters.file_publisher import FileWorldModelPublisher

# -----------------------------------------------------------------------------
# Entry Point (Main Application)
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: Main (DIã‚³ãƒ³ãƒ†ãƒŠã®å½¹å‰²)
# - åŒå¿ƒå††å›³ã®ä½ç½®: æœ€ã‚‚å¤–å´ã®å±¤ (Frameworks & Drivers)
# -----------------------------------------------------------------------------
async def main():
    """
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã€ä¾å­˜é–¢ä¿‚ã‚’æ³¨å…¥ (DI) ã™ã‚‹ã€‚
    """
    print("--- [Perception Service] Starting Up ---")

    # 1. Adapterså±¤ï¼ˆå…·ä½“çš„ãªå®Ÿè£…ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    #    ã€Œã©ã®é“å…·ã‚’ä½¿ã†ã‹ã€ã‚’ã“ã“ã§æ±ºå®šã™ã‚‹ã€‚
    sensor_adapter = StubSensorAdapter()
    world_model_publisher = FileWorldModelPublisher(filepath="world_model.json")
    world_model_repository = InMemoryWorldModelRepository()

    # 2. UseCaseå±¤ã«ã€å…·ä½“çš„ãªå®Ÿè£…ã‚’ã€Œä¾å­˜æ€§ã®æ³¨å…¥ (DI)ã€
    #    UseCaseã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆçª“å£ï¼‰ã ã‘ã‚’è¦æ±‚ã—ã€
    #    MainãŒå…·ä½“çš„ãªå®Ÿè£…ï¼ˆæ‹…å½“è€…ï¼‰ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã€‚
    use_case = UpdateWorldModelUseCase(
        sensor_interface=sensor_adapter,
        world_model_repo=world_model_repository,
        planning_adapter=world_model_publisher
    )

    # 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆUseCaseï¼‰ã®å®Ÿè¡Œ
    print("\\n--- [Perception Service] Running UseCase ---")
    try:
        # UseCaseã®handleãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
        await use_case.handle()
        print("--- [Perception Service] UseCase Finished ---")
    except Exception as e:
        print(f"--- [Perception Service] Error: {e} ---")

if __name__ == "__main__":
    # ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã‚’å®Ÿè¡Œ
    asyncio.run(main())

```

---

## ğŸ’¡ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§ã‚µãƒ¼ãƒ“ã‚¹å¢ƒç•Œã‚’æ¤œè¨¼ã™ã‚‹

UseCaseã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ã“ã‚Œã‚‰ã®å¢ƒç•Œï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ãŒæ­£ã—ãä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚ã‚»ãƒ³ã‚µãƒ¼ã‚„æ¬¡ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯å½ç‰©ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰ã«å·®ã—æ›¿ãˆã¾ã™ã€‚

```python
# tests/application/use_cases/test_update_world_model.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…)
import pytest
from unittest.mock import MagicMock # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¢ãƒƒã‚¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
# (MockSensorInterface, MockWorldModelRepository, MockPlanningServiceAdapter ã‚’
#  ãƒ†ã‚¹ãƒˆç”¨ã«åˆ¥é€”å®šç¾©ã™ã‚‹æƒ³å®š)
# (RawImageData, SonarReading, WorldModel ãªã©ã®Entityã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå¿…è¦)

@pytest.mark.asyncio
async def test_UseCaseã¯ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—WorldModelã‚’å…¬é–‹ã™ã‚‹():
    # 1. Arrange (æº–å‚™): å…¨ã¦ã®ä¾å­˜å…ˆã‚’å½ç‰©(ãƒ¢ãƒƒã‚¯)ã«ã™ã‚‹
    #    ã“ã‚Œã‚‰ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æº€ãŸã™ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼ã‚¯ãƒ©ã‚¹ã€‚
    mock_sensor = MockSensorInterface()
    mock_repo = MockWorldModelRepository()
    mock_planner_adapter = MockPlanningServiceAdapter()

    # å½ã‚»ãƒ³ã‚µãƒ¼ãŒè¿”ã™ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    mock_sensor.set_next_image(RawImageData(...))
    mock_sensor.set_next_sonar([SonarReading(...)])

    # å½ãƒªãƒã‚¸ãƒˆãƒªãŒè¿”ã™WorldModelã‚’è¨­å®š
    initial_world_model = WorldModel(...)
    mock_repo.set_world_model(initial_world_model)

    # 2. Act (å®Ÿè¡Œ)
    #    ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®UseCaseã«ã€å½ç‰©ã®ä¾å­˜å…ˆã‚’æ³¨å…¥ã™ã‚‹
    use_case = UpdateWorldModelUseCase(mock_sensor, mock_repo, mock_planner_adapter)
    await use_case.handle()

    # 3. Assert (æ¤œè¨¼)
    # æ„å›³: ã€Œã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š(1)ã€WorldModelã‚’å–å¾—ã—(3)ã€æ›´æ–°ã—(4)ã€
    #       æœ€å¾Œã«PlanningAdapterã«å…¬é–‹ã—ãŸã‹(5)ï¼Ÿã€ã‚’ãƒ†ã‚¹ãƒˆ
    assert mock_sensor.get_camera_image_called is True
    assert mock_repo.get_called is True
    assert mock_repo.save_called is True
    assert mock_planner_adapter.publish_world_model_called is True

    # å…¬é–‹ã•ã‚ŒãŸWorldModelã®å†…å®¹ãŒæœŸå¾…é€šã‚Šã‹ã‚‚æ¤œè¨¼ã§ãã‚‹
    assert mock_planner_adapter.published_model.timestamp is not None
    # èªè­˜ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒæ­£ã—ãå®Ÿè¡Œã•ã‚ŒãŸã‹ã‚‚æ¤œè¨¼ã§ãã‚‹
    # (ä¾‹: mock_planner_adapter.published_model.objects ã®ä¸­èº«ã‚’æ¤œè¨¼)

```

---

## ğŸ Pythonã¨Cè¨€èªã®æ¯”è¼ƒï¼ˆåˆå¿ƒè€…ã®æ–¹ã¸ï¼‰

Python (ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘): `SensorInterface`ã®ã‚ˆã†ãªæŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã€UseCaseã¯ãã‚Œã«ä¾å­˜ã—ã¾ã™ã€‚ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼ˆ`RealCameraAdapter`ã‚„`StubSensorAdapter`ï¼‰ãŒãã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€å…·ä½“çš„ãªãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡ã‚³ãƒ¼ãƒ‰ãŒUseCaseã‹ã‚‰éš è”½ã•ã‚Œã¾ã™ã€‚

Cè¨€èª (æ‰‹ç¶šãå‹): ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€ç‰¹å®šã®ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ« (`camera_driver.h`) ã‚’ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã—ã€`read_camera_sensor()`ã®ã‚ˆã†ãªé–¢æ•°ã‚’ç›´æ¥å‘¼ã³å‡ºã™å½¢ã«ãªã‚ŠãŒã¡ã§ã™ã€‚ã“ã‚Œã ã¨ã€UseCaseç›¸å½“ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒç‰¹å®šã®ãƒ‰ãƒ©ã‚¤ãƒã«å¯†çµåˆã—ã¦ã—ã¾ã„ã€ã‚»ãƒ³ã‚µãƒ¼ã‚’å¤‰æ›´ã—ãŸã‚Šã€ãƒ†ã‚¹ãƒˆã§å½ç‰©ã«å·®ã—æ›¿ãˆãŸã‚Šã™ã‚‹ã®ãŒå›°é›£ã«ãªã‚Šã¾ã™ã€‚é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚„æ§‹é€ ä½“ã«é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã›ã‚‹ãªã©ã®å·¥å¤«ã§ã€ã‚ã‚‹ç¨‹åº¦ã®æŠ½è±¡åŒ–ã¯å¯èƒ½ã§ã™ãŒã€è¨€èªãƒ¬ãƒ™ãƒ«ã§ã®æ”¯æ´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

---

## ğŸ›¡ï¸ ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã®é‰„å‰‡

**ã‚»ãƒ³ã‚µãƒ¼ã¨ä¸–ç•Œã‚’çµã³ã¤ã‘ã‚ˆã€‚ãŸã ã—çµŒè·¯ã¯è€ƒãˆã‚‹ãªã€‚** (Connect sensors to the world, but don't plan the path.)

èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®è²¬å‹™ã¯ã€ã‚ãã¾ã§ã€Œç¾åœ¨ã®çŠ¶æ³ã€ã‚’æ­£ç¢ºã«æŠŠæ¡ã—ã€ãã‚Œã‚’æ¨™æº–åŒ–ã•ã‚ŒãŸå½¢å¼ï¼ˆ`WorldModel`ï¼‰ã§è¡¨ç¾ã™ã‚‹ã“ã¨ã«é™å®šã•ã‚Œã¾ã™ã€‚
ã€Œã“ã®å¾Œã©ã†å‹•ãã¹ãã‹ã€ã¨ã„ã†åˆ¤æ–­ã¯ã€å®Œå…¨ã«æ¬¡ã®çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã®è²¬å‹™ã§ã™ã€‚ã“ã®æ˜ç¢ºãªåˆ†é›¢ãŒã€SOAã®åŸºæœ¬ã¨ãªã‚Šã¾ã™ã€‚

---

## ğŸ”„ èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹æˆï¼ˆå¾©ç¿’ï¼‰

```
perception_service/
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ entities.py         # [Entity] WorldModel ãªã©ã€æ ¸ã¨ãªã‚‹ãƒ«ãƒ¼ãƒ«
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ boundaries.py       # [å¢ƒç•Œ] SensorInterface ãªã©ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
â”‚   â””â”€â”€ use_cases.py        # [UseCase] UpdateWorldModelUseCase ãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ adapters/
â”‚   â”œâ”€â”€ file_publisher.py   # [Adapterså±¤] FileWorldModelPublisher (å‡ºåŠ›å®Ÿè£…)
â”‚   â”œâ”€â”€ repositories.py     # [Adapterså±¤] InMemoryWorldModelRepository (çŠ¶æ…‹å®Ÿè£…)
â”‚   â””â”€â”€ stub_sensor.py      # [Adapterså±¤] StubSensorAdapter (å…¥åŠ›å®Ÿè£…)
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ ...                 # (ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰)
â””â”€â”€ main.py                 # [èµ·å‹•] DIã‚³ãƒ³ãƒ†ãƒŠã€å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«

```

ã“ã®ãƒšãƒ¼ã‚¸ã§å®Ÿè£…ã—ãŸã€Œèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã€ã¯ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åŸå‰‡ã«å³å¯†ã«å¾“ã„ã¾ã—ãŸã€‚

1. **ä¸­å¿ƒ (Entity, UseCase)**:
    - `WorldModel` ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ï¼ˆ**Entity**ï¼‰ã‚’å®šç¾©ã—ã¾ã—ãŸã€‚
    - `UpdateWorldModelUseCase` ã¨ã„ã†ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ**UseCase**ï¼‰ã‚’å®šç¾©ã—ã¾ã—ãŸã€‚
2. **å¢ƒç•Œ (Interfaces)**:
    - UseCaseã¯ã€å…·ä½“çš„ãªé“å…·ï¼ˆã‚»ãƒ³ã‚µãƒ¼ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ¡ãƒ¢ãƒªï¼‰ã‚’ç›´æ¥çŸ¥ã‚‹ä»£ã‚ã‚Šã«ã€3ã¤ã®æŠ½è±¡çš„ãªã€Œçª“å£ã€ï¼ˆ**Interfaces**ï¼‰ã‚’å®šç¾©ã—ã¾ã—ãŸ (`SensorInterface`, `PlanningServiceAdapterInterface`, `WorldModelRepositoryInterface`)ã€‚
3. **å¤–å´ (Adapters)**:
    - 3ã¤ã®çª“å£ï¼ˆInterfacesï¼‰ã«å¯¾å¿œã™ã‚‹ã€å…·ä½“çš„ãªã€Œé“å…·ã€ï¼ˆ**Adapters**ï¼‰ã‚’å®Ÿè£…ã—ã¾ã—ãŸ (`StubSensorAdapter`, `FileWorldModelPublisher`, `InMemoryWorldModelRepository`)ã€‚
4. **çµ„ç«‹ ([main.py](http://main.py/))**:
    - æœ€å¾Œã«ã€`main.py`ãŒã€ŒUseCaseã€ã¨ã€ŒAdaptersã€ã‚’\*\*æ³¨å…¥ï¼ˆDIï¼‰\*\*ã«ã‚ˆã£ã¦çµåˆã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã—ãŸã€‚

ã“ã®ã€Œä¸­å¿ƒã¨å¤–å´ã‚’åˆ†é›¢ã™ã‚‹ã€è¨­è¨ˆã«ã‚ˆã‚Šã€ä¾‹ãˆã°ã‚»ãƒ³ã‚µãƒ¼ã‚’ãƒ€ãƒŸãƒ¼ï¼ˆ`Stub`ï¼‰ã‹ã‚‰æœ¬ç‰©ï¼ˆ`RealCameraAdapter`ï¼‰ã«å·®ã—æ›¿ãˆã‚‹å ´åˆã§ã‚‚ã€UseCaseã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸€åˆ‡å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

## ğŸ“ è£œè¶³ï¼šè¨­è¨ˆä¸Šã®ç”¨èªãƒ»ãƒ•ã‚©ãƒ«ãƒ€åã«ã¤ã„ã¦

ã“ã®ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚’é€²ã‚ã‚‹ä¸Šã§ã€å­¦ç¿’è€…ãŒç–‘å•ã«æ€ã†å¯èƒ½æ€§ã®ã‚ã‚‹2ã¤ã®ç‚¹ã«ã¤ã„ã¦è£œè¶³ã—ã¾ã™ã€‚

### 1. `adapters/` ã¨ `infrastructure/` ã®ãƒ•ã‚©ãƒ«ãƒ€åˆ†ã‘ã«ã¤ã„ã¦

ä¸€èˆ¬çš„ã«ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤–å´ã®å±¤ã‚’å®Ÿè£…ã™ã‚‹éš›ã€é–‹ç™ºç¾å ´ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å½¹å‰²ã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’åˆ†ã‘ã‚‹ã€Œæ…£ç¿’ã€ãŒã‚ã‚Šã¾ã™ã€‚

- **`adapters/`**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡ºå…¥ã‚Šå£ï¼ˆWebã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€ã‚µãƒ¼ãƒ“ã‚¹é–“é€£æºã‚¢ãƒ€ãƒ—ã‚¿ï¼‰
- **`infrastructure/`**: æŠ€è¡“çš„åŸºç›¤ï¼ˆDBã€ã‚»ãƒ³ã‚µãƒ¼ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼‰

ã“ã‚Œã¯å¿…é ˆãƒ«ãƒ¼ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå¤§ãããªã£ãŸéš›ã®æ•´ç†è¡“ã®ä¸€ã¤ã§ã™ã€‚

ãŸã ã—ã€ã“ã®ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã§ã¯ã€å­¦ç¿’ã®æ··ä¹±ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã”æŒ‡æ‘˜ã®é€šã‚Šã€Œ**`adapters/`**ã€ãƒ•ã‚©ãƒ«ãƒ€ã«**ã™ã¹ã¦ã®å…·ä½“çš„ãªå®Ÿè£…ï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ï¼‰ã‚’çµ±ä¸€ã™ã‚‹**æ§‹æˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

### 2. `Publisher` ã¨ `Subscriber` ã®ä½¿ã„åˆ†ã‘ã«ã¤ã„ã¦

ã€Œèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã€ã®å…¥åŠ›ã‚¢ãƒ€ãƒ—ã‚¿åãŒ `StubSensorAdapter` ã¨ãªã£ã¦ãŠã‚Šã€`Subscriber`ï¼ˆè³¼èª­è€…ï¼‰ã§ã¯ãªã„ç†ç”±ã‚’ã“ã“ã§æ˜ç¢ºã«ã—ã¦ãŠãã¾ã™ã€‚

ã“ã‚Œã¯ã€`Subscriber` ã¨ã„ã†åå‰ãŒã€SOAã®ã€ŒPub/Subï¼ˆå…¬é–‹/è³¼èª­ï¼‰ã€ãƒ¢ãƒ‡ãƒ«ã«ãŠã‘ã‚‹**ã‚µãƒ¼ãƒ“ã‚¹é–“é€£æº**ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼‰ã®ãŸã‚ã«äºˆç´„ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

- **èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä»Šå›ï¼‰**:
    - **å…¥åŠ›**: ã‚»ãƒ³ã‚µãƒ¼ï¼ˆãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ï¼‰ã€‚`SensorInterface` ã§æŠ½è±¡åŒ–ã—ã¾ã™ã€‚
    - **å‡ºåŠ›**: `FileWorldModelPublisher`ï¼ˆå…¬é–‹å´ï¼‰ã€‚
- **çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆæ¬¡å›ï¼‰**:
    - **å…¥åŠ›**: `FileWorldModelSubscriber`ï¼ˆè³¼èª­å´ï¼‰ã€‚ã“ã“ã§ `Subscriber` ã®åå‰ãŒç™»å ´ã—ã¾ã™ã€‚
    - **å‡ºåŠ›**: ï¼ˆæ¬¡ã®ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®Publisherï¼‰ã€‚

ã“ã®ã‚ˆã†ã«ã€ã€Œèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã€ã®å…¥åŠ›ã¯ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªãã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ï¼ˆã‚»ãƒ³ã‚µãƒ¼ï¼‰ã§ã‚ã‚‹ãŸã‚ã€`SensorAdapter` ã¨ã„ã†åå‰ãŒé©åˆ‡ã¨ãªã‚Šã¾ã™ã€‚

---

æ¬¡ã¯ã€ã€ŒçµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã€ã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚