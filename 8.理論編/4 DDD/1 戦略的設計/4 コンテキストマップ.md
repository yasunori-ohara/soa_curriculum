# 4. コンテキストマップ

# 🏛️ 戦略的設計：コンテキストマップ

ユビキタス言語で会話し、境界づけられたコンテキスト(BC)でドメインを分割したら、次はその**分割したコンテキスト同士がどのように連携・関係しているのか**を明確にする必要があります。そのためのツールが「**コンテキストマップ (Context Map)**」です。

---

## ❓ コンテキストマップとは？

> 複数の境界づけられたコンテキスト間の関係性を図示し、チーム間の組織的・技術的な連携パターンを明示するドキュメント（または図）。
> 

### 💡 簡単に言うと

境界づけられたコンテキストを「国」に例えるなら、コンテキストマップはその国々がどのような「**外交関係**」（同盟、貿易協定、鎖国など）を結んでいるかを示す「**世界地図**」のようなものです。
[Image representing a world map showing connections between countries]

### 🤔 なぜ重要か？

ソフトウェアシステム全体は、分割されたコンテキスト（サービスやモジュール）が連携して初めて機能します。コンテキストマップを作成し、関係性を明確にすることには、以下のような利点があります。

1. **チーム間の連携の明確化**:
どのチーム（コンテキスト）が他のどのチームに依存しているのか、どのような情報を交換するのか、その責任分界点はどこか、といった**組織的な連携**が明確になります。
2. **技術的な統合戦略の選択**:
コンテキスト間の関係性に応じて、最適な**技術的な連携方法**（API呼び出し、メッセージング、共有ライブラリなど）を選択するための指針となります。
3. **意図しない依存関係の防止**:
コンテキストマップを描くことで、隠れた依存関係や、望ましくない密結合（例：コンテキスト境界を越えたDB直接参照）を早期に発見し、修正することができます。
4. **システム全体の理解**:
個々のコンテキストだけでなく、システム全体がどのように構成され、連携しているのかを俯瞰的に理解するための共通言語となります。

---

## 🗺️ コンテキストマップのパターン

コンテキストマップでは、BC間の関係性を表すいくつかの**標準的なパターン**が定義されています。代表的なものをいくつか紹介します。

- **パートナーシップ (Partnership)** 🤝:
2つのコンテキスト（チーム）が協力し、共同で目標達成を目指す関係。どちらか一方が勝手に仕様を変えることはできず、密な連携が必要です。
- **共有カーネル (Shared Kernel)** 🌱:
2つのコンテキストが、ドメインモデルの一部（コードやDBスキーマなど）を文字通り共有する関係。変更には両チームの合意が必要で、密結合になりやすいですが、共通基盤が重要な場合に採用されます。
- **顧客/供給者 (Customer/Supplier)** 🛒:
一方（供給者）が他方（顧客）に対してサービス（APIなど）を提供する関係。供給者側が主導権を持ちますが、顧客側の要求も考慮する必要があります。
- **順応者 (Conformist)** 🙏:
供給者側が圧倒的に強く、顧客側が供給者のモデルやAPIに完全に合わせるしかない（変更要求もほぼ通らない）関係。外部の標準APIやレガシーシステムとの連携でよく見られます。
- **防腐層 (Anti-Corruption Layer - ACL)** 🛡️:
自コンテキストを、外部コンテキスト（特にレガシーシステムや品質の低いシステム）の「汚染」から守るために、間に\*\*翻訳層（ACL）\*\*を設けるパターン。外部モデルが変更されても、ACLがその差分を吸収し、自コンテキストへの影響を最小限に抑えます。
- **公開ホストサービス (Open Host Service - OHS)** 📢:
コンテキストが、自身の機能やデータにアクセスするための、明確に定義された\*\*公開API（プロトコル）\*\*を提供するパターン。REST APIやgRPCなどがこれにあたります。
- **公開言語 (Published Language - PL)** 📜:
OHSと似ていますが、こちらは主にデータ（情報モデル）の**共通フォーマット**（例：JSONスキーマ、XMLスキーマ、Protobuf定義）を公開し、それを通じて連携するパターン。MQTTでのメッセージ形式などがこれにあたります。

---

## ✅ これまでの実践例（どこで使ったか）

私たちの自動駐車システムでは、コンテキストマップを明示的に描きませんでしたが、サービス間の連携方法は暗黙的にパターンを選択していました。

### 📌 サービス間の連携 (第4巡, 第5巡)

- **具体例**: 認識サービスは `world_model` を公開し、経路計算サービスはそれを購読。経路計算サービスは `plan` を公開し、制御サービスはそれを購読しました。
- **実践**: これは、**公開ホストサービス (OHS)** と **公開言語 (PL)** の組み合わせに近い形です。
    - 各サービスは、自身の成果物（`world_model`, `plan`）を外部に**公開 (Publish)** しました（OHS的な側面）。
    - そのデータの形式（JSON / Entity構造）が、サービス間の**公開言語 (PL)** として機能しました。
    - データを受け取る側（Subscriber）は、公開された言語（データ形式）に従って情報を解釈しました。これは **順応者 (Conformist)** に近い関係性とも言えます（Publisherが定義した形式にSubscriberが合わせるため）。

<!-- end list -->

```
  [認識サービス] --(OHS/PL: world_model)--> [経路計算サービス] --(OHS/PL: plan)--> [制御サービス]
      (供給者)                               (顧客/供給者)                           (顧客)

```

- **ポイント**: 非同期（MQTT）を選択したことで、サービス間の結合度は非常に低く（疎結合）、これはコンテキストマップ上でも望ましい関係性として描かれることが多いです。

---

## ❌ 間違った適用例（アンチパターン）

コンテキスト間の関係性を意識せずに設計を進めると、管理不能な依存関係（いわゆる「**ビッグボールオブマッド - Big Ball of Mud**」）に陥る危険があります。

- **例1：コンテキスト境界を越えた直接呼び出し/参照**
境界づけられたコンテキストのアンチパターン（例：他サービスのDBを直接読む、内部関数を呼び出す）は、コンテキストマップ上で最も避けるべき関係性（または関係性の欠如）です。
- **例2：過剰な共有カーネル**
安易に多くのコードやデータを共有カーネルにしてしまうと、その共有部分の変更が広範囲に影響し、チーム間の調整コストが爆発的に増加します。共有は慎重に行うべきです。
- **例3：循環依存**
コンテキストAがBに依存し、BがCに依存し、CがAに依存する…といった循環依存の関係は、変更の影響がループし、システム全体が硬直化する原因になります。コンテキストマップを描くことで、このような依存関係を発見しやすくなります。

---

## 📝 まとめ

コンテキストマップは、DDDの戦略的設計において、**分割したコンテキスト（BC）間の関係性を可視化し、チーム間の連携方法と技術的な統合戦略を決定するための重要なツール**です。

コンテキストマップを描き、BC間の関係性を意識的に設計することで、

- 意図しない密結合を防ぎ、
- 各チーム（コンテキスト）の自律性を保ち、
- システム全体として変更に強く、進化しやすい構造を維持することができます。

---

## ➡️ 次へ

これで戦略的設計の主要な要素（ユビキタス言語、境界づけられたコンテキスト、コンテキストマップ）を見てきました。
次は、一つの境界づけられたコンテキストの「内部」をどのように設計するか、DDDの「**戦術的設計**」について見ていきましょう。