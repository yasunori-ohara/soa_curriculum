# 00 はじめに

## ✅ 実践済みのCA改善事項

1. **依存性のルール (The Dependency Rule) 🧱**:
    - **内容**: 依存関係は常に外側から内側へ向かうべき。内側の円（Entity, UseCase）は外側の円（Adapters）について何も知らない。
    - **実践**: すべてのプロジェクトで徹底しました。UseCaseはインターフェースにのみ依存し、具体的なAdapterクラスを知りませんでした。
2. **レイヤー構造 (Layers) 🧅**:
    - **内容**: ソフトウェアを同心円状の層（Entities, Use Cases, Interface Adapters, Frameworks & Drivers）に分割する。
    - **実践**: `domain/`, `application/`, `adapters/` というフォルダ構成で、この層構造を明確に実装しました。
3. **境界インターフェース (Boundary Interfaces / Ports) 🔌**:
    - **内容**: 層と層の間には、インターフェース（抽象）を定義し、それを介してのみやり取りする。
    - **実践**: `application/boundaries.py` に `SensorInterface`, `RepositoryInterface`, `PublisherInterface` などを定義し、UseCaseはこれらインターフェースにのみ依存しました。
4. **関心の分離 (Separation of Concerns) ✂️**:
    - **内容**: ビジネスロジック（UseCase, Entity）と、技術的詳細（UI, DB, 通信）を明確に分離する。
    - **実践**: CAの構造そのものがこれを実現しています。特に第5巡では、通信方式（ファイル→MQTT）の変更がUseCaseに全く影響しないことで、この分離の効果を体験しました。
5. **テスト容易性 (Testability) ✅**:
    - **内容**: ビジネスロジック（UseCase, Entity）を、UIやDBなしで単体テストできるようにする。
    - **実践**: 各サービスのUseCaseのユニットテストで、依存先（Adapter）をモックに差し替えてテストしました。
6. **フレームワーク独立性 (Framework Independence) 🌐**:
    - **内容**: Webフレームワーク（Flask, Djangoなど）は外側の「詳細」であり、ビジネスロジックはそれに依存しない。
    - **実践**: （第1〜2巡で）UIをコンソールからWebに移行（概念）したり、第5巡で通信基盤が変わってもUseCaseが変わらなかったりしたことで、この原則を体験しました。`main.py` がフレームワーク（や `asyncio` などの実行環境）との接着点の役割を担いました。
7. **UI独立性 (UI Independence) 🖥️**:
    - **内容**: UI（Web画面、モバイルアプリ、CLI）は外側の「詳細」であり、変更してもビジネスロジックに影響を与えない。
    - **実践**: フレームワーク独立性とほぼ同義ですが、UIの変更がAdapter層の差し替えで済むことを（概念的に）確認しました。
8. **データベース独立性 (Database Independence) 💾**:
    - **内容**: データベース（MongoDB, PostgreSQLなど）は外側の「詳細」であり、変更してもビジネスロジックに影響を与えない。
    - **実践**: 第2巡でインメモリDBからMongoDBへの移行（概念）や、第4巡以降のリポジトリパターン（インターフェース＋実装）を通じて、この原則を実践しました。

---

## ⚠️ 少し触れたが、深掘り可能な要素

- **Presenters / Controllers (Interface Adapters層の一部)**: UseCaseからの出力データを、UI（Web画面など）に適した形式に変換する部分です。今回のSOAの例ではUIがなかったため、この部分はあまり登場しませんでした。（第1〜2巡のWebアプリでは、フレームワークの機能として暗黙的に使われていました）
- **DTO (Data Transfer Objects)**: 層（特にUseCaseとAdapter）の間でデータを渡すための、単純なデータ構造です。今回はEntityを直接渡す場面もありましたが、厳密にはDTOを定義してやり取りすることが推奨される場合もあります。

---

## 📝 まとめ

クリーンアーキテクチャが目指す**「ビジネスロジックを技術的詳細から守り、独立性・テスト容易性を高める」**という核心的な改善事項は、これまでの実践を通じて十分に習得できていると言えます。
特に、依存性のルールとインターフェース（境界）の活用は、CAの最も重要な要素であり、これをしっかり実践できました。

### 📝 コメントアウトについての補足

アンチパターンを示すコード例の中に、一部 `#` でコメントアウトされている箇所があります。これは以下の理由によります。

1. **実行不能なコード**: そのコード片だけではPythonとして実行できない場合や、説明のための擬似コード（例: JavaScript）を示す場合に、コメントアウトしています。
2. **問題箇所の強調**: コード全体ではなく、「この特定の行（例: 不適切な `import` やメソッド定義）だけがルール違反である」ことを明確にするために、その部分をコメントアウトして示しています。

コメントアウトされていないアンチパターン例は、構造を示すために、そのまま実行可能な（ただし問題のある）Pythonコードとして提示しています。