# 03 ç–Žçµåˆã‚’ä¿ã¦

# ðŸ›ï¸ ç–Žçµåˆã‚’ä¿ã¦

SOAã®4å¤§åŽŸå‰‡ã®3ç•ªç›®ã¯ã€ã€Œ**ç–Žçµåˆã‚’ä¿ã¦ (Loose Coupling)**ã€ã§ã™ã€‚ã“ã‚Œã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã®ã€Œè‡ªå¾‹æ€§ã€ã¨ã‚‚å¯†æŽ¥ã«é–¢é€£ã—ã€å¤‰æ›´ã«å¼·ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®éµã¨ãªã‚Šã¾ã™ã€‚

---

## â“ åŽŸå‰‡ã®å®šç¾©

> ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚ã‚’æœ€å°é™ã«ã—ã€ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®å¤‰æ›´ãŒä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ä¸Žãˆã‚‹å½±éŸ¿ã‚’æ¥µåŠ›å°‘ãªãã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã™ã¹ãã§ã‚ã‚‹ã€‚
> 

### ðŸ’¡ ç°¡å˜ã«è¨€ã†ã¨

ã‚µãƒ¼ãƒ“ã‚¹åŒå£«ã¯ã€Œ**æµ…ã„ä»˜ãåˆã„**ã€ã«ç•™ã‚ã¾ã—ã‚‡ã†ã€ã¨ã„ã†ã“ã¨ã§ã™ã€‚ãŠäº’ã„ã®å†…éƒ¨äº‹æƒ…ï¼ˆå®Ÿè£…ã®è©³ç´°ï¼‰ã«æ·±å…¥ã‚Šã›ãšã€æ±ºã‚ã‚‰ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆå¥‘ç´„ï¼‰ã‚’é€šã˜ã¦ã€å¿…è¦æœ€ä½Žé™ã®æƒ…å ±ã ã‘ã‚’ã‚„ã‚Šå–ã‚Šã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### ðŸ¤” ãªãœé‡è¦ã‹ï¼Ÿ

ã‚µãƒ¼ãƒ“ã‚¹é–“ã®çµåˆåº¦ãŒå¼·ã„ï¼ˆ**å¯†çµåˆ - Tight Coupling**ï¼‰ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚

1. å¤‰æ›´ã®é€£éŽ– (Ripple Effect):
    
    ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹Aã®å†…éƒ¨å®Ÿè£…ã‚’å°‘ã—å¤‰æ›´ã—ãŸã ã‘ã§ã€ãã‚Œã«ä¾å­˜ã—ã¦ã„ãŸã‚µãƒ¼ãƒ“ã‚¹Bã€Cã€Dâ€¦ã‚‚é€£éŽ–çš„ã«ä¿®æ­£ãŒå¿…è¦ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å¤‰æ›´ãŒåºƒç¯„å›²ã«åŠã³ã€ã‚³ã‚¹ãƒˆã¨ãƒªã‚¹ã‚¯ãŒå¢—å¤§ã—ã¾ã™ã€‚
    
2. ç‹¬ç«‹ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ã®é˜»å®³:
    
    ã‚µãƒ¼ãƒ“ã‚¹Aã ã‘ã‚’æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„ã®ã«ã€å¯†çµåˆã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹Bã‚‚åŒæ™‚ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãªã„ã¨å‹•ã‹ãªã„ã€ã¨ã„ã£ãŸçŠ¶æ³ãŒç™ºç”Ÿã—ã‚„ã™ããªã‚Šã¾ã™ã€‚
    
3. ãƒ†ã‚¹ãƒˆã®è¤‡é›‘åŒ–:
    
    ã‚µãƒ¼ãƒ“ã‚¹Aã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€ãã‚Œã«å¯†çµåˆã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹Bã‚„Cã‚‚ä¸€ç·’ã«èµ·å‹•ãƒ»è¨­å®šã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚ç‹¬ç«‹ã—ãŸãƒ†ã‚¹ãƒˆãŒå›°é›£ã«ãªã‚Šã¾ã™ã€‚
    
4. å†åˆ©ç”¨æ€§ã®ä½Žä¸‹:
    
    ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ç¾¤ã¨å¯†çµåˆã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã§å†åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒé›£ã—ããªã‚Šã¾ã™ã€‚
    

ç–Žçµåˆã‚’ä¿ã¤ã“ã¨ã§ã€å„ã‚µãƒ¼ãƒ“ã‚¹ã¯**ç‹¬ç«‹ã—ã¦å¤‰æ›´ãƒ»é€²åŒ–**ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã¨ã—ã¦ã®**ä¿Šæ•æ€§ï¼ˆAgilityï¼‰ã¨ä¿å®ˆæ€§**ãŒé«˜ã¾ã‚Šã¾ã™ã€‚

---

## âœ… ã“ã‚Œã¾ã§ã®å®Ÿè·µä¾‹ï¼ˆã©ã“ã§ä½¿ã£ãŸã‹ï¼‰

ç§ãŸã¡ã®è‡ªå‹•é§è»Šã‚·ã‚¹ãƒ†ãƒ ã¯ã€ã„ãã¤ã‹ã®è¨­è¨ˆé¸æŠžã«ã‚ˆã£ã¦ç–Žçµåˆã‚’å®Ÿç¾ã—ã¦ã„ã¾ã—ãŸã€‚

### ðŸ“Œ éžåŒæœŸé€šä¿¡ (MQTT) ã®æŽ¡ç”¨ (ç¬¬5å·¡)

- **å…·ä½“ä¾‹**: èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã¯ `/world_model` ãƒˆãƒ”ãƒƒã‚¯ã«ãƒ‡ãƒ¼ã‚¿ã‚’Publishã™ã‚‹ã ã‘ã§ã€èª°ãŒï¼ˆçµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ãŒï¼‰ãã‚Œã‚’Subscribeã—ã¦ã„ã‚‹ã‹ã‚’çŸ¥ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
- **å®Ÿè·µ**: Publisherã¨SubscriberãŒäº’ã„ã‚’ç›´æŽ¥çŸ¥ã‚‹å¿…è¦ãŒãªã„MQTTï¼ˆPub/Subï¼‰ã¯ã€**æ™‚é–“çš„çµåˆ**ï¼ˆç›¸æ‰‹ãŒåŒæ™‚ã«å‹•ã„ã¦ã„ã‚‹å¿…è¦ãŒãªã„ï¼‰ã¨**ç©ºé–“çš„çµåˆ**ï¼ˆç›¸æ‰‹ã®å ´æ‰€ã‚’çŸ¥ã‚‹å¿…è¦ãŒãªã„ï¼‰ã®ä¸¡æ–¹ã‚’ç·©ã‚ã¾ã™ã€‚èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…ãŒå¤‰ã‚ã£ã¦ã‚‚ã€çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã¯å½±éŸ¿ã‚’å—ã‘ã¾ã›ã‚“ï¼ˆå¥‘ç´„ãŒå¤‰ã‚ã‚‰ãªã„é™ã‚Šï¼‰ã€‚é€†ã‚‚åŒæ§˜ã§ã™ã€‚ã“ã‚Œã¯éžå¸¸ã«ç–Žãªçµåˆã§ã™ã€‚

### ðŸ“Œ å¥‘ç´„ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã«ã‚ˆã‚‹é€£æº (ç¬¬4å·¡, ç¬¬5å·¡)

- **å…·ä½“ä¾‹**: ã‚µãƒ¼ãƒ“ã‚¹é–“ã®å”¯ä¸€ã®æŽ¥ç‚¹ã¯ã€`world_model` ã‚„ `plan` ã¨ã„ã£ãŸãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ï¼ˆJSONã‚¹ã‚­ãƒ¼ãƒž / Entityæ§‹é€ ï¼‰ã ã‘ã§ã—ãŸã€‚
- **å®Ÿè·µ**: ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ç›¸æ‰‹ã®å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ã‚„ä½¿ç”¨ã—ã¦ã„ã‚‹æŠ€è¡“ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžã€DBãªã©ï¼‰ã«ã¤ã„ã¦ä½•ã‚‚çŸ¥ã‚Šã¾ã›ã‚“ã€‚ãŸã åˆæ„ã•ã‚ŒãŸã€Œå¥‘ç´„ã€ã«å¾“ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã™ã‚‹ã ã‘ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**å®Ÿè£…ã®è©³ç´°ã«é–¢ã™ã‚‹çµåˆ**ãŒæŽ’é™¤ã•ã‚Œã¾ã—ãŸã€‚

### ðŸ“Œ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®é©ç”¨ (ã‚µãƒ¼ãƒ“ã‚¹å†…éƒ¨)

- **å…·ä½“ä¾‹**: å„ã‚µãƒ¼ãƒ“ã‚¹å†…éƒ¨ã§ã€`UseCase` ã¯ `Adapters` å±¤ã®å®Ÿè£…ã‚’çŸ¥ã‚‰ãšã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ã¿ã«ä¾å­˜ã—ã¦ã„ã¾ã—ãŸã€‚
- **å®Ÿè·µ**: ã‚µãƒ¼ãƒ“ã‚¹å†…éƒ¨ã®å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚ç–Žçµåˆã«ä¿ãŸã‚Œã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°ã€MQTTã‚¢ãƒ€ãƒ—ã‚¿ã®å®Ÿè£…ã‚’å¤‰æ›´ã—ã¦ã‚‚ã€`UseCase` ã¯å½±éŸ¿ã‚’å—ã‘ã¾ã›ã‚“ã€‚ã“ã‚Œã‚‚ç–Žçµåˆã®ä¸€å½¢æ…‹ã§ã™ã€‚

---

## âŒ é–“é•ã£ãŸé©ç”¨ä¾‹ï¼ˆã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

å¯†çµåˆãªè¨­è¨ˆã¯ã€å¤‰æ›´ã®å½±éŸ¿ç¯„å›²ã‚’åºƒã’ã€ã‚·ã‚¹ãƒ†ãƒ ã®æŸ”è»Ÿæ€§ã‚’å¥ªã„ã¾ã™ã€‚

- ä¾‹1ï¼šä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã®å†…éƒ¨ã‚¯ãƒ©ã‚¹ã‚„é–¢æ•°ã‚’ç›´æŽ¥å‘¼ã³å‡ºã™
    
    ï¼ˆâ€» RPC (Remote Procedure Call) ã§ã‚‚ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ãªã—ã«è¡Œã†ã¨ã“ã‚Œã«è¿‘ã„çŠ¶æ…‹ã«ãªã‚Šã†ã‚‹ï¼‰
    
    `# çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹å†… (ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³)
    # from perception_service.internal_logic import calculate_object_distance # ðŸ‘ˆ NG! ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã®å†…éƒ¨é–¢æ•°ã‚’import
    
    class CalculatePathUseCase:
        def handle(self):
            world_model = ...
            # ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹(èªè­˜ã‚µãƒ¼ãƒ“ã‚¹)ã®å†…éƒ¨é–¢æ•°ã‚’ç›´æŽ¥å‘¼ã³å‡ºã™ï¼
            # distance = calculate_object_distance(world_model.objects[0], current_position)
            # ...
            pass`
    
    ã“ã‚Œã¯æœ€æ‚ªã®å¯†çµåˆã§ã™ã€‚èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®å†…éƒ¨å®Ÿè£…ï¼ˆé–¢æ•°åã€å¼•æ•°ã€ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã¯å³åº§ã«å£Šã‚Œã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹å¢ƒç•ŒãŒå®Œå…¨ã«ç„¡è¦–ã•ã‚Œã¦ã„ã¾ã™ã€‚
    
- ä¾‹2ï¼šå…±æœ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆå†æŽ²ï¼‰
    
    è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒåŒã˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å…±æœ‰ã™ã‚‹ã“ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã„ã†ã€Œå®Ÿè£…ã®è©³ç´°ã€ã‚’é€šã˜ã¦ã‚µãƒ¼ãƒ“ã‚¹åŒå£«ã‚’å¯†çµåˆã•ã›ã¦ã—ã¾ã„ã¾ã™ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®å¤‰æ›´ãŒã€è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã«å½±éŸ¿ã‚’ä¸Žãˆã¾ã™ã€‚
    
- ä¾‹3ï¼šéŽåº¦ã«ã€ŒãŠã—ã‚ƒã¹ã‚Šã€ãªé€šä¿¡ (Chatty Communication)
    
    ã‚ã‚‹å‡¦ç†ã‚’å®Œäº†ã™ã‚‹ãŸã‚ã«ã€ã‚µãƒ¼ãƒ“ã‚¹Aã¨ã‚µãƒ¼ãƒ“ã‚¹Bã®é–“ã§ã€ä½•åº¦ã‚‚ç´°ã‹ã„åŒæœŸçš„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆä¾‹ï¼šRESTå‘¼ã³å‡ºã—ï¼‰ã‚’ç¹°ã‚Šè¿”ã™ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚
    
     `[A] --(get user info)--> [B]
      [A] <-- (user info) ---- [B]
      [A] --(get user prefs)--> [B]
      [A] <-- (user prefs) --- [B]
      [A] --(get user address)--> [B]
      [A] <-- (user address) -- [B]
      (å‡¦ç†å®Œäº†)`
    
    ã“ã‚Œã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®ä½Žä¸‹ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾€å¾©é…å»¶ï¼‰ã ã‘ã§ãªãã€ã‚µãƒ¼ãƒ“ã‚¹AãŒã‚µãƒ¼ãƒ“ã‚¹Bã®APIï¼ˆè¤‡æ•°ï¼‰ã«å¼·ãä¾å­˜ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹Bã®APIãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨ã€ã‚µãƒ¼ãƒ“ã‚¹Aã‚‚ä¿®æ­£ãŒå¿…è¦ã«ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚
    
    **æ”¹å–„ç­–**: ãªã‚‹ã¹ã1å›žã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å¿…è¦ãªæƒ…å ±ã‚’ã¾ã¨ã‚ã¦å–å¾—ã§ãã‚‹ã‚ˆã†ã«APIã‚’è¨­è¨ˆã™ã‚‹ï¼ˆä¾‹ï¼š`getUserProfile` APIã‚’ä½œã‚‹ï¼‰ã€ã‚ã‚‹ã„ã¯éžåŒæœŸé€šä¿¡ã‚’æ¤œè¨Žã—ã¾ã™ã€‚
    

---

## ðŸ“ ã¾ã¨ã‚

ç–Žçµåˆã¯ã€ã€Œ**å¤‰æ›´ã®å½±éŸ¿ç¯„å›²ã‚’é™å®šã—ã€å„ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ã—ã¦é€²åŒ–ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹**ã€ãŸã‚ã®åŽŸå‰‡ã§ã™ã€‚

ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚ã‚’ã€**å®‰å®šã—ãŸå¥‘ç´„ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰**ã ã‘ã«é™å®šã—ã€**å®Ÿè£…ã®è©³ç´°**ã¸ã®ä¾å­˜ã‚’å¾¹åº•çš„ã«æŽ’é™¤ã—ã¾ã™ã€‚**éžåŒæœŸé€šä¿¡**ã¯ã€ç–Žçµåˆã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®å¼·åŠ›ãªæ‰‹æ®µã®ä¸€ã¤ã§ã™ã€‚

ç–Žçµåˆãªã‚·ã‚¹ãƒ†ãƒ ã¯ã€å¤‰æ›´ã«å¼·ãã€ãƒ†ã‚¹ãƒˆã—ã‚„ã™ãã€ã‚¹ã‚±ãƒ¼ãƒ«ã—ã‚„ã™ã„ã¨ã„ã†ã€SOAãŒç›®æŒ‡ã™å¤šãã®åˆ©ç‚¹ã‚’äº«å—ã§ãã¾ã™ã€‚

---

## âž¡ï¸ æ¬¡ã¸

ã„ã‚ˆã„ã‚ˆæœ€å¾Œã®åŽŸå‰‡ã€ã€Œ**(4/4) å ´æ‰€ã‚’é€éŽçš„ã«æ‰±ãˆ**ã€ã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã®ç‰©ç†çš„ãªé…ç½®å ´æ‰€ã«é–¢ã™ã‚‹åŽŸå‰‡ã§ã™ã€‚