# 09 補足2

# 補足2：FastAPI と Pydantic

今回の改修で、APIサーバー側の技術としてFastAPIを、データ定義としてPydanticを採用しました。これらは現代のPython Web開発において強力な組み合わせです。

## 🚀 FastAPI とは？

FastAPIは、Python 3.6+ でAPIを構築するための、モダンで高性能なWebフレームワークです。

- **高性能:** Node.jsやGoに匹敵する非常に高速なパフォーマンスを（非同期I/Oを活用することで）実現します。
- **学習の容易さ:** Pythonの標準的な型ヒントに基づいて動作するため、学習コストが低いです。
- **主な用途:** REST API（今回の用途）やWebSocket通信などのサーバーを構築するために使われます。

## 🛡️ Pydantic とは？

Pydanticは、Pythonの型ヒントを利用した「データバリデーション（検証）」ライブラリです。

- **データ検証:** `str` や `int`、`List` といった型ヒントを定義するだけで、実行時にデータがその型に合っているかを厳密にチェックし、合わなければエラーを返します。
- **パースとシリアライズ:** JSONのような外部データ（文字列や辞書）を、型安全なPythonオブジェクト（クラスインスタンス）に自動変換（パース）したり、逆にPythonオブジェクトをJSON形式に変換（シリアライズ）したりします。
- **FastAPIとの関係:** FastAPIは、APIのリクエスト（入力）とレスポンス（出力）の定義に、このPydanticモデルを全面的に採用しています。

## 💡 採用する理由と効果

ステップ1では `openapi.yaml` を手で書きましたが、FastAPIとPydanticを採用する最大の理由は、そのプロセスを自動化できる点にあります。

- **1. OpenAPIとAPIドキュメントの自動生成:**
Pydanticでレスポンスモデル（`dto.py`）を定義し、FastAPIでエンドポイント（`rest_api.py`）を実装するだけで、FastAPIが自動的にOpenAPI仕様（JSON/YAML）を生成します。
さらに、Swagger UI ( `/docs` ) や ReDoc ( `/redoc` ) といったインタラクティブなAPIドキュメントも自動で提供され、ブラウザから直接APIをテストできます。
- **2. バリデーションの自動化:**
Pydanticモデルがリクエストの型ヒントとして指定されていると、FastAPIは入ってきたJSONデータがその型定義（必須項目、データ型など）に違反していないかを自動で検証します。開発者が面倒なバリデーションコードを書く必要は一切ありません。
- **3. 開発効率と保守性:**
型ヒントがそのまま「仕様書」となり、バリデーションロジックとなり、シリアライズロジックとなります。コードが簡潔になるだけでなく、仕様と実装の乖離を防ぐことができます。

## 🔄 非同期通信（MQTT）とFastAPI

### 1. FastAPIは非同期（MQTT）時にも使えるか？

はい、使えます。
FastAPIは、その設計の中核に **ASGI (Asynchronous Server Gateway Interface)** を据えており、非同期I/O（`async`/`await`）をフルサポートしています。

FastAPIはHTTPリクエストを処理する「サーバー」です。
MQTTはPub/Subモデルの「メッセージング」プロトコルです。

両者は共存可能であり、例えば「FastAPIでHTTPリクエストを受けたら、それをトリガーにしてMQTTメッセージをPublishする」といった非同期処理を実装することは全く問題ありません。

### 2. なぜ第5巡（MQTT）で使わなかったのか？

これは **アーキテクチャの目的の違い** です。

第5巡の目的は、サービスがHTTPのエンドポイント（APIの口）を持たず、**MQTTブローカーという単一の窓口だけを介して連携する**「イベント駆動型アーキテクチャ」を学ぶことでした。

当時の各サービスは、純粋なPublisher（送信専用）またはSubscriber（受信専用）としてのみ動作していました。外部（例えばWebブラウザや他のサービス）からHTTPで呼び出される必要がなかったため、HTTPサーバー機能を持つFastAPIを導入する動機がありませんでした。

対して第6巡では、**HTTP (REST) でリクエストを受け付ける**ことがアーキテクチャの必須要件となりました。この「HTTPリクエストの受付」という役割を担わせるために、FastAPIが最適な選択肢として採用されたのです。