# 02 集約の発見と境界設定

# ステップ２：集約の発見と境界設定 (再訪) 🧱

Step 1 でドメインとユビキタス言語を再確認し、境界づけられたコンテキスト（認識、経路計算、制御）の妥当性を評価しました。このステップでは、各コンテキストの中心となる**集約 (Aggregate)** とその**境界**、守るべき**不変条件 (Invariants)** をDDDの視点から改めて定義し直します。

## 🤔 集約とは？（復習）

- 関連するエンティティと値オブジェクトの**まとまり**。
- データ変更における**一貫性**の単位。
- 外部からのアクセスは**集約ルート (Aggregate Root)** を通じてのみ行う。

**ポイント**: 各コンテキスト内で、状態を持ち、その状態の一貫性を保つ責任を持つ「モノ」を探します。

---

## 💬 コンテキストごとの候補検討 (再評価)

### 🧭 1. 認識コンテキスト (Perception Context) 📸

- **主な関心事**: センサーデータを解釈し、`WorldModel` を生成する。
- **集約候補**:
    - `WorldModel`: Step 1で検討した通り、これは特定の瞬間の環境スナップショットであり、コンテキスト間で受け渡されるデータ（契約）です。IDを持ちライフサイクルを通じて状態が変わるというよりは、**値オブジェクト**（またはDTO）としての性質が強いです。
    - `PerceptionSystem`？: 認識アルゴリズムのパラメータ（例：カメラのキャリブレーションデータ、認識閾値）などを保持し、その設定の一貫性を管理する必要がある場合、これを集約として考えることもできます。しかし、今回のコア機能（センサー入力→`WorldModel`出力）だけを見ると、状態を持つ集約よりも、**ドメインサービス**（認識アルゴリズム）や**ファクトリ**（`WorldModel`生成）が中心となる可能性が高いです。
- **判断**: このコンテキストでは、明確な「状態を持つ集約」よりも、**値オブジェクト**（`SensorData`, `WorldModel`）と**ドメインサービス/ファクトリ**（認識ロジック）が主要な構成要素となりそうです。

### 🧭 2. 経路計算コンテキスト (Planning Context) 🧠

- **主な関心事**: `WorldModel` を入力とし、`ParkingPlan` を生成する。
- **集約候補**:
    - `ParkingPlan`: 計算結果であり、次の制御コンテキストへの指示（契約）です。計画IDを持ち、後で参照・変更される可能性があるならエンティティ/集約ですが、単純に計算して次のコンテキストに渡すだけなら、**値オブジェクト**（またはDTO）としての性質が強いです。
    - `PlanningSystem`？: 認識コンテキストと同様に、計画アルゴリズムのパラメータ（例：好みの駐車スタイル、安全マージン）を保持・管理する必要があれば、集約候補になりえます。しかし、コア機能（`WorldModel`入力→`ParkingPlan`出力）だけを見ると、ここでも**ドメインサービス**（計画アルゴリズム）が中心となりそうです。
- **判断**: このコンテキストも、明確な「状態を持つ集約」よりも、**値オブジェクト**（`WorldModel`, `ParkingPlan`, `ControlCommand`）と**ドメインサービス**（計画ロジック）が主要となりそうです。

### 🧭 3. 車両制御コンテキスト (Control Context) 🦾

- **主な関心事**: `ParkingPlan` を入力とし、車両の物理的な状態 (`VehicleState`) を管理・制御し、アクチュエータに指示を出す。
- **集約候補**:
    - `VehicleControl` (または `Vehicle`): これが最も集約らしい候補です。
        - **ルート**: `VehicleControl` (Entity)。識別子は `VehicleID` が自然でしょう。
        - **内部**: 現在の `VehicleState` (VO or Entity?), 目標とする軌道/状態 (Planから派生)、制御パラメータ (VO) など。
        - **責務**: 車両の物理的な状態（速度、舵角など）の一貫性を保ちながら、計画(`ParkingPlan`)に基づいて目標状態に追従するように制御する。制御コマンドの実行、状態の更新、安全ルールの適用（例：最大速度、最大舵角）などを管理する。
    - `VehicleState`: これは特定の瞬間の状態を表す**値オブジェクト**として扱い、`VehicleControl` 集約がこの `VehicleState` を内部で更新・管理するのが自然です。
- **判断**: このコンテキストでは、「**`VehicleControl` 集約**」が中心となり、車両の状態管理と制御ロジックの実行に関する一貫性を保つ責任を持つと考えられます。

---

## 💬 集約の決定（案）

以上の再評価から、DDDの視点をより取り入れると、集約は以下のようになります。

1. **`VehicleControl` 集約 (制御コンテキスト)**:
    - **ルート**: `VehicleControl` (VehicleID で識別)
    - **責務**: 車両状態の管理と制御実行の一貫性を保つ。
- **認識・経路計算コンテキスト**:
    - これらのコンテキストの中心的な成果物である `WorldModel` と `ParkingPlan` は、集約ではなく、コンテキスト間で受け渡される**値オブジェクト**（またはDTO）としての性質が強いと判断します。
    - 認識アルゴリズムや経路計算アルゴリズムは、**ドメインサービス**としてモデル化するのが適切かもしれません。

| **コンテキスト** | **主な焦点** | **入力** | **主要な処理/成果物** | **出力 (契約)** |
| --- | --- | --- | --- | --- |
| **📸 認識 (Perception)** | 値オブジェクト, ドメインサービス | `SensorData` (VO) | `PerceptionService` が `WorldModel` (VO) を生成 | `WorldModel` (VO) |
| **🧠 経路計算 (Planning)** | 値オブジェクト, ドメインサービス | `WorldModel` (VO) | `PlanningService` が `ParkingPlan` (VO, `ControlCommand` (VO)リストを含む) を生成 | `ParkingPlan` (VO) |
| **🦾 車両制御 (Control)** | 集約 | `ParkingPlan` (VO) | `VehicleControl` (集約) が計画を実行し、状態(`VehicleState` VO)を管理 | `ActuatorCommand` (VO) -> HW |

---

## 💬 境界と不変条件（例）

- **`VehicleControl` 集約**:
    - 車両速度は常に物理的な制限（例：-5 m/s ～ +5 m/s）の範囲内にある。
    - ステアリング角度は常に機械的な制限（例：-540度 ～ +540度）の範囲内にある。
    - 制御コマンド (`ControlCommand`) を実行する際は、現在の `VehicleState` と安全ルールに基づいて実行可能か検証する。

---

## 📝 まとめ

このステップでは、第4・5巡のサービス分割をDDDの視点（境界づけられたコンテキスト）で再評価し、妥当であることを確認しました。

さらに、各コンテキストの中心的な役割を担う要素について、DDDの戦術パターン（集約、値オブジェクト、ドメインサービス）の観点から見直しました。

- **認識・経路計算コンテキスト**: 中心的な成果物 (`WorldModel`, `ParkingPlan`) は**値オブジェクト**（またはDTO）的であり、コアロジックは**ドメインサービス**が担うのが自然。
- **制御コンテキスト**: 車両の状態と制御の一貫性を管理する\*\*`VehicleControl` 集約\*\*が中心となる。

このようにDDDのパターンを適用することで、各コンテキストのモデルがより明確になり、責務分担がより洗練されます。

---

## ➡️ 次へ

次は、これらのコンテキスト（特に制御コンテキスト）内部で使われる「**(Step 3) 値オブジェクトとエンティティの洗練**」に進み、`VehicleState` や `ActuatorCommand` などを具体的に設計していきましょう。