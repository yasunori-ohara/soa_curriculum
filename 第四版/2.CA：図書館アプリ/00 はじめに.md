# 00 はじめに

# 📚 はじめに：シンプルな図書館の貸出管理システム

TODOアプリより一歩進んで、ビジネスルールをより豊かに扱える題材として
**「シンプルな図書館の貸出管理システム」** を構築していきます。

---

## 🌟 この題材が優れている理由

### 1. 状態を持つリッチな Entity

TODO の `Task` は「完了 / 未完了」しか状態を持ちませんでしたが、
図書館の `Book` は「貸出可能」「貸出中」「紛失中」などの複数の状態を持ちます。

さらに、「本」と「会員」の関係を表す `Loan`（貸出記録）という Entity は
**業務の中心ロジック（貸出・返却・延滞）** を担う重要な存在です。

> → Entity 自身が状態遷移を管理する（`book.check_out()` など）点が学習効果大です。

---

### 2. 複雑な Use Case を扱う

「本を貸し出す」ユースケースには：

* 会員の資格確認
* 本の在庫状態チェック
* `Loan` エンティティの生成と返却期限の算出
* 関連する `Book`・`Loan` の永続化

といった実務に近い流れが含まれます。
これにより、**UseCase と Entity の役割の違い**がより鮮明になります。

---

### 3. 「依存性の方向」がより体感できる

UI（司書が操作する画面）やDB（PostgreSQLなど）といった**技術的な詳細（外側）**が、
**ビジネスルール（内側）** に影響を及ぼさないように設計します。

* `Loan` や `Book` が DB に直接触らない
* UseCase が抽象的な `Repository` にのみ依存する

これが **依存性逆転の原則（DIP）** の具体例です。

---

## 🧩 クリーンアーキテクチャの登場人物

![クリーンアーキテクチャ](../クリーンアーキテクチャ・クラス図.png)

| 層                | クラス / インターフェース               | 役割                       | 層の位置                                                     |
| ---------------- | ---------------------------- | ------------------------ | -------------------------------------------------------- |
| **Entities**     | `Book`                       | 書籍。貸出状態を持ち、状態遷移ロジックを備える  | core/domain                                              |
|                  | `Member`                     | 会員。資格や貸出制限などのロジックを持つ     | core/domain                                              |
|                  | `Loan`                       | 貸出記録。どの本を誰にいつ貸したかを管理     | core/domain                                              |
| **UseCase層 DTO** | `CheckOutBookInputData`      | Controller→UseCase 間のデータ | core/usecase/boundary/dto.py                             |
|                  | `CheckOutBookOutputData`     | UseCase→Presenter 間のデータ  | core/usecase/boundary/dto.py                             |
| **Boundaries**   | `CheckOutBookInputBoundary`  | UseCase の入力ポート           | core/usecase/boundary/input_boundary.py                  |
|                  | `CheckOutBookOutputBoundary` | UseCase の出力ポート           | core/usecase/boundary/output_boundary.py                 |
| **Repositories** | `BookRepository`             | 書籍永続化の抽象I/F              | core/domain/repository.py                                |
|                  | `MemberRepository`           | 会員永続化の抽象I/F              | core/domain/repository.py                                |
|                  | `LoanRepository`             | 貸出記録永続化の抽象I/F            | core/domain/repository.py                                |
| **UseCase**      | `CheckOutBookInteractor`     | 「本を貸し出す」ユースケースの本体        | core/usecase/interactor/checkout_book.py                 |
| **Adapters**     | `CheckOutBookController`     | UI入力をUseCaseに渡す          | interface_adapters/controllers/book_controller.py        |
|                  | `CheckOutBookPresenter`      | 出力データを ViewModel に整形     | interface_adapters/presenters/book_presenter.py          |
|                  | `InMemoryBookRepository`     | Repositoryのメモリ実装         | infrastructure/repositories/in_memory_book_repository.py |

---

## 📁 フォルダ構成

```text
clean_architecture_library/
├─ core/
│   ├─ domain/
│   │   ├─ book.py
│   │   ├─ member.py
│   │   ├─ loan.py
│   │   ├─ repository.py
│   │   └─ errors.py
│   │
│   └─ usecase/
│       ├─ interactor/
│       │   └─ checkout_book.py
│       └─ boundary/
│           ├─ input_boundary.py
│           ├─ output_boundary.py
│           └─ dto.py
│
├─ interface_adapters/
│   ├─ controllers/
│   │   └─ book_controller.py
│   ├─ presenters/
│   │   └─ book_presenter.py
│   └─ views/
│       ├─ view_console.py
│       ├─ view_web.py
│       └─ view_gui.py
│
├─ infrastructure/
│   └─ repositories/
│       ├─ in_memory_book_repository.py
│       ├─ in_memory_member_repository.py
│       ├─ in_memory_loan_repository.py
│       └─ postgres_book_repository.py
│
├─ tests/
│   ├─ unit/
│   │   ├─ test_checkout_book_usecase.py
│   │   ├─ test_controller.py
│   │   ├─ test_presenter.py
│   │   └─ test_repository_inmemory.py
│   └─ conftest.py
│
├─ logs/
│   └─ app.log
│
└─ main.py
```

> この構成は第1巡(ToDoアプリ)と全く同じ層構造です。
> **ドメインが変わっても、アーキテクチャは変わらない** ― これが教材の狙いです。

---

## 🚀 シナリオ：「本の貸出」フロー

1. `CheckOutBookController` が `member_id` と `book_id` を受け取る
2. UseCase (`CheckOutBookInteractor`) が `MemberRepository` と `BookRepository` を用いて対象を検索
3. `Member` の資格確認、`Book` の状態確認を行う
4. 問題なければ `Loan` エンティティを生成し、返却期限を設定
5. `Book` の状態を `check_out()` で更新（貸出中へ）
6. 変更された `Book` と `Loan` をそれぞれの `Repository` 経由で永続化
7. 結果を `CheckOutBookOutputData` に詰め、`CheckOutBookPresenter` に渡す
8. PresenterがViewModelを更新し、Viewが画面に反映する

→ ここで一度もDB・UIに直接依存しません。
「ビジネスロジックだけで動く」＝テストが容易な構造です。

---

## 💡 ユニットテストの例（責務を守っていることを確認）

```python
def test_貸出が成功するシナリオ():
    # Arrange
    mock_book_repo = MockBookRepository(貸出可能な本)
    mock_member_repo = MockMemberRepository(有効な会員)
    mock_loan_repo = MockLoanRepository()
    mock_presenter = MockPresenter()

    interactor = CheckOutBookInteractor(
        book_repo=mock_book_repo,
        member_repo=mock_member_repo,
        loan_repo=mock_loan_repo,
        presenter=mock_presenter,
    )

    # Act
    input_data = CheckOutBookInputData(member_id="M001", book_id="B001")
    interactor.execute(input_data)

    # Assert
    assert mock_book_repo.last_saved.status == "貸出中"
    assert mock_loan_repo.saved_count == 1
    assert mock_presenter.last_output.success is True
```

---

## 🧠 PythonとC言語の対比

| 観点              | Python版（OOP）           | C言語版（手続き型）        |
| --------------- | ---------------------- | ----------------- |
| データとロジック        | `Book` クラスが自分で状態遷移     | 構造体 + 関数で別々管理     |
| 呼び出し            | `book.check_out()`     | `check_out(book)` |
| クリーンアーキテクチャでの狙い | **Entityが自律する**ことで保守容易 | **関数が外部に依存**しがち   |

---

## 🎯 まとめ

この図書館アプリは、次のような学習ゴールを意識しています。

* Entity にビジネスロジック（状態遷移）を持たせる設計を体得
* UseCase が複数の Repository を統合する流れを理解
* Presenter / Controller / Repository がどう「境界」で連携するかを確認
* 技術詳細（DBやUI）を差し替えてもビジネスロジックが壊れない構造を実感

