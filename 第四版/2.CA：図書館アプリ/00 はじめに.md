# 00 はじめに

# 📚 はじめに：シンプルな図書館の貸出管理システム

TODOアプリより一歩進んで、ビジネスルールをより豊かに扱える題材として
**「シンプルな図書館の貸出管理システム」** を構築していきます。

---

## 🌟 この題材が優れている理由

### 1. 状態を持つリッチな Entity

TODO の `Task` は「完了 / 未完了」でしたが、図書館の `Book` は「貸出可能」「貸出中」「紛失中」など複数の状態を持ちます。
さらに「本」と「会員」の関係を表す `Loan`（貸出記録）は、**業務の中心ロジック（貸出・返却・延滞）** を担う重要な存在です。

> → **Entity 自身が状態遷移を管理**（例：`book.check_out()`）する設計を体感できます。

---

### 2. 複雑な Use Case を扱う

「本を貸し出す」ユースケースには：

* 会員の資格確認
* 本の在庫状態チェック
* `Loan` の生成と返却期限の算出
* 関連する `Book`・`Loan` の永続化

といった実務に近い流れが含まれます。これにより、**UseCase と Entity の役割の違い**がより鮮明になります。

---

### 3. 「依存性の方向」を体感する

UI（司書画面）やDB（PostgreSQLなど）といった**技術的な詳細（外側）**が、**ビジネスルール（内側）**に影響しない設計にします。

* `Loan` や `Book` は DB に直接触らない
* UseCase は抽象的な `Repository` にのみ依存する

これは **依存性逆転の原則（DIP）** の具体例です。

---

## 🧩 クリーンアーキテクチャの登場人物

![クリーンアーキテクチャ](../クリーンアーキテクチャ・クラス図.png)

| 層                 | クラス / インターフェース               | 役割                      | 層の位置                                              |
| ----------------- | ---------------------------- | ----------------------- | ------------------------------------------------- |
| **Entities**      | `Book`                       | 書籍。貸出状態を持ち、状態遷移ロジックを備える | core/domain                                       |
|                   | `Member`                     | 会員。資格や貸出制限などのロジック       | core/domain                                       |
|                   | `Loan`                       | 貸出記録。どの本を誰にいつ貸したかを管理    | core/domain                                       |
| **DTO（UseCase層）** | `CheckoutBookInputData`      | Controller→UseCase のデータ | core/usecase/boundary/dto.py                      |
|                   | `CheckoutBookOutputData`     | UseCase→Presenter のデータ  | core/usecase/boundary/dto.py                      |
| **Boundaries**    | `CheckoutBookInputBoundary`  | UseCase の入力ポート          | core/usecase/boundary/input_boundary.py           |
|                   | `CheckoutBookOutputBoundary` | UseCase の出力ポート          | core/usecase/boundary/output_boundary.py          |
| **Repositories**  | `BookRepository`             | 書籍永続化の抽象I/F             | core/domain/repository.py                         |
|                   | `MemberRepository`           | 会員永続化の抽象I/F             | core/domain/repository.py                         |
|                   | `LoanRepository`             | 貸出記録永続化の抽象I/F           | core/domain/repository.py                         |
| **UseCase**       | `CheckoutBookInteractor`     | 「本を貸し出す」ユースケース本体        | core/usecase/interactor/checkout_book.py          |
| **Adapters**      | `CheckoutBookController`     | UI入力をUseCaseに渡す         | interface_adapters/controllers/book_controller.py |
|                   | `CheckoutBookPresenter`      | 出力を ViewModel に整形       | interface_adapters/presenters/book_presenter.py   |
|                   | `InMemory*Repository`        | Repositoryのメモリ実装        | infrastructure/repositories/*                     |

---

## 📁 フォルダ構成

```text
clean_architecture_library/
├─ core/
│   ├─ domain/
│   │   ├─ book.py
│   │   ├─ member.py
│   │   ├─ loan.py
│   │   ├─ repository.py
│   │   └─ errors.py
│   │
│   └─ usecase/
│       ├─ interactor/
│       │   └─ checkout_book.py
│       └─ boundary/
│           ├─ input_boundary.py
│           ├─ output_boundary.py
│           └─ dto.py
│
├─ interface_adapters/
│   ├─ controllers/
│   │   └─ book_controller.py
│   ├─ presenters/
│   │   └─ book_presenter.py
│   └─ views/
│       ├─ view_console.py
│       ├─ view_web.py
│       └─ view_gui.py
│
├─ infrastructure/
│   └─ repositories/
│       ├─ in_memory_book_repository.py
│       ├─ in_memory_member_repository.py
│       ├─ in_memory_loan_repository.py
│       ├─ postgres_book_repository.py
│       ├─ postgres_member_repository.py
│       └─ postgres_loan_repository.py
│
├─ tests/
│   └─ unit/
│       ├─ test_checkout_book_usecase.py
│       ├─ test_controller.py
│       ├─ test_presenter.py
│       ├─ test_in_memory_book_repository.py
│       ├─ test_in_memory_member_repository.py
│       └─ test_in_memory_loan_repository.py
│
└─ main.py
```

> 第1巡（TODO）と**全く同じ層構造**です。
> **ドメインが変わってもアーキテクチャは変わらない** ― これが教材の狙いです。

---

## 🚀 シナリオ：「本の貸出」フロー

1. `CheckoutBookController` が `member_id` と `book_id` を受け取る
2. UseCase（`CheckoutBookInteractor`）が `MemberRepository` と `BookRepository` で対象を検索
3. `Member` の資格確認、`Book` の状態確認
4. 問題なければ `Loan` を生成し、返却期限を設定
5. `book.check_out()` で `Book` を「貸出中」に状態遷移
6. 変更された `Book` と `Loan` を各 `Repository` 経由で永続化（※後章でトランザクション境界を扱います）
7. 結果を `CheckoutBookOutputData` に詰め、`CheckoutBookPresenter` に渡す
8. Presenter が ViewModel を更新し、View が画面に反映

→ **DB・UIに直接依存しない**ため、ビジネスロジックだけで動作確認・テストが容易です。

---

## 💡 ユニットテストの例（責務の検証）

```python
def test_貸出が成功するシナリオ():
    # Arrange
    mock_book_repo = MockBookRepository(貸出可能な本)
    mock_member_repo = MockMemberRepository(有効な会員)
    mock_loan_repo = MockLoanRepository()
    mock_presenter = MockPresenter()

    interactor = CheckoutBookInteractor(
        book_repo=mock_book_repo,
        member_repo=mock_member_repo,
        loan_repo=mock_loan_repo,
        presenter=mock_presenter,
    )

    # Act
    input_data = CheckoutBookInputData(member_id="M001", book_id="B001")
    interactor.execute(input_data)

    # Assert
    assert mock_book_repo.last_saved.status == "貸出中"
    assert mock_loan_repo.saved_count == 1
    assert mock_presenter.last_output.success is True
```

---

## 🧠 Python と C の対比（復習）

| 観点         | Python版（OOP）        | C言語版（手続き型）        |
| ---------- | ------------------- | ----------------- |
| データとロジック   | `Book` が自分で状態遷移     | 構造体 + 関数で別管理      |
| 呼び出し       | `book.check_out()`  | `check_out(book)` |
| クリーンアーキの狙い | **Entityが自律** →保守容易 | **関数が外部に依存**しがち   |

---

## 🎯 まとめ（学習ゴール）

* **Entity にビジネスロジック（状態遷移）** を持たせる設計を体得
* **UseCase が複数 Repository を統合**する流れを理解
* **Presenter / Controller / Repository が境界で連携**する様子を確認
* **技術詳細（DBやUI）を差し替えても壊れない**構造を実感


