# 6. ドメインイベント

# 🏛️ 戦術的設計：ドメインイベント

DDD（ドメイン駆動設計）の戦術的設計において、「**ドメインイベント (Domain Event)**」は、ドメイン（ビジネス領域）内で**過去に発生した重要な出来事**をモデル化するためのパターンです。これにより、ドメインモデル内の異なる部分を**疎結合**に保つことができます。

---

## ❓ ドメインイベントとは？

> ドメインにおいて意味のある何かが起こったことを示すオブジェクト。イベントは過去の出来事を表すため、不変（Immutable）である。
> 

### 💡 簡単に言うと

ドメイン内で起きた「**ニュース速報**」や「**出来事の記録**」のようなものです。「注文が確定した」「商品の価格が変更された」「駐車計画が計算された」といった、ビジネス上意味のある事実を表します。

### 🤔 なぜ重要か？

ドメインイベントを導入することで、特に副作用（ある出来事の結果として別の処理を行う必要がある場合）を扱う際に、モデルの結合度を下げることができます。

1. **関心の分離と疎結合**:
あるエンティティ（例：`Order`）の状態が変わったときに、それに関連する別の処理（例：`Shipment` の準備、`Notification` の送信）を `Order` エンティティ自身が直接呼び出すのではなく、`OrderPlaced` イベントを発行します。他の関心を持つ部分（`ShipmentHandler`, `NotificationHandler`）がそのイベントを購読（リッスン）し、それぞれの処理を実行します。これにより、`Order` は `Shipment` や `Notification` の存在を知る必要がなくなり、疎結合になります。
    
    ```
      [Order Aggregate] --(raises)--> [OrderPlaced Event]
                                         /       \
                             (listens)  /         \ (listens)
                                       v           v
                          [Shipment Handler]   [Notification Handler]
                             (副作用を実行)       (副作用を実行)
    
    ```
    
2. **時間的な分離 (Temporal Decoupling)**:
イベントを発行する側と、それに応答する側が、同時に存在したり、同じトランザクション内で処理を完了したりする必要がなくなります（イベントの実装方法によります）。
3. **境界づけられたコンテキスト間の連携**:
ドメインイベントは、異なる境界づけられたコンテキスト（サービス）間で情報を伝達する手段としても利用できます。（この場合、より広義の「統合イベント」や「アプリケーションイベント」と呼ばれることもあります）
4. **監査ログや分析**:
発生したドメインイベントを記録しておくことで、システムの監査ログやビジネス分析のための貴重なデータソースとなります。
5. **イベントソーシング (Event Sourcing) の基盤**:
（これは高度なパターンですが）エンティティの現在の状態を直接保存する代わりに、そのエンティティで発生した一連のドメインイベントを全て保存し、必要に応じてイベントを再生して状態を復元するというアーキテクチャパターンの基礎となります。

---

## ✅ これまでの実践例（どこで使ったか）

私たちは、ドメインイベントを**明示的には**モデル化・実装しませんでした。しかし、サービス間連携のMQTTメッセージはその考え方に近いです。

### 📌 サービス間連携 (第5巡)

- **具体例**: 認識サービスが `WorldModel` をMQTTでPublishし、経路計算サービスがそれをSubscribeしました。経路計算サービスが `ParkingPlan` をPublishし、制御サービスがSubscribeしました。
- **実践**: これらは、あるサービス（ドメイン）で「何か（データ更新）」が起こったことを、別のサービス（ドメイン）に通知する、広義の**イベント通知**と見なすことができます。ただし、厳密なDDDのドメインイベントは、通常、**単一の境界づけられたコンテキスト内部**での出来事をモデル化し、その副作用を処理するために使われます。サービス間連携で使われるものは、「**統合イベント (Integration Event)**」や「**アプリケーションイベント (Application Event)**」として区別されることが多いです。

---

## ❌ 間違った適用例（アンチパターン）

ドメインイベントは強力ですが、誤用するとシステムの複雑さを増す可能性があります。

- **例1：イベントをリクエスト/レスポンスのように使う**
イベントは「過去に起こったこと」の通知であり、発行元が応答を期待すべきではありません。もし応答が必要なら、それはイベントではなく、コマンド（命令）やクエリ（問い合わせ）としてモデル化すべきです（例：CQRSパターン）。
- **例2：イベントハンドラ内で元の集約をさらに変更する**`OrderPlaced` イベントを受け取ったハンドラが、そのイベントを発行した `Order` 集約の状態を直接変更しようとするのは、通常アンチパターンです。これはトランザクションの管理を複雑にし、集約の一貫性を損なう可能性があります。副作用は、別の集約の状態を変更するか、外部システムと連携する形で行うのが一般的です。
- **例3：イベントに過剰なデータを含める**
イベントは「何が起こったか」を示すための最小限の識別情報（例：`OrderId`）と、場合によっては関連する少量のデータを含むべきです。イベントを受け取った側が、詳細な情報が必要であれば、そのIDを使ってリポジトリなどから改めて取得するのが良い場合が多いです（特に統合イベントの場合）。イベント自体に巨大なデータを含めると、ペイロードが大きくなり、パフォーマンスに影響する可能性があります。
- **例4：ドメイン的に意味のないイベント**`UserEmailUpdated` は意味のあるドメインイベントですが、`UserRecordSavedToDatabase` は実装の詳細であり、ドメインイベントではありません。イベントはビジネス（ドメイン）の言葉で語られるべきです。

---

## 📝 まとめ

ドメインイベントは、「**ドメイン内で発生した重要な過去の出来事**」をモデル化し、システムの**疎結合性**を高めるためのパターンです。

- **過去形**で命名する（例: `OrderPlaced`）。
- **不変**である。
- 副作用のトリガーとして使い、関心を分離する。

適切に使うことで、ドメインモデルの異なる部分や、異なる境界づけられたコンテキストを、柔軟かつ効果的に連携させることができます。

---

## ➡️ 次へ

次は、特定のエンティティや値オブジェクトに属さないドメインロジックを扱うための「**ドメインサービス (Domain Service)**」について見ていきましょう。