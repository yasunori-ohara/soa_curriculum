# 02 集約の発見と境界設定

# ステップ２：集約の発見と境界設定 🧱

Step 1 でユビキタス言語（候補）を洗い出し、ドメインの概要を掴みました。このステップでは、このドメインにおける中心的な**集約 (Aggregate)** とその**境界**、そして守るべき**不変条件 (Invariants)** を見つけ出します。

## 🤔 集約とは？（復習）

- 関連するエンティティと値オブジェクトの**まとまり**。
- データ変更における**一貫性**の単位。
- 外部からのアクセスは**集約ルート (Aggregate Root)** を通じてのみ行う。

**ポイント**: 状態を持ち、その状態の一貫性を保つ責任を持つ「モノ」を探します。

---

## 🧭 候補の検討

Step 1 で挙げた主な概念候補を見てみましょう。

- **車線モデル (LaneModel)**: センサーからの入力データ。状態を持つというより「観測結果」。➡️ **値オブジェクト**候補。
- **車両状態 (VehicleState)**: 自車の物理的な状態。これも「観測結果」。➡️ **値オブジェクト**候補。
- **車線内相対位置 (LaneRelativePosition)**: `LaneModel` と `VehicleState` から計算される値。➡️ **値オブジェクト**候補。
- **逸脱状態 (DepartureState)**: `LaneRelativePosition` から判断される状態。➡️ **値オブジェクト**または**Enum**候補。
- **システム状態 (SystemStatus)**: システムが作動中か、警告のみか、介入中かなどの状態。これはIDを持つ「モノ」の状態ではなさそうですが、システム全体の重要な状態です。
- **警告要求 (WarningRequest)**: システムからの出力。➡️ **値オブジェクト**候補。
- **操舵トルク要求 (SteeringTorqueRequest)**: システムからの出力。➡️ **値オブジェクト**候補。

これらの候補を見ると、IDを持ちライフサイクルを通じて状態が変わるような明確な「主役級エンティティ」が見当たりにくいです。しかし、「**車線逸脱防止支援システム**」**そのもの**が、`SystemStatus` という内部状態を持ち、入力（`LaneModel`, `VehicleState`）に基づいて判断を行い、出力（`WarningRequest`, `SteeringTorqueRequest`）を生成する、一連の責任を持つ単位と考えられます。

---

## 🧭 集約の決定（案）

このドメインでは、システム全体を一つの**集約**としてモデル化するのが自然かもしれません。

1. **`LaneKeepingAssist` 集約**:
    - **ルート**: `LaneKeepingAssist` (Entity)。識別子はこのシステムが搭載される**車両 (`VehicleID`)** に紐づくかもしれません（車ごとに一つのシステム）。あるいは、システム自体のインスタンスIDを持つかもしれません。
    - **内部**: 現在の `SystemStatus` (VO/Enum)、各種設定値（警告閾値、介入強度など - VO）、計算された中間状態（`LaneRelativePosition`, `DepartureState` - VO）。
    - **責務**:
        - システムの有効/無効状態 (`SystemStatus`) を管理する。
        - `LaneModel` と `VehicleState` を入力として受け取る。
        - `LaneRelativePosition` と `DepartureState` を計算する。
        - `DepartureState` と `SystemStatus` に基づいて、警告 (`WarningRequest`) や操舵介入 (`SteeringTorqueRequest`) が必要かを判断する。
        - 自身の `SystemStatus` を適切に遷移させる（例：ドライバー操作で一時停止 `SUPPRESSED` にするなど）。

```
 +-------------------------------------+
 |    LaneKeepingAssist Aggregate      |
 | +---------------------------------+ |
 | | LaneKeepingAssist (Root Entity) | |
 | | - vehicleId (or systemId)       | |
 | | - systemStatus (VO/Enum)        | |  <-- Internal State
 | | - warningThreshold (VO)         | |
 | | - interventionStrength (VO)     | |
 | |                                 | |
 | | + updateState(LaneModel,        | |  <-- Main Behavior
 | |               VehicleState)     | |      (Returns Warning/Torque Requests?)
 | |                                 | |
 | | + activate()                    | |  <-- State Transitions
 | | + deactivate()                  | |
 | | + suppressByDriver()            | |
 | +---------------------------------+ |
 +-------------------------------------+
    |                 |                 |
    Input:            Calculates:       Output:
    LaneModel (VO)    LaneRelPos (VO)   WarningRequest (VO)
    VehicleState (VO) DepartureState(VO) SteeringTorqueRequest (VO)

```

---

## 🧭 境界と不変条件

- **集約境界**: `LaneKeepingAssist` 集約は、システムの作動状態 (`SystemStatus`) と、それに関連する判断ロジック（いつ警告し、いつ介入するか）の一貫性を保つ責任を持ちます。
- **不変条件 (例)**:
    - `SystemStatus` は、定義された状態（`INACTIVE`, `ACTIVE_...`, `SUPPRESSED`, `FAULT`）のいずれかでなければならない。
    - `SystemStatus` が `INACTIVE` や `FAULT` のときは、警告や介入要求を生成してはならない。
    - 操舵介入は、`SystemStatus` が `ACTIVE_ASSISTING` の場合にのみ行われる。
    - 警告の閾値や介入強度の設定値は、常に妥当な範囲内にある。

---

## 📝 まとめ

このステップでは、車線逸脱防止支援システムのドメインにおける中心的な概念として、「**`LaneKeepingAssist` 集約**」を特定しました。

多くの入力データ (`LaneModel`, `VehicleState`) や計算結果 (`LaneRelativePosition` など) は**値オブジェクト**として扱うのが適切であり、システム全体の**状態 (`SystemStatus`)** と**振る舞い**（状態遷移、判断ロジック）を\*\*`LaneKeepingAssist` 集約\*\*がカプセル化する、というモデルを考えました。

この集約が、システムの動作の一貫性を保つための境界となります。

---

## ➡️ 次へ

次は、この集約内部で使われる主要な「**(Step 3) 値オブジェクトとエンティティの洗練**」に進み、`LaneRelativePosition`, `DepartureState`, `SystemStatus` などを具体的に設計していきましょう。