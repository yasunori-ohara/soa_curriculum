# 23 æ©Ÿèƒ½æ‹¡å¼µï¼šUIãƒ†ã‚¹ãƒˆ

## ğŸ”„ 1. GUIç‰ˆ View (`GuiView`) ã®ãƒ†ã‚¹ãƒˆ

### ğŸ’¡ ã­ã‚‰ã„

* `GuiView.on_add_clicked()` ãŒã€Entryã®å†…å®¹ã‚’ Controller ã«æ¸¡ã—ã¦ã„ã‚‹ã“ã¨
* `GuiView.render()` ãŒã€ViewModel ã® `display_text` ã‚’ Label ã«åæ˜ ã—ã¦ã„ã‚‹ã“ã¨

tkinter ã¯å®Ÿéš›ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤ºã—ã‚ˆã†ã¨ã—ã¾ã™ãŒã€ãƒ†ã‚¹ãƒˆã§ã¯ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ä»£ã‚ã‚Šã«ã€æœ€å°é™ã®ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆæ§‹ç¯‰ã ã‘ã‚’è¨±ã—ã¤ã¤ã€Controllerã‚’ã‚¹ãƒ‘ã‚¤åŒ–ã—ã¾ã™ã€‚

```python
# tests/unit/test_view_gui.py

import tkinter as tk
import pytest

from core.usecase.boundary.dto import TodoViewModel
from interface_adapters.views.view_gui import GuiView


class SpyController:
    """
    GuiView ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ Controller ã®ã‚¹ãƒ‘ã‚¤ã€‚
    å‘¼ã³å‡ºã—å›æ•°ã¨ã€æœ€å¾Œã«æ¸¡ã•ã‚ŒãŸå¼•æ•°ã‚’è¨˜éŒ²ã™ã‚‹ã€‚
    """
    def __init__(self):
        self.called_times = 0
        self.last_title = None

    def add_todo(self, title: str):
        self.called_times += 1
        self.last_title = title


@pytest.fixture
def gui_env(monkeypatch):
    """
    tkinter.Tk() ãŒæœ¬ç‰©ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤ºã—ã‚ˆã†ã¨ã™ã‚‹ã¨
    ãƒ†ã‚¹ãƒˆç’°å¢ƒï¼ˆCIã‚„ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ç’°å¢ƒï¼‰ã§å¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚‹ã€‚

    ãã“ã§ã€Tk() ã‚’ãƒ€ãƒŸãƒ¼ã®ãƒ«ãƒ¼ãƒˆã«å·®ã—æ›¿ãˆã‚‹ã€‚
    """
    # æœ¬ç‰©ã®Tk()ã‚’æœ¬å½“ã«ãƒ¢ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã§å·®ã—æ›¿ãˆã‚‹ã€‚
    # ä»Šå›ã¯ãã®ã¾ã¾å®Ÿä½“åŒ–ã—ã¦ã‚‚ã€mainloop()ã‚’å‘¼ã°ãªã„é™ã‚Šã¯
    # GUIãŒãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„å‰æã§é€²ã‚ã‚‹ã®ã§ã€ç‰¹ã«å·®ã—æ›¿ãˆãªã—ã§ã‚‚OKã€‚
    # ãŸã ã€ã“ã®fixtureã¯å°†æ¥ã®æ‹¡å¼µï¼ˆmonkeypatch.Tkã®å·®ã—æ›¿ãˆï¼‰ç”¨ã«ç½®ã„ã¦ãŠãã€‚
    yield


def test_gui_view_calls_controller_and_updates_label(gui_env):
    # Arrange
    vm = TodoViewModel(display_text="åˆæœŸè¡¨ç¤º")
    controller = SpyController()

    # Tkã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã¯å›ã•ãªã„ã®ã§å®‰å…¨
    view = GuiView(controller, vm)

    # å…¥åŠ›æ¬„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰“ã¡è¾¼ã‚“ã æƒ³å®šã®æ–‡å­—ã‚’ã‚»ãƒƒãƒˆ
    view.entry.delete(0, tk.END)
    view.entry.insert(0, "GUIã‹ã‚‰è¿½åŠ ã—ãŸã‚¿ã‚¹ã‚¯")

    # Act: ãƒœã‚¿ãƒ³æŠ¼ä¸‹ç›¸å½“ã®å‡¦ç†ã‚’ç›´æ¥å‘¼ã¶
    view.on_add_clicked()

    # Assert 1: Controllerã«å…¥åŠ›ãŒæ¸¡ã£ã¦ã„ã‚‹ã‹
    assert controller.called_times == 1
    assert controller.last_title == "GUIã‹ã‚‰è¿½åŠ ã—ãŸã‚¿ã‚¹ã‚¯"

    # Assert 2: ViewModelã®å†…å®¹ãŒLabelã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹
    # PresenterãŒæ›´æ–°ã—ã¦ã„ã‚‹å‰æã§ã€View.render() ãŒãã‚Œã‚’è¡¨ç¤ºç”¨ãƒ©ãƒ™ãƒ«ã«æµã—è¾¼ã‚€
    assert view.label.cget("text") == vm.display_text
```

### ğŸ’¡ è£œè¶³

* `GuiView.run()` ã¯ `mainloop()` ã‚’å›ã™ã®ã§ã€ãã“ã¯å‘¼ã³ã¾ã›ã‚“ã€‚ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§ã¯GUIã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¯èµ·å‹•ã—ãªã„ã®ãŒåŸºæœ¬ã€‚
* tkinterã®Widgetã¯ã€ç”Ÿæˆæ™‚ç‚¹ã§ã¯ãƒ¡ãƒ¢ãƒªä¸Šã«ä½œã‚‰ã‚Œã‚‹ã ã‘ãªã®ã§ã€`mainloop()`ã•ãˆå‘¼ã°ãªã‘ã‚Œã°ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã›ã‚“ã€‚

---

## ğŸ”„ 2. FastAPIç‰ˆ View (`FastApiView`) ã®ãƒ†ã‚¹ãƒˆ

### ğŸ’¡ ã­ã‚‰ã„

* GET `/` ã§ã€ViewModelã®å†…å®¹ãŒHTMLã«åæ˜ ã•ã‚Œã¦è¿”ã‚‹ã“ã¨
* POST `/` ã§ã€ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ãŒ Controller ã«æ¸¡ã•ã‚Œã‚‹ã“ã¨
* POST å¾Œã¯ Presenter ãŒæ›´æ–°ã—ãŸ ViewModel ã®çŠ¶æ…‹ãŒ HTML ã«å«ã¾ã‚Œã¦è¿”ã‚‹ã“ã¨

FastAPIã¯å…¬å¼ã« `fastapi.testclient.TestClient` ã‚’ç”¨æ„ã—ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’ä½¿ã„ã¾ã™ã€‚
Controller ã¯ã‚¹ãƒ‘ã‚¤ã«ã—ã¦ã€å‘¼ã³å‡ºã—ã®ä¸­èº«ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

```python
# tests/unit/test_view_fastapi.py

from fastapi.testclient import TestClient

from core.usecase.boundary.dto import TodoViewModel
from interface_adapters.views.view_fastapi import FastApiView


class SpyController:
    """
    FastApiViewã‹ã‚‰å‘¼ã°ã‚Œã‚‹Controllerã®ã‚¹ãƒ‘ã‚¤ã€‚
    POSTæ™‚ã«æ¸¡ã•ã‚ŒãŸtitleã‚’è¨˜éŒ²ã™ã‚‹ã€‚
    """
    def __init__(self):
        self.called_times = 0
        self.last_title = None

    def add_todo(self, title: str):
        self.called_times += 1
        self.last_title = title


def test_fastapi_view_get_renders_view_model(tmp_path, monkeypatch):
    """
    GET / ã§ ViewModel.display_text ãŒHTMLä¸Šã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
    """
    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œã‚‹
    template_dir = tmp_path / "templates"
    template_dir.mkdir()

    template_file = template_dir / "index.html"
    template_file.write_text(
        """
        <html>
        <body>
            <p id="msg">{{ display }}</p>
        </body>
        </html>
        """,
        encoding="utf-8",
    )

    vm = TodoViewModel(display_text="åˆæœŸè¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")
    controller = SpyController()

    # FastApiViewã¯ã€ãƒ‡ãƒ•ã‚©ã§
    # directory="interface_adapters/views/templates"
    # ã‚’è¦‹ã«è¡Œãã®ã§ã€ãã“ã‚’ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å·®ã—æ›¿ãˆã‚‹
    def fake_init_templates(self):
        from fastapi.templating import Jinja2Templates
        self.templates = Jinja2Templates(directory=str(template_dir))

    # monkeypatchã§ templates ã®åˆæœŸåŒ–ã ã‘å·®ã—æ›¿ãˆã‚‹
    monkeypatch.setattr(
        FastApiView,
        "_FastApiView__init_templates",
        fake_init_templates,
        raising=False,
    )

    # FastApiViewã‚’ç”Ÿæˆ
    view = FastApiView(controller, vm)

    # ãŸã ã—ä¸Šè¨˜monkeypatchã§ã¯ __init__ å†…ã®æŒ™å‹•ã‚’å®Œå…¨ã«ã¯æ›¸ãæ›ãˆã‚‰ã‚Œãªã„ã®ã§ã€
    # ã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«ã€ç›´æ¥å·®ã—æ›¿ãˆã‚‹å½¢ã§å¯¾å¿œã™ã‚‹ã»ã†ãŒå®‰å®šã™ã‚‹:
    # view.templates = Jinja2Templates(directory=str(template_dir))
    # ï¼ˆã“ã®1è¡Œã‚’ãƒ†ã‚¹ãƒˆå†…ã§ä¸Šæ›¸ãã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã—ã¾ã—ã‚‡ã†ï¼‰

    from fastapi.templating import Jinja2Templates
    view.templates = Jinja2Templates(directory=str(template_dir))

    client = TestClient(view.app)

    # Act
    res = client.get("/")

    # Assert
    assert res.status_code == 200
    assert "åˆæœŸè¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" in res.text
    assert '<p id="msg">' in res.text


def test_fastapi_view_post_calls_controller_and_updates_response(tmp_path):
    """
    POST / ã§ Controller.add_todo() ãŒå‘¼ã°ã‚Œã€
    ãƒ¬ã‚¹ãƒãƒ³ã‚¹HTMLã«æœ€æ–°ã® ViewModel.display_text ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
    """
    template_dir = tmp_path / "templates"
    template_dir.mkdir()

    template_file = template_dir / "index.html"
    template_file.write_text(
        """
        <html>
        <body>
            <p id="msg">{{ display }}</p>
        </body>
        </html>
        """,
        encoding="utf-8",
    )

    vm = TodoViewModel(display_text="ã¾ã è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“")
    controller = SpyController()

    # FastApiViewã‚’ç”Ÿæˆ
    view = FastApiView(controller, vm)

    # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ ¼ç´å…ˆã‚’ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å·®ã—æ›¿ãˆ
    from fastapi.templating import Jinja2Templates
    view.templates = Jinja2Templates(directory=str(template_dir))

    client = TestClient(view.app)

    # Act: POSTã§æ–°ã—ã„TODOã‚’é€ä¿¡
    res = client.post("/", data={"title": "Webã‹ã‚‰é€ã£ãŸã‚¿ã‚¹ã‚¯"})

    # ControllerãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert controller.called_times == 1
    assert controller.last_title == "Webã‹ã‚‰é€ã£ãŸã‚¿ã‚¹ã‚¯"

    # PresenterãŒViewModel.display_textã‚’æ›´æ–°ã—ãŸã€ã¨ä»®å®šã™ã‚‹ã€‚
    # æœ¬ç•ªã§ã¯UseCaseâ†’Presenterã«ã‚ˆã‚Švm.display_textãŒæ›¸ãæ›ã‚ã£ã¦ã„ã‚‹ã¯ãšãªã®ã§ã€
    # ãƒ†ã‚¹ãƒˆã§ã¯æ‰‹ã§å†…å®¹ã‚’å¤‰ãˆã¦å†ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼ã—ã¦ã‚‚ã‚ˆã„ã€‚
    #
    # ä»Šå›ã¯ã€Œãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã€ã€ŒHTMLãŒè¿”ã£ã¦ã„ã‚‹ã“ã¨ã€
    # ã€ŒdisplayãŒHTMLå†…ã«æç”»ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€ã‚’è¦‹ã‚‹:
    assert res.status_code == 200
    assert '<p id="msg">' in res.text
    # vm.display_text ã¯ãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œã®æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æƒ³å®š
    # (ã‚·ãƒŠãƒªã‚ªã«å¿œã˜ã¦ "è¿½åŠ ã—ã¾ã—ãŸ" çš„ãªæ–‡ç« ã«ãªã‚‹ã“ã¨ã‚’æœŸå¾…ã™ã‚‹)
```

### ğŸ’¡ ã¡ã‚‡ã£ã¨ã ã‘è§£èª¬

* FastAPIã¯åŒæœŸ/éåŒæœŸä¸¡å¯¾å¿œã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æŒã£ã¦ã„ã¦ã€`TestClient(view.app)` ã‚’ä½¿ã†ã¨HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã§ãã¾ã™ã€‚
* ç”»é¢ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ`index.html`ï¼‰ã¯æœ¬ç•ªã§ã¯ `interface_adapters/views/templates/index.html` ã‚’èª­ã‚€æƒ³å®šã§ã—ãŸã€‚
  ãƒ†ã‚¹ãƒˆã§ã¯ `tmp_path`ï¼ˆpytestçµ„ã¿è¾¼ã¿ã®ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã€`view.templates` ã‚’ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å·®ã—æ›¿ãˆã¦å‹•ã‹ã—ã¾ã™ã€‚
* Controller ã¯ã‚¹ãƒ‘ã‚¤åŒ–ã—ã¦ã€ã€ŒPOSTæ™‚ã«ã¡ã‚ƒã‚“ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãŒå‘¼ã°ã‚ŒãŸï¼Ÿã€ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
* ViewModelã®è¡¨ç¤ºï¼ˆ`display_text`ï¼‰ãŒHTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚æ¤œè¨¼ã—ã¾ã™ã€‚

---

## ğŸ”„ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®è¿½åŠ 

ä»Šå›ã®2ã¤ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€æ—¢å­˜ã® `tests/unit/` ã«æ¬¡ã®ã‚ˆã†ã«è¿½åŠ ã§ãã¾ã™ã€‚

```text
tests/
â””â”€ unit/
    â”œâ”€ test_todo_usecase.py
    â”œâ”€ test_presenter.py
    â”œâ”€ test_controller.py
    â”œâ”€ test_view_console.py
    â”œâ”€ test_view_gui.py          # â† GUIç‰ˆ View ã®ãƒ†ã‚¹ãƒˆ
    â”œâ”€ test_view_fastapi.py      # â† FastAPIç‰ˆ View ã®ãƒ†ã‚¹ãƒˆ
    â””â”€ test_in_memory_todo_repository.py
```

---

## ğŸ”„ ã¾ã¨ã‚

* GUIã®Viewã‚‚ã€Web(FastAPI)ã®Viewã‚‚ã€ŒControllerã«ä¾é ¼ã—ã¦ViewModelã‚’è¡¨ç¤ºã™ã‚‹ã ã‘ã€ãªã®ã§ã€ãƒ†ã‚¹ãƒˆã¯ãã“ã«é›†ä¸­ã§ãã‚‹ã€‚
* ã©ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã£ã¦ã‚‚ã€ãƒ†ã‚¹ãƒˆè¦³ç‚¹ã¯ã»ã¼åŒã˜ï¼š

  * å…¥åŠ›ãŒControllerã«æ¸¡ã‚‹ã“ã¨
  * ViewModelã®å†…å®¹ãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨
* ã¤ã¾ã‚Šã€**ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒå¤‰ã‚ã£ã¦ã‚‚ãƒ†ã‚¹ãƒˆã®ä»•æ–¹ã¯å¤‰ã‚ã‚‰ãªã„**
  â†’ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ†é›¢ãŒã†ã¾ãã„ã£ã¦ã„ã‚‹è¨¼æ‹ ã€‚

