# 03 çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¢ãƒ€ãƒ—ã‚¿å·®ã—æ›¿ãˆ

# ğŸš€ ã‚¹ãƒ†ãƒƒãƒ—3ï¼šçµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¢ãƒ€ãƒ—ã‚¿å·®ã—æ›¿ãˆ (Subscriber & Publisher)

ç¬¬5å·¡ã®3ç•ªç›®ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚
ã€ŒçµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã€ã®ã€Œå…¥ã‚Šå£ã€ã¨ã€Œå‡ºå£ã€ã®ä¸¡æ–¹ã‚’ã€ãƒ•ã‚¡ã‚¤ãƒ«I/Oã‹ã‚‰MQTTã«å·®ã—æ›¿ãˆã¾ã™ã€‚

- **å…¥åŠ›**: `FileWorldModelSubscriber` â” `MqttWorldModelSubscriber`
- **å‡ºåŠ›**: `FilePlanPublisher` â” `MqttPlanPublisher`

---

## ğŸ¯ ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚´ãƒ¼ãƒ«

- çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã®UseCaseã‚„Entityã«ã¯**ä¸€åˆ‡è§¦ã‚Œãšã«**ã€å…¥åŠ›ãƒ»å‡ºåŠ›ã®ä¸¡ã‚¢ãƒ€ãƒ—ã‚¿ã‚’å·®ã—æ›¿ãˆã‚‹ã€‚
- `world_model.json` ã‚’**è³¼èª­ï¼ˆSubscribeï¼‰** ã—ã€`plan.json` ã‚’**å…¬é–‹ï¼ˆPublishï¼‰** ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã€‚

---

## ğŸ§© å¤‰æ›´ã®æ¦‚è¦

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å¤‰æ›´ãƒ»è¿½åŠ ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ **`adapters/` ãƒ•ã‚©ãƒ«ãƒ€**ã¨ **`main.py`** ã®ã¿ã§ã™ã€‚

- **`domain/entities.py`**: å¤‰æ›´ãªã—
- **`application/use_cases.py`**: å¤‰æ›´ãªã—
- **`application/boundaries.py`**: å¤‰æ›´ãªã—
- **`adapters/mqtt_subscriber.py`**: ğŸ‘ˆ **ï¼ˆæ–°è¦ä½œæˆï¼‰**
- **`adapters/mqtt_publisher.py`**: ğŸ‘ˆ **ï¼ˆæ–°è¦ä½œæˆï¼‰**
- **`adapters/file_...`**: ï¼ˆä¸è¦ã«ãªã‚‹ï¼‰
- **`adapters/repositories.py`**: å¤‰æ›´ãªã—
- **`main.py`**: ğŸ‘ˆ **ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨DIéƒ¨åˆ†ã‚’ä¿®æ­£ï¼‰**

---

## ğŸ› ï¸ æ‰‹é †1ï¼šMQTTã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆç¢ºèªï¼‰

ï¼ˆã‚¹ãƒ†ãƒƒãƒ—2ã§ `paho-mqtt` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã‚ã‚Œã°ã€ã“ã®æ‰‹é †ã¯ä¸è¦ã§ã™ã€‚ï¼‰

```bash
pip install paho-mqtt

```

---

## âš™ï¸ æ‰‹é †2ï¼šMqttWorldModelSubscriber ã®ä½œæˆ

`application/boundaries.py` ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ `WorldModelSubscriberInterface`ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã‚’å®Ÿè£…ã™ã‚‹ã€æ–°ã—ã„ã€Œå…¥åŠ›ã‚¢ãƒ€ãƒ—ã‚¿ã€ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã‚Œã¯MQTTã®ã€Œãƒ—ãƒƒã‚·ãƒ¥å‹ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒæ¥ãŸã‚‰é€šçŸ¥ï¼‰ã€ã®å‹•ä½œã‚’ã€UseCaseãŒè¦æ±‚ã™ã‚‹ã€Œãƒ—ãƒ«å‹ï¼ˆ`get_world_model()`ï¼‰ã€ã«å¤‰æ›ã™ã‚‹ã€é‡è¦ãªã‚¢ãƒ€ãƒ—ã‚¿ã§ã™ã€‚

```python
# adapters/mqtt_subscriber.py (çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹å†…ã«æ–°è¦ä½œæˆ)
import paho.mqtt.client as mqtt
import json
import asyncio
from domain.entities import WorldModel, DetectedObject, ParkingSpace # Entityå®šç¾©
from application.boundaries import WorldModelSubscriberInterface
from typing import Optional
from datetime import datetime

# -----------------------------------------------------------------------------
# Service Adapter Implementation (MQTT Subscriber)
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: ServiceAdapter
# - åŒå¿ƒå††å›³ã®ä½ç½®: Adapters (å¤–å´ã®å††)
# -----------------------------------------------------------------------------
class MqttWorldModelSubscriber(WorldModelSubscriberInterface):
    """
    UseCaseã®è¦æ±‚(I/F)ã«åŸºã¥ãã€MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã‹ã‚‰
    WorldModelã‚’è³¼èª­ï¼ˆSubscribeï¼‰ã™ã‚‹ã‚¢ãƒ€ãƒ—ã‚¿ã€‚
    """
    def __init__(self, broker_address: str, broker_port: int, topic: str):
        self._broker_address = broker_address
        self._broker_port = broker_port
        self._topic = topic

        # UseCaseã«æ¸¡ã™ãŸã‚ã®ã€æœ€æ–°ã®WorldModelã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        self._latest_world_model: Optional[WorldModel] = None

        # MQTTã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
        self._client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2)
        self._client.reconnect_delay_set(min_delay=1, max_delay=30)

        # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®è¨­å®š
        self._client.on_connect = self._on_connect
        self._client.on_disconnect = self._on_disconnect
        self._client.on_message = self._on_message # ğŸ‘ˆ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®é–¢æ•°

        # æ¥ç¶šã¨ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œ
        try:
            self._client.connect_async(self._broker_address, self._broker_port, 60)
            self._client.loop_start() # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å—ä¿¡å‡¦ç†ã‚’é–‹å§‹
        except Exception as e:
            print(f"[Adapter] MQTT Subscriber: Failed to connect initially: {e}")

    def _on_connect(self, client, userdata, flags, rc, properties=None):
        if rc == 0:
            print(f"[Adapter] MQTT Subscriber: Connected to broker at {self._broker_address}")
            # æ¥ç¶šæˆåŠŸæ™‚ã«ã€æŒ‡å®šã•ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯ã‚’è³¼èª­ï¼ˆSubscribeï¼‰ã™ã‚‹
            client.subscribe(self._topic)
            print(f"[Adapter] MQTT Subscriber: Subscribed to topic '{self._topic}'")
        else:
            print(f"[Adapter] MQTT Subscriber: Failed to connect, return code {rc}")

    def _on_disconnect(self, client, userdata, rc, properties=None):
        print(f"[Adapter] MQTT Subscriber: Disconnected from broker. Reconnecting...")

    def _on_message(self, client, userdata, msg):
        """
        [MQTT Push] ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹
        """
        try:
            print(f"[Adapter] MQTT Subscriber: Received message from topic '{msg.topic}'")
            payload = msg.payload.decode('utf-8')
            data = json.loads(payload)

            # JSONè¾æ›¸ã‹ã‚‰WorldModel Entityã«å¤‰æ›
            world_model = WorldModel(
                timestamp=datetime.fromisoformat(data["timestamp"]),
                # (â€» ãƒã‚¹ãƒˆã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¤‰æ›ã¯åˆ¥é€”å¿…è¦)
            )

            # å—ä¿¡ã—ãŸæœ€æ–°ã®WorldModelã‚’å†…éƒ¨ã«ä¿å­˜
            self._latest_world_model = world_model

        except json.JSONDecodeError:
            print("[Adapter] MQTT Subscriber: Failed to decode JSON message")
        except Exception as e:
            print(f"[Adapter] MQTT Subscriber: Error processing message: {e}")

    async def get_world_model(self) -> Optional[WorldModel]:
        """
        [UseCase Pull] UseCaseã‹ã‚‰å‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«ã€
        å†…éƒ¨ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹æœ€æ–°ã®WorldModelã‚’è¿”ã™
        """
        # UseCaseã¯éåŒæœŸI/Oï¼ˆawaitï¼‰ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ãŸã‚ã€
        # ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«åˆ¶å¾¡ã‚’æˆ»ã™ï¼ˆãŠä½œæ³•ï¼‰
        await asyncio.sleep(0)

        # _on_message ã§ä¿å­˜ã•ã‚ŒãŸæœ€æ–°ã®ãƒ¢ãƒ‡ãƒ«ã‚’è¿”ã™
        return self._latest_world_model

```

---

## âš™ï¸ æ‰‹é †3ï¼šMqttPlanPublisher ã®ä½œæˆ

æ¬¡ã«ã€`application/boundaries.py` ã® `PlanPublisherInterface` ã‚’å®Ÿè£…ã™ã‚‹ã€ã€Œå‡ºå£ã€ç”¨ã®ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚
ã“ã‚Œã¯ã‚¹ãƒ†ãƒƒãƒ—2ã§ä½œæˆã—ãŸ `MqttWorldModelPublisher` ã¨ã»ã¼åŒã˜ã§ã™ãŒã€å…¬é–‹ã™ã‚‹ãƒˆãƒ”ãƒƒã‚¯åãŒç•°ãªã‚Šã¾ã™ã€‚

```python
# adapters/mqtt_publisher.py (çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹å†…ã«æ–°è¦ä½œæˆ)
import paho.mqtt.client as mqtt
import json
import asyncio
from domain.entities import ParkingPlan # ğŸ‘ˆ å‡ºåŠ›ã™ã‚‹Entity
from application.boundaries import PlanPublisherInterface # ğŸ‘ˆ å®Ÿè£…ã™ã‚‹I/F

# -----------------------------------------------------------------------------
# Service Adapter Implementation (MQTT Publisher)
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: ServiceAdapter
# - åŒå¿ƒå††å›³ã®ä½ç½®: Adapters (å¤–å´ã®å††)
# -----------------------------------------------------------------------------
class MqttPlanPublisher(PlanPublisherInterface):
    """
    UseCaseã®è¦æ±‚(I/F)ã«åŸºã¥ãã€ParkingPlanã‚’
    MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã«å…¬é–‹ï¼ˆPublishï¼‰ã™ã‚‹ã‚¢ãƒ€ãƒ—ã‚¿ã€‚
    """
    def __init__(self, broker_address: str, broker_port: int, topic: str):
        self._broker_address = broker_address
        self._broker_port = broker_port
        self._topic = topic

        self._client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2)
        self._client.reconnect_delay_set(min_delay=1, max_delay=30)
        self._client.on_connect = self._on_connect
        self._client.on_disconnect = self._on_disconnect

        try:
            self._client.connect_async(self._broker_address, self._broker_port, 60)
            self._client.loop_start()
        except Exception as e:
            print(f"[Adapter] MQTT Publisher: Failed to connect initially: {e}")

    def _on_connect(self, client, userdata, flags, rc, properties=None):
        if rc == 0:
            print(f"[Adapter] MQTT Publisher: Connected to broker at {self._broker_address}")
        else:
            print(f"[Adapter] MQTT Publisher: Failed to connect, return code {rc}")

    def _on_disconnect(self, client, userdata, rc, properties=None):
        print(f"[Adapter] MQTT Publisher: Disconnected from broker. Reconnecting...")

    async def publish_plan(self, plan: ParkingPlan):
        """
        ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹(async)ã«åŸºã¥ãã€é§è»Šè¨ˆç”»ã‚’å…¬é–‹ã™ã‚‹
        """
        # ParkingPlanã‚’è¾æ›¸å½¢å¼ã«å¤‰æ›
        plan_dict = {
             "timestamp": plan.timestamp.isoformat(),
             "commands": [cmd.__dict__ for cmd in plan.commands]
        }
        payload = json.dumps(plan_dict, indent=2)

        try:
            # MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã«å…¬é–‹ (publish)
            result = self._client.publish(self._topic, payload, qos=1)

            if result.rc == mqtt.MQTT_ERR_SUCCESS:
                print(f"[Adapter] MQTT Publisher: Parking Plan published to topic '{self._topic}'")
            else:
                print(f"[Adapter] MQTT Publisher: Failed to publish (rc: {result.rc}). Will retry.")

            await asyncio.sleep(0)

        except Exception as e:
            print(f"[Adapter] MQTT Publisher: Error publishing: {e}")

```

---

## ğŸš€ æ‰‹é †4ï¼š[main.py](http://main.py/) ã®ä¿®æ­£ï¼ˆDIã®å·®ã—æ›¿ãˆï¼‰

æœ€å¾Œã«ã€çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã® `main.py` ã‚’é–‹ãã€ãƒ•ã‚¡ã‚¤ãƒ«I/Oã‚¢ãƒ€ãƒ—ã‚¿ã‚’ä½¿ã£ã¦ã„ãŸéƒ¨åˆ†ã‚’ã€ä»Šä½œæˆã—ãŸ2ã¤ã®MQTTã‚¢ãƒ€ãƒ—ã‚¿ã«å·®ã—æ›¿ãˆã¾ã™ã€‚

```python
# main.py (çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹å†…)
import asyncio
from application.use_cases import CalculateParkingPlanUseCase
# from adapters.file_subscriber import FileWorldModelSubscriber # <- å¤ã„ã‚¢ãƒ€ãƒ—ã‚¿
from adapters.mqtt_subscriber import MqttWorldModelSubscriber # <- ğŸ‘ˆ æ–°ã—ã„å…¥åŠ›ã‚¢ãƒ€ãƒ—ã‚¿
from adapters.repositories import InMemoryPlanRepository        # <- å¤‰æ›´ãªã—
# from adapters.file_publisher import FilePlanPublisher       # <- å¤ã„ã‚¢ãƒ€ãƒ—ã‚¿
from adapters.mqtt_publisher import MqttPlanPublisher       # <- ğŸ‘ˆ æ–°ã—ã„å‡ºåŠ›ã‚¢ãƒ€ãƒ—ã‚¿

# -----------------------------------------------------------------------------
# Entry Point (Main Application)
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: Main (DIã‚³ãƒ³ãƒ†ãƒŠã®å½¹å‰²)
# - åŒå¿ƒå††å›³ã®ä½ç½®: æœ€ã‚‚å¤–å´ã®å±¤ (Frameworks & Drivers)
# -----------------------------------------------------------------------------
async def main():
    """
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã€ä¾å­˜é–¢ä¿‚ã‚’æ³¨å…¥ (DI) ã™ã‚‹ã€‚
    """
    print("--- [Planning Service] Starting Up ---")

    # 1. Adapterså±¤ï¼ˆå…·ä½“çš„ãªå®Ÿè£…ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–

    # â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ å·®ã—æ›¿ãˆéƒ¨åˆ†1 (å…¥åŠ›) â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    # world_model_subscriber = FileWorldModelSubscriber(filepath="world_model.json") # <- å¤ã„ã‚¢ãƒ€ãƒ—ã‚¿

    # æ–°ã—ã„MQTT Subscriberã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    world_model_subscriber = MqttWorldModelSubscriber(
        broker_address="localhost",
        broker_port=1883,
        topic="autodrive/world_model" # ğŸ‘ˆ èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ãŒå…¬é–‹ã™ã‚‹ãƒˆãƒ”ãƒƒã‚¯ã‚’è³¼èª­
    )
    # â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² å·®ã—æ›¿ãˆéƒ¨åˆ†1 â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    # â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ å·®ã—æ›¿ãˆéƒ¨åˆ†2 (å‡ºåŠ›) â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    # plan_publisher = FilePlanPublisher(filepath="plan.json") # <- å¤ã„ã‚¢ãƒ€ãƒ—ã‚¿

    # æ–°ã—ã„MQTT Publisherã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    plan_publisher = MqttPlanPublisher(
        broker_address="localhost",
        broker_port=1883,
        topic="autodrive/plan" # ğŸ‘ˆ ã“ã®ãƒˆãƒ”ãƒƒã‚¯åã§è¨ˆç”»ã‚’å…¬é–‹
    )
    # â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² å·®ã—æ›¿ãˆéƒ¨åˆ†2 â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    plan_repository = InMemoryPlanRepository()

    # 2. UseCaseå±¤ã«ã€å…·ä½“çš„ãªå®Ÿè£…ã‚’ã€Œä¾å­˜æ€§ã®æ³¨å…¥ (DI)ã€
    #    UseCaseã¯å·®ã—æ›¿ãˆã‚‰ã‚ŒãŸã“ã¨ã«æ°—ã¥ã‹ãªã„
    use_case = CalculateParkingPlanUseCase(
        world_model_sub=world_model_subscriber,
        plan_repo=plan_repository,
        plan_pub=plan_publisher
    )

    # 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆUseCaseï¼‰ã®ã€ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œã€‘
    # (â€»ã“ã®ãƒ«ãƒ¼ãƒ—éƒ¨åˆ†ã¯ç¬¬4å·¡ã®æœ€çµ‚çµ±åˆã§ä¿®æ­£æ¸ˆã¿)
    print("\\n--- [Planning Service] Running in loop (Press Ctrl+C to stop) ---")
    while True:
        try:
            await use_case.handle()
            await asyncio.sleep(1)
        except Exception as e:
            print(f"--- [Planning Service] Error in loop: {e} ---")
            await asyncio.sleep(5)

if __name__ == "__main__":
    # ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆçµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã‚’å®Ÿè¡Œ
    asyncio.run(main())

```

---

## ğŸ’¡ æ‰‹é †5ï¼šå‹•ä½œç¢ºèªï¼ˆ2ã‚µãƒ¼ãƒ“ã‚¹é€£æºï¼‰

ã“ã‚Œã§å·®ã—æ›¿ãˆã¯å®Œäº†ã§ã™ã€‚å‹•ä½œç¢ºèªã‚’ã—ã¾ã—ã‚‡ã†ã€‚

1. ï¼ˆã‚¹ãƒ†ãƒƒãƒ—1ã§èµ·å‹•ã—ãŸï¼‰**MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹**ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
2. **ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’2ã¤**é–‹ãã¾ã™ã€‚
3. **ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1**ã§ã€**èªè­˜ã‚µãƒ¼ãƒ“ã‚¹**ï¼ˆã‚¹ãƒ†ãƒƒãƒ—2ã§ä¿®æ­£æ¸ˆã¿ï¼‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
    
    ```bash
    python perception_service/main.py
    
    ```
    
4. **ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2**ã§ã€ä»Šå›ä¿®æ­£ã—ãŸ**çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹**ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
    
    ```bash
    python planning_service/main.py
    
    ```
    

### ç¢ºèªã™ã‚‹ãƒã‚¤ãƒ³ãƒˆ

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1ï¼ˆèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ï¼‰:

```bash
...
[Adapter] MQTT Publisher: Connected to broker...
...
[Adapter] MQTT Publisher: World Model published to topic 'autodrive/world_model' # <- å…¬é–‹
...

```

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2ï¼ˆçµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ï¼‰:

```bash
...
[Adapter] MQTT Subscriber: Connected to broker...
[Adapter] MQTT Subscriber: Subscribed to topic 'autodrive/world_model' # <- è³¼èª­
[Adapter] MQTT Publisher: Connected to broker...
...
[Adapter] MQTT Subscriber: Received message from topic 'autodrive/world_model' # <- ğŸ‘ˆ å—ä¿¡æˆåŠŸï¼
[UseCase] Calculating parking plan...
[Adapter] InMemoryRepo: Saving ParkingPlan to memory.
[Adapter] MQTT Publisher: Parking Plan published to topic 'autodrive/plan'     # <- ğŸ‘ˆ å…¬é–‹æˆåŠŸï¼
...

```

`world_model.json` ã‚„ `plan.json` ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸€åˆ‡ä½¿ã‚ã‚Œãšã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆMQTTï¼‰çµŒç”±ã§ãƒ‡ãƒ¼ã‚¿ãŒé€£æºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

---

## ğŸ›¡ï¸ ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®é‰„å‰‡

**UseCaseã¯ã€å…¥å‡ºåŠ›ãŒãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã‚‚ã€ãã®é•ã„ã‚’å¸åã™ã‚‹ã®ãŒã‚¢ãƒ€ãƒ—ã‚¿ã®è²¬å‹™ã§ã‚ã‚‹ã€‚**

`MqttWorldModelSubscriber` ã¯ã€MQTTã®ã€Œãƒ—ãƒƒã‚·ãƒ¥å‹ã€ã®å‹•ä½œã‚’ã€UseCaseãŒè¦æ±‚ã™ã‚‹ã€Œãƒ—ãƒ«å‹ï¼ˆ`get_world_model()`ï¼‰ã€ã«è¦‹äº‹ã«å¤‰æ›ï¼ˆã‚¢ãƒ€ãƒ—ãƒˆï¼‰ã—ã¾ã—ãŸã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€UseCaseã¯é€šä¿¡æ–¹å¼ã®å¤‰æ›´ã«ä¸€åˆ‡æ°—ã¥ãã“ã¨ãªãã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã«é›†ä¸­ã—ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

æ¬¡ã¯ã€ã€Œã‚¹ãƒ†ãƒƒãƒ—4ï¼šè»Šä¸¡åˆ¶å¾¡ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¢ãƒ€ãƒ—ã‚¿å·®ã—æ›¿ãˆã€ã«é€²ã¿ã€æœ€å¾Œã® `Subscriber` ã‚’ç½®ãæ›ãˆã¾ã™ã€‚