# ç¬¬1ç« ï¼šEntityï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰ã€ç¬¬2å·¡ï¼šå›³æ›¸è²¸å‡ºã€‘

## ğŸ¯ ã“ã®ç« ã®ç›®çš„

ã“ã®ç« ã§ã¯ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æœ€ã‚‚å†…å´ã«ä½ç½®ã™ã‚‹ã€Œ**Entityï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰**ã€ã‚’ã€å›³æ›¸è²¸å‡ºãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆLibrary Lendingï¼‰ã§å®Ÿè£…ã—ã¾ã™ã€‚

Entityã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãã®ã‚‚ã®**ã‚’è¡¨ã™å±¤ã§ã™ã€‚
å¤–éƒ¨ã®æŠ€è¡“ï¼ˆWebãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€UIï¼‰ã«ä¸€åˆ‡ä¾å­˜ã›ãšã€
ã‚·ã‚¹ãƒ†ãƒ ã®**æ ¸ã¨ãªã‚‹æ„å‘³ã¨ä¸å¤‰æ¡ä»¶ï¼ˆä¸å¤‰æ¡ä»¶ãƒ»æ•´åˆæ€§ï¼‰**ã‚’å®šç¾©ã—ã¾ã™ã€‚

---

## ğŸ§© Entityã¨ã¯

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åŒå¿ƒå††ã§è¨€ã†ã¨ã€æœ€ã‚‚ä¸­å¿ƒã®å††ã«ä½ç½®ã—ã¾ã™ã€‚

![ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](../ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.png)

ã“ã®å±¤ã¯ã€Œãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ï¼ˆBusiness Rulesï¼‰ã€ã§ã™ã€‚
**æŠ€è¡“çš„ãªè©³ç´°ã‚’æ’é™¤ã—ãŸç´”ç²‹ãªãƒ­ã‚¸ãƒƒã‚¯**ã ã‘ã‚’æŒã¡ã¾ã™ã€‚

ç¬¬2å·¡ã®é¡Œæã€Œå›³æ›¸è²¸å‡ºã€ã«ãŠã‘ã‚‹ä¸»ãªæ¦‚å¿µã¯æ¬¡ã®3ã¤ã§ã™ã€‚

* **Book** â€¦ æ›¸ç±ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€è‘—è€…ã€ISBN ãªã©ï¼‰
* **Member** â€¦ ä¼šå“¡ï¼ˆåå‰ã€ãƒ¡ãƒ¼ãƒ«ï¼‰
* **Loan** â€¦ è²¸å‡ºå±¥æ­´ï¼ˆã©ã®æœ¬ã‚’èª°ãŒã„ã¤å€Ÿã‚Šã¦ã€ã„ã¤ã¾ã§ã«è¿”ã™ã‹ï¼‰

> é‡è¦ï¼š
> ã€Œå€Ÿã‚Šã‚‰ã‚Œã¦ã„ã‚‹æœ€ä¸­ã«åŒã˜æœ¬ã‚’ã‚‚ã†ä¸€åº¦å€Ÿã‚Šã‚‹ã“ã¨ã¯ã§ããªã„ã€ç­‰ã®**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æŒ¯ã‚‹èˆã„**ã¯ UseCase ã§æ‰±ã„ã¾ã™ã€‚
> ä¸€æ–¹ã€**â€œç©ºã®ã‚¿ã‚¤ãƒˆãƒ«ã¯ã‚ã‚Šãˆãªã„â€** ç­‰ã®**æ¦‚å¿µã®ä¸å¤‰æ¡ä»¶**ã¯ Entity ãŒè²¬å‹™ã‚’æŒã¡ã¾ã™ã€‚

---

## ğŸ§± Entityå±¤ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
project_root/
â””â”€â”€ domain/
    â”œâ”€â”€ book.py    â† Bookã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
    â”œâ”€â”€ member.py  â† Memberã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
    â””â”€â”€ loan.py    â† Loanã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
```

---

## ğŸ§­ è¨­è¨ˆæ–¹é‡ï¼ˆç¬¬1å·¡ã¨åŒã˜åŸºæœ¬åŸå‰‡ï¼‰

* **ä½•ç‰©ã«ã‚‚ä¾å­˜ã—ãªã„ï¼ˆDepend on Nothingï¼‰**
  import ã¯æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã¿ã€‚DBã€FastAPIã€SQLã¯ç™»å ´ã—ã¾ã›ã‚“ã€‚
* **æ¦‚å¿µã®ä¸å¤‰æ¡ä»¶ï¼ˆInvariantï¼‰ã‚’æ‹…ä¿**
  ä¾‹ï¼šç©ºæ–‡å­—ã‚’è¨±ã•ãªã„ã€ãƒ¡ãƒ¼ãƒ«æ›¸å¼ã®æœ€ä½é™ãƒã‚§ãƒƒã‚¯ ãªã©ã€‚
* **å¤–éƒ¨ã®æŠ€è¡“ãŒå¤‰ã‚ã£ã¦ã‚‚ã€ã“ã®å±¤ã¯å¤‰ã‚ã‚‰ãªã„**
  Web/DB/èªè¨¼ã®éƒ½åˆã¯ä¸€åˆ‡æŒã¡è¾¼ã¾ãªã„ã€‚

---

## ğŸ§  ä¾‹é¡Œï¼šå›³æ›¸è²¸å‡ºã® Entity

### âœ³ï¸ `domain/book.py`

```python
# --------------------------------------------------------------------
# Entity å±¤ã«ç›¸å½“ï¼ˆæœ€ã‚‚å†…å´ã®å††ï¼‰
# å›³æ›¸è²¸å‡ºãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã€Œæ›¸ç±ã€ã®æœ¬è³ªçš„ãªãƒ«ãƒ¼ãƒ«ã‚’è¡¨ã™ã€‚
# å¤–éƒ¨æŠ€è¡“ï¼ˆWeb/DBï¼‰ã«ã¯ä¸€åˆ‡ä¾å­˜ã—ãªã„ã€‚
# --------------------------------------------------------------------
from dataclasses import dataclass
from datetime import datetime
from typing import Optional


@dataclass
class Book:
    id: Optional[int]
    title: str
    author: str
    isbn: str
    created_at: datetime

    def __post_init__(self):
        if not self.title or not self.title.strip():
            raise ValueError("Book.title ã¯å¿…é ˆã§ã™")
        if not self.author or not self.author.strip():
            raise ValueError("Book.author ã¯å¿…é ˆã§ã™")
        if not self.isbn or not self.isbn.strip():
            raise ValueError("Book.isbn ã¯å¿…é ˆã§ã™")

    def rename(self, new_title: str):
        """æ›¸ç±ã‚¿ã‚¤ãƒˆãƒ«ã®å¤‰æ›´ï¼ˆæ¦‚å¿µçš„ã«è¨±å®¹ã™ã‚‹å ´åˆã®ã¿ä½¿ç”¨ï¼‰"""
        if not new_title or not new_title.strip():
            raise ValueError("Book.title ã¯ç©ºã«ã§ãã¾ã›ã‚“")
        self.title = new_title
```

### âœ³ï¸ `domain/member.py`

```python
# --------------------------------------------------------------------
# å›³æ›¸è²¸å‡ºãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã€Œä¼šå“¡ã€ã®æœ¬è³ªçš„ãªãƒ«ãƒ¼ãƒ«ã‚’è¡¨ã™ Entity
# --------------------------------------------------------------------
from dataclasses import dataclass
from datetime import datetime
from typing import Optional
import re


EMAIL_RE = re.compile(r"^[^@\s]+@[^@\s]+\.[^@\s]+$")


@dataclass
class Member:
    id: Optional[int]
    name: str
    email: str
    created_at: datetime

    def __post_init__(self):
        if not self.name or not self.name.strip():
            raise ValueError("Member.name ã¯å¿…é ˆã§ã™")
        if not self.email or not self.email.strip():
            raise ValueError("Member.email ã¯å¿…é ˆã§ã™")
        # ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼ˆè©³ç´°ãªæ¤œè¨¼ã¯Interfaceå±¤ã§è¿½åŠ å¯èƒ½ï¼‰
        if not EMAIL_RE.match(self.email):
            raise ValueError("Member.email ãŒä¸æ­£ãªå½¢å¼ã§ã™")

    def rename(self, new_name: str):
        if not new_name or not new_name.strip():
            raise ValueError("Member.name ã¯ç©ºã«ã§ãã¾ã›ã‚“")
        self.name = new_name
```

### âœ³ï¸ `domain/loan.py`

```python
# --------------------------------------------------------------------
# å›³æ›¸è²¸å‡ºãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã€Œè²¸å‡ºã€ã®æœ¬è³ªçš„ãªãƒ«ãƒ¼ãƒ«ã‚’è¡¨ã™ Entity
# --------------------------------------------------------------------
from dataclasses import dataclass
from datetime import datetime
from typing import Optional


@dataclass
class Loan:
    id: Optional[int]
    book_id: int
    member_id: int
    borrowed_at: datetime
    due_at: datetime
    returned_at: Optional[datetime]

    def __post_init__(self):
        if self.due_at <= self.borrowed_at:
            raise ValueError("Loan.due_at ã¯ borrowed_at ã‚ˆã‚Šå¾Œã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")

    # Entity ã¯â€œæ¦‚å¿µã«å†…åœ¨ã™ã‚‹åˆ¤æ–­â€ã®ã¿æä¾›ã€‚
    # å®Ÿéš›ã®ã€Œå€Ÿã‚Šã‚‹ã€ã€Œè¿”ã™ã€ã®æŒ¯ã‚‹èˆã„ï¼ˆæ¤œæŸ»ã‚„æ°¸ç¶šåŒ–ã‚’ä¼´ã†å‡¦ç†ï¼‰ã¯ UseCase ã®è²¬å‹™ã€‚
    def is_active(self) -> bool:
        """è¿”å´ã•ã‚Œã¦ã„ãªã„è²¸å‡ºã‹ï¼Ÿ"""
        return self.returned_at is None

    def is_overdue(self, now: datetime) -> bool:
        """å»¶æ»ã‹ï¼Ÿï¼ˆè¿”å´ã•ã‚Œã¦ãŠã‚‰ãšã€ã‹ã¤æœŸé™ã‚’éãã¦ã„ã‚‹ï¼‰"""
        return self.is_active() and (now > self.due_at)

    def mark_returned(self, when: datetime):
        """è¿”å´æ—¥æ™‚ã‚’è¨˜éŒ²ï¼ˆä¸å¤‰æ¡ä»¶ã®æ›´æ–°ã¯Entityã§æ‹…ä¿ã—ã¦è‰¯ã„ï¼‰"""
        if self.returned_at is not None:
            raise ValueError("ã™ã§ã«è¿”å´æ¸ˆã¿ã§ã™")
        if when < self.borrowed_at:
            raise ValueError("è¿”å´æ—¥æ™‚ã¯è²¸å‡ºæ—¥æ™‚ã‚ˆã‚Šå‰ã«ã¯ã§ãã¾ã›ã‚“")
        self.returned_at = when
```

---

## âœ… è§£èª¬ï¼ˆã©ã“ã¾ã§ã‚’ Entity ã«æ›¸ãã‹ï¼‰

* **æ¦‚å¿µã®ä¸å¤‰æ¡ä»¶**ï¼ˆç©ºæ–‡å­—ç¦æ­¢ã€æ™‚ç³»åˆ—ãŒå‰å¾Œã—ãªã„ ç­‰ï¼‰ã¯ **Entity** ã§æ‹…ä¿ã—ã¾ã™ã€‚
  â†’ ã€ŒBook.title ã¯å¿…é ˆã€ã€ŒLoan.due_at ã¯ borrowed_at ã‚ˆã‚Šå¾Œã€ãªã©ã€‚

* **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‰‹ç¶šã**ï¼ˆâ€œã“ã®ä¼šå“¡ã¯ä½•å†Šã¾ã§å€Ÿã‚Šã‚‰ã‚Œã‚‹ã‹ï¼Ÿâ€â€œåŒã˜æœ¬ã¯åŒæ™‚ã«é‡è¤‡è²¸å‡ºä¸å¯â€ãªã©ã€è¤‡æ•° Entity/å¤–éƒ¨çŠ¶æ…‹ã‚’æ¨ªæ–­ã—ã¦åˆ¤æ–­ã™ã‚‹å‡¦ç†ï¼‰ã¯ **UseCase** ã§æ‰±ã„ã¾ã™ã€‚
  â†’ å¤–éƒ¨çŠ¶æ…‹ï¼ˆæ—¢å­˜ã®è²¸å‡ºæœ‰ç„¡ã€ä¼šå“¡ã®åˆ¶é™ï¼‰ã‚’å‚ç…§ã™ã‚‹ãŸã‚ **æŠ½è±¡ãƒªãƒã‚¸ãƒˆãƒª**çµŒç”±ã§è¡Œã†ã®ãŒç­‹ã€‚

* **ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚„HTTPå…¥å‡ºåŠ›**ã¯ **Entity ã®è²¬å‹™ã§ã¯ãªã„**
  â†’ DBã‚„Webã®éƒ½åˆã‚’å…¥ã‚Œãªã„ã“ã¨ã§ã€**æœ€ã‚‚å®‰å®š**ã—ãŸå±¤ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ’¬ Entityå±¤ã§â€œã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨â€

| NG ä¾‹                           | ãªãœãƒ€ãƒ¡ï¼Ÿ                                     |
| ------------------------------ | ----------------------------------------- |
| `save_to_db()` ã®ã‚ˆã†ãªä¿å­˜ãƒ¡ã‚½ãƒƒãƒ‰      | DBã¯å¤–å´ã®è©³ç´°ã€‚æ°¸ç¶šåŒ–ã¯ Infrastructure å±¤ã®è²¬å‹™ã€‚        |
| `from_request(req)` ã®ã‚ˆã†ãªHTTPä¾å­˜ | Webã¯å¤–å´ã®è©³ç´°ã€‚å…¥åŠ›æ•´å½¢ã¯ Controller/PRESENTER ã®è²¬å‹™ã€‚ |
| SQLæ–‡å­—åˆ—ã‚„ ORM ãƒ¢ãƒ‡ãƒ«ã‚’ import        | æŠ€è¡“è©³ç´°ãŒæ··ã–ã‚‹ã¨å†…å´ãŒå¤–å´ã«ç¸›ã‚‰ã‚Œã¦ã—ã¾ã†ã€‚                   |
| å¤–éƒ¨APIå‘¼ã³å‡ºã—                      | å¤–ç•Œã¨ã®é€šä¿¡ã¯ä¸Šä½å±¤ã§æ‰±ã†ã€‚                            |

---

## ğŸ“˜ ã“ã®ç« ã®ç†è§£ãƒã‚¤ãƒ³ãƒˆ

* **Entity ã¯æœ€å†…å±¤ã®â€œãƒ«ãƒ¼ãƒ«ã®å¿ƒè‡“â€**ã€‚å¤–å´ã®éƒ½åˆï¼ˆWeb/DBï¼‰ã‚’ä¸€åˆ‡æŒã¡è¾¼ã¾ãªã„ã€‚
* **Invariantï¼ˆä¸å¤‰æ¡ä»¶ï¼‰**ã¯ Entity ã®è²¬å‹™ã€‚
  ä¸€æ–¹ã€**å¤–éƒ¨çŠ¶æ…‹ã‚’å‚ç…§ã™ã‚‹æ¥­å‹™æ‰‹ç¶šã**ã¯ UseCase ã®è²¬å‹™ã€‚
* ã“ã“ã‚’å …ç‰¢ã«ã™ã‚‹ã¨ã€**å¤–å´ãŒå¤‰ã‚ã£ã¦ã‚‚å£Šã‚Œãªããªã‚‹**ã€‚

---

## ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼šUseCaseå±¤ã¸

æ¬¡ã¯ã€**Entity ã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æŒ¯ã‚‹èˆã„ã‚’å®šç¾©ã™ã‚‹**
**UseCaseï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰å±¤** ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ã“ã®ç« ã§ä½œã£ãŸ `Book` / `Member` / `Loan` ã‚’çµ„ã¿åˆã‚ã›ã€

* æœ¬ã‚’ç™»éŒ²ã™ã‚‹
* ä¼šå“¡ã‚’ç™»éŒ²ã™ã‚‹
* æœ¬ã‚’å€Ÿã‚Šã‚‹
* æœ¬ã‚’è¿”ã™
* å»¶æ»ã‚’ä¸€è¦§ã™ã‚‹
* æ¤œç´¢ã™ã‚‹ï¼ˆæœ¬/ä¼šå“¡ï¼‰

ã¨ã„ã£ãŸæ“ä½œã‚’ã€**æŠ½è±¡ãƒªãƒã‚¸ãƒˆãƒª**ã«ä¾å­˜ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚
ä¾å­˜ã®å‘ãã¨åˆ¶å¾¡ã®æµã‚Œã‚’ã€å†åº¦ã“ã“ã§ç¢ºèªã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

![ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»ä¾å­˜ã¨åˆ¶å¾¡](../ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»ä¾å­˜ã¨åˆ¶å¾¡.png)


