## 自動駐車システム

DDDの学習の総仕上げとして、より複雑な「自動駐車システム」を題材に、これまで学んだすべての道具を使って設計の思考訓練を行いましょう。

自動駐車システムの設計では、`駐車スペース`や計算された`走行軌跡`といった**値オブジェクト**を定義します。次に、駐車スペースを探索する**`環境認識`集約**、駐車までの最適な軌跡を計算する**`経路計画`集約**、計画通りに車を動かす**`駐車実行`集約**を設計します。最終的に、これらを**「認識」「計画」「制御」**という主要な**境界づけられたコンテキスト**に分割していきます。

***
### 1. 戦術的設計：自動駐車システムを構成する「部品」

まず、システムの内部構造を、DDDの戦術的設計パターンを使ってモデル化します。

#### 道具1：値オブジェクト
自動駐車システムで頻繁に登場する「値」の概念を定義します。

* **`VehiclePose` (車両姿勢)**:
    単なるx, y座標だけでなく、車両の向き（ヨー角 θ）も含む、極めて重要な値オブジェクトです。「どの位置で、どちらを向いているか」を表します。
* **`ParkingSpace` (駐車スペース)**:
    超音波センサーやカメラが見つけた駐車可能なスペース。平行駐車か縦列駐車かの種別、4つの角の座標、大きさなどの情報を持ちます。
* **`Trajectory` (走行軌跡)**:
    経路計画の結果として生成される、**一連の`VehiclePose`のリスト**です。これが、車が辿るべき「道筋」そのものを表す、非常にリッチな値オブジェクトになります。
* **`SensorReading` (センサー測定値)**:
    個々の超音波センサーからの距離や、カメラからの画像データなど。

#### 道具2：集約
自動駐車は「スペース発見 → 経路計画 → 駐車実行」という明確なフェーズを持ちます。このフェーズごとに、一貫性を保つべき責任者として集約を設計します。

##### 集約候補1：`EnvironmentModel` (環境認識)
* **責務**: 複数のセンサーからの不確実な情報を統合し、「**現在、信頼できる駐車スペースがどこにあるか**」という単一の真実を維持する。
* **振る舞い**:
    * `update_with_sensor_data(readings)`: 新しいセンサー情報で内部の地図モデルを更新し、駐車スペースの候補をリストアップする。

##### 集約候補2：`PathPlanner` (経路計画)
* **責務**: `EnvironmentModel`からの駐車スペース情報と、現在の`VehiclePose`を元に、**衝突しない最適な`Trajectory`（走行軌跡）を計算する**。
* **振る-舞い**:
    * `plan_trajectory(current_pose, target_space) -> Trajectory`: 内部で複雑な経路探索アルゴリズム（A*など）を実行し、結果として`Trajectory`値オブジェクトを返す。これは、状態を持たない計算専門の集約（ドメインサービスに近い）です。

##### 集約候補3：`ParkingController` (駐車実行)
* **責務**: `PathPlanner`が生成した`Trajectory`に従って、**駐車操作の開始から完了（または失敗）までの状態を一貫して管理する**。
* **振る舞い**:
    * `start_parking(trajectory)`: 駐車実行を開始する。内部の状態を「実行中」に遷移させる。
    * `update_execution_status(current_pose)`: 車の現在の姿勢と、目標となる軌跡を比較し、その差を埋めるための具体的な操舵角やアクセル・ブレーキの量を計算し、アクチュエーターに出力する。軌跡から大きく外れたら状態を「失敗」に遷移させる。

---
### 2. 戦略的設計：自動駐車システムの「地図」

次に、これらの集約が、システム全体のどの部分に属するのかを、境界づけられたコンテキストとして整理します。

* **認識コンテキスト (Perception Context)**:
    * **責務**: 「外界を理解する」こと。`EnvironmentModel`集約がここに属します。

* **計画コンテキスト (Planning Context)**:
    * **責務**: 「どう動くべきかを計画する」こと。LKAにはなかった、自動駐車特有のコンテキストです。`PathPlanner`集約がここに属します。

* **制御コンテキスト (Control Context)**:
    * **責務**: 「計画通りに実行する」こと。`ParkingController`集約がここに属します。

* **ドライバー通知コンテキスト (Driver Interface Context)**:
    * **責務**: 「ドライバーに進捗や結果を伝える」こと。「駐車スペースが見つかりました」「駐車を開始します」といった表示や音声通知を管理します。

#### コンテキストマップ（影響の流れ）

このシステムの連携は、綺麗なパイプラインを形成します。

`[センサー群]` → `[認識コンテキスト]` → `[計画コンテキスト]` → `[制御コンテキスト]` → `[アクチュエーター群]`

1.  **認識**コンテキストが駐車スペースを見つける。
2.  その情報が**計画**コンテキストに渡され、走行軌跡が計算される。
3.  その走行軌跡が**制御**コンテキストに渡され、実行される。

この一連の思考プロセスが、複雑な自動駐車システムを、責務が明確で、テストしやすく、個別に改良可能なソフトウェア部品の集合体として設計するための、DDDに基づいたアプローチです。

