## 🖼️ ユースケース

リポジトリパターンは、ドメインモデルと永続化層を綺麗に分離する、強力な「接着剤」のような役割を果たします。このパターンを知ることで、これまでのご経験がさらに強力なものになりますね。

次のステップは、これらの部品（値オブジェクト、集約、リポジトリ）が、**実際のユースケース（ユーザーの操作）の中で、どのように連携して動作するのか**を確認することです。

-----

### 道具の連携：ユースケースの実現

これまで私たちは、システムの「部品」を一つずつ設計してきました。次は、これらの部品を組み立てて、具体的な機能を実現する「アプリケーション層（UseCase）」の視点で見ていきましょう。

ここでは、「**緊急アラーム録画ボタンが押された**」という、このシステムで最も重要なユースケースの一つを取り上げます。

#### ユースケース：緊急アラーム録画の実行

**`RecordEmergencySegmentUseCase`**

```python
class RecordEmergencySegmentUseCase:
    def __init__(
        self,
        # このUseCaseが必要とする専門家（リポジトリ）を入り口で指定する
        storage_repo: IStorageRepository,
        camera_repo: ICameraRepository
    ):
        self._storage_repo = storage_repo
        self._camera_repo = camera_repo

    def execute(self, camera_id_str: str, current_time: datetime):
        # --- 指揮者 (UseCase) の仕事 ---

        # 1. 必要な部品（集約）を取得する
        storage = self._storage_repo.get()
        camera_id = CameraId(camera_id_str) # 値オブジェクトを生成
        camera = self._camera_repo.find_by_id(camera_id)

        # 2. 録画セグメントのデータを準備する
        #    (プリ録画・アフター録画の時間を計算するなど)
        segment_data = self._prepare_segment_data(camera, current_time)
        new_segment = RecordingSegment(**segment_data)
        
        # 3. 集約に「仕事」をお願いする
        #    UseCaseは「どうやって」保護領域に保存するかは知らない。
        #    ただ「緊急として追加して」とお願いするだけ。
        try:
            storage.add_emergency_segment(new_segment)
        except ProtectedStorageFullError as e:
            # もし集約がルール違反（満杯）を検知したら、エラーを処理する
            self._notify_error_to_user(e)
            return

        # 4. 変更された集約を保存する
        self._storage_repo.save(storage)
```

### この設計がもたらすもの

この`UseCase`のコードから分かるように、

  * **UseCaseの関心事**:

      * どのリポジトリを使い、どの集約を呼び出すか、という\*\*手順（ワークフロー）\*\*の管理。
      * 集約が返したエラー（例：保護領域が満杯）を、ユーザーへの通知などの**アプリケーション固有の処理**に変換すること。

  * **UseCaseが知らないこと**:

      * `Storage`集約が、**どのようにして**保護領域の空きをチェックしているか。
      * `Storage`集約が、**どのようにして**ループ録画を実現しているか。
      * `Camera`集約が、**どのような**設定を持っているか。

ビジネスの**複雑なルール**はすべて**集約**が、**永続化の複雑さ**はすべて**リポジトリ**が隠蔽してくれています。その結果、UseCaseは非常にシンプルで、**ビジネスの「手順」を記述することだけに集中できる**のです。

-----

これで、戦術的設計の思考訓練は一通り完了です。
一つの具体的な題材を通して、DDDの主要な道具たちがどのように連携し、クリーンで堅牢な設計を生み出すか、その全体像を掴んでいただけたかと思います。