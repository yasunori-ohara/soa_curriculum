## 「関係性」を定義する

次のステップは、本物だと確認できたコンテキスト同士が、**どのように連携し、影響し合うのか、その「関係性」を定義する**ことです。この関係性を描いた地図を**コンテキストマップ**と呼びます。

-----

### コンテキストマップの作成

私たちは、システムの「地図」に3つの主要なエリア（境界づけられたコンテキスト）を描き、それぞれの役割を明確にしました。

  * **予約コンテキスト**
  * **顧客管理コンテキスト**
  * **決済コンテキスト**

しかし、これらのエリアが完全に孤立していては、システムとして機能しません。次に行うのは、これらのエリア間をつなぐ「道」や「通信ルール」を定義し、システム全体の連携方法を可視化することです。

-----

#### 1\. 影響の流れを見極める（上流／下流）

まず、どのコンテキストが他のコンテキストに影響を与える「源流」となるかを考えます。これを**上流 (Upstream)** と **下流 (Downstream)** の関係と呼びます。

  * **予約コンテキスト**で「予約が確定」すると、その情報に基づいて「支払い」が発生する必要があります。
      * → **予約コンテキスト**が**上流**、**決済コンテキスト**が**下流**となります。
  * 同じく、「予約が確定」した際、その予約を行った「顧客」の予約履歴を更新する必要があります。
      * → **予約コンテキスト**が**上流**、**顧客管理コンテキスト**が**下流**となります。

これを図にすると、影響の流れ（依存関係）が見えてきます。  
※ 図にすると崩れてしまうので、テキストで表現に変更。
```
予約コンテキスト (上流) は、決済コンテキスト (下流) に影響を与えます。
予約コンテキスト (上流) は、顧客管理コンテキスト (下流) にも影響を与えます。
```

-----

#### 2\. 境界での「翻訳」を定義する（腐敗防止層）

関係性が定義できたら、次に「**どのように情報をやり取りするか**」を考えます。

**決済コンテキスト**の立場になってみましょう。支払い処理をするために、予約のすべての情報（宿泊期間、客室タイプなど）が必要でしょうか？ いいえ、必要なのは\*\*「誰が」「いくら」支払うか\*\*という情報だけです。

もし、予約コンテキストの複雑な情報をそのまま受け取ってしまうと、決済コンテキストは予約の都合に振り回されてしまいます。そこで、下流コンテキスト（決済）の境界に、**腐敗防止層 (Anti-Corruption Layer, ACL)** という名の「翻訳家」を置きます。

  * **役割**: 上流（予約）からの情報を受け取り、下流（決済）が理解できるシンプルな命令だけに翻訳します。
  * **具体例**:
    1.  予約コンテキストが「予約確定イベント」を発行します。
    2.  決済コンテキストの**ACL**がそのイベントを受け取ります。
    3.  ACLはイベントの豊富な情報の中から、`customerId`と`amount`だけを抜き出します。
    4.  そして、「`ChargeCustomerCommand(customerId, amount)`」という、決済コンテキスト内部で使うシンプルな命令に**翻訳**して渡します。

この「翻訳家」を置くことで、各コンテキストは自身のモデルの純粋性を保ち、独立性を高く維持することができるのです。