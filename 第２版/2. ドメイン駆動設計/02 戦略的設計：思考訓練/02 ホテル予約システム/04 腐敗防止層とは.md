## 腐敗防止層

**腐敗防止層 (Anti-Corruption Layer, ACL)** は、コンテキスト同士を連携させる上で非常に重要なパターンです。

腐敗防止層とは、**下流コンテキストが、上流コンテキストの複雑なモデルや言語に振り回されないように、自分自身を守るために作る「翻訳・防御壁」**のことです。

***
### なぜ「腐敗防止」が必要なのか？

コンテキスト同士が連携するとき、上流のモデルを下流がそのまま使ってしまうと、下流は上流の都合に強く縛られてしまいます。上流でモデルの変更があると、下流も追随して修正が必要になり、独立性が失われてしまいます。これをモデルの**「腐敗」**と呼びます。

腐敗防止層は、この問題を解決します。

### 国際会議の同時通訳ブース 🎧



このパターンは、国際会議での**同時通訳ブース**に例えることができます。

* **外国語の講演者 (上流コンテキスト)**:
    * 複雑で専門的な外国語（上流のモデル）で、滔々とスピーチをしています。

* **あなた (下流コンテキスト)**:
    * 会議の参加者です。講演の要点だけを、自分の母国語で理解したいと思っています。外国語の細かいニュアンスまですべて理解する必要はありません。

* **同時通訳ブース (腐敗防止層)**:
    * あなたの耳元にあるイヤホンに繋がっています。ブースの中の通訳者は、外国語の講演を聞き、その中から**あなたが必要な情報だけ**を抜き出して、あなたの**母国語に翻訳**してくれます。

この通訳ブースのおかげで、あなたは外国語を学ぶ必要なく、講演者の話に振り回されることなく、自分の仕事（内容の理解）に集中できます。

---
### ホテルシステムの例

これをホテルシステムに当てはめてみましょう。

1.  **上流（予約コンテキスト）からの情報**:
    「予約が確定した」というイベントが発生します。この情報には、宿泊期間、客室タイプ、宿泊客の人数、リクエスト（禁煙ルーム希望など）、合計料金、顧客IDなど、豊富な情報が含まれています。

2.  **腐敗防止層 (ACL) の仕事**:
    下流である**決済コンテキスト**の入り口にいるACLは、この豊富な情報を受け取ります。しかし、決済コンテキストが知る必要があるのは、**「誰に（顧客ID）」「いくら（合計料金）」請求するか**だけです。

3.  **下流（決済コンテキスト）への翻訳**:
    ACLは、他の不要な情報をすべて捨て去り、「`ChargeCommand(customerId: 'CUS-123', amount: 15000)`」という、決済コンテキスト内部だけで使われるシンプルな命令に**翻訳**します。



### まとめ

腐敗防止層（ACL）は、
* **下流コンテキストのモデルをシンプルで純粋に保つ。**
* **上流コンテキストの変更が、下流コンテキストに与える影響を最小限に食い止める。**

という、コンテキストの独立性を守るための、極めて重要な防御パターンなのです。

## 🤔 腐敗防止層は下流コンテキストが自分自身を守るために作るのですか？

はい、その通りです。

腐敗防止層は、**下流コンテキスト（情報を受け取る側）のチームが、自分たちのシステムを守るために、自分たちで構築します。**

***
### なぜ「守る側」が作るのか？

この責任の所在は、腐敗防止層の役割を考えると非常に自然です。

#### 自分の「翻訳家」は自分で雇う



この関係は、外国の要人と会談する際に、**自分のための通訳を自分で雇う**のと同じです。

* **外国の要人 (上流コンテキスト)**:
    * 自分の母国語で、豊富な情報を話します。彼らは、あなたの言語を学ぶ義理もなければ、あなたが何を知りたいかを細かく気遣う必要もありません。

* **あなた (下流コンテキスト)**:
    * 会談を成功させるために、要人の話の中から自分に関係のある要点だけを、自分の言葉で理解する必要があります。

この時、あなたは要人に対して「私のために、私の分かる言葉で話してください」とは要求しませんよね。代わりに、**自分自身で優秀な通訳（腐敗防止層）を雇い**、「要人の話を聞いて、私に必要な部分だけを翻訳してくれ」と指示します。

翻訳のルール（どの単語をどう訳すか）を決めるのは、常に**情報を受け取る側**であるあなたです。

---
### ホテルシステムの例

これをホテルシステムに当てはめてみましょう。

* **予約コンテキスト (上流)**:
    * 「予約が確定した」という事実を、自身の持つ豊富な情報（宿泊期間、客室タイプ、特別リクエストなど）を含んだ形で、システム全体に知らせます。

* **決済コンテキスト (下流)**:
    * 支払い処理を行うために必要なのは、`customerId`と`amount`だけです。予約の詳細は知りたくありません。

* **決済コンテキストのチーム (下流チーム)**:
    * **自分たちのコンテキストの入り口**に、腐敗防止層を**自分たちで実装します**。
    * この腐敗防止層は、予約コンテキストからの豊富な情報を受け取り、自分たちが必要な`customerId`と`amount`だけを抜き出して、自分たちの内部で使うシンプルな命令に翻訳します。

予約コンテキストのチームは、決済チームがこのような翻訳を行っていることを知る必要すらありません。

この「**翻訳の責任は、常に情報を受け取る側（下流）が負う**」という原則が、各コンテキストの独立性を保つ上で非常に重要なのです。