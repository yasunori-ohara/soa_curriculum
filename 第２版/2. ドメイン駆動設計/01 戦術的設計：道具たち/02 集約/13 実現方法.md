## 集約：実現方法

## ❓ DDDの集約はOOPのプログラム言語の何かしらの機能を使って実現していると思うのですが、どの機能を使っていますか？

DDDの集約は、特定の言語に用意された特別な機能（例: `aggregate` キーワード）を使うのではなく、私たちが普段から使っている**基本的なオブジェクト指向の機能をいくつか組み合わせて、規律（ルール）を持って使う**ことで実現するデザインパターンです。

---
### 🏰 集約という「要塞」を築くための言語機能

集約を「外部の不正な操作から内部の状態を護る**要塞**」だと考えてみましょう。この要塞を築くために、以下の基本的な言語機能が重要な役割を果たします。

#### 1. クラスとオブジェクト (要塞そのもの)
`class` は、データ（プロパティ）と振る舞い（メソッド）を一つにまとめる基本機能です。集約ルートである `Book` クラスや、内部エンティティである `Review` クラスが、この要塞の設計図にあたります。

---
#### 2. アクセス修飾子 (門と壁)
`public`, `private` といったアクセス修飾子は、集約のルールを強制するための**最も重要な機能**です。

* `public`: 「**城門**」です。集約ルートが外部に公開する操作メソッド（例: `addReview`）は `public` にします。これが、外部とやり取りする唯一の正式な窓口です。
* `private`: 「**城壁**」や「**城内の立ち入り禁止区域**」です。集約の内部データ（例: `reviews` 配列）や、内部だけで使うメソッド（例: `recalculateAverageRating`）を `private` にします。これにより、外部から内部の状態を勝手に書き換えたり、ルールを無視した操作をしたりするのを防ぎます。

---
#### 3. メソッド (門番への命令)
集約ルートに定義された `public` なメソッドは、門番（ルート）に与えることができる**正式な命令**です。`book.reviews.push(...)` のような直接的なデータ操作を許さず、`book.addReview(...)` という命令（メソッド）を通じてのみ状態変更を許可します。メソッドの内部で、ビジネスルール（不変条件）のチェックを必ず行います。

---
#### 4. コンストラクタ / ファクトリ (建築規則)
コンストラクタやファクトリは、集約が**生まれた瞬間に、必ず正しい状態であること**を保証する機能です。要塞を建てる際の「建築基準法」のようなものです。必要な情報が足りなかったり、初期状態として不正な値が渡されたりした場合は、インスタンスの生成を許可しません。

---
#### 5. 例外処理 (命令の拒否)
外部から与えられた命令が、ビジネスルールに違反する場合（例: 同じ人が2回目のレビューをしようとした）、メソッドは**例外 (Exception) をスロー**します。これは、門番が「その命令はルール違反なので実行できません」と要求を**拒否**する行為にあたります。これにより、集約が不正な状態に陥るのを防ぎます。



このように、特別な魔法があるわけではなく、**クラス**で概念をまとめ、**アクセス修飾子**で境界を守り、**メソッド**で操作を限定し、**コンストラクタ**で整合性を保証し、**例外**でルール違反を通知する、といった基本機能の組み合わせと、それを徹底する**規律**によって、DDDの集約は実現されています。