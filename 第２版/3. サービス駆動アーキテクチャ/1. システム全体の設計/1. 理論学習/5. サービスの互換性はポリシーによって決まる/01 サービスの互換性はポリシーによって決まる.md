## 4. サービスの互換性はポリシーによって決まる (Service compatibility is determined by policy)

この原則の核心は、**「一度公開したサービスを更新する際には、そのサービスを利用している他のサービスを壊さないように、明確に定められたルール（ポリシー）に従わなければならない」**という考え方です。

SOAでは各サービスが自律的に進化していきますが、完全に自分勝手に変更を加えてしまうと、システム全体が頻繁に壊れてしまいます。そこで、安全に進化していくための交通整理ルールが必要になるのです。

### 🤝 なぜポリシーが必要か？：USB規格の例え

この考え方は、パソコンの**USB規格**の進化に例えることができます。

USBは1.0から始まり、2.0、3.0、そしてUSB4へと進化してきました。速度や機能は向上しましたが、常に**後方互換性（Backward Compatibility）**というポリシーが守られてきました。

* 新しいUSB3.0のポートに、古いUSB2.0のマウスを挿しても問題なく動きます。
* 古いUSB2.0のポートに、新しいUSB3.0のメモリを挿しても（速度は落ちますが）動きます。

これは、「新しい規格は、古い規格の機能を必ずサポートする」という厳格なポリシーがあるからです。もしUSB3.0が登場したときに、コネクタの形が全く別物になり、過去の機器が一切使えなくなっていたら、大混乱が起きていたでしょう。

サービスのAPIも同じです。一度公開したAPIは、それを信頼して利用しているクライアント（他のサービスやフロントエンドアプリ）がいます。APIを提供する側は、クライアントを壊さないように、互換性を維持する責任があるのです。

### 🤝 一般的な互換性ポリシーの例

APIの互換性を維持するための、最も一般的で重要なルールは**「追加はOK、変更と削除はNG」**というものです。

#### **やって良いこと（後方互換性を維持する変更）**

* **APIレスポンスに、新しいオプショナルな項目を追加する**:
    古いクライアントは、知らない項目が追加されても просто無視します。
* **新しいAPIエンドポイントを追加する**:
    `/v1/users`はそのままに、新しく`/v2/users`を追加するなど。古いクライアントは古いエンドポイントを使い続けます。
* **リクエストに、新しいオプショナルなパラメータを追加する**:
    古いクライアントがそのパラメータを送らなくても、サーバー側でデフォルトの動作をすることで対応します。

#### **やってはいけないこと（後方互換性を破壊する変更）**

* **APIレスポンスから項目を削除する**:
    その項目に依存しているクライアントは、エラーを起こして停止します。
* **既存の項目の名前を変更する**:
    これは「古い項目を削除し、新しい項目を追加する」のと同じ意味であり、破壊的な変更です。
* **既存の項目のデータ型を変更する** (例: 数値を文字列に変える):
    クライアントは数値が返ってくることを期待しているため、エラーになります。
* **リクエストに、新しい必須パラメータを追加する**:
    古いクライアントは新しい必須パラメータを送ってこないため、全てのリクエストがエラーになります。

### 🤝 破壊的な変更が必要になった場合は？

どうしても互換性を破壊する変更が必要になった場合は、**APIのバージョンを上げる**のが一般的な解決策です。

* 既存の`/v1/users`はそのまま維持し続ける。
* 破壊的な変更を含んだ、新しい`/v2/users`というエンドポイントを公開する。
* そして、「`/v1`は今後6ヶ月で廃止しますので、`/v2`に移行してください」というように、クライアントに移行期間を告知します。

### 🤝 まとめ

この原則は、一見するとサービスの自律性を**制約**するように見えるかもしれません。しかし実際には、明確なルールがあるからこそ、各サービスチームは**「このルールさえ守れば、他を壊す心配なく安全に変更できる」**と自信を持って、**自律的**に開発を進めることができるのです。

OpenAPIの仕様書は、このポリシーが守られているか（破壊的な変更がないか）をツールで自動的にチェックするためにも利用されます。

---

以上で、SOAの4大基本原則すべての解説が完了しました。
これらの原則はすべて、サービスの**「疎結合」**と**「独立性」**を高め、変化に強い柔軟なシステムを構築するために存在しています。

次はいよいよ、これらの理論を元に簡単なサービスの**設計**に進んでいきましょう。準備はよろしいでしょうか？
