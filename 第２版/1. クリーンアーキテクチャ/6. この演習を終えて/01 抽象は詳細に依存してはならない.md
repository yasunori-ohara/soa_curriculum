## 🤔 抽象は詳細に依存してはならない / 詳細が抽象に依存すべきである

### 依存性反転の原則（DIP）

これは、**依存性反転の原則（DIP）**のことであり、クリーンアーキテクチャの心臓部です。

* **上位レベルの方針**: ビジネスの目的やルールそのもの。（例：「本を貸し出す」という業務フロー）
* **下位レベルの実装**: その方針を実現するための具体的な技術や手段。（例：「メモリ上の辞書にデータを保存する」という技術）

この原則は、「**ビジネスの目的が、それを実現する些末な手段に振り回されてはいけない**」という考え方です。

## 🛂 インターフェースの役割：依存関係の「逆転」

この原則を実現する上で絶対不可欠な鍵となるのが**インターフェース**です。インターフェースは、上位レベルの方針と下位レベルの詳細の間に立ち、両者の力関係を「逆転」させます。

壁のコンセントに例えるなら、**PC（上位レベル）**が「私を動かすには、この形の差し込み口（**インターフェース**）が必要です」と**要求を定義**し、**壁の配線（下位レベル）**は、その要求された規格に合ったコンセントを**提供する責任**を負います。これにより、依存関係が逆転します。

### 2つの図による可視化

この原則とインターフェースの役割は、2つの図を使うことで完璧に可視化できます。

### 🌐 **1. 同心円の図：アーキテクチャ全体の「法則」**
![クリーンアーキテクチャ・同心円](../クリーンアーキテクチャ・同心円.png)
この図は、DIPを**マクロな視点**で表現します。

* **上位レベルの方針（Use Cases, Entities）**は円の**内側**にあります。
* **下位レベルの詳細（Adapters, Frameworks）**は円の**外側**にあります。
* **インターフェース（Boundaries）**は、内側の層が要求するものとして定義されるため、概念的には**内側の層**に属します。

「依存性の矢印は必ず内側を向く」というルールは、**「下位レベル（外側）が、上位レベル（内側）の要求（インターフェース）に依存しなければならない」**というDIPの法則そのものを図で示しています。この図は、なぜアーキテクチャ全体が安定するのか、その**哲学**を語ります。

### 🌐 **2. フローのクラス図：単一機能の「仕組み」**
![クリーンアーキテクチャ・クラス図](../クリーンアーキテクチャ・クラス図.png)
この図は、DIPを**ミクロな視点**で表現します。

`UseCase Interactor` → `<I>DataAccessInterface` ← `DataAccess`

この「→ ←」という矢印の形が、依存性逆転の**具体的な仕組み**を表しています。

* **`UseCase Interactor`（上位レベル）**は、具体的な`DataAccess`クラスを知りません。ただ、自分が必要とする機能が書かれた契約書、`DataAccessInterface`（**抽象**）だけを見ています。
* **`DataAccess`（下位レベル）**は、その`DataAccessInterface`（**抽象**）に書かれた契約を守るように、自身を実装する責任があります。

この図は、一つの機能がどのようにしてDIPの法則を守りながら実装されるのか、その**技術的な詳細**を語ります。

## 🛠️ 題材との関連（図書館システム）

* `application/check_out_book_interactor.py`（**上位レベルの方針**）は、「本を貸し出す」というビジネスルールを定義しています。
* `adapters/data_access.py`の`InMemoryBookDataAccess`クラス（**下位レベルの実装**）は、その機能を「メモリ上の辞書」で実現します。

もしインターフェースがなければ、`Interactor`が`InMemoryBookDataAccess`を直接知ってしまい、「抽象が詳細に依存」したことになります。

これを避けるため、私たちは`boundaries.py`に`BookDataAccessInterface`という**抽象的な「契約書」（インターフェース）**を定義しました。

* **`CheckOutBookInteractor`**は、この抽象的な`BookDataAccessInterface`にのみ依存します。
* **`InMemoryBookDataAccess`**は、この`BookDataAccessInterface`という「契約」を**実装する責任**を負います。

この**インターフェース**の存在によって初めて、「**詳細が抽象に依存する**」というクリーンで柔軟な関係が実現できるのです。そして、この関係こそが、同心円の図が示す「内側へ向かう依存」の具体的な現れなのです。