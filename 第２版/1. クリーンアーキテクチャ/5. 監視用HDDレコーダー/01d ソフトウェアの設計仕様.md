## ソフトウェアの「設計仕様」

いただいた製品仕様を、クリーンアーキテクチャのコンポーネント（登場人物）にマッピングし、開発に着手できるような**アーキテクチャ仕様**に変換します。

これは、製品の「要求仕様」を、ソフトウェアの「設計仕様」に落とし込む作業にあたります。

---
### 監視用HDDレコーダーのアーキテクチャ仕様

#### 1. Domain層：システムの核となるルール (Entities)
アプリケーションや技術に依存しない、システムの最も純粋なビジネスコンセプトとルールを定義します。

* **`RecordingSegment` (録画セグメント) Entity**
    * **責務**: 一つの録画データの管理情報（メタデータ）を保持する。
    * **プロパティ**: `id`, `camera_id`, `start_time`, `end_time`, `recording_type` (Enum: `NORMAL`, `ALARM`, `EMERGENCY`), `resolution`, `frame_rate`
    * **ルール (メソッド)**: `is_protected()` -> `recording_type`が`EMERGENCY`ならTrueを返す。

* **`CameraSetting` (カメラ設定) Entity**
    * **責務**: 一台のカメラに関する設定値を保持し、その値の正当性を保証する。
    * **プロパティ**: `camera_id`, `normal_quality`, `alarm_setting` (プリ/アフター録画時間を含む)
    * **ルール (メソッド)**: `camera_id`が1〜16の範囲内であることなどを自己検証する。

* **`RecordingSchedule` (録画スケジュール) Entity**
    * **責務**: 一つのタイマー予約録画ルールを保持する。
    * **プロパティ**: `id`, `camera_id`, `day_of_week`, `start_time`, `end_time`, `is_enabled`
    * **ルール (メソッド)**: `is_active_at(datetime)` -> 指定された日時がスケジュール範囲内かを判定する。

* **`StoragePolicy` (ストレージポリシー) Entity**
    * **責務**: HDD全体の運用戦略を定義し、どのセグメントを上書きすべきか、緊急領域に空きがあるか、といった高度な判断を行う。
    * **プロパティ**: `emergency_area_percentage`, `emergency_area_full_policy`
    * **ルール (メソッド)**: `find_segment_to_overwrite(segments)`, `can_record_emergency(segments)`

---
#### 2. Application層：システムの振る舞い (Use Cases)
システムの具体的な機能（ユースケース）を定義します。各ユースケースは、`Entity`を指揮して一つのシナリオを完結させます。

* **`StartScheduledRecordingUseCase`**: 定期的に起動され、各カメラのスケジュールをチェックし、必要に応じて録画を開始/停止させる。
* **`HandleAlarmEventUseCase`**: 人物検知イベント発生時に、プリ/アフター録画を含むアラーム録画セグメントを生成・保存する。
* **`HandleEmergencyEventUseCase`**: 緊急ボタン押下時に、保護領域への緊急録画セグメントを生成・保存する。
* **`SearchRecordingsUseCase`**: 日時やアラーム種別を条件に、再生対象となる`RecordingSegment`のリストを検索する。
* **`PlaybackControlUseCase`**: 再生、停止、早送り、コマ送りといった再生状態を管理する。
* **`UpdateCameraSettingUseCase`**: ユーザーからの入力に基づき、`CameraSetting` Entityを更新する。
* **`DeleteProtectedRecordingUseCase`**: ユーザーの指示に基づき、保護された緊急録画セグメントを削除する。

---
#### 3. Interfaces：層の間の「契約書」 (Boundaries)
`UseCase`と外部の世界（UI, DB, ハードウェア）との間の依存関係を逆転させるためのインターフェースを定義します。

* **Data Access Interfaces**:
    * `RecordingSegmentRepository`: `RecordingSegment`のメタデータの永続化を管理。
    * `CameraSettingRepository`: `CameraSetting`の永続化を管理。
    * `RecordingScheduleRepository`: `RecordingSchedule`の永続化を管理。

* **Hardware Interfaces**:
    * `CameraHardwareInterface`: カメラからの映像ストリーム取得やプリ録画バッファを管理。
    * `HddHardwareInterface`: 録画セグメントファイルの物理的な書き込み・削除を管理。
    * `AlarmInputHardwareInterface`: 人物検知や緊急ボタンの物理的な信号を検知。
    * `ControlPanelHardwareInterface`: 操作パネルのボタン押下を検知。

* **UI Boundaries**:
    * 各`UseCase`に対応する`InputBoundary`と`OutputBoundary`。（例: `SearchRecordingsInputBoundary`）

---
#### 4. Adapters層：変換と仲介
`Boundaries`で定義された「契約」を、具体的な技術で実装します。

* **Repositories**: `InMemory...Repository`や`File...Repository`など、上記Data Access Interfaceの具体的な実装クラス群。
* **Hardware Adapters**: `ConsoleCameraSimulator`, `ConsoleHddSimulator`など、上記Hardware Interfaceをコンソールでシミュレートする実装クラス群。
* **Controllers**: `SystemEventController`（アラーム検知など）、`ControlPanelController`（ユーザーのボタン操作）など、イベントを`UseCase`に伝達するクラス群。
* **Presenters**: `RecordingStatusPresenter`, `PlaybackPresenter`など、`UseCase`の結果を`ViewModel`に変換するクラス群。

---
#### 5. Frameworks & Drivers層：具体的な技術
アプリケーションの最も外側。具体的なツールやライブラリ、そして全体の組み立て役です。

* **View**: `ConsoleView`など、ユーザーとの具体的な入出力を担当。
* **Hardware Drivers**: 物理デバイスを直接操作する低レベルなドライバコード。
* **Main / Composition Root**: `main.py`。上記`Adapters`層の具象クラスをすべてインスタンス化し、システム全体を配線して起動する。