## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‹ã‚‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¾‹

-----

## ã‚¹ãƒ†ãƒƒãƒ—1ï¼šDDDé©ç”¨å‰ãƒ»ç´”ç²‹ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®çŠ¶æ…‹

ã“ã®æ™‚ç‚¹ã§ã®ç›®æ¨™ã¯ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åŸå‰‡ï¼ˆé–¢å¿ƒã®åˆ†é›¢ã€ä¾å­˜æ€§ã®ãƒ«ãƒ¼ãƒ«ï¼‰ã«å¾“ã†ã“ã¨ã§ã™ã€‚ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ã¾ã å˜ãªã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã‚ã‚Šã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã™ã¹ã¦ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«é›†ä¸­ã—ã¾ã™ã€‚

#### ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ (ãƒ‡ãƒ¼ã‚¿æ§‹é€ )

**ğŸ“ `entities/book.py`**

```python
from dataclasses import dataclass

@dataclass
class Book:
    id: str
    title: str
    status: str  # 'AVAILABLE' or 'LOANED'
```

**ğŸ“ `entities/member.py`**

```python
from dataclasses import dataclass

@dataclass
class Member:
    id: str
    name: str
```

**ğŸ“ `entities/loan.py`**

```python
from dataclasses import dataclass
from datetime import datetime

# Loanã¯å˜ãªã‚‹ã€Œè²¸å‡ºè¨˜éŒ²ã€ã®ãƒ‡ãƒ¼ã‚¿
@dataclass
class Loan:
    id: str
    book_id: str
    member_id: str
    loan_date: datetime
    due_date: datetime
```

#### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ (ã™ã¹ã¦ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒã“ã“ã«é›†ã¾ã‚‹)

**ğŸ“ `usecases/lend_book.py` (Before)**

```python
from datetime import datetime, timedelta

class LendBookUseCase:
    def __init__(
        self,
        book_repo: IBookRepository,
        member_repo: IMemberRepository,
        loan_repo: ILoanRepository
    ):
        self._book_repo = book_repo
        self._member_repo = member_repo
        self._loan_repo = loan_repo

    def execute(self, book_id: str, member_id: str):
        # --- 1. ãƒ‡ãƒ¼ã‚¿ã®å–å¾— ---
        book = self._book_repo.find_by_id(book_id)
        member = self._member_repo.find_by_id(member_id)
        
        if not book or not member:
            raise ValueError("æœ¬ã¾ãŸã¯ä¼šå“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

        # --- 2. ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®æ¤œè¨¼ (ãƒ­ã‚¸ãƒƒã‚¯ãŒã“ã“ã«é›†ä¸­ï¼) ---
        # ãƒ«ãƒ¼ãƒ«Aï¼šæœ¬ãŒè²¸å‡ºå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        if book.status == 'LOANED':
            raise ValueError("ã“ã®æœ¬ã¯æ—¢ã«è²¸å‡ºä¸­ã§ã™")
            
        # ãƒ«ãƒ¼ãƒ«Bï¼šä¼šå“¡ã®è²¸å‡ºä¸Šé™ã‚’ãƒã‚§ãƒƒã‚¯
        current_loans_count = self._loan_repo.count_by_member(member_id)
        if current_loans_count >= 5:
            raise ValueError("è²¸å‡ºä¸Šé™æ•°ã«é”ã—ã¦ã„ã¾ã™")

        # --- 3. ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° ---
        # çŠ¶æ…‹ã‚’ç›´æ¥å¤‰æ›´
        book.status = 'LOANED'
        
        loan_date = datetime.now()
        due_date = loan_date + timedelta(days=14) # è¿”å´æœŸé™ã¯2é€±é–“å¾Œ
        
        new_loan = Loan(
            id=generate_id(),
            book_id=book.id,
            member_id=member.id,
            loan_date=loan_date,
            due_date=due_date
        )

        # --- 4. ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ ---
        self._book_repo.save(book)
        self._loan_repo.save(new_loan)
```

ã“ã‚ŒãŒã€DDDã‚’é©ç”¨ã™ã‚‹å‰ã®ã€ãƒªã‚¢ãƒ«ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®çŠ¶æ…‹ã§ã™ã€‚ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ãŸã ã®ãƒ‡ãƒ¼ã‚¿å…¥ã‚Œç‰©ã§ã€`LendBookUseCase`ãŒã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ«ã‚’çŸ¥ã£ã¦ã„ã¦ã€å„ãƒªãƒã‚¸ãƒˆãƒªã‚’æ“ä½œã™ã‚‹è²¬ä»»ã‚’è² ã£ã¦ã„ã¾ã™ã€‚

-----

## ã‚¹ãƒ†ãƒƒãƒ—2ï¼šDDDã®é›†ç´„ã‚’é©ç”¨ã—ãŸãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

ã“ã“ã‹ã‚‰ã€ã‚¹ãƒ†ãƒƒãƒ—1ã®çŠ¶æ…‹ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«æ•£ã‚‰ã°ã£ãŸãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã€ã‚ã‚‹ã¹ãå ´æ‰€ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼‰ã«ç§»å‹•ã•ã›ã¾ã™ã€‚

#### é›†ç´„ (æŒ¯ã‚‹èˆã„ã‚’æŒã¤è³¢ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)

**ğŸ“ `domain/aggregates/book.py` (After)**

```python
class Book:
    def __init__(self, id: str, title: str, status: str):
        self.id = id
        self.title = title
        self._status = status # å†…éƒ¨çŠ¶æ…‹ã¯éš è”½

    def is_available(self) -> bool:
        return self._status == 'AVAILABLE'

    # ã€Œè²¸ã—å‡ºã•ã‚Œã‚‹ã€ã¨ã„ã†æŒ¯ã‚‹èˆã„ã‚’å®Ÿè£…
    def lend(self):
        if not self.is_available():
            raise ValueError("ã“ã®æœ¬ã¯æ—¢ã«è²¸å‡ºä¸­ã§ã™")
        self._status = 'LOANED'
```

**ğŸ“ `domain/aggregates/member.py` (After)**

```python
class Member:
    def __init__(self, id: str, name: str):
        self.id = id
        self.name = name

    # è²¸å‡ºä¸Šé™ã«é–¢ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’MemberãŒæŒã¤
    def check_loan_limit(self, current_loans_count: int):
        if current_loans_count >= 5:
            raise ValueError("è²¸å‡ºä¸Šé™æ•°ã«é”ã—ã¦ã„ã¾ã™")
```

**ğŸ“ `domain/aggregates/loan.py` (After)**

```python
from datetime import datetime, timedelta

class Loan:
    def __init__(self, id: str, book_id: str, member_id: str, loan_date: datetime, due_date: datetime):
        self.id = id
        self.book_id = book_id
        self.member_id = member_id
        self.loan_date = loan_date
        self.due_date = due_date

    # Loanã®ç”Ÿæˆãƒ«ãƒ¼ãƒ«ã‚’ãƒ•ã‚¡ã‚¯ãƒˆãƒªã«ã‚«ãƒ—ã‚»ãƒ«åŒ–
    @classmethod
    def create(cls, book: Book, member: Member, current_loans_count: int) -> 'Loan':
        # é–¢é€£ã™ã‚‹é›†ç´„ã«ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’ä¾é ¼
        member.check_loan_limit(current_loans_count)
        # book.lend()ã®ä¸­ã§is_available()ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹
        
        loan_date = datetime.now()
        due_date = loan_date + timedelta(days=14)
        
        return cls(generate_id(), book.id, member.id, loan_date, due_date)
```

#### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ (ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ãŸæŒ‡æ®è€…)

**ğŸ“ `usecases/lend_book.py` (After)**

```python
class LendBookUseCase:
    def __init__(
        self,
        book_repo: IBookRepository,
        member_repo: IMemberRepository,
        loan_repo: ILoanRepository
    ):
        self._book_repo = book_repo
        self._member_repo = member_repo
        self._loan_repo = loan_repo

    def execute(self, book_id: str, member_id: str):
        # 1. å¿…è¦ãªé›†ç´„ã‚„æƒ…å ±ã‚’å–å¾—ã™ã‚‹
        book = self._book_repo.find_by_id(book_id)
        member = self._member_repo.find_by_id(member_id)
        current_loans_count = self._loan_repo.count_by_member(member_id)

        # 2. ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«ä»•äº‹ã‚’ãŠé¡˜ã„ã™ã‚‹ï¼ˆifæ–‡ãŒæ¶ˆãˆãŸï¼ï¼‰
        #    Loanã®ç”Ÿæˆã¨ã€ãã®ãŸã‚ã®ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚’ä¾é ¼
        new_loan = Loan.create(book, member, current_loans_count)
        
        #    Bookã®çŠ¶æ…‹å¤‰æ›´ã‚’ä¾é ¼
        book.lend()
        
        # 3. å¤‰æ›´ãŒã‚ã£ãŸé›†ç´„ã‚’ã¾ã¨ã‚ã¦ä¿å­˜ã™ã‚‹
        self._book_repo.save(book)
        self._loan_repo.save(new_loan)
```

ã“ã®æ¯”è¼ƒã§ã€é›†ç´„ã‚’å°å…¥ã™ã‚‹ã“ã¨ãŒã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã„ã‹ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«ç§»å‹•ã•ã›ã€ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã§å®‰å…¨ãªã‚‚ã®ã«ã™ã‚‹ã‹ãŒæ˜ç¢ºã«ãªã£ãŸã‹ã¨æ€ã„ã¾ã™ã€‚
