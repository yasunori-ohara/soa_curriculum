## Pythonで集約を実現するためには

Pythonで集約を実現するために、特別な魔法のような機能はなく、以下の**基本的な言語機能の組み合わせ**と**規約**を利用しています。

-----

## 集約という「要塞」を築くPythonの言語機能 🏰

前回実装した`Book`集約を例に、どの機能が要塞のどの部分にあたるかを見ていきましょう。

### 1\. クラス (`class`)

**役割**: 要塞の**設計図**
`Book`や`Review`を`class`として定義することで、データ（属性）と振る舞い（メソッド）を一つのまとまりとしてカプセル化します。これはオブジェクト指向の最も基本的な機能であり、集約の土台となります。

```python
class Book:
    # ...
```

-----

### 2\. コンストラクタ (`__init__`)

**役割**: 要塞の**建設**
`__init__`メソッドは、オブジェクトが生成されるときに必ず呼ばれます。ここで、集約が最低限必要とする初期状態（例えば、空のレビューリスト）を整え、整合性の取れた状態でインスタンスが生まれることを保証します。

```python
def __init__(self, title: str):
    self.title = title
    self._reviews: List[Review] = []
    self._average_rating: float = 0.0
```

-----

### 3\. メソッド (`def add_review(...)`)

**役割**: **門番への公式な命令**
`add_review`のようなpublicなメソッドは、外部から集約を操作するための唯一の公式な窓口です。ビジネスルール（不変条件）のチェックや、状態変更のロジックはすべてこの中に実装します。

```python
def add_review(self, user_id: str, rating: int, comment: str):
    # ルールチェックや状態変更のロジックはすべてここ
    # ...
```

-----

### 4\. アンダースコアによる命名規約 (`_`)

**役割**: **「関係者以外立ち入り禁止」の看板**
Pythonで集約のルールを強制するための**最も重要な規約**です。`_reviews`や`_recalculate_average_rating`のように、名前の先頭にアンダースコアを付けることで、「これは内部で使うものなので、外部から直接触らないでください」という**紳士協定**を示します。これが集約の「境界」を守るための壁の役割を果たします。

-----

### 5\. プロパティ (`@property`)

**役割**: **防弾ガラスの飾り窓**
`@property`を使うと、メソッドを属性のように見せかけることができます。これにより、`_average_rating`という内部状態を、外部からは`book.average_rating`という形で**安全に読み取ることだけ**を許可できます。書き込み（`book.average_rating = 5`）はできないため、内部の状態が勝手に変更されるのを防ぎます。

```python
@property
def average_rating(self) -> float:
    return self._average_rating
```

-----

### 6\. 例外処理 (`raise ValueError`)

**役割**: **侵入者を知らせる警報**
ビジネスルールに違反する操作が行われた場合、メソッドは例外を発生させます。これは、門番が不正な命令を拒否し、「ルール違反です！」と警報を鳴らす行為です。これにより、集約が不正な状態になるのを防ぎます。

```python
if any(r.user_id == user_id for r in self._reviews):
    raise ValueError("この本には既にレビューを投稿済みです。")
```

このように、Pythonでは言語機能と開発者の間の規約を組み合わせることで、集約の「一貫性を保つ責任者」としての役割を実現しています。