## 第3章：アーキテクチャ上の置き場所が明確になる

リポジトリがもたらす3つ目の、そして建築的に最も重要な効果は、**クリーンアーキテクチャのどこに何を置くべきか**という「住所」を明確に定めてくれる点です。

リポジトリは、\*\*「インターフェース（仕様書）」**と**「実装（具体的な作業）」\*\*という2つのパーツから構成され、それぞれが異なるレイヤーに配置されます。

### 1\. インターフェース（仕様書）の置き場所：ドメイン層

リポジトリの**インターフェース**（Pythonでは抽象基底クラス `ABC` を使うことが多い）は、**ドメイン層**に配置します。

なぜなら、インターフェースは「ビジネスロジックが、永続化層に**何を**して欲しいか」を定義する**契約書**だからです。この契約書は、ビジネスの言葉（ユビキタス言語）で書かれるべきであり、ドメイン層の一部です。

**📁 `domain/repositories.py`**

```python
from abc import ABC, abstractmethod
from domain.aggregates.book import Book

# ドメイン層で「本の倉庫番には、こういう仕事をお願いしたい」という契約を定義
# データベースが何か、といった詳細は一切書かない
class IBookRepository(ABC):

    @abstractmethod
    def find_by_id(self, book_id: str) -> Book:
        pass

    @abstractmethod
    def save(self, book: Book):
        pass
```

### 2\. 実装（具体的な作業）の置き場所：インフラ層

一方で、インターフェースを実際に実装する**具体的なクラス**は、最も外側の**インフラストラクチャ層**に配置します。

なぜなら、このクラスはPostgreSQLやMySQLといった**特定の技術**に依存した、具体的なコードを書く場所だからです。これはビジネスロジックではなく、「外部の詳細」です。

**📁 `infrastructure/repositories/postgres_book_repository.py`**

```python
from domain.repositories import IBookRepository
from domain.aggregates.book import Book
import psycopg2 # ← 具体的な技術への依存

# インフラ層で「PostgreSQLを使った場合の、本の倉庫番の仕事のやり方」を実装
class PostgresBookRepository(IBookRepository):

    def find_by_id(self, book_id: str) -> Book:
        # PostgreSQLに接続し、SELECT文を実行してBook集約を復元する
        # ...具体的な実装...
        pass

    def save(self, book: Book):
        # PostgreSQLに接続し、UPDATE文やINSERT文を実行する
        # ...具体的な実装...
        pass
```

### 依存性逆転の原則 (DIP)

この配置により、クリーンアーキテクチャの心臓部である\*\*「依存性逆転の原則」\*\*が実現されます。

  * **悪い依存**: `UseCase（内側） → PostgresRepository（外側）`

      * これでは、ビジネスロジックがインフラの詳細に依存してしまいます。

  * **良い依存 (DIP)**:
    `UseCase（内側） → IBookRepository（内側）`
    `PostgresRepository（外側） → IBookRepository（内側）`

<!-- end list -->

```
┌───────────┐      ┌─────────────────┐      ┌────────────────────────┐
│  UseCase  │  ──> │ IBookRepository │ <──  │ PostgresBookRepository │
└───────────┘      └─────────────────┘      └────────────────────────┘
 (ドメインに近い層)         (ドメイン層)                (インフラ層)
```

図のように、外側のインフラ層が、内側のドメイン層で定義されたインターフェースに**依存する**形になります。依存性の方向が逆転するため、「依存性逆転」と呼ばれます。

### この配置がもたらす絶大なメリット

1.  **テスト容易性**:
    UseCaseをテストする際、本物の`PostgresBookRepository`の代わりに、メモリ上で動く簡単な`InMemoryBookRepository`を差し込むことができます。UseCaseは相手がインターフェース（契約）を守っていることしか気にしないため、テストのために重たいデータベースを起動する必要がなくなります。

2.  **柔軟性と交換可能性**:
    将来、データベースをPostgreSQLからMongoDBに移行したくなったとします。その場合、`MongoBookRepository`という新しい実装クラスを作るだけで済み、**ドメイン層やUseCaseのコードには一切変更が必要ありません**。

このように、リポジトリの「住所」を明確に定めることは、ドメインモデルをインフラストラクチャの詳細から守り、システム全体を**疎結合で、テストしやすく、変化に強い**構造に保つための、極めて重要な役割を果たすのです。