## レーンキープアシスト（LKA）

**レーンキープアシスト（LKA）**は、ユーザーから見るとシンプルな機能に見えますが、内部には多くのルールや状態管理が含まれており、DDDの思考訓練の題材として最適です。

LKAの設計では、まず`車線情報`や`車両速度`といった**値オブジェクト**を定義します。次に、カメラ情報から「現在の走行レーン」を安定して認識する責務を持つ**`車線認識`集約**と、LKAのON/OFF状態を管理し、適切な操舵トルクを計算する**`ステアリング制御`集約**を設計します。最終的には、これらを**「認識」「制御」「ドライバー通知」**といった**境界づけられたコンテキスト**に分割していくのが良いアプローチになります。

***

### 1. 戦術的設計：LKAを構成する「部品」を考える

まず、LKAシステムを構成するであろう、具体的な「言葉」と「ルール」を、値オブジェクトと集約として定義していきます。

#### 道具1：値オブジェクト

* **`VehicleSpeed` (車両速度)**:
    単なる数値ではなく、「km/h」という単位を持ち、「0km/h以上」といったルールを持つ値オブジェクト。
* **`SteeringAngle` (操舵角)**, **`SteeringTorque` (操舵トルク)**:
    それぞれ「度」「Nm」といった単位と、物理的な最大値・最小値を持つ値オブジェクト。
* **`LaneMarking` (車線)**:
    カメラが認識した白線や黄線のことです。線の種類（実線、破線）、色、位置、そして「信頼度（どのくらい鮮明に見えているか）」といった情報を持つ、少しリッチな値オブジェクトです。
* **`LanePosition` (レーン内位置)**:
    左右の車線からの距離や、車線中央からのズレといった、車線内での車両の相対的な位置を表す値オブジェクト。

#### 道具2：集約

LKAは、「OFF」「待機中」「作動中」「一時停止中」「エラー」といった複雑な状態を持ち、それらの状態遷移には厳密なルールが伴います。この**状態とルールの一貫性**を管理するために、集約が非常に強力な武器となります。

##### 集約候補1：`LanePerception` (車線認識)


* **集約ルート**: `LanePerception`
* **責務**: カメラから刻々と送られてくる生のセンサー情報（たくさんの`LaneMarking`の断片）を分析し、**「現在の走行レーンは、信頼できる安定した状態か」を一貫して管理する**。
* **内包するもの**: `left_lane: LaneMarking`, `right_lane: LaneMarking`, `current_position: LanePosition` など。
* **振る舞い**:
    * `update_with_sensor_data(sensor_data)`: 新しいセンサー情報を受け取り、過去のデータと統合して、より信頼性の高いレーンモデルを維持します（ノイズ除去など）。このメソッドを呼び出すだけで、内部の状態は常に一貫性が保たれます。

##### 集約候補2：`SteeringControl` (ステアリング制御)


* **集約ルート**: `SteeringControl`
* **責務**: LKAシステムのON/OFF状態を管理し、`LanePerception`からの情報に基づいて、**適切な操舵トルクを計算して出力する**。
* **内包するもの**: `system_status: LKASystemStatus` (OFF, ACTIVEなど), 速度設定など。
* **振る舞い**:
    * `activate()`: LKAを作動状態にする。この時、「車速が60km/h以上であること」「車線が安定して認識できていること」といった作動条件をチェックします。
    * `calculate_steering_torque(lane_model: LanePerception)`: `LanePerception`集約の状態（車線の中央からどれだけズレているか）を入力として受け取り、制御ロジック（例：PID制御）に基づいて、「右に1.5Nmのトルクをかける」といった具体的な操舵トルクを計算します。
    * `deactivate_by_driver_input()`: ドライバーが強くハンドルを切ったことを検知し、システムを一時停止状態にする、といったルールも管理します。

---
### 2. 戦略的設計：LKAと周辺システムとの「地図」

LKAは単体では動作せず、車の中の様々なシステムと連携します。この関係性を**境界づけられたコンテキスト**として整理します。

* **認識コンテキスト (Perception Context)**:
    カメラやセンサーからの情報を分析し、「外界がどうなっているか」を理解することに特化した領域。`LanePerception`集約はここに属します。

* **制御コンテキスト (Control Context)**:
    認識コンテキストからの情報に基づいて、「車をどう動かすか」を判断し、命令を出す領域。`SteeringControl`集約はここに属します。

* **ドライバー通知コンテキスト (Driver Interface Context)**:
    制御コンテキストからの状態（「LKAが作動した」など）を受け取り、メーターの表示灯を点灯させたり、警告音を鳴らしたりする領域。

* **アクチュエーションコンテキスト (Actuation Context)**:
    制御コンテキストからの命令（「右に1.5Nmのトルク」）を受け取り、ステアリングモーターに適切な電気信号を送る、物理デバイスに近い領域。

#### コンテキストマップ（影響の流れ）

これらの関係性を描くと、SDVにおけるソフトウェアの綺麗な分割単位が見えてきます。

`[カメラセンサー]` → `[認識コンテキスト]` → `[制御コンテキスト]` → `[ステアリングモーター]`

`[制御コンテキスト]` → `[ドライバー通知コンテキスト]`

このように、一見シンプルに見えるLKAも、DDDの道具を使って分析することで、責務が明確な部品（値オブジェクト、集約）と、それらが連携する見通しの良いシステム構造（コンテキスト）に分解できるのです。