## 補足

**要点を抑えた一発回答**として、
実際のLKA開発では、これらのコンテキスト間の連携は**リアルタイム性**が非常に重要であり、**ドメインイベント**という非同期通信パターンがよく使われます。

***
### 補足：ドメインイベントによるコンテキスト連携

私たちが設計したコンテキスト同士は、互いに情報をやり取りする必要がありました。

> `[認識コンテキスト]` → `[制御コンテキスト]` → `[ドライバー通知コンテキスト]`

この連携方法として、**ドメインイベント (Domain Event)** という非同期パターンを使うと、システムをより疎結合で拡張しやすくできます。

#### ドメインイベントとは？

ドメインイベントは、「**ドメインで発生した、過去の重要な出来事**」を表すオブジェクトです。

**例**:
`認識コンテキスト`が、安定したレーンモデルの更新を完了したとします。その瞬間、`認識コンテキスト`は以下のような**イベント（出来事）**をシステム内に**発行（ブロードキャスト）**します。

> **`LaneModelUpdated` イベント**
> * 発生時刻: 2025-10-14 21:05:12.100
> * 内容: 「新しいレーンモデルが計算されました。左車線はここで、信頼度は98%です。」



#### イベント駆動での連携

このイベントが発行されると、それを**購読（サブスクライブ）**している他のコンテキストが、それぞれ独立して反応します。

1.  **`制御コンテキスト`の反応**:
    * `LaneModelUpdated`イベントを受け取る。
    * 「お、新しいレーン情報が来たな。これを使って次の操舵トルクを計算しよう」と、自身の`calculate_steering_torque()`メソッドを呼び出す。
    * 計算の結果、「LKAがステアリングに介入した」という新しいイベント`SteeringIntervened`を発行する。

2.  **`ドライバー通知コンテキスト`の反応**:
    * `SteeringIntervened`イベントを受け取る。
    * 「なるほど、システムが介入したのか。では、メーターのアイコンを緑色に点灯させよう」と、UIの更新処理を行う。

### このパターンのメリット

* **疎結合**:
    `認識コンテキスト`は、自分の情報を誰が（`制御コンテキスト`なのか、あるいはテスト用のログ収集ツールなのか）使っているかを**一切知る必要がありません**。ただ、「こういう出来事が起きた」と叫ぶだけです。これにより、コンテキスト間の依存関係がなくなります。

* **拡張性**:
    将来、新たに「ドライブレコーダーコンテキスト」を追加したくなったとします。この新しいコンテキストが`LaneModelUpdated`イベントを購読すれば、既存の`認識コンテキスト`のコードを**一切変更することなく**、「車線が認識された瞬間の映像を記録する」といった新しい機能を追加できます。

SDVのような複雑なシステムでは、このようなイベント駆動のアプローチを取ることで、各機能（コンテキスト）を独立させ、後から機能を追加・変更しやすい、柔軟なアーキテクチャを構築することが一般的です。

## 🤔 当時の通信はCAN通信でした。ドメインイベントとの違いを教えてください。

はい、CAN通信とドメインイベントは、SDV開発において非常に重要な概念です。両者の違いを明確にしましょう。

**CAN通信**は、メッセージを運ぶための**「物理的な道路」や「郵便システム」**そのものです。対して**ドメインイベント**は、その道路を通って運ばれる**「手紙の内容（ビジネス上の意味）」**です。両者は、実装レイヤーが全く異なる、補完的な関係にあります。

***

### 役割と抽象レベルの違い

CAN通信とドメインイベントは、どちらも「情報を伝える」という目的は同じですが、その**役割**と**抽象度**が全く異なります。

| 観点 | CAN通信 (CAN Communication) | ドメインイベント (Domain Event) |
| :--- | :--- | :--- |
| **役割** | 通信プロトコル | 設計パターン / メッセージオブジェクト |
| **抽象レベル** | **低レベル**（物理層、データリンク層） | **高レベル**（ドメイン層、アプリケーション層） |
| **関心事** | ECU間で**データを確実に**送受信すること | ドメインで**重要な出来事が起きた**と通知すること |
| **メッセージの内容** | CAN ID + 0〜8バイトの**生データ** | イベント名 + **意味のある**プロパティ群 |
| **例え** | 郵便配達の**システム**（トラック、仕分け所） | 配達される**手紙の内容**（「結婚しました」「請求書在中」）|

---
### どのように連携するのか？

実際のSDVのソフトウェアでは、これら2つは協調して動作します。**ドメインイベント**という高レベルな「意味」を、**CAN通信**という低レベルな「道路」に乗せて運ぶのです。



**「認識コンテキスト」が「制御コンテキスト」にレーン情報を伝える流れ**

1.  **【ドメイン層】 イベントの発生**:
    `LanePerception`集約が新しいレーンモデルを計算し終えた瞬間、`LaneModelUpdated`というリッチな**ドメインイベントオブジェクト**をメモリ上で生成します。
    * `event = LaneModelUpdated(position_cm=15.5, confidence=0.95)`

2.  **【アダプター層】 翻訳・梱包 (シリアライズ)**:
    「CAN送信用アダプター」が、このドメインイベントオブジェクトを受け取ります。そして、CANの仕様に合わせて、このリッチな情報を**0〜8バイトの生データに変換（梱包）**し、`0x1A4`のような特定の**CAN ID**を割り当てます。
    * `can_message = { id: 0x1A4, data: [0x9B, 0x5F, ...] }`

3.  **【物理層】 データの送信**:
    CANドライバーが、この`can_message`を物理的な**CANバス**に電気信号として送信します。

4.  **【物理層〜アダプター層】 データの受信と翻訳解除**:
    制御コンテキスト側のECUがCANバスから`id: 0x1A4`のメッセージを受信します。
    「CAN受信用アダプター（腐敗防止層）」が、その生データを**翻訳解除**し、「これは`LaneModelUpdated`イベントだな」と解釈して、再びリッチな**ドメインイベントオブジェクト**をメモリ上に復元します。

5.  **【ドメイン層】 イベントの利用**:
    復元された`LaneModelUpdated`イベントを受け取った`SteeringControl`集約が、次の操舵トルクの計算を開始します。

---
### まとめ

あなたが当時CAN通信でやっていたことは、まさにこの**ステップ2, 3, 4**にあたります。
DDDは、その前後の**ステップ1と5**、つまり「**そもそも、そのCANデータがビジネス上どのような『意味』を持つのか**」をドメインイベントとして明確に定義することで、低レベルな通信の詳細と、高レベルなビジネスロジックを綺麗に分離するための、強力な設計思想を与えてくれるのです。