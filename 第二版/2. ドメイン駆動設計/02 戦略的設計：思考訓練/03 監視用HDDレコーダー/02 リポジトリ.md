## 🖼️ リポジトリ

値オブジェクトと集約という、ドメインモデルの核となる部品が設計できました。

次のステップは、これらの**集約を永続化（保存・復元）するための「倉庫番」役**である、**リポジトリのインターフェース**を定義することです。

-----

### 道具3：リポジトリ - 集約の永続化を担当する

私たちが設計した`Camera`や`Storage`といった集約オブジェクトは、今のままではプログラムが終了すると消えてしまう、メモリ上の存在です。これらの状態をHDDなどの記録媒体に保存し、次回起動時に復元する仕組みが必要になります。この役割を担うのが**リポジトリ**です。

リポジトリは、集約の「保管庫」として、ドメイン層が永続化の詳細を知らなくて済むようにすべてを隠蔽します。

-----

#### 1\. `Camera`集約のためのリポジトリ

`Camera`集約は、カメラが16台あるため、個別に設定を読み書きする必要があります。

**📁 `domain/repositories/camera_repository.py`**

```python
from abc import ABC, abstractmethod
from domain.aggregates.camera import Camera
from domain.value_objects.camera_id import CameraId

# Camera集約の倉庫番（リポジトリ）にお願いできる仕事のリスト
class ICameraRepository(ABC):

    @abstractmethod
    def find_by_id(self, camera_id: CameraId) -> Camera:
        """指定されたIDのカメラ設定（集約）を復元する"""
        pass

    @abstractmethod
    def save(self, camera: Camera):
        """カメラ設定（集約）の状態を保存する"""
        pass
```

**使い方（UseCaseのイメージ）**:
`ChangeResolutionUseCase`は、このリポジトリを使って以下のように動作します。

1.  `camera = camera_repo.find_by_id(CameraId(1))` で1番カメラの現在の設定を取得。
2.  `camera.change_settings(Resolution('高'))` で設定を変更。
3.  `camera_repo.save(camera)` で変更後の状態を丸ごと保存する。

-----

#### 2\. `Storage`集約のためのリポジトリ

`Storage`集約は、HDD全体で一つしか存在しない概念（シングルトン）です。そのため、IDで個別に探す必要はありません。

**📁 `domain/repositories/storage_repository.py`**

```python
from abc import ABC, abstractmethod
from domain.aggregates.storage import Storage

# Storage集約の倉庫番（リポジトリ）にお願いできる仕事のリスト
class IStorageRepository(ABC):

    @abstractmethod
    def get(self) -> Storage:
        """HDDの状態（集約）を丸ごと復元する"""
        pass

    @abstractmethod
    def save(self, storage: Storage):
        """HDDの状態（集約）を丸ごと保存する"""
        pass
```

**使い方（UseCaseのイメージ）**:
`RecordNormalSegmentUseCase`は、このリポジトリを使って以下のように動作します。

1.  `storage = storage_repo.get()` で現在のHDDの状態を取得。
2.  `storage.add_segment(new_segment)` で新しい録画セグメントを追加（この中でループ録画のロジックが動く）。
3.  `storage_repo.save(storage)` で最新のHDDの状態を保存する。

-----

### まとめ

これらのリポジトリインターフェースを定義することで、ドメイン層とアプリケーション層（UseCase）は、「**どのようにして**設定や録画データがHDDに書き込まれるのか」という物理的な詳細を一切知る必要がなくなります。

彼らはただ、ビジネスの言葉で「IDが1番のカメラ設定を持ってきて」「このHDDの状態を保存して」と、専門家であるリポジトリにお願いするだけで済むのです。