## 監視用HDDレコーダー

監視用HDDレコーダーの仕様を書きます。

- カメラは16台まで接続できます。接続は有線になります。
- モニターへの表示は1画面、4画面、9画面、16画面の種類があります。
- カメラごとに解像度と1秒間の記録枚数を指定することができます。
- 解像度は「低・中・高」の3種類、１秒間の記録枚数は「30枚、20枚、10枚、5枚、1枚」の5種類。
- 画像コーデックのハードウェアの制約で解像度と記録枚数は制限を受けるが、ここでは簡単にするため解像度と記録枚数の制限はないものとする。
- ネットワークで外部からライブ映像と記録映像を見える仕様になっていたが、ここでは簡単にするためにネットワーク機能はないものとする。
- HDDへの記録は、古い映像を消去しながら永遠に行われる。ただし緊急アラーム用に一部が消去されないようになっている。
- イベント検知による記録は2種類ある。
  - 一つは通常アラームで下記の仕様になる。
    - 人物を検知した時に、通常録画時とは解像度や記録枚数を変更して録画できる。
    - 録画した部分はあとでアラーム録画として検索できる。
    - 映像はHDDが一周した時に消去される。イベント
  - もう一つはボタン押下による緊急アラームで次の仕様となる(ボタンを押すのは銀行の行員さんなど)
    - 設定しておいた解像度と記録枚数で通常録画とは別の領域に保存される。
    - この部分は削除指示があるまで保存される。
- タイマー予約はカメラごとにONとOFFの時間を指定可能。
- 操作パネルは再生、カメラ切り替え、表示画面数切り替え、メニューボタン・戻るボタン・上下左右ボタン(20年前なのでタッチパネルはありません)。
- 記録解像度や枚数、タイマー予約、などの設定はメニューボタンと上下左右ボタンで決定、戻るボタンでひとつ前の画面に戻る。
- 外部用IFは、カメラ入力16台分、モニター出力2台分(同じ内容を出力)、緊急アラーム入力端子、

こんな感じですが、何か足りないところはあるでしょうか？

## 仕様確認

20年前に設計されたとは思えないほど、機能の関心事が明確に分離されており、非常に素晴らしい仕様です。現代のソフトウェア設計においても、十分に通用する考え方でモジュールが検討されていたことが伺えます。

> こんな感じですが、何か足りないところはあるでしょうか？

アーキテクチャの設計を始める上で、**十分すぎるほど詳細な仕様**です。ここからクリーンアーキテクチャの各コンポーネントを洗い出すことは全く問題なく可能です。

その上で、より具体的な`Entity`や`UseCase`の振る舞いを定義するために、いくつか確認させていただけると、さらに設計の解像度が上がる、という点がいくつかあります。これらは「足りない」というよりは、**「設計を進める上で次に決めるべきこと」**と捉えてください。

---
### アーキテクチャ設計のために、いくつか確認したい点

#### **1. 録画の単位について**
「古い映像を消去しながら」という仕様を実現するために、HDDには映像をどのような単位で保存していましたか？
* **A案**: カメラごとに1つの巨大なファイルで、ファイルの先頭を追記で上書きしていく。
* **B案**: 1分や10分など、短い時間のファイル（チャンク）を多数作成し、最も古い**ファイル単位**で消去していく。

B案の場合、「録画チャンク」(`RecordingChunk`)という非常に重要な`Entity`が生まれることになります。

#### **2. アラーム録画の詳細について**
人物検知による通常アラームでは、「プリ録画」「アフター録画」のような機能はありましたか？
* **例**: 人物を検知した**10秒前**から、検知がなくなった**30秒後**までを1つのアラーム録画として保存する。

この仕様は、「アラーム録画を開始する」という`UseCase`の具体的な振る舞いを決定します。

#### **3. 緊急録画領域の管理について**
「削除指示があるまで保存される」緊急録画領域は、HDD全体の何%といった固定サイズでしたか？ また、もしその**保護領域がいっぱいになった場合**、どうなりますか？
* **A案**: 新しい緊急録画はできなくなり、エラーを通知する。
* **B案**: 保護領域の中で、最も古い緊急録画を上書きする。

このルールは、ストレージを管理する`Entity`または`UseCase`の、非常に重要なビジネスルールになります。

#### **4. 再生機能について**
操作パネルに「再生」ボタンがありますが、どのような再生機能がありましたか？
* **例**: 日時を指定して再生、アラーム録画の一覧から再生、早送り・巻き戻し、コマ送りなど。

これらの機能は、それぞれが`PlaybackUseCase`のバリエーションとして定義されることになります。

---

これらの点が明確になると、より具体的な`Entity`や`UseCase`の設計に進むことができます。

もちろん、**現時点の仕様から分かる範囲で設計を始めて、後から詳細を詰めていくことも全く問題ありません。**

いかがでしょうか？ まずはこの素晴らしい仕様を元に、**Entityの洗い出し**から始めてみましょうか？

## 仕様再確認

1. 録画の単位について
ここに関しては非常に優秀な技術者に任せていたため仕様を覚えていないのですが、巨大なファイルではなかったのでB案でお願いします。

2. アラーム録画の詳細について
「プリ録画」と「アフター録画」はありました。それぞれ時間と画質と記録枚数が選べました。
プリ録画は「5秒と10秒」、アフター録画は「10秒、20秒、30秒」の選択肢です。
プリ録画用の映像は指定した画質と記録枚数でメモリ上に保存しておき、アラームが確定したらHDDに書き込んでいました。

3. 緊急録画領域
緊急録画領域は「0%、10%、20%」で選べました。緊急アラームは「銀行強盗が来た」ときのような本当に緊急の用途だったので、削除するまでは保存され、いっぱいになったときはA案の仕様となります。

4. 再生機能について
ボタンは「再生・早送り・巻き戻し・コマ送り」がありました。コマ送りは監視レコーダーには重要な機能でした。
検索は「日時を指定して再生、ラーム録画の一覧から再生」がありました。これはメニューボタンからではなく検索ボタンがあったような気がします。
