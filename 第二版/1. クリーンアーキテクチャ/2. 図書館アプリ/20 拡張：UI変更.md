# ğŸ”„ UIã®å¤‰æ›´: Djangoã¸ã®æ›è£…

ã“ã®ç« ã§ã¯ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®çœŸä¾¡ã‚’ä½“é¨“ã—ã¾ã™ã€‚ã“ã‚Œã¾ã§ä½œæˆã—ã¦ããŸã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®**UIéƒ¨åˆ†ã ã‘ã‚’ã€Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹Djangoã«å·®ã—æ›¿ãˆã¾ã™ã€‚**

ã“ã®ä½œæ¥­ã®æœ€ã‚‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¯ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆ`UseCase`ï¼‰ã®ã‚³ãƒ¼ãƒ‰ã«ã¯ä¸€åˆ‡æ‰‹ã‚’åŠ ãˆãªã„**ã¨ã„ã†ã“ã¨ã§ã™ã€‚ãƒ“ã‚¸ãƒã‚¹ã®æ ¸å¿ƒéƒ¨åˆ†ã¯ãã®ã¾ã¾ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®æ¥ç‚¹ã§ã‚ã‚‹UIã ã‘ã‚’ãƒ—ãƒ©ã‚°ã®ã‚ˆã†ã«äº¤æ›ã§ãã‚‹ã“ã¨ã‚’ä½“æ„Ÿã—ã¾ã—ã‚‡ã†ã€‚

## ğŸ¯ ã“ã®ç« ã®ç›®çš„

  * UIãŒã€Œè©³ç´°ã€ã§ã‚ã‚Šã€ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‹ã‚‰ç‹¬ç«‹ã—ã¦ã„ã‚‹ã“ã¨ã‚’è¨¼æ˜ã™ã‚‹ã€‚
  * `Adapters`å±¤ã®å½¹å‰²ï¼ˆå†…å´ã®ä¸–ç•Œã¨å¤–å´ã®ä¸–ç•Œã‚’ç¹‹ãç¿»è¨³ï¼‰ã‚’æ·±ãç†è§£ã™ã‚‹ã€‚
  * ä¾å­˜æ€§åè»¢ã®åŸå‰‡ã«ã‚ˆã‚Šã€UIæŠ€è¡“ã®å¤‰æ›´ãŒãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã«å½±éŸ¿ã‚’åŠã¼ã•ãªã„ã“ã¨ã‚’å®Ÿè·µã§ç¤ºã™ã€‚

## âœ… å¤‰æ›´ãƒ»è¿½åŠ ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«

UIã¨ã„ã†ã€Œè©³ç´°ã€ã«é–¢ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ãŒå¤‰æ›´å¯¾è±¡ã§ã™ã€‚

  * `adapters/`
      * `django_views.py` (Newâœ¨): Djangoã®Viewã¨Controllerã®å½¹å‰²ã‚’æ‹…ã†ã€æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã€‚
      * `django_presenter.py` (Newâœ¨): Djangoã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ãŸã‚ã®ã€æ–°ã—ã„Presenterã€‚
  * `django_project/` (Newâœ¨):
      * `urls.py`: URLã¨Viewã‚’ç´ä»˜ã‘ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€‚
      * `templates/checkout.html`: ç”»é¢è¡¨ç¤ºã®ãŸã‚ã®HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€‚
  * `main.py` â†’ `manage.py`: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•æ–¹æ³•ãŒDjangoã®ä½œæ³•ã«å¤‰ã‚ã‚Šã¾ã™ã€‚

## âŒ å¤‰æ›´ãŒ**ä¸è¦**ãªãƒ•ã‚¡ã‚¤ãƒ«

ã“ã‚Œã“ããŒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ ¸å¿ƒã§ã™ã€‚ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯**ä¸€è¡Œã‚‚å¤‰æ›´ã—ã¾ã›ã‚“ã€‚**

  * **`domain/entities.py`**
  * **`application/use_cases/check_out_book.py`**
  * **`application/boundaries.py`**
  * **`application/data_structures.py`**
  * `adapters/data_access.py` (DBã¯ãã®ã¾ã¾ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚’ä½¿ã†ãŸã‚å¤‰æ›´ä¸è¦)

## ğŸ’» ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®è©³ç´°è§£èª¬

### 1. Djangoç”¨ã®æ–°ã—ã„Presenter

`UseCase`ã‹ã‚‰ã®`OutputData`ã‚’ã€Djangoã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ãŒç†è§£ã§ãã‚‹`dict`ï¼ˆè¾æ›¸ï¼‰å½¢å¼ã«å¤‰æ›ã™ã‚‹ã€æ–°ã—ã„Presenterã‚’ç”¨æ„ã—ã¾ã™ã€‚

```python
# adapters/django_presenter.py

from typing import Dict, Any
from application.boundaries import CheckOutBookOutputBoundary
from application.data_structures import CheckOutBookOutputData

# -----------------------------------------------------------------------------
# Django Presenter
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: Presenter
# - åŒå¿ƒå††å›³ã®ä½ç½®: Adapters (å¤–å´ã®å††)
# -----------------------------------------------------------------------------
class DjangoCheckOutBookPresenter(CheckOutBookOutputBoundary):
    """Djangoã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã«æ¸¡ã™ãŸã‚ã®Contextï¼ˆè¾æ›¸ï¼‰ã‚’ç”Ÿæˆã™ã‚‹Presenter"""
    _context: Dict[str, Any] = {}

    def present(self, output_data: CheckOutBookOutputData):
        due_date_str = output_data.due_date.strftime('%Yå¹´%mæœˆ%dæ—¥')
        display_text = (
            f"è²¸å‡ºå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n"
            f"æ›¸ç±: ã€{output_data.book_title}ã€, "
            f"ä¼šå“¡: {output_data.member_name}æ§˜, "
            f"è¿”å´æœŸé™: {due_date_str}"
        )
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã™ãŸã‚ã®è¾æ›¸ã‚’æ›´æ–°ã™ã‚‹
        self._context['message'] = display_text

    def get_context(self) -> Dict[str, Any]:
        return self._context
```

### 2. Djangoã®View (Controllerã®å½¹å‰²ã‚‚å…¼ã­ã‚‹)

Djangoã§ã¯ã€`View`é–¢æ•°ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã€`Controller`ã®ã‚ˆã†ã«`UseCase`ã‚’å‘¼ã³å‡ºã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚

```python
# adapters/django_views.py

from django.shortcuts import render
from .django_presenter import DjangoCheckOutBookPresenter
from adapters.data_access import (
    InMemoryBookDataAccess, InMemoryMemberDataAccess, InMemoryLoanDataAccess
)
from application.use_cases.check_out_book import CheckOutBookUseCase
from application.data_structures import CheckOutBookInputData

# -----------------------------------------------------------------------------
# Django View
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: View + Controller
# - åŒå¿ƒå††å›³ã®ä½ç½®: Adapters (å¤–å´ã®å††)
# -----------------------------------------------------------------------------
def checkout_view(request):
    """
    Djangoã®Viewé–¢æ•°ã€‚HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã€‚
    ã“ã®é–¢æ•°ãŒã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯ã®ã€ŒãƒŸãƒ‹Composition Rootã€ã®å½¹å‰²ã‚’æœãŸã™ã€‚
    """
    context = {}
    if request.method == 'POST':
        try:
            # --- ã“ã“ã§ä¾å­˜é–¢ä¿‚ã‚’çµ„ã¿ç«‹ã¦ã‚‹ï¼ˆDIï¼‰---
            presenter = DjangoCheckOutBookPresenter()
            book_repo = InMemoryBookDataAccess()
            member_repo = InMemoryMemberDataAccess()
            loan_repo = InMemoryLoanDataAccess()
            use_case = CheckOutBookUseCase(presenter, book_repo, member_repo, loan_repo)
            
            # 1. Viewã‹ã‚‰ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’InputDataã«å¤‰æ›
            input_data = CheckOutBookInputData(
                book_id=int(request.POST.get('book_id')),
                member_id=int(request.POST.get('member_id'))
            )
            
            # 2. UseCaseã‚’å‘¼ã³å‡ºã™
            use_case.handle(input_data)
            
            # 3. Presenterã‹ã‚‰çµæœï¼ˆContextï¼‰ã‚’å–å¾—
            context = presenter.get_context()

        except Exception as e:
            context['message'] = f"ã‚¨ãƒ©ãƒ¼: {e}"

    # HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æç”»ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ã™
    return render(request, 'checkout.html', context)
```

  * **ãƒŸãƒ‹Composition Root**: Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ã“ã®`checkout_view`é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã™ã€‚ãã®ä¸­ã§`UseCase`ã‚„`Presenter`ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦ãŠã‚Šã€`main.py`ãŒæ‹…ã£ã¦ã„ãŸ**éƒ¨å“ã®çµ„ã¿ç«‹ã¦**ã®å½¹å‰²ã‚’ã€ã“ã®é–¢æ•°ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆå˜ä½ã§å®Ÿè¡Œã—ã¦ã„ã‚‹ç‚¹ãŒé‡è¦ã§ã™ã€‚

### 3. HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨URLè¨­å®š

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ“ä½œã™ã‚‹ç”»é¢ã¨ã€ãã®ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®URLã‚’å®šç¾©ã—ã¾ã™ã€‚

```html
<!DOCTYPE html>
<html>
<head>
    <title>æ›¸ç±è²¸å‡ºã‚·ã‚¹ãƒ†ãƒ </title>
</head>
<body>
    <h1>æ›¸ç±è²¸å‡º</h1>
    <form method="post">
        {% csrf_token %}
        æ›¸ç±ID: <input type="text" name="book_id"><br>
        ä¼šå“¡ID: <input type="text" name="member_id"><br>
        <button type="submit">è²¸å‡ºå®Ÿè¡Œ</button>
    </form>

    {% if message %}
    <h2>å‡¦ç†çµæœ</h2>
    <pre>{{ message }}</pre>
    {% endif %}
</body>
</html>
```

```python
# django_project/urls.py
from django.urls import path
from adapters.django_views import checkout_view

urlpatterns = [
    path('checkout/', checkout_view, name='checkout'),
]
```

## ğŸ›¡ï¸ ã“ã®ç« ã®é‰„å‰‡

UIã¯ã‚ãã¾ã§è©³ç´°ã§ã‚ã‚Šã€äº¤æ›å¯èƒ½ãªéƒ¨å“ã«éãã¾ã›ã‚“ã€‚

> **UIã¯è©³ç´°ã§ã‚ã‚‹ã€‚ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã«è§¦ã‚Œã‚‹ãªã€‚ (The UI is a detail. Do not touch the business rules.)**

  * ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰Webã‚¢ãƒ—ãƒªã¸ã®å¤§ããªå¤‰æ›´ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€**ãƒ“ã‚¸ãƒã‚¹ã®æ ¸å¿ƒéƒ¨åˆ†ã¯ä¸€è¡Œã‚‚å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚**
  * ã“ã‚Œã¯ã€`UseCase`ãŒå…·ä½“çš„ãªUIæŠ€è¡“ï¼ˆ`print`ã‚„`HTML`ï¼‰ã§ã¯ãªãã€æŠ½è±¡çš„ãª`Boundary`ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã«ã®ã¿ä¾å­˜ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚
  * ã“ã®æ§‹é€ ã«ã‚ˆã‚Šã€å°†æ¥UIã‚’ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚¢ãƒ—ãƒªã‚„ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã«å¤‰æ›´ã™ã‚‹ã“ã¨ã«ãªã£ãŸã¨ã—ã¦ã‚‚ã€åŒã˜ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨ã§ãã¾ã™ã€‚ã“ã‚Œã“ããŒã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒã‚‚ãŸã‚‰ã™**ä¿å®ˆæ€§ã¨æ‹¡å¼µæ€§ã®é«˜ã•**ãªã®ã§ã™ã€‚