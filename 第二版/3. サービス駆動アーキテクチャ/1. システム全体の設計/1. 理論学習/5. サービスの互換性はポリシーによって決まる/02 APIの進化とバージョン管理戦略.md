## APIの進化とバージョン管理戦略

この「APIのバージョン管理と移行戦略」は、より実践的な**「APIのライフサイクル管理」**や**「SOAガバナンス」**といった、もう少し後の応用的な章で詳しく扱うのが一般的です。

しかし、今学んだ原則**「サービスの互換性はポリシーによって決まる」**と非常に密接に関連しており、SOAの考え方を理解する上で欠かせない、極めて重要な概念です。

ですので、記憶が新しいうちに、ここで独立したページとしてまとめておきます。

### 🤝 APIの進化とバージョン管理戦略

一度公開したAPIは、多くのクライアントから利用される公共インフラとなります。しかし、ビジネスの成長と共にAPIも進化させる必要があります。このページでは、既存の利用者を保護しつつ、APIを安全に進化させるための戦略を解説します。

### 🤝 なぜAPIのバージョン管理が重要なのか？

サービスの自律性を重んじるSOAでは、各サービスが独立して進化できることが理想です。しかし、あるサービスのAPIが互換性を無視して変更されれば、それに依存する全てのクライアントが機能不全に陥り、システム全体に障害が波及します。

これを防ぎ、**「安定性」**と**「革新性」**を両立させるために、計画的なバージョン管理戦略が不可欠なのです。

### 🤝 推奨戦略：「並行稼働（Parallel Change）」パターン

APIを安全に進化させるための最も確実で広く使われている戦略が、**並行稼働パターン**（別名: Expand and Contractパターン）です。これは、古い橋の隣に新しい橋を建設し、交通を切り替えてから古い橋を解体するアプローチに似ています。

このパターンは、以下の3つのフェーズで構成されます。

1.  **Expand (拡張)**
    新しい仕様を持つAPIエンドポイント（例: `/v2`）を追加します。この時点では、古いエンドポイント（例: `/v1`）も**完全に稼働したまま**です。新旧両方のAPIが同時に利用可能な状態となります。

2.  **Migrate (移行)**
    APIの利用者（クライアント開発者）に対して、新しい`/v2`のリリースを告知し、`/v1`からの移行を促します。この際、「`/v1`は半年後に廃止予定です」といったように、明確な移行期間を設定することが重要です。利用者は、それぞれの都合の良いタイミングで、自分たちのアプリケーションを`/v2`に対応させていきます。

3.  **Contract (縮小)**
    設定した移行期間が過ぎ、`/v1`へのアクセスがなくなったことを監視ツールなどで確認した上で、古い`/v1`エンドポイントを安全に停止・削除します。

この戦略により、既存のクライアントに一切影響を与えることなく、ゼロダウンタイムでAPIを新しいバージョンに進化させることができます。

### 🤝 具体的なバージョニングの方法

APIのバージョンをクライアントに示す方法にはいくつかありますが、最も一般的なのはURLにバージョン番号を含める方法です。

* **URLパスでのバージョニング（最も一般的で推奨）**
    `https://api.example.com/v1/users`
    `https://api.example.com/v2/users`
    バージョンがURLに明記されるため、ブラウザやログからも分かりやすく、非常に明確です。

* **クエリパラメータでのバージョニング**
    `https://api.example.com/users?version=2`
    手軽ですが、URLの見た目が煩雑になる可能性があります。

* **カスタムヘッダーでのバージョニング**
    HTTPリクエストのヘッダーでバージョンを指定します。（例: `Api-Version: 2`）
    URLがクリーンに保てますが、ブラウザから直接試すのが難しくなるなど、利便性が少し落ちます。

### 🤝 まとめ

APIの進化を安全に進める秘訣は、**「既存の契約（エンドポイント）は不変である」**という原則を守り、**「新しい契約はバージョンを上げて追加する」**ことです。この規律を守ることで、SOAは安定性と変化への対応力を両立させることができるのです。

