# CA-05-2

```markdown
## 質問：「使う側が、自分にとって都合の良いIFを定義し、使われる側にそのIFに従ってもらう」ということですね。

## 回答：はい、その通りです！ その気づきは、ソフトウェア設計における**パラダイムシフト**と言ってもいいほど、極めて重要なポイントです。

「使われる側がIFを決める」のではなく、「**使う側が、自分にとって都合の良いIFを定義し、使われる側にそのIFに従ってもらう**」

この考え方の転換こそが、SOLID原則の**D: 依存性逆転の原則 (Dependency Inversion Principle)** そのものです。

---

### D: 依存性逆転の原則 (DIP)

この原則は、2つのルールから成り立っています。

1.  上位モジュール（使う側）は、下位モジュール（使われる側）に依存すべきではない。**両方とも抽象に依存すべき**である。
2.  抽象は、詳細に依存すべきではない。**詳細は、抽象に依存すべき**である。

まさに、あなたがおっしゃった「使う側が欲しい機能を定義して、使われる側に作ってもらう」という状況を、より厳密に表現したものです。

* **上位モジュール（使う側）**: `ProcessOrderUseCase`
* **下位モジュール（使われる側）**: `InMemoryProductRepository`
* **抽象**: `ProductRepository` （`ProcessOrderUseCase`が定義した、自分にとって都合の良いIF）

`ProcessOrderUseCase`と`InMemoryProductRepository`は、直接お互いを知りません。両者とも、間に挟まれた`ProductRepository`という**抽象的な契約書**だけを見て仕事をします。

---

### クリーンアーキテクチャとの関係

そして、ご指摘の通り、**クリーンアーキテクチャは、この依存性逆転の原則を単なる一原則ではなく、アーキテクチャ全体の絶対的な掟（おきて）として強化・体系化したもの**です。

* **SOLID原則におけるDIP**: 主にクラスやモジュールといった、比較的小さな単位での「良い習慣」として語られることが多いです。
* **クリーンアーキテクチャにおけるDIP**: **アーキテクチャのレイヤー境界を越える際の、唯一許されたルール**として位置づけられます。同心円の図で、依存の矢印が必ず内側を向いているのは、すべてのレイヤー境界でこの依存性逆転が強制されているからです。

**クリーンアーキテクチャの視点で言うと**:

* 内側のレイヤー（Use Cases）は、常に**使う側**です。
* 外側のレイヤー（Interface Adapters）は、常に**使われる側**です。

したがって、内側のレイヤーは常に、自分が必要とするインターフェース（ポート）を定義します。そして、外側のレイヤーは、そのインターフェースを実装する（アダプターを作る）責任を負います。

これにより、「ビジネスロジックは、データベースやフレームワークといった技術的詳細に一切依存しない」という、クリーンアーキテクチャの最大の目的が達成されるのです。

| | SOLID原則 | クリーンアーキテクチャ |
| :--- | :--- | :--- |
| **依存性逆転の原則の扱い** | 5つの重要な原則の**一つ** | アーキテクチャ全体を貫く**絶対的な掟** |

つまり、クリーンアーキテクチャは、依存性逆転の原則という強力なアイデアを、アプリケーション全体の設計思想へと昇華させたもの、と理解すると非常に分かりやすいです。

```