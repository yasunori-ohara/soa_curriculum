# SOA-06

```markdown
## `main.py` (ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼†ãƒ‰ãƒ©ã‚¤ãƒ)

ã“ã‚Œã¾ã§ä½œã£ã¦ããŸå…¨ã¦ã®éƒ¨å“ã‚’çµ„ã¿ç«‹ã¦ã¦å‘½ã‚’å¹ãè¾¼ã‚€**`main.py`**ã«é€²ã¿ã¾ã™ã€‚

---
### 1. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ï¼šå…¨ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨éƒ¨å“ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã€Œç·çµ„ç«‹å·¥å ´ã€

ã“ã®main.pyãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å¼•ãç¶šãFrameworks & Driversï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼†ãƒ‰ãƒ©ã‚¤ãƒï¼‰ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å±ã—ã€**Composition Rootï¼ˆã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒˆï¼‰**ã¨ã—ã¦ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚

SOAã¸ã®ç§»è¡Œã«ä¼´ã„ã€ã“ã®çµ„ç«‹å·¥å ´ã®å½¹å‰²ã¯ã•ã‚‰ã«é‡è¦ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¾ã§ã¯è‡ªåˆ†ãŸã¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…éƒ¨ã®éƒ¨å“ã ã‘ã‚’çµ„ã¿ç«‹ã¦ã¦ã„ã¾ã—ãŸãŒã€ä»Šå›ã¯**ã€Œåœ¨åº«ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã„ã†ç‹¬ç«‹ã—ãŸå¤–éƒ¨ã®éƒ¨å“ã¨ã€ãã‚Œã‚’æˆ‘ã€…ã®ã‚·ã‚¹ãƒ†ãƒ ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ã€Œã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã€**ã‚‚æ‰±ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã¾ã•ã«ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®åœ°å›³ã‚’å”¯ä¸€çŸ¥ã£ã¦ã„ã‚‹å ´æ‰€ã§ã‚ã‚Šã€ã©ã®éƒ¨å“ã¨ã©ã®éƒ¨å“ã‚’ã€ã©ã®ã‚ˆã†ã«ã¤ãªãåˆã‚ã›ã‚‹ã‹ã‚’æ±ºå®šã™ã‚‹ã€æœ€çµ‚çš„ãªè²¬ä»»è€…ã§ã™ã€‚

### 2. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®è©³ç´°è§£èª¬

`import`æ–‡: å…¨ã¦ã®ç™»å ´äººç‰©ã®é›†çµ
`import`æ–‡ã‚’è¦‹ã¦ãã ã•ã„ã€‚ã“ã®`main.py`ã¯ã€`domain`, `use_cases`, `interface_adapters`ã¨ã„ã£ãŸå…¨ã¦ã®å†…éƒ¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«åŠ ãˆã€`external_services`ã¨ãã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹æˆã™ã‚‹å…¨ã¦ã®å…·ä½“çš„ãªç™»å ´äººç‰©ã‚’çŸ¥ã£ã¦ã„ã‚‹ã®ã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã§ã™ã€‚

#### 1. ä¾å­˜æ€§ã®æ³¨å…¥ (Dependency Injection): å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’å«ã‚ãŸçµ„ã¿ç«‹ã¦
ã“ã“ãŒSOAåŒ–ã«ã‚ˆã‚‹çµ„ç«‹æ–¹æ³•ã®æœ€ã‚‚å¤§ããªå¤‰æ›´ç‚¹ã§ã™ã€‚

1. ã¾ãšã€ç‹¬ç«‹ã—ãŸå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹**`InventoryService`**ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

2. æ¬¡ã«ã€ãã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆ`inventory_service`ï¼‰ã‚’å†…åŒ…ã™ã‚‹**`InventoryServiceAdapter`**ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã‚Œã§ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ã€Œå¤‰æ›ãƒ—ãƒ©ã‚°ã€ãŒå®Œæˆã—ã¾ã—ãŸã€‚

3. ãã—ã¦ã€`ProcessOrderUseCase`ã‚’ç”Ÿæˆã™ã‚‹éš›ã«ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«å¿…è¦ãªå…¨ã¦ã®å…·ä½“çš„ãªéƒ¨å“ï¼ˆ2ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã¨ã€åœ¨åº«ã‚µãƒ¼ãƒ“ã‚¹ç”¨ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰ã‚’æ³¨å…¥ã—ã¾ã™ã€‚

`ProcessOrderUseCase`ã¯ã€è‡ªåˆ†ãŒæ¸¡ã•ã‚ŒãŸ`inventory_adapter`ãŒã€å†…éƒ¨ã§`InventoryService`ã¨é€šä¿¡ã—ã¦ã„ã‚‹ã¨ã„ã†äº‹å®Ÿã‚’ä¸€åˆ‡çŸ¥ã‚Šã¾ã›ã‚“ã€‚ãŸã ã€ãã‚ŒãŒ`InventoryServicePort`ã¨ã„ã†å¥‘ç´„æ›¸ã‚’å®ˆã£ã¦ã„ã‚‹ã“ã¨ã ã‘ã‚’ä¿¡é ¼ã—ã¦å‹•ä½œã—ã¾ã™ã€‚

#### 2. åˆæœŸãƒ‡ãƒ¼ã‚¿ã®è¨­å®š: å„ã‚µãƒ¼ãƒ“ã‚¹ã®æº–å‚™
ã“ã“ã§ã¯ã€ç§ãŸã¡ã®ã€Œæ³¨æ–‡å—ä»˜ã‚µãƒ¼ãƒ“ã‚¹ã€ãŒç®¡ç†ã™ã‚‹å•†å“ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆ`product_repo`ï¼‰ã¨ã€å¤–éƒ¨ã®ã€Œåœ¨åº«ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã€ãŒç®¡ç†ã™ã‚‹åœ¨åº«ãƒ‡ãƒ¼ã‚¿ï¼ˆ`inventory_service`ï¼‰ã®ä¸¡æ–¹ã«ã€åˆæœŸå€¤ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ãã‚Œãã‚Œã®ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ã‚‹ã“ã¨ãŒæ˜ç¢ºã«åˆ†ã‹ã‚Šã¾ã™ã€‚

#### 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ & 4. çµæœã®ç¢ºèª: ã‚µãƒ¼ãƒ“ã‚¹é–“é€£æºã®ç¢ºèª
ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã—ãŸå¾Œã€æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒ`order_repo`ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«ã€`inventory_service`ã®åœ¨åº«ãŒæ­£ã—ãå‰Šæ¸›ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ç¢ºèªã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç§ãŸã¡ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨æ­£ã—ãé€£æºã—ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã¨ã—ã¦ãƒ“ã‚¸ãƒã‚¹ãŒé€²è¡Œã—ãŸã“ã¨ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚

### 3. ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é‰„å‰‡ï¼ˆå†ç¢ºèªï¼‰

- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã‹ãªã„
- ã™ã¹ã¦ã®å…·ä½“çš„ãªå®Ÿè£…ã‚’çŸ¥ã£ã¦ã„ã‚‹
- æœ€ã‚‚å¤‰æ›´ã•ã‚Œã‚„ã™ã„

---
### main.py
``` Python
# ä¾å­˜æ€§ã®ãƒ«ãƒ¼ãƒ«:
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ€ã‚‚å¤–å´ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å±ã—ã¾ã™ã€‚
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’çµ„ã¿ç«‹ã¦ã‚‹ãŸã‚ã€ã™ã¹ã¦ã®å†…å´ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€
# ãã—ã¦å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚„ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‹ã‚‰å…·ä½“çš„ãªã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

from domain.product import Product
from use_cases.process_order import ProcessOrderUseCase, ProcessOrderInput
from interface_adapters.repositories import InMemoryProductRepository, InMemoryOrderRepository
from interface_adapters.inventory_service_adapter import InventoryServiceAdapter
from external_services.inventory_service import InventoryService

def main():
    """
    ã€Frameworks & Driversãƒ¬ã‚¤ãƒ¤ãƒ¼ / Composition Rootã€‘
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã™ã¹ã¦ã®éƒ¨å“ã‚’çµ„ã¿ç«‹ã¦ã€èµ·å‹•ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°ã€‚
    SOAåŒ–ã«ä¼´ã„ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ãã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚‚ã“ã“ã§çµ„ã¿ç«‹ã¦ã‚‹ã€‚
    """
    print("--- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç·çµ„ç«‹é–‹å§‹ ---")

    # --- 1. ä¾å­˜æ€§ã®æ³¨å…¥ (Dependency Injection) ---
    # 1-1. å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
    inventory_service = InventoryService()

    # 1-2. å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ç”Ÿæˆã—ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ³¨å…¥
    inventory_adapter = InventoryServiceAdapter(inventory_service=inventory_service)

    # 1-3. å†…éƒ¨ã§ä½¿ã†ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
    product_repo = InMemoryProductRepository()
    order_repo = InMemoryOrderRepository()

    # 1-4. Use Caseã‚’ç”Ÿæˆã—ã€å¿…è¦ãªã™ã¹ã¦ã®ä¾å­˜ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã¨ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰ã‚’æ³¨å…¥
    use_case = ProcessOrderUseCase(
        product_repo=product_repo,
        order_repo=order_repo,
        inventory_service=inventory_adapter # â¬…ï¸ UseCaseã¯ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®å­˜åœ¨ã—ã‹çŸ¥ã‚‰ãªã„
    )
    
    print("--- ç·çµ„ç«‹å®Œäº† ---")

    # --- 2. åˆæœŸãƒ‡ãƒ¼ã‚¿ã®è¨­å®š ---
    print("\n--- åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ ---")
    # å•†å“ãƒã‚¹ã‚¿ãƒ¼æƒ…å ±ã‚’ProductRepositoryã«ä¿å­˜
    mouse = Product("p-001", "é«˜æ©Ÿèƒ½ãƒã‚¦ã‚¹", 4000)
    keyboard = Product("p-002", "é™éŸ³ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰", 6000)
    product_repo.save(mouse)
    product_repo.save(keyboard)
    
    # åœ¨åº«æƒ…å ±ã‚’å¤–éƒ¨ã®InventoryServiceã«è¨­å®š
    inventory_service.add_stock("p-001", 10)
    inventory_service.add_stock("p-002", 5)
    
    # --- 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ ---
    print("\n--- ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè¡Œ ---")
    
    # ã‚·ãƒŠãƒªã‚ª1: æ­£å¸¸ãªæ³¨æ–‡
    try:
        order_input_1 = ProcessOrderInput(items=[
            {"product_id": "p-001", "quantity": 2},
            {"product_id": "p-002", "quantity": 1},
        ])
        result = use_case.execute(order_input_1)
        print(f"âœ… æˆåŠŸ: æ³¨æ–‡ID={result.order_id}, åˆè¨ˆé‡‘é¡={result.total_price}å††")
    except ValueError as e:
        print(f"âŒ å¤±æ•—: {e}")

    # --- 4. çµæœã®ç¢ºèª ---
    print("\n--- æœ€çµ‚çŠ¶æ…‹ç¢ºèª ---")
    # æ³¨æ–‡ãŒOrderRepositoryã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    first_order_id = list(order_repo._orders.keys())[0]
    saved_order = order_repo.find_by_id(first_order_id)
    if saved_order:
        print(f"ğŸ“ ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡: ID={saved_order.order_id}, åˆè¨ˆé‡‘é¡={saved_order.total_price}å††")
    
    # åœ¨åº«ãŒå¤–éƒ¨ã®InventoryServiceã§å‰Šæ¸›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    final_mouse_stock = inventory_service.get_stock("p-001")
    print(f"ğŸ“¦ {mouse.name}ã®æœ€çµ‚åœ¨åº«: {final_mouse_stock}å€‹") # 10 -> 8 ã«ãªã£ã¦ã„ã‚‹ã¯ãš

if __name__ == "__main__":
    main()
```

```