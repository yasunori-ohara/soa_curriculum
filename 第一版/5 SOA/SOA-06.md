# SOA-06 : ðŸ”´ `infrastructure/main.py` (çµ„ç«‹ã¨å®Ÿè¡Œ)

`SOA-05` ã§ `UseCase` ãŒå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã•ã‚Œã¾ã—ãŸã€‚ã„ã‚ˆã„ã‚ˆ `SOA` ç·¨ã®æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã€ã“ã‚Œã¾ã§ä½œã£ã¦ããŸå…¨ã¦ã®éƒ¨å“ã‚’çµ„ã¿ç«‹ã¦ã¦å‘½ã‚’å¹ãè¾¼ã‚€ `infrastructure/main.py` ã«é€²ã¿ã¾ã™ã€‚

## ðŸŽ¯ ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«

  * `SOA` åŒ–ã«ä¼´ã„ã€`main.py`ï¼ˆComposition Rootï¼‰ã®å½¹å‰²ãŒ\*\*å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚‚å«ã‚ãŸã€Œç·çµ„ç«‹å·¥å ´ã€\*\*ã«æ‹¡å¼µã•ã‚Œã‚‹ã“ã¨ã‚’ç†è§£ã™ã‚‹ã€‚
  * å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã€å†…éƒ¨ãƒªãƒã‚¸ãƒˆãƒªã€`UseCase` ã‚’æ­£ã—ã**ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–**ã—ã€\*\*ä¾å­˜æ€§ã®æ³¨å…¥ï¼ˆDIï¼‰\*\*ã‚’è¡Œã†ã€‚
  * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã€å†…éƒ¨çŠ¶æ…‹ï¼ˆ`Order`ï¼‰ã¨å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆåœ¨åº«ï¼‰ã®ä¸¡æ–¹ãŒæ­£ã—ãæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

-----

## ðŸ­ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ï¼šå…¨ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨éƒ¨å“ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã€Œç·çµ„ç«‹å·¥å ´ã€

ã“ã® `main.py` ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å¼•ãç¶šã `Frameworks & Drivers` ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å±žã—ã€\*\*Composition Rootï¼ˆã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒˆï¼‰\*\*ã¨ã—ã¦ã®å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚

`SOA` ã¸ã®ç§»è¡Œã«ä¼´ã„ã€ã“ã®çµ„ç«‹å·¥å ´ã®å½¹å‰²ã¯ã•ã‚‰ã«é‡è¦ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¾ã§ã¯è‡ªåˆ†ãŸã¡ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…éƒ¨ã®éƒ¨å“ã ã‘ã‚’çµ„ã¿ç«‹ã¦ã¦ã„ã¾ã—ãŸãŒã€ä»Šå›žã¯ **ã€Œåœ¨åº«ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã„ã†ç‹¬ç«‹ã—ãŸå¤–éƒ¨ã®éƒ¨å“** ã¨ã€ãã‚Œã‚’æˆ‘ã€…ã®ã‚·ã‚¹ãƒ†ãƒ ã«æŽ¥ç¶šã™ã‚‹ãŸã‚ã® **ã€Œã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã€** ã‚‚æ‰±ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ ðŸ­ðŸ”§ã€‚

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã¾ã•ã«ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®åœ°å›³ã‚’å”¯ä¸€çŸ¥ã£ã¦ã„ã‚‹å ´æ‰€ã§ã‚ã‚Šã€ã©ã®éƒ¨å“ã¨ã©ã®éƒ¨å“ã‚’ã€ã©ã®ã‚ˆã†ã«ã¤ãªãŽåˆã‚ã›ã‚‹ã‹ã‚’æ±ºå®šã™ã‚‹ã€æœ€çµ‚çš„ãªè²¬ä»»è€…ã§ã™ã€‚

-----

## ðŸ’» ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®è©³ç´°è§£èª¬

### `import`æ–‡: å…¨ã¦ã®ç™»å ´äººç‰©ã®é›†çµ

`import` æ–‡ã‚’è¦‹ã¦ãã ã•ã„ã€‚ã“ã® `main.py` ã¯ã€`domain`, `use_cases`, `interface_adapters` ã¨ã„ã£ãŸå…¨ã¦ã®å†…éƒ¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«åŠ ãˆã€`external_services`ï¼ˆå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹æœ¬ä½“ï¼‰ã¨ãã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼ˆ`InventoryServiceAdapter`ï¼‰ã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹æˆã™ã‚‹å…¨ã¦ã®**å…·ä½“çš„ãªç™»å ´äººç‰©**ã‚’çŸ¥ã£ã¦ã„ã‚‹ã®ã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã§ã™ã€‚

### 1\. ä¾å­˜æ€§ã®æ³¨å…¥ (Dependency Injection): å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’å«ã‚ãŸçµ„ã¿ç«‹ã¦

ã“ã“ãŒ `SOA` åŒ–ã«ã‚ˆã‚‹çµ„ç«‹æ–¹æ³•ã®æœ€ã‚‚å¤§ããªå¤‰æ›´ç‚¹ã§ã™ã€‚

1.  ã¾ãšã€ç‹¬ç«‹ã—ãŸå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ **`InventoryService`** ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
2.  æ¬¡ã«ã€ãã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆ`inventory_service`ï¼‰ã‚’å†…åŒ…ã™ã‚‹ **`InventoryServiceAdapter`** ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã‚Œã§ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«æŽ¥ç¶šã™ã‚‹ãŸã‚ã®ã€Œå¤‰æ›ãƒ—ãƒ©ã‚°ã€ãŒå®Œæˆã—ã¾ã—ãŸã€‚
3.  ãã—ã¦ã€å†…éƒ¨ã§ä½¿ã†ãƒªãƒã‚¸ãƒˆãƒªï¼ˆ`InMemoryProductRepository`, `InMemoryOrderRepository`ï¼‰ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
4.  æœ€å¾Œã«ã€`ProcessOrderUseCase` ã‚’ç”Ÿæˆã™ã‚‹éš›ã«ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«å¿…è¦ãªå…¨ã¦ã®å…·ä½“çš„ãªéƒ¨å“ï¼ˆ2ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã¨ã€åœ¨åº«ã‚µãƒ¼ãƒ“ã‚¹ç”¨ã®**ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼**ï¼‰ã‚’æ³¨å…¥ã—ã¾ã™ã€‚

`ProcessOrderUseCase` ã¯ã€è‡ªåˆ†ãŒæ¸¡ã•ã‚ŒãŸ `inventory_adapter` ãŒã€å†…éƒ¨ã§ `InventoryService` ã¨é€šä¿¡ã—ã¦ã„ã‚‹ã¨ã„ã†äº‹å®Ÿã‚’**ä¸€åˆ‡çŸ¥ã‚Šã¾ã›ã‚“**ã€‚ãŸã ã€ãã‚ŒãŒ `IInventoryServicePort` ã¨ã„ã†ã€Œå¥‘ç´„æ›¸ï¼ˆéµç©´ï¼‰ã€ã‚’å®ˆã£ã¦ã„ã‚‹ã“ã¨ã ã‘ã‚’ä¿¡é ¼ã—ã¦å‹•ä½œã—ã¾ã™ã€‚

### 2\. åˆæœŸãƒ‡ãƒ¼ã‚¿ã®è¨­å®š: å„ã‚µãƒ¼ãƒ“ã‚¹ã®æº–å‚™

ã“ã“ã§ã¯ã€ç§ãŸã¡ã®ã€Œæ³¨æ–‡å—ä»˜ã‚µãƒ¼ãƒ“ã‚¹ã€ãŒç®¡ç†ã™ã‚‹å•†å“ãƒžã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆ`product_repo`ï¼‰ã¨ã€å¤–éƒ¨ã®ã€Œåœ¨åº«ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã€ãŒç®¡ç†ã™ã‚‹åœ¨åº«ãƒ‡ãƒ¼ã‚¿ï¼ˆ`inventory_service`ï¼‰ã®**ä¸¡æ–¹**ã«ã€åˆæœŸå€¤ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ãã‚Œãžã‚Œã®ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ã‚‹ã“ã¨ãŒæ˜Žç¢ºã«åˆ†ã‹ã‚Šã¾ã™ã€‚

### 3\. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ & 4. çµæžœã®ç¢ºèª: ã‚µãƒ¼ãƒ“ã‚¹é–“é€£æºã®ç¢ºèª

`UseCase` ã‚’å®Ÿè¡Œã—ãŸå¾Œã€æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒ `order_repo` ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«ã€`inventory_service` ã®åœ¨åº«ãŒæ­£ã—ãå‰Šæ¸›ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ç¢ºèªã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç§ãŸã¡ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨æ­£ã—ãé€£æºã—ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã¨ã—ã¦ãƒ“ã‚¸ãƒã‚¹ãŒé€²è¡Œã—ãŸã“ã¨ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚

-----

## ðŸ›ï¸ ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é‰„å‰‡ï¼ˆå†ç¢ºèªï¼‰

  * **ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã‹ãªã„:** å¤‰æ›´ãªã—ã€‚
  * **ã™ã¹ã¦ã®å…·ä½“çš„ãªå®Ÿè£…ã‚’çŸ¥ã£ã¦ã„ã‚‹:** å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ `InventoryService` ã‚„ `InventoryServiceAdapter` ã¨ã„ã†æ–°ã—ã„å…·è±¡ã‚¯ãƒ©ã‚¹ã‚’çŸ¥ã£ã¦ã„ã‚‹ã®ã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã§ã™ã€‚
  * **æœ€ã‚‚å¤‰æ›´ã•ã‚Œã‚„ã™ã„:** åœ¨åº«ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æŽ¥ç¶šæ–¹æ³•ãŒå¤‰ã‚ã£ãŸå ´åˆï¼ˆä¾‹: `InventoryService` ãŒ `REST API` ã«ãªã£ãŸå ´åˆï¼‰ã€ä¸»ã«ä¿®æ­£ã•ã‚Œã‚‹ã®ã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆDIéƒ¨åˆ†ã§ `RestInventoryAdapter` ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ãªã©ï¼‰ã§ã™ã€‚

-----

## ðŸ“„ `infrastructure/main.py` ã®å®Ÿè£…

(`DDD-07` ã® `main.py` ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™)

```python:infrastructure/main.py
# ä¾å­˜æ€§ã®ãƒ«ãƒ¼ãƒ«:
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ€ã‚‚å¤–å´ã® Infrastructure ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å±žã—ã¾ã™ã€‚
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’çµ„ã¿ç«‹ã¦ã‚‹ãŸã‚ã€ã™ã¹ã¦ã®å†…å´ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€
# ãã—ã¦å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚„ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‹ã‚‰å…·ä½“çš„ãªã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

# ðŸ”µ domain ã‹ã‚‰ã€Œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®šã®ãŸã‚)
from domain.product import PhysicalProduct, DigitalProduct # Product ã‚’ç›´æŽ¥ä½¿ã‚ãªããªã£ãŸ
from domain.order import Order # çµæžœç¢ºèªç”¨

# ðŸŸ¢ use_cases ã‹ã‚‰ã€Œãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã€ã¨ã€ŒDTOã€ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from use_cases.process_order_use_case import (
    ProcessOrderUseCase, 
    ProcessOrderInput, 
    ProcessOrderItemInput,
    ProcessOrderOutput # çµæžœè¡¨ç¤ºç”¨
)

# ðŸŸ¡ interface_adapters ã‹ã‚‰ã€Œå†…éƒ¨ãƒªãƒã‚¸ãƒˆãƒªã€ã¨ã€Œå¤–éƒ¨ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã€ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from interface_adapters.repositories import (
    InMemoryProductRepository, 
    InMemoryOrderRepository
)
from interface_adapters.inventory_service_adapter import InventoryServiceAdapter

# ðŸ“¦ external_services ã‹ã‚‰ã€Œå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹æœ¬ä½“ã€ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from external_services.inventory_service import InventoryService

def main():
    """
    ã€Infrastructureãƒ¬ã‚¤ãƒ¤ãƒ¼ / Composition Rootã€‘
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã™ã¹ã¦ã®éƒ¨å“ã‚’çµ„ã¿ç«‹ã¦ã€èµ·å‹•ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°ã€‚
    SOAåŒ–ã«ä¼´ã„ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ãã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚‚ã“ã“ã§çµ„ã¿ç«‹ã¦ã‚‹ã€‚
    """
    print("--- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç·çµ„ç«‹é–‹å§‹ (SOA Version) ---")

    # --- 1. ä¾å­˜æ€§ã®æ³¨å…¥ (Dependency Injection) ---
    
    # 1a. å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
    inventory_service = InventoryService()

    # 1b. å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«æŽ¥ç¶šã™ã‚‹ãŸã‚ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ç”Ÿæˆã—ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ³¨å…¥
    inventory_adapter = InventoryServiceAdapter(inventory_service=inventory_service)

    # 1c. å†…éƒ¨ã§ä½¿ã†ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
    product_repo = InMemoryProductRepository()
    order_repo = InMemoryOrderRepository()

    # 1d. Use Caseã‚’ç”Ÿæˆã—ã€å¿…è¦ãªã™ã¹ã¦ã®ä¾å­˜ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã¨ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰ã‚’æ³¨å…¥
    use_case = ProcessOrderUseCase(
        product_repo=product_repo,
        order_repo=order_repo,
        inventory_service=inventory_adapter # â¬…ï¸ UseCaseã¯ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼(æŠ½è±¡Port)ã—ã‹çŸ¥ã‚‰ãªã„
    )
    
    print("--- ç·çµ„ç«‹å®Œäº† ---")

    # --- 2. åˆæœŸãƒ‡ãƒ¼ã‚¿ã®è¨­å®š (å„ã‚µãƒ¼ãƒ“ã‚¹ã®æº–å‚™) ---
    print("\n--- åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ ---")
    # å•†å“ãƒžã‚¹ã‚¿ãƒ¼æƒ…å ±ã‚’ ProductRepository ã«ä¿å­˜ (Productã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ã“ã“ã§ä¸€æ™‚çš„ã«ä½¿ç”¨)
    # ProductRepository ã¯ find_by_id ã—ã‹å…¬é–‹ã—ã¦ã„ãªã„ãŸã‚ã€
    # æœ¬æ¥ã¯åˆ¥ã®æ–¹æ³•(åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆç­‰)ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹ã¹ãã ãŒã€ä»Šå›žã¯ä¾¿å®œä¸Šç›´æŽ¥æ“ä½œ
    product_repo._products["p-001"] = PhysicalProduct("p-001", "é«˜æ©Ÿèƒ½ãƒžã‚¦ã‚¹", 4000, 999) # åœ¨åº«ã¯å¤–éƒ¨ç®¡ç†ãªã®ã§ãƒ€ãƒŸãƒ¼
    product_repo._products["p-002"] = PhysicalProduct("p-002", "é™éŸ³ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰", 6000, 999)
    print("ðŸ›’ å•†å“ãƒžã‚¹ã‚¿ãƒ¼è¨­å®šå®Œäº† (ProductRepository)")
    
    # åœ¨åº«æƒ…å ±ã‚’å¤–éƒ¨ã® InventoryService ã«è¨­å®š
    inventory_service.add_stock("p-001", 10) # ãƒžã‚¦ã‚¹åœ¨åº«: 10
    inventory_service.add_stock("p-002", 5)  # ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰åœ¨åº«: 5
    
    # --- 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ ---
    print("\n--- ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè¡Œ ---")
    
    # ã‚·ãƒŠãƒªã‚ª1: æ­£å¸¸ãªæ³¨æ–‡ (ãƒžã‚¦ã‚¹ x 2, ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ x 1)
    print("\n[ã‚·ãƒŠãƒªã‚ª1: æ­£å¸¸ãªæ³¨æ–‡ (ãƒžã‚¦ã‚¹ x 2, ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ x 1)]")
    saved_order_id: str | None = None
    try:
        order_input_1 = ProcessOrderInput(
            customer_id="cust-101",
            items=[
                ProcessOrderItemInput(product_id="p-001", quantity=2),
                ProcessOrderItemInput(product_id="p-002", quantity=1),
            ]
        )
        # UseCase ã‚’å®Ÿè¡Œã—ã€å‡ºåŠ› DTO ã‚’å—ã‘å–ã‚‹
        result_dto_1: ProcessOrderOutput = use_case.execute(order_input_1)
        print(f"âœ… æ³¨æ–‡æˆåŠŸ: OrderID={result_dto_1.order_id}, Total={result_dto_1.total_price}å††")
        saved_order_id = result_dto_1.order_id # å¾Œã®ç¢ºèªç”¨
    except ValueError as e:
        print(f"âŒ æ³¨æ–‡å¤±æ•—: {e}")
    except RuntimeError as e: # ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‹ã‚‰ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼ãªã©
         print(f"âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: {e}")

    # ã‚·ãƒŠãƒªã‚ª2: åœ¨åº«ä¸è¶³ (ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ x 5)
    print("\n[ã‚·ãƒŠãƒªã‚ª2: åœ¨åº«ä¸è¶³ (ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ x 5)]")
    try:
         order_input_2 = ProcessOrderInput(
            customer_id="cust-102",
            items=[
                ProcessOrderItemInput(product_id="p-002", quantity=5), # æ®‹ã‚Šåœ¨åº«ã¯ 5-1=4 ã®ã¯ãš
            ]
        )
         result_dto_2 = use_case.execute(order_input_2)
         print(f"âœ… æ³¨æ–‡æˆåŠŸ: OrderID={result_dto_2.order_id}, Total={result_dto_2.total_price}å††")
    except ValueError as e:
        print(f"âŒ æ³¨æ–‡å¤±æ•—: {e}") # ã“ã“ã§ã€Œåœ¨åº«ä¸è¶³ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš
    except RuntimeError as e:
         print(f"âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: {e}")

    # --- 4. çµæžœã®ç¢ºèª (ã‚µãƒ¼ãƒ“ã‚¹é–“é€£æºã®ç¢ºèª) ---
    print("\n--- æœ€çµ‚çŠ¶æ…‹ç¢ºèª ---")
    # æ³¨æ–‡ãŒ OrderRepository ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    if saved_order_id:
        print(f"\nðŸ“ ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ {saved_order_id} ã®ç¢ºèª (OrderRepository):")
        saved_order = order_repo.find_by_id(saved_order_id)
        if saved_order:
            print(f" OrderID: {saved_order.order_id}, Total: {saved_order.total_price}å††")
            print(" æ˜Žç´°:")
            for item in saved_order.line_items:
                 # Orderé›†ç´„ã¯Productã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸ã®å‚ç…§ã‚’æŒã£ã¦ã„ã‚‹
                print(f"  - {item.product.name} x {item.quantity}") 
        else:
             print(" ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    
    # åœ¨åº«ãŒå¤–éƒ¨ã® InventoryService ã§æ­£ã—ãå‰Šæ¸›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    print("\nðŸ“¦ æœ€çµ‚åœ¨åº«ã®ç¢ºèª (InventoryService):")
    final_mouse_stock = inventory_service.get_stock("p-001")
    final_keyboard_stock = inventory_service.get_stock("p-002")
    print(f" é«˜æ©Ÿèƒ½ãƒžã‚¦ã‚¹: {final_mouse_stock}å€‹ (åˆæœŸ: 10, æ³¨æ–‡: 2 -> æœŸå¾…å€¤: 8)")
    print(f" é™éŸ³ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰: {final_keyboard_stock}å€‹ (åˆæœŸ: 5, æ³¨æ–‡: 1 -> æœŸå¾…å€¤: 4)")

if __name__ == "__main__":
    main()

```