# 付録03

## 質問：「上位レベルとは相対的・再帰的であることに留意せよ」といいう言葉を聞いたのですが、本カリキュラムで言うとどの段階で採用されているでしょうか？

## ## 回答：はい、その言葉「上位レベルとは相対的・再帰的であることに留意せよ」は、依存性逆転の原則（DIP）やクリーンアーキテクチャの思想を、さらに深く理解するための、非常に鋭く、本質的な概念です。

これは、カリキュラムの**特定の「一つの段階」で採用されるというよりは、OOPからSOAへと進む各ステージで、そのスケールを拡大しながら繰り返し現れる、普遍的な「原理」**です。

この原理を理解するために、**マトリョーシカ人形**を想像してみてください。

---

### なぜ「相対的」なのか？

あるマトリョーシカ人形は、自分より小さな人形から見れば**「上位レベル（大きい）」**ですが、自分より大きな人形から見れば**「下位レベル（小さい）」**です。「上位」か「下位」かは、どの視点から見るかによって変わる**相対的**なものなのです。

### なぜ「再帰的」なのか？

大きな人形を開けると、中から少し小さな人形が出てきます。その人形をさらに開けると、また人形が出てきます。このように、**「大きいものが小さいものを内包する」という構造が、スケールを変えながら何度も繰り返されます**。これが**再帰的**であるということです。

---

### カリキュラムにおける適用段階

それでは、この「上位レベル（方針） vs 下位レベル（詳細）」という相対的・再帰的な構造が、私たちのカリキュラムの各段階でどのように現れていたかを見ていきましょう。

### 1. OOPの段階：クラスレベルでの適用

- **上位レベル（方針）**: `Store`クラス。
    - 「注文を受け付けたら、商品の在庫を確認し、減らす」という**方針**を決定します。
- **下位レベル（詳細）**: `PhysicalProduct`クラスや`DigitalProduct`クラス。
    - 在庫を「どうやって」確認し、「どうやって」減らすかという**詳細**を実装します。

`Store`は、相手がどんな商品であっても「在庫を確認しろ」と命令するだけであり、その具体的な方法（物理在庫か、常にOKか）という詳細には関与しません。

### 2. クリーンアーキテクチャの段階：アプリケーションレベルでの適用

- **上位レベル（方針）**: `ProcessOrderUseCase`。
    - 「注文を処理するには、商品を見つけ出し、状態を保存する必要がある」という**方針**を決定します。
- **下位レベル（詳細）**: `InMemoryProductRepository`。
    - 商品を「どうやって」見つけ出し、「どうやって」保存するかという**詳細**（ここではインメモリ辞書）を実装します。

`UseCase`は、`Repository`という抽象的なインターフェースに命令するだけであり、その背後にあるデータベースが何かという詳細には関与しません。

### 3. DDDの段階：ビジネスロジックレベルでの適用

ここが面白い点で、**役割が逆転**します。

- **上位レベル（方針）**: `Order`集約。
    - 「注文とは、商品明細を持ち、その合計金額は常に正しくなければならない。在庫がなければ明細に追加できない」という、ビジネスの最も核心的な**方針**を決定します。
- **下位レベル（詳細）**: `ProcessOrderUseCase`。
    - `Order`集約から見れば、`UseCase`は、その核心的な方針を**利用するクライアントの一つ**にすぎません。`UseCase`は、`Order`集約を操作するための**詳細**な手順を実装している、と見なすことができます。

### 4. SOAの段階：システムレベルでの適用

- **上位レベル（方針）**: 私たちの「注文受付サービス」全体。
    - 「顧客からの注文を受け付け、成立させる」という、より大きなビジネス上の**方針**を担います。
- **下位レベル（詳細）**: 外部の「在庫管理サービス」。
    - 「注文受付」という方針を達成するために利用される、**詳細**な機能の一つです。

「注文受付サービス」は、「在庫を確認しろ」と抽象的なポートに命令するだけであり、その先にいるのがどんな技術で作られたサービスなのかという詳細には関与しません。

---

### まとめ

| ステージ | 上位レベル（方針） | 下位レベル（詳細） |
| --- | --- | --- |
| **OOP** | `Store`クラス | `Product`の具象クラス |
| **CA** | `ProcessOrderUseCase` | `Repository`の具象クラス |
| **DDD** | `Order`集約 | `ProcessOrderUseCase` |
| **SOA** | 注文受付サービス | 在庫管理サービス |

このように、「上位レベル」と「下位レベル」の関係は絶対的なものではなく、**どのスケールで物事を見ているか**によって変化する**相対的**なものです。そして、この「方針は詳細に依存してはならない」という原則が、クラスレベルからシステムレベルまで、**再帰的に**適用されているのです。

この原理を理解することは、あらゆるソフトウェア設計において、柔軟で変更に強い構造を見抜くための強力な武器となります。