# 02 èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼å·®ã—æ›¿ãˆ

# ğŸš€ ã‚¹ãƒ†ãƒƒãƒ—2ï¼šèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¢ãƒ€ãƒ—ã‚¿å·®ã—æ›¿ãˆ (Publisher)

ç¬¬5å·¡ã®2ç•ªç›®ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚
ã€Œèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã€ã®ã€Œå‡ºå£ã€ã§ã‚ã‚‹ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ã€ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãå‡ºã—ï¼ˆ`File...Publisher`ï¼‰ã‹ã‚‰ã€MQTTï¼ˆ`Mqtt...Publisher`ï¼‰ã«å·®ã—æ›¿ãˆã¾ã™ã€‚

---

## ğŸ¯ ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚´ãƒ¼ãƒ«

- èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®UseCaseã‚„Entityã«ã¯**ä¸€åˆ‡è§¦ã‚Œãšã«**ã€å‡ºåŠ›ã‚¢ãƒ€ãƒ—ã‚¿ã ã‘ã‚’å·®ã—æ›¿ãˆã‚‹ã€‚
- `world_model.json` ã‚’ä½œæˆã™ã‚‹ä»£ã‚ã‚Šã«ã€MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ï¼ˆä¸­ç¶™å±€ï¼‰ã¸ã€Œä¸–ç•Œãƒ¢ãƒ‡ãƒ«ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’ **Publishï¼ˆå…¬é–‹ï¼‰** ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

---

## ğŸ§© å¤‰æ›´ã®æ¦‚è¦

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å¤‰æ›´ãƒ»è¿½åŠ ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ **`adapters/` ãƒ•ã‚©ãƒ«ãƒ€**ã¨ **`main.py`** ã®ã¿ã§ã™ã€‚

- **`domain/entities.py`**: å¤‰æ›´ãªã—
- **`application/use_cases.py`**: å¤‰æ›´ãªã—
- **`application/boundaries.py`**: å¤‰æ›´ãªã—
- **`adapters/mqtt_publisher.py`**: ğŸ‘ˆ **ï¼ˆæ–°è¦ä½œæˆï¼‰**
- **`adapters/file_publisher.py`**: ï¼ˆä¸è¦ã«ãªã‚‹ãŒã€å‚ç…§ç”¨ã«æ®‹ã—ã¦ãŠã„ã¦ã‚‚è‰¯ã„ï¼‰
- **`adapters/stub_sensor.py`**: å¤‰æ›´ãªã—
- **`adapters/repositories.py`**: å¤‰æ›´ãªã—
- **`main.py`**: ğŸ‘ˆ **ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨DIéƒ¨åˆ†ã‚’ä¿®æ­£ï¼‰**

---

## ğŸ› ï¸ æ‰‹é †1ï¼šMQTTã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã€Pythonã‹ã‚‰MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¨é€šä¿¡ã™ã‚‹ãŸã‚ã®æ¨™æº–çš„ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª `paho-mqtt` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ï¼ˆå„ã‚µãƒ¼ãƒ“ã‚¹ã®Pythonç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ï¼‰

```bash
pip install paho-mqtt

```

---

## âš™ï¸ æ‰‹é †2ï¼šMqttWorldModelPublisher ã®ä½œæˆ

`application/boundaries.py` ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ `PlanningServiceAdapterInterface`ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã‚’**å®Ÿè£…ã™ã‚‹**ã€æ–°ã—ã„ã€Œé“å…·ã€ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã®ã‚¯ãƒ©ã‚¹ãŒã€`File...Publisher` ã®ä»£ã‚ã‚Šã¨ãªã‚Šã¾ã™ã€‚

```python
# adapters/mqtt_publisher.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…ã«æ–°è¦ä½œæˆ)
import paho.mqtt.client as mqtt
import json
import asyncio
from domain.entities import WorldModel
from application.boundaries import PlanningServiceAdapterInterface

# -----------------------------------------------------------------------------
# Service Adapter Implementation (MQTT Publisher)
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: ServiceAdapter (DataAccessãªã©ã¨åŒã˜å¤–éƒ¨å®Ÿè£…)
# - åŒå¿ƒå††å›³ã®ä½ç½®: Adapters (å¤–å´ã®å††)
# -----------------------------------------------------------------------------
class MqttWorldModelPublisher(PlanningServiceAdapterInterface):
    """
    UseCaseã®è¦æ±‚(I/F)ã«åŸºã¥ãã€WorldModelã‚’
    MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã«å…¬é–‹ï¼ˆPublishï¼‰ã™ã‚‹ã‚¢ãƒ€ãƒ—ã‚¿ã€‚
    """
    def __init__(self, broker_address: str, broker_port: int, topic: str):
        self._broker_address = broker_address
        self._broker_port = broker_port
        self._topic = topic

        # MQTTã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
        self._client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2)
        # æ¥ç¶šãŒåˆ‡ã‚ŒãŸå ´åˆã®è‡ªå‹•å†æ¥ç¶šã‚’æœ‰åŠ¹åŒ–
        self._client.reconnect_delay_set(min_delay=1, max_delay=30)

        # æ¥ç¶šã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®è¨­å®š
        self._client.on_connect = self._on_connect
        self._client.on_disconnect = self._on_disconnect

        # MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¸ã®æ¥ç¶šï¼ˆéåŒæœŸã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼‰
        try:
            self._client.connect_async(self._broker_address, self._broker_port, 60)
            # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‡¦ç†ï¼ˆæ¥ç¶šã€å†æ¥ç¶šã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼‰ã‚’
            # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œé–‹å§‹
            self._client.loop_start()
        except Exception as e:
            print(f"[Adapter] MQTT Publisher: Failed to connect initially: {e}")

    def _on_connect(self, client, userdata, flags, rc, properties=None):
        if rc == 0:
            print(f"[Adapter] MQTT Publisher: Connected to broker at {self._broker_address}")
        else:
            print(f"[Adapter] MQTT Publisher: Failed to connect, return code {rc}")

    def _on_disconnect(self, client, userdata, rc, properties=None):
        print(f"[Adapter] MQTT Publisher: Disconnected from broker. Reconnecting...")

    async def publish_world_model(self, world_model: WorldModel):
        """
        ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹(async)ã«åŸºã¥ãã€ä¸–ç•Œãƒ¢ãƒ‡ãƒ«ã‚’å…¬é–‹ã™ã‚‹
        """
        # 1. WorldModelã‚’è¾æ›¸å½¢å¼ã«å¤‰æ›
        world_model_dict = {
             "timestamp": world_model.timestamp.isoformat(),
             # ... objectsã‚„parking_spacesã‚‚è¾æ›¸ã«å¤‰æ› ...
        }

        # 2. è¾æ›¸ã‚’JSONæ–‡å­—åˆ—ï¼ˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼‰ã«å¤‰æ›
        payload = json.dumps(world_model_dict, indent=2)

        try:
            # 3. MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã«å…¬é–‹ (publish)
            # loop_start()ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã®publishè‡ªä½“ã¯éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼ˆå³åº§ã«å®Œäº†ï¼‰
            result = self._client.publish(self._topic, payload, qos=1)

            if result.rc == mqtt.MQTT_ERR_SUCCESS:
                print(f"[Adapter] MQTT Publisher: World Model published to topic '{self._topic}'")
            else:
                # ã‚­ãƒ¥ãƒ¼ãŒã„ã£ã±ã„ã€ã¾ãŸã¯æ¥ç¶šãŒåˆ‡ã‚Œã¦ã„ã‚‹
                print(f"[Adapter] MQTT Publisher: Failed to publish (rc: {result.rc}). Will retry.")

            # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒ 'async' ã§ã‚ã‚‹ãŸã‚ã€
            # ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«åˆ¶å¾¡ã‚’æˆ»ã™ï¼ˆãŠä½œæ³•ï¼‰
            await asyncio.sleep(0)

        except Exception as e:
            print(f"[Adapter] MQTT Publisher: Error publishing: {e}")

```

---

## ğŸš€ æ‰‹é †3ï¼š[main.py](http://main.py/) ã®ä¿®æ­£ï¼ˆDIã®å·®ã—æ›¿ãˆï¼‰

æœ€å¾Œã«ã€èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã® `main.py` ã‚’é–‹ãã€å¤ã„ `FileWorldModelPublisher` ã‚’ä½¿ã£ã¦ã„ãŸéƒ¨åˆ†ã‚’ã€ä»Šä½œæˆã—ãŸ `MqttWorldModelPublisher` ã«å·®ã—æ›¿ãˆã¾ã™ã€‚

```python
# main.py (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹å†…)
import asyncio
from application.use_cases import UpdateWorldModelUseCase
from adapters.stub_sensor import StubSensorAdapter       # <- å¤‰æ›´ãªã—
from adapters.repositories import InMemoryWorldModelRepository # <- å¤‰æ›´ãªã—
# from adapters.file_publisher import FileWorldModelPublisher  # <- å¤ã„ã‚¢ãƒ€ãƒ—ã‚¿ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤ï¼‰
from adapters.mqtt_publisher import MqttWorldModelPublisher  # <- ğŸ‘ˆ æ–°ã—ã„ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# -----------------------------------------------------------------------------
# Entry Point (Main Application)
# - ã‚¯ãƒ©ã‚¹å›³ã®ä½ç½®: Main (DIã‚³ãƒ³ãƒ†ãƒŠã®å½¹å‰²)
# - åŒå¿ƒå††å›³ã®ä½ç½®: æœ€ã‚‚å¤–å´ã®å±¤ (Frameworks & Drivers)
# -----------------------------------------------------------------------------
async def main():
    """
    ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã€ä¾å­˜é–¢ä¿‚ã‚’æ³¨å…¥ (DI) ã™ã‚‹ã€‚
    """
    print("--- [Perception Service] Starting Up ---")

    # 1. Adapterså±¤ï¼ˆå…·ä½“çš„ãªå®Ÿè£…ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    sensor_adapter = StubSensorAdapter()

    # â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ å·®ã—æ›¿ãˆéƒ¨åˆ† â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    # world_model_publisher = FileWorldModelPublisher(filepath="world_model.json") # <- å¤ã„ã‚¢ãƒ€ãƒ—ã‚¿

    # æ–°ã—ã„MQTTã‚¢ãƒ€ãƒ—ã‚¿ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    # ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã®ã€Œä½æ‰€ã€ã¨ã€Œãƒˆãƒ”ãƒƒã‚¯ï¼ˆéŠ˜æŸ„ï¼‰ã€ã‚’æŒ‡å®šã™ã‚‹
    world_model_publisher = MqttWorldModelPublisher(
        broker_address="localhost", # ã‚¹ãƒ†ãƒƒãƒ—1ã§èµ·å‹•ã—ãŸãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼
        broker_port=1883,
        topic="autodrive/world_model" # ã“ã®ãƒˆãƒ”ãƒƒã‚¯åã§å…¬é–‹ã™ã‚‹
    )
    # â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² å·®ã—æ›¿ãˆéƒ¨åˆ† â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    world_model_repository = InMemoryWorldModelRepository()

    # 2. UseCaseå±¤ã«ã€å…·ä½“çš„ãªå®Ÿè£…ã‚’ã€Œä¾å­˜æ€§ã®æ³¨å…¥ (DI)ã€
    #    UseCaseã¯å·®ã—æ›¿ãˆã‚‰ã‚ŒãŸã“ã¨ã«æ°—ã¥ã‹ãªã„
    use_case = UpdateWorldModelUseCase(
        sensor_interface=sensor_adapter,
        world_model_repo=world_model_repository,
        planning_adapter=world_model_publisher # <- å·®ã—æ›¿ãˆå¾Œã®ã‚¢ãƒ€ãƒ—ã‚¿ã‚’æ¸¡ã™
    )

    # 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆUseCaseï¼‰ã®ã€ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œã€‘
    # (â€»ã“ã®ãƒ«ãƒ¼ãƒ—éƒ¨åˆ†ã¯ç¬¬4å·¡ã®æœ€çµ‚çµ±åˆã§ä¿®æ­£æ¸ˆã¿)
    print("\\n--- [Perception Service] Running in loop (Press Ctrl+C to stop) ---")
    while True:
        try:
            await use_case.handle()
            await asyncio.sleep(1)
        except Exception as e:
            print(f"--- [Perception Service] Error in loop: {e} ---")
            await asyncio.sleep(5)

if __name__ == "__main__":
    # ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆèªè­˜ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã‚’å®Ÿè¡Œ
    asyncio.run(main())

```

---

## ğŸ’¡ æ‰‹é †4ï¼šå‹•ä½œç¢ºèªï¼ˆã‚µãƒ¼ãƒ“ã‚¹å˜ä½“ï¼‰

ã“ã‚Œã§å·®ã—æ›¿ãˆã¯å®Œäº†ã§ã™ã€‚å‹•ä½œç¢ºèªã‚’ã—ã¾ã—ã‚‡ã†ã€‚

1. ï¼ˆã‚¹ãƒ†ãƒƒãƒ—1ã§èµ·å‹•ã—ãŸï¼‰**MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹**ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
    
    ```bash
    docker-compose up -d
    
    ```
    
2. `perception_service/` ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ `main.py` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
    
    ```bash
    python perception_service/main.py
    
    ```
    

### ç¢ºèªã™ã‚‹ãƒã‚¤ãƒ³ãƒˆ

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚

```bash
--- [Perception Service] Starting Up ---
[Adapter] InMemoryRepo: Initialized.
[Adapter] MQTT Publisher: Connected to broker at localhost  # <- ğŸ‘ˆ æ¥ç¶šæˆåŠŸ
...
--- [Perception Service] Running in loop (Press Ctrl+C to stop) ---
...
[Adapter] InMemoryRepo: Getting WorldModel from memory.
[Adapter] InMemoryRepo: Saving WorldModel to memory.
[Adapter] MQTT Publisher: World Model published to topic 'autodrive/world_model' # <- ğŸ‘ˆ å…¬é–‹æˆåŠŸ
...

```

ãã—ã¦ã€ç¬¬4å·¡ã¨ã¯ç•°ãªã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã« `world_model.json` ã¨ã„ã†**ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸€åˆ‡ä½œæˆã•ã‚Œãªããªã£ãŸ**ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
ãƒ‡ãƒ¼ã‚¿ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ãªãã€MQTTãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ï¼ˆä¸­ç¶™å±€ï¼‰ã«ç›´æ¥é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

## ğŸ›¡ï¸ ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®é‰„å‰‡

**UseCaseã¯ã€ã‚¢ãƒ€ãƒ—ã‚¿ãŒãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã“ã†ãŒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æŠ•ã’ã‚ˆã†ãŒã€çŸ¥ã‚‹å¿…è¦ã¯ãªã„ã€‚**

`UpdateWorldModelUseCase` ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸€åˆ‡å¤‰æ›´ã™ã‚‹ã“ã¨ãªãã€ãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›å…ˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆMQTTï¼‰ã«å¤‰æ›´ã§ãã¾ã—ãŸã€‚
`UseCase` ãŒä¾å­˜ã—ã¦ã„ãŸã®ã¯ã€ã‚ãã¾ã§æŠ½è±¡çš„ãªã€Œ`PlanningServiceAdapterInterface`ï¼ˆçª“å£ï¼‰ã€ã ã‘ã ã£ãŸã‹ã‚‰ã§ã™ã€‚
ã“ã‚ŒãŒã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ãƒãƒ£ã‚¯ãƒãƒ£ãŒã‚‚ãŸã‚‰ã™ã€Œã‚¢ãƒ€ãƒ—ã‚¿ã®å·®ã—æ›¿ãˆå¯èƒ½æ€§ã€ã¨ã„ã†å¼·åŠ›ãªåˆ©ç‚¹ã§ã™ã€‚

---

æ¬¡ã¯ã€ã€Œã‚¹ãƒ†ãƒƒãƒ—3ï¼šçµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¢ãƒ€ãƒ—ã‚¿å·®ã—æ›¿ãˆã€ã«é€²ã¿ã€`File...Subscriber` ã¨ `File...Publisher` ã®ä¸¡æ–¹ã‚’MQTTã«ç½®ãæ›ãˆã¾ã™ã€‚