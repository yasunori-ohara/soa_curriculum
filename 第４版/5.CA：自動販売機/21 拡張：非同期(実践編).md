# 21 æ‹¡å¼µï¼šéåŒæœŸï¼ˆå®Ÿè·µç·¨ï¼‰

# âš¡ï¸ éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¸ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆå®Ÿè·µç·¨ï¼‰

ã“ã“ã§ã¯ã€æ—¢å­˜ã®ã‚¢ãƒ—ãƒªã‚’ã€ŒåŒæœŸã€â†’ã€ŒéåŒæœŸã€ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã¿ã¾ã™ã€‚

ã‚­ãƒ¢ã¯ã“ã‚Œã§ã™ğŸ‘‡

> ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ï¼ˆä¸­å¿ƒï¼‰ã¯ãã®ã¾ã¾ã€‚
> å®Ÿè¡Œã®ä»•æ–¹ï¼ˆå¤–å´ï¼‰ã ã‘ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã€‚

ã“ã‚Œã¯ã€ŒUIã‚’å·®ã—æ›¿ãˆã‚‹ã€ã€ŒDBã®å®Ÿè£…ã‚’å¤‰ãˆã‚‹ã€ã¨åŒã˜ãƒãƒªã§ã™ã€‚ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¢ã‚¯ã‚»ã‚¹ã®ã‚„ã‚Šæ–¹ã‚‚ã€ŒæŠ€è¡“çš„ãªè©³ç´°ã€ã«ã™ããªã„ã€ã¨ã„ã†ã®ã‚’ä½“ã§æ„Ÿã˜ã¦ã‚‚ã‚‰ã†ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚

ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã¯ã“ã‚Œã¾ã§ã¨åŒã˜ã§ã™ï¼š

```text
vending_machine/
â”œâ”€ domain/
â”‚   â”œâ”€ entities.py                # Item / PaymentManagerï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®ä¸­å¿ƒï¼‰
â”‚   â””â”€ errors.py                  # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«é•åä¾‹å¤–ï¼ˆå¿…è¦ãªã‚‰ï¼‰
â”‚
â”œâ”€ usecase/
â”‚   â”œâ”€ dto.py                     # InputData / OutputData / ViewModel
â”‚   â”œâ”€ boundaries.py              # UseCaseãŒå¤–éƒ¨ã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹å¥‘ç´„ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç¾¤ï¼‰
â”‚   â”œâ”€ insert_coin_usecase.py     # ã‚³ã‚¤ãƒ³æŠ•å…¥ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
â”‚   â””â”€ select_item_usecase.py     # å•†å“è³¼å…¥ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆâ†ã“ã‚Œã‚’éåŒæœŸåŒ–ã™ã‚‹ï¼‰
â”‚
â”œâ”€ interface_adapters/
â”‚   â”œâ”€ controller.py              # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’UseCaseã«æ©‹æ¸¡ã—
â”‚   â”œâ”€ presenter.py               # UseCaseçµæœâ†’ViewModelã«æ•´å½¢
â”‚   â”œâ”€ view_console.py            # CLIãƒ«ãƒ¼ãƒ—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ã‚„ã‚Šå–ã‚Šï¼‰
â”‚   â”œâ”€ data_access.py             # InMemoryåœ¨åº«ãƒªãƒã‚¸ãƒˆãƒª / PaymentManagerãƒªãƒã‚¸ãƒˆãƒª
â”‚   â””â”€ hardware_adapter.py        # ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§æ¨¡æ“¬ï¼‰
â”‚
â””â”€ main.py                        # ä¾å­˜æ€§ã‚’çµ„ã¿ç«‹ã¦ã¦ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã™ã‚‹
```

ã“ã®æ§‹æˆã¯ãã®ã¾ã¾ç¶­æŒã—ãŸã¾ã¾ã€éåŒæœŸå¯¾å¿œã—ã¾ã™ã€‚

---

## ğŸª¨ ã‚¹ãƒ†ãƒƒãƒ—1ï¼šã¾ãšã€Œå¤‰ã‚ã‚‰ãªã„ã‚‚ã®ã€ã‚’ç¢ºèªã™ã‚‹

æœ€åˆã«ä¸€ç•ªå¤§äº‹ãªã“ã¨ã‚’è¨€ã„ã¾ã™ã€‚

> `domain/entities.py` ã¯ä¸€è¡Œã‚‚å¤‰ãˆã¾ã›ã‚“ã€‚

ä¾‹ãˆã° `Item` ã‚„ `PaymentManager` ã¯ã€åœ¨åº«ã‚’æ¸›ã‚‰ã—ãŸã‚Šã€ãŠé‡£ã‚Šã‚’è¨ˆç®—ã—ãŸã‚Šã™ã‚‹ã ã‘ã§ã™ã€‚ãã“ã«ã¯ã€Œå¾…ã¡æ™‚é–“(IOå¾…ã¡)ã€ãŒã‚ã‚Šã¾ã›ã‚“ã€‚CPUã ã‘ã§çµ‚ã‚ã‚‹ç´”ç²‹ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç´”ç²‹ãªãƒ«ãƒ¼ãƒ«ï¼‰ã§ã™ã€‚

* `Item.is_in_stock()`
* `Item.dispense()`
* `PaymentManager.process_purchase(item)`
* `PaymentManager.return_change()`

ã“ã‚Œã‚‰ã¯åŒæœŸ/éåŒæœŸã¨ã„ã†â€œå®Ÿè¡Œãƒ¢ãƒ‡ãƒ«â€ã¨ã¯ç„¡é–¢ä¿‚ã§ã™ã€‚
ã ã‹ã‚‰ã€éåŒæœŸåŒ–ã®å½±éŸ¿ã¯**ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆä¸­å¿ƒï¼‰ã«ã¯æ³¢åŠã—ã¾ã›ã‚“**ã€‚

ã“ã‚Œã¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç¾å‘³ã—ã„ã¨ã“ã‚ã§ã™ã€‚
ã€Œãƒ“ã‚¸ãƒã‚¹ã®æ ¸å¿ƒã€ã¯ã€ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œã‚¹ã‚¿ã‚¤ãƒ«ã«å½±éŸ¿ã•ã‚Œãªã„ã€‚

---

## ğŸ”Œ ã‚¹ãƒ†ãƒƒãƒ—2ï¼šå¢ƒç•Œï¼ˆusecase/boundaries.pyï¼‰ã‚’éåŒæœŸå¯¾å¿œã«ã™ã‚‹

ã©ã“ã‹ã‚‰å¤‰ãˆã‚‹ã¹ãã‹ï¼Ÿ
å¤–å´ã§ã™ã€‚ç‰¹ã«ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡ã¯ã€Œå®Ÿæ©Ÿã«å‘½ä»¤ã‚’å‡ºã™ã€ã€Œãƒ¢ãƒ¼ã‚¿ãƒ¼ãŒå›ã‚‹ã¾ã§å¾…ã¤ã€ãªã©ã€å¾…ã¡æ™‚é–“ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã“ã“ã‚’ `async` ã«ã—ã¾ã™ã€‚

`HardwareInterface` ã‚’ã“ã†å¤‰ãˆã¾ã™ï¼š

```python
# vending_machine/usecase/boundaries.py
from abc import ABC, abstractmethod
from vending_machine.domain.entities import Item

class HardwareInterface(ABC):
    @abstractmethod
    async def dispense_item(self, item: Item):
        """
        æŒ‡å®šã•ã‚ŒãŸå•†å“ã‚’ç‰©ç†çš„ã«æ’å‡ºã™ã‚‹ã€‚
        éåŒæœŸI/Oï¼ˆãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡ã‚„ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ãªã©ï¼‰ã‚’æƒ³å®šã€‚
        """
        raise NotImplementedError

    @abstractmethod
    async def return_change(self, amount: int):
        """
        æŒ‡å®šã•ã‚ŒãŸé‡‘é¡ã®ãŠé‡£ã‚Šã‚’ç‰©ç†çš„ã«æ’å‡ºã™ã‚‹ã€‚
        ã“ã¡ã‚‰ã‚‚ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢I/Oã«ãªã‚‹ã®ã§asyncã€‚
        """
        raise NotImplementedError
```

å¤‰æ›´ç‚¹ã¯ã“ã“ã ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
`SelectItemInputBoundary`ï¼ˆï¼UseCaseã®ã€Œå…¥å£ã€ï¼‰ã‚‚éåŒæœŸã«ã—ã¾ã™ã€‚

```python
from abc import ABC, abstractmethod
from vending_machine.usecase.dto import SelectItemInputData

class SelectItemInputBoundary(ABC):
    @abstractmethod
    async def handle(self, input_data: SelectItemInputData):
        """
        å•†å“è³¼å…¥ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã€‚
        éåŒæœŸã«ãªã£ãŸãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’å‘¼ã³å‡ºã™å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§asyncã€‚
        """
        raise NotImplementedError
```

ğŸ‘ ã“ã†ã—ã¦ `UseCase` ã¨ `Hardware` ã®ã‚ã„ã ã®å¥‘ç´„ãŒã€ŒéåŒæœŸã®ä¸–ç•Œã€ã‚’è¡¨ç¾ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä»–ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆ`ItemDataAccessInterface`, `PaymentManagerAccessInterface`, `SelectItemOutputBoundary`ï¼‰ã¯åŒæœŸã®ã¾ã¾ã§ã‚‚OKã§ã™ã€‚
ç†ç”±ï¼šãƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹ã‚„Presenteræ›´æ–°ã¯å³æ™‚ã§çµ‚ã‚ã‚‹ã‹ã‚‰ï¼ˆI/Oå¾…ã¡ã§ã¯ãªã„ï¼‰ã€‚

---

## ğŸ§  ã‚¹ãƒ†ãƒƒãƒ—3ï¼šUseCaseï¼ˆselect_item_usecase.pyï¼‰ã‚’ async åŒ–ã™ã‚‹

`SelectItemUseCase` ã¯ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’å‘¼ã¶è²¬ä»»è€…ãªã®ã§ã€`await`ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

```python
# vending_machine/usecase/select_item_usecase.py

from vending_machine.usecase.boundaries import (
    SelectItemInputBoundary,
    SelectItemOutputBoundary,
    ItemDataAccessInterface,
    PaymentManagerAccessInterface,
    HardwareInterface,
)
from vending_machine.usecase.dto import SelectItemInputData, SelectItemOutputData

class SelectItemUseCase(SelectItemInputBoundary):
    """
    å•†å“è³¼å…¥ï¼ˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãï¼‰ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã€‚
    - å•†å“ãŒã‚ã‚‹ã‹ç¢ºèª
    - ãŠé‡‘ãŒè¶³ã‚Šã‚‹ã‹ç¢ºèª
    - ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚’å›ã—ã¦å•†å“ã‚’å‡ºã™
    - ãŠé‡£ã‚Šã‚’è¿”ã™
    - Presenterã«çµæœã‚’ä¼ãˆã‚‹
    """

    def __init__(
        self,
        presenter: SelectItemOutputBoundary,
        item_repository: ItemDataAccessInterface,
        payment_manager_repo: PaymentManagerAccessInterface,
        hardware: HardwareInterface,
    ):
        self._presenter = presenter
        self._item_repository = item_repository
        self._payment_manager_repo = payment_manager_repo
        self._hardware = hardware

    async def handle(self, input_data: SelectItemInputData):
        """
        éåŒæœŸãƒ¡ã‚½ãƒƒãƒ‰ã«ãªã£ãŸã®ã¯ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æ“ä½œãŒawaitã«ãªã‚‹ã‹ã‚‰ã€‚
        ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ã¯åŒæœŸå‡¦ç†ã®ã¾ã¾ã€‚
        """

        # 1. å¿…è¦ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é›†ã‚ã‚‹
        item = self._item_repository.find_by_slot_id(input_data.slot_id)
        if item is None:
            self._presenter.present_failure("æŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
            return

        pm = self._payment_manager_repo.get()

        try:
            # 2. ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«ã®å®Ÿè¡Œï¼ˆåŒæœŸã®ã¾ã¾ï¼‰
            if not item.is_in_stock():
                raise ValueError(f"ã€Œ{item.name}ã€ã¯å£²ã‚Šåˆ‡ã‚Œã§ã™ã€‚")

            change = pm.process_purchase(item)  # ãŠé‡£ã‚Šè¨ˆç®—ï¼‹æ®‹é«˜ãƒªã‚»ãƒƒãƒˆ

            # 3. ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡ï¼ˆã“ã“ãŒ awaitï¼‰
            await self._hardware.dispense_item(item)
            if change > 0:
                await self._hardware.return_change(change)

            # 4. åœ¨åº«æ¸›ã‚‰ã™ãƒ»ä¿å­˜ï¼ˆåŒæœŸã§OKï¼‰
            item.dispense()
            self._item_repository.save(item)
            self._payment_manager_repo.save(pm)

            # 5. Presenterã«æˆåŠŸã‚’ä¼ãˆã‚‹ï¼ˆåŒæœŸã®ã¾ã¾ï¼‰
            output = SelectItemOutputData(
                item_name=item.name,
                change=change,
            )
            self._presenter.present_success(output)

        except ValueError as e:
            # ãŠé‡‘ä¸è¶³ã‚„å£²ã‚Šåˆ‡ã‚Œãªã©
            self._presenter.present_failure(str(e))
```

ğŸ¥¤ å¤§äº‹ãªè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆï¼š

* `process_purchase()` ã¯åŒæœŸã®ã¾ã¾
* `item.dispense()` ã‚‚åŒæœŸã®ã¾ã¾
* `await` ãŒå¿…è¦ãªã®ã¯ `hardware` å‘¼ã³å‡ºã—ã ã‘
* `UseCase` ã®ä¸­ã§ async/await ãŒå¿…è¦ã«ãªã£ã¦ã‚‚ã€**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãã®ã‚‚ã®ã¯å¤‰ã‚ã‚‰ãªã„**

ã“ã‚ŒãŒã€Œå®Ÿè¡Œãƒ¢ãƒ‡ãƒ«ã¯è©³ç´°ï¼ˆDetailï¼‰ã§ã‚ã‚‹ã€ã¨ã„ã†ã“ã¨ã€‚

---

## ğŸ¤– ã‚¹ãƒ†ãƒƒãƒ—4ï¼šHardware Adapterï¼ˆinterface_adapters/hardware_adapter.pyï¼‰ã‚’ async åŒ–ã™ã‚‹

ã“ã“ãŒ I/Oï¼ˆå¤–ç•Œã¨ã®å¯¾è©±ï¼‰ãªã®ã§ã€`async` å¯¾å¿œã•ã›ã¾ã™ã€‚
ã€Œãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚’å›ã™æ™‚é–“ã€ã€Œã‚³ã‚¤ãƒ³ã‚’æ‰•ã„å‡ºã™æ™‚é–“ã€ã‚’ `asyncio.sleep()` ã§ç–‘ä¼¼çš„ã«å†ç¾ã—ã¾ã™ã€‚

```python
# vending_machine/interface_adapters/hardware_adapter.py

import asyncio
from vending_machine.usecase.boundaries import HardwareInterface
from vending_machine.domain.entities import Item

class ConsoleHardwareAdapter(HardwareInterface):
    """
    ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç‰ˆå®Ÿè£…ã€‚
    å®Ÿæ©Ÿã®ã‹ã‚ã‚Šã«printã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã€‚
    ä»Šå›ã¯ç–‘ä¼¼çš„ãªI/Oå¾…ã¡ã‚’asyncio.sleepã§å†ç¾ã™ã‚‹ã€‚
    """

    async def dispense_item(self, item: Item):
        """
        [ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å®Ÿè£…]
        å•†å“ã‚’æ’å‡ºã™ã‚‹ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚’å›ã™â€¦ã¨ã„ã†æƒ³å®šã®å‡¦ç†ã€‚
        ä»Šå›ã¯ print ã¨ sleep ã§â€œãã‚Œã£ã½ãâ€å¾…ã¤ã€‚
        """
        print("ï¼ˆå•†å“ã‚’æ’å‡ºã—ã¦ã„ã¾ã™...ï¼‰")
        await asyncio.sleep(1.0)  # ãƒ¢ãƒ¼ã‚¿ãƒ¼ãŒå‹•ä½œã—ã¦ã„ã‚‹1ç§’é–“
        print(f"ï¼ˆã‚¬ã‚³ãƒ³ãƒƒï¼ã€{item.name}ã€ã‚’æ’å‡ºã—ã¾ã—ãŸï¼‰")

    async def return_change(self, amount: int):
        """
        [ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å®Ÿè£…]
        ãŠé‡£ã‚Šã‚’æ‰•ã„å‡ºã™â€¦ã¨ã„ã†æƒ³å®šã®å‡¦ç†ã€‚
        åŒæ§˜ã«å¾…ã¡æ™‚é–“ã‚’å…¥ã‚Œã‚‹ã€‚
        """
        if amount <= 0:
            return
        print("ï¼ˆãŠé‡£ã‚Šã‚’æº–å‚™ã—ã¦ã„ã¾ã™...ï¼‰")
        await asyncio.sleep(0.5)  # ã‚³ã‚¤ãƒ³æ‰•ã„å‡ºã—0.5ç§’æƒ³å®š
        print(f"ï¼ˆãƒãƒ£ãƒªãƒ³ï¼ãŠé‡£ã‚Š {amount} å††ã‚’è¿”å´ã—ã¾ã—ãŸï¼‰")
```

ã“ã“ã§è¡Œã£ã¦ã„ã‚‹ã“ã¨ã¯ã€ã“ã†ã§ã™ï¼š

* `UseCase` ã¯ `HardwareInterface` ã®æŠ½è±¡ã ã‘ã‚’çŸ¥ã£ã¦ã„ã‚‹
* `ConsoleHardwareAdapter` ã¯ãã®æŠ½è±¡ã‚’æº€ãŸã™å…·ä½“å®Ÿè£…
* ä»Šå›ã€ãã®å…·ä½“å®Ÿè£…ãŒãŸã¾ãŸã¾ã€ŒéåŒæœŸI/Oã€ã§ã™
* ã§ã‚‚ `UseCase` ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å£Šã‚Œãªã„
* ã‚‚ã¡ã‚ã‚“ `domain` ã«ã¯ä¸€åˆ‡æ³¢åŠã—ã¦ã„ãªã„

ã“ã‚Œã¯ã¤ã¾ã‚Šã€**æŠ€è¡“çš„ãªè©³ç´°ã¯ã„ã¤ã§ã‚‚å®‰å…¨ã«å·®ã—æ›¿ãˆã‚‰ã‚Œã‚‹**ã¨ã„ã†ã“ã¨ã®å®Ÿæ¼”ã§ã™ã€‚

---

## ğŸ® ã‚¹ãƒ†ãƒƒãƒ—5ï¼šController ã¨ View ã‚‚ async ã«åˆã‚ã›ã‚‹

`View` ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å—ã‘ã¦ `Controller` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
`Controller` ã¯ `UseCase` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

ã“ã®å‘¼ã³å‡ºã—ãƒã‚§ãƒ¼ãƒ³ã« `await` ã‚’ä¼æ’­ã•ã›ã¾ã™ã€‚

### controller.pyï¼ˆæŠœç²‹ãƒ»éåŒæœŸç‰ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰

```python
# vending_machine/interface_adapters/controller.py

from vending_machine.usecase.boundaries import SelectItemInputBoundary
from vending_machine.usecase.dto import SelectItemInputData
from vending_machine.usecase.boundaries import PaymentManagerAccessInterface

class VendingMachineController:
    """
    View ã‹ã‚‰å‘¼ã°ã‚Œã‚‹å…¥ã‚Šå£ã€‚
    ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’UseCaseã®InputDataã«ç¿»è¨³ã—ã€UseCaseã‚’å‘¼ã¶å½¹ã€‚
    """

    def __init__(
        self,
        select_item_use_case: SelectItemInputBoundary,
        payment_manager_repo: PaymentManagerAccessInterface,
    ):
        self._select_item_use_case = select_item_use_case
        self._pm_repo = payment_manager_repo

    async def select_item(self, slot_id: str):
        """
        å•†å“è³¼å…¥ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã€ã¨ã„ã†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹ã€‚
        éåŒæœŸUseCaseã‚’awaitã™ã‚‹ã€‚
        """
        input_data = SelectItemInputData(slot_id=slot_id)
        await self._select_item_use_case.handle(input_data)

    def insert_coin(self, coin: int):
        """
        ã‚³ã‚¤ãƒ³æŠ•å…¥ã¯ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’å©ã‹ãšã€PaymentManagerã ã‘ã‚’æ›´æ–°ã™ã‚‹ã®ã§åŒæœŸã®ã¾ã¾ã§ã‚‚OKã€‚
        """
        pm = self._pm_repo.get()
        pm.insert_coin(coin)
        self._pm_repo.save(pm)

    def return_change(self):
        """
        ãŠé‡£ã‚Šè¿”å´è¦æ±‚ã‚‚ã€ä»Šå›ã¯åŒæœŸã®PaymentManagerãƒ­ã‚¸ãƒƒã‚¯ã§å®Œçµã•ã›ã¦ã—ã¾ã†å®Ÿè£…ä¾‹ã€‚
        ï¼ˆã‚‚ã—ã“ã“ã§ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’ç‰©ç†çš„ã«å‹•ã‹ã™ãªã‚‰asyncã«ã™ã‚‹ï¼‰
        """
        pm = self._pm_repo.get()
        change = pm.return_change()
        self._pm_repo.save(pm)
        return change
```

ãƒã‚¤ãƒ³ãƒˆã¯ã€Œãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã«è§¦ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å‡¦ç†ã ã‘ async ã«å¯„ã›ã‚‹ã€ã“ã¨ã€‚
ï¼ˆã“ã“ã§ã¯ `select_item` ãŒãã‚Œã«è©²å½“ã—ã¾ã™ï¼‰

ä»–ã®æ“ä½œã‚‚ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’å·»ãè¾¼ã‚€ã‚ˆã†ã«ã—ãŸã„ãªã‚‰ã€åŒã˜ã‚ˆã†ã« `async def` / `await` ã«ã—ã¦ã„ã‘ã¾ã™ã€‚

---

### view_console.pyï¼ˆæŠœç²‹ãƒ»éåŒæœŸç‰ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰

```python
# vending_machine/interface_adapters/view_console.py

class ConsoleView:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ç›´æ¥ã®ã‚„ã‚Šå–ã‚Šæ‹…å½“ã€‚
    - å…¥åŠ›ã‚’å—ã‘ã‚‹
    - Controllerã‚’å‘¼ã¶ï¼ˆawaitã™ã‚‹å ´åˆã‚‚ã‚ã‚‹ï¼‰
    - PresenterãŒæ›´æ–°ã—ãŸViewModelã‚’è¡¨ç¤ºã™ã‚‹
    """

    def __init__(self, controller, view_model, payment_manager_repo):
        self._controller = controller
        self._view_model = view_model
        self._pm_repo = payment_manager_repo

    async def run(self):
        """
        ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆéåŒæœŸç‰ˆï¼‰
        """
        while True:
            pm = self._pm_repo.get()
            print("\n--------------------")
            print(f"ç¾åœ¨ã®æŠ•å…¥é‡‘é¡: {pm.current_amount}å††")
            print("æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„: [c: ã‚³ã‚¤ãƒ³æŠ•å…¥, s: å•†å“é¸æŠ, r: ãŠé‡£ã‚Šè¿”å´, q: çµ‚äº†]")
            action = input("> ").lower()

            try:
                if action == "c":
                    coin_str = input("æŠ•å…¥ã™ã‚‹ç¡¬è²¨ï¼ˆ10, 50, 100, 500ï¼‰: ")
                    self._controller.insert_coin(int(coin_str))

                elif action == "s":
                    slot_id = input("è³¼å…¥ã™ã‚‹å•†å“ã®ã‚¹ãƒ­ãƒƒãƒˆID: ")
                    # â† å•†å“è³¼å…¥ã¯ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’å‹•ã‹ã™ã®ã§await
                    await self._controller.select_item(slot_id)

                elif action == "r":
                    change = self._controller.return_change()
                    if change > 0:
                        self._view_model.display_text = f"{change}å††ãŠè¿”ã—ã—ã¾ã—ãŸã€‚"
                    else:
                        self._view_model.display_text = "è¿”å´ã™ã‚‹ç¡¬è²¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"

                elif action == "q":
                    print("ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚")
                    break

                else:
                    self._view_model.display_text = "ç„¡åŠ¹ãªæ“ä½œã§ã™ã€‚"

            except ValueError:
                self._view_model.display_text = "ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªå…¥åŠ›ã§ã™ã€‚"
            except Exception as e:
                self._view_model.display_text = f"äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼: {e}"

            # ãƒ«ãƒ¼ãƒ—æœ€å¾Œã«Presenter/ViewModelãŒæŒã¤æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            self.render()

    def render(self):
        """
        PresenterãŒæ•´å½¢æ¸ˆã¿ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹ã€‚
        """
        print(f"ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤: {self._view_model.display_text}")
```

ã“ã“ã‚‚åŒã˜è€ƒãˆæ–¹ã§ã™ã€‚

* Viewã¯UIæ‹…å½“ãªã®ã§ã€Œã©ã®æ“ä½œã¯awaitãŒå¿…è¦ã‹ã€ã‚’åˆ¤æ–­ã—ã¦Controllerã‚’å‘¼ã¶
* ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¯ä¸€åˆ‡ã“ã“ã«æ›¸ã‹ãªã„ï¼ˆãã‚Œã¯UseCaseå´ã®ä»•äº‹ï¼‰

---

## ğŸš€ ã‚¹ãƒ†ãƒƒãƒ—6ï¼šmain.pyï¼ˆèµ·å‹•éƒ¨åˆ†ï¼‰ã‚’éåŒæœŸã‚¨ãƒ³ãƒˆãƒªã«ã™ã‚‹

åŒæœŸç‰ˆã® `main()` ã¯ãã®ã¾ã¾ `async def main()` ã«ãªã‚Šã¾ã™ã€‚
ãã—ã¦ã€ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã§ `asyncio.run(main())` ã‚’å‘¼ã³ã¾ã™ã€‚

```python
# main.py
import asyncio

from vending_machine.interface_adapters.presenter import VendingMachinePresenter
from vending_machine.interface_adapters.data_access import (
    InMemoryItemRepository,
    InMemoryPaymentManagerRepository,
)
from vending_machine.interface_adapters.hardware_adapter import ConsoleHardwareAdapter
from vending_machine.interface_adapters.controller import VendingMachineController
from vending_machine.interface_adapters.view_console import ConsoleView
from vending_machine.usecase.select_item_usecase import SelectItemUseCase
from vending_machine.usecase.dto import VendingMachineViewModel

async def main():
    # 1. å…±æœ‰çŠ¶æ…‹ï¼ˆViewModelã‚„ãƒªãƒã‚¸ãƒˆãƒªï¼‰ã‚’æº–å‚™
    view_model = VendingMachineViewModel()
    item_repo = InMemoryItemRepository()
    pm_repo = InMemoryPaymentManagerRepository()
    hardware = ConsoleHardwareAdapter()

    # 2. Presenter
    presenter = VendingMachinePresenter(view_model)

    # 3. UseCaseï¼ˆéåŒæœŸç”¨ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
    select_item_uc = SelectItemUseCase(
        presenter=presenter,
        item_repository=item_repo,
        payment_manager_repo=pm_repo,
        hardware=hardware,
    )

    # 4. Controller
    controller = VendingMachineController(
        select_item_use_case=select_item_uc,
        payment_manager_repo=pm_repo,
    )

    # 5. Viewï¼ˆéåŒæœŸãƒ«ãƒ¼ãƒ—ï¼‰
    view = ConsoleView(
        controller=controller,
        view_model=view_model,
        payment_manager_repo=pm_repo,
    )

    # 6. å®Ÿè¡Œé–‹å§‹
    await view.run()


if __name__ == "__main__":
    asyncio.run(main())
```

ã“ã“ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ã¨ã¦ã‚‚å¤§äº‹ã§ã™ï¼š

* `main.py` ã®è²¬å‹™ã¯ã€Œå…¨éƒ¨å“ã‚’é…ç·šã™ã‚‹ã“ã¨ã€ã ã‘
* ã©ã®å±¤ãŒã©ã®å±¤ã‚’çŸ¥ã£ã¦ã„ã„ã®ã‹ã€ã¨ã„ã†ä¾å­˜é–¢ä¿‚ã®ãƒ«ãƒ¼ãƒ«è‡ªä½“ã¯ã€åŒæœŸç‰ˆã¨å¤‰ã‚ã£ã¦ã„ã¾ã›ã‚“
* ãŸã ã€Œä¸€éƒ¨ãŒasyncã ã‹ã‚‰awaitã§å‘¼ã¶ã€ã‚ˆã†ã«ã—ãŸã ã‘

---

## ğŸ› éåŒæœŸã‚¢ãƒ—ãƒªã®ãƒ‡ãƒãƒƒã‚°ã®ã‚³ãƒ„

async/awaitã«ãªã‚‹ã¨ã€Œé †ç•ªã©ã†ãªã£ã¦ã‚‹ã®ï¼Ÿã€ã£ã¦ä¸å®‰ã«ãªã‚Šã¾ã™ã€‚
ã§ã‚‚åŸºæœ¬ã¯åŒã˜ã§ã™ã€‚

* `print()` ãƒ‡ãƒãƒƒã‚°ã¯æ™®é€šã«æœ‰åŠ¹

  * ã€Œdispense_itemå…¥ã£ãŸã€ã€Œawaitå¾…ã¡ä¸­ã€ã€Œçµ‚ã‚ã£ãŸã€ã‚’é †ç•ªã«å‡ºã™ã ã‘ã§çŠ¶æ³ãŒè¿½ãˆã¾ã™
* `logging` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã†ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§è¿½è·¡ã§ãã‚‹
* `asyncio.sleep()` ã‚’çŸ­ãã™ã‚Œã°ãƒ†ã‚¹ãƒˆé«˜é€ŸåŒ–ãŒã§ãã‚‹
* VSCodeãªã©ã®IDEã¯ `async def` ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ç½®ã‘ã¾ã™ï¼ˆã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œå¯èƒ½ï¼‰

ã•ã‚‰ã«ã€`asyncio.run()` ã®å‰ã«ãƒ‡ãƒãƒƒã‚°ç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚„ `asyncio.get_running_loop().set_debug(True)` ã‚’ä½¿ã†ã¨ã€ã€Œã©ã®ã‚¿ã‚¹ã‚¯ãŒé•·ãæ­¢ã¾ã£ã¦ã‚‹ï¼Ÿã€ã¿ãŸã„ãªæƒ…å ±ã‚‚æ‹¾ãˆã¾ã™ã€‚

---

## ğŸ”š ã¾ã¨ã‚ï¼šå®Ÿè¡Œãƒ¢ãƒ‡ãƒ«ã‚‚è©³ç´°ã§ã‚ã‚‹

ã“ã®ç« ã§ã‚„ã£ãŸã“ã¨ã‚’æŒ¯ã‚Šè¿”ã‚Šã¾ã™ã€‚

1. `domain/entities.py` ã¯å¤‰æ›´ãªã—
   ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¯ä½•ã‚‚å£Šã‚Œãªã„
2. `HardwareInterface` ã‚’ `async` ã«ã—ãŸ
   â†’ ã“ã‚Œã¯ã€Œå¤–ã®ä¸–ç•Œã¨ã®æ¥ç‚¹ã€ã®è©±
3. `SelectItemUseCase` ã‚’ `async def handle` ã«ã—ãŸ
   â†’ ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’ `await` ã™ã‚‹ãŸã‚
4. View / Controller / main ã¾ã§ `await` ã‚’ä¼æ’­ã•ã›ãŸ
   â†’ UIã®å‘¼ã³å‡ºã—å´ã‚‚éåŒæœŸå¯¾å¿œã«

ã“ã“ã§ä¼ãˆãŸã„ã“ã¨ã¯ä¸€ã¤ã ã‘ã§ã™ã€‚

> å®Ÿè¡Œæ–¹æ³•ã¯è©³ç´°ã§ã‚ã‚‹ã€‚
> (The execution model is a detail.)

è‡ªè²©æ©ŸãŒã€ŒåŒæœŸçš„ã«ã‚¬ã‚³ãƒ³ã€ã¨å‹•ãã‹ã€ã€ŒéåŒæœŸã«ã‚¬ã‚³ãƒ³ã€ã¨å‹•ãã‹ã¯ã€ã‚ãã¾ã§å¤–å´ã®éƒ½åˆã§ã™ã€‚
åœ¨åº«ãƒã‚§ãƒƒã‚¯ã®ãƒ«ãƒ¼ãƒ«ã‚„ã€ãŠé‡£ã‚Šè¨ˆç®—ã®ãƒ«ãƒ¼ãƒ«ã¯ã€æ°¸é ã«åŒã˜ã§ã™ã€‚

ã“ã®åˆ†é›¢ã“ããŒã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç´„æŸã—ã¦ãã‚Œã‚‹â€œå¤‰æ›´ã«å¼·ã„è¨­è¨ˆâ€ã§ã™ã€‚
UIãŒå¤‰ã‚ã£ã¦ã‚‚ã€DBãŒå¤‰ã‚ã£ã¦ã‚‚ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒé€²åŒ–ã—ã¦ã‚‚ã€åŒæœŸâ†’éåŒæœŸã«åˆ‡ã‚Šæ›¿ã‚ã£ã¦ã‚‚â”€â”€ãƒ“ã‚¸ãƒã‚¹ã®èŠ¯ã ã‘ã¯å®ˆã‚‰ã‚Œã‚‹ã€‚ã“ã‚Œã§ã€ã“ã®ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã®æ—…ã¯ãã‚Œã„ã«é–‰ã˜ã¾ã™ã€‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚ğŸ‘
