# 12 テストまとめ
# 🚀 テストまとめ — pytestでクリーンアーキテクチャを検証する

## 🎯 この章の目的

ここまでで、クリーンアーキテクチャの各レイヤーを順に構築してきました。

* **Entity（ドメイン）**
* **UseCase（ユースケース）**
* **Presenter / Controller / View（UI系）**
* **Repository（データアクセス）**

この章では、すべての層が独立してテストできるように設計されていることを確認します。
そして実際に **pytest** を使って自動テストを実行できる環境を整えます。

---

## 🧭 テストの全体像

クリーンアーキテクチャの利点の一つは、
**ビジネスロジック（UseCase）をUIやDBから切り離して単独でテストできること**です。

各層は独立して責務を持つため、
たとえば以下のように「レイヤー単位のテスト」が可能です。

| テスト対象        | テストで確認する内容            | 使用するテストダブル                      |
| ------------ | --------------------- | ------------------------------- |
| UseCase      | ビジネスロジックが正しく動くか       | Fake Repository / Spy Presenter |
| Presenter    | ViewModelが正しく更新されるか   | なし（ViewModelのみ）                 |
| Controller   | ユーザー入力を正しくUseCaseに渡すか | Spy UseCase                     |
| View         | 入力と出力の制御ができているか       | Spy Controller                  |
| Repository実装 | 保存・取得処理が正しいか          | なし（実体をテスト）                      |

---

## 🗂 ディレクトリ構成（最終版）

テストを含めた全体構成は次のようになります。

```text
clean_architecture_todo/
├─ core/
│   ├─ domain/
│   │   ├─ todo.py
│   │   ├─ repository.py
│   │   └─ errors.py
│   └─ usecase/
│       ├─ interactor/
│       │   └─ create_todo.py
│       └─ boundary/
│           ├─ input_boundary.py
│           ├─ output_boundary.py
│           └─ dto.py
│
├─ interface_adapters/
│   ├─ presenters/
│   │   └─ todo_presenter.py
│   ├─ controllers/
│   │   └─ todo_controller.py
│   └─ views/
│       └─ view_console.py
│
├─ infrastructure/
│   └─ repositories/
│       └─ in_memory_todo_repository.py
│
├─ main.py
│
└─ tests/
    ├─ conftest.py
    └─ unit/
        ├─ test_todo_usecase.py
        ├─ test_presenter.py
        ├─ test_controller.py
        ├─ test_view_console.py
        └─ test_in_memory_todo_repository.py
```

---

## 🧩 conftest.py — 共通フィクスチャ（Spy / Fake）

pytestでは、共通のテスト用オブジェクトを `conftest.py` に定義しておくと、
各テストファイルから自動で使えます。

```python
# tests/conftest.py
from typing import List, Optional
import pytest

from core.usecase.boundary.output_boundary import TodoOutputBoundary
from core.usecase.boundary.dto import TodoOutputData
from core.domain.repository import TodoRepository
from core.domain.todo import Todo

# Presenterのスパイ（呼び出し監視用）
class SpyTodoPresenter(TodoOutputBoundary):
    def __init__(self):
        self.called_times = 0
        self.called_with_output_data: Optional[TodoOutputData] = None

    def present(self, output_data: TodoOutputData):
        self.called_times += 1
        self.called_with_output_data = output_data

# Repositoryのフェイク（メモリ上に保存）
class FakeInMemoryTodoRepository(TodoRepository):
    def __init__(self):
        self._store: List[Todo] = []
        self._next_id = 1
        self.save_called_times = 0

    def save(self, todo: Todo) -> Todo:
        self.save_called_times += 1
        todo.id = self._next_id
        self._next_id += 1
        self._store.append(todo)
        return todo

    def find_all(self) -> List[Todo]:
        return list(self._store)

# pytestフィクスチャ
@pytest.fixture
def spy_presenter():
    return SpyTodoPresenter()

@pytest.fixture
def fake_repo():
    return FakeInMemoryTodoRepository()
```

---

## ✅ UseCase のテスト

`TodoUseCase` が、Presenter・Repositoryと正しくやり取りできるかを検証します。

```python
# tests/unit/test_todo_usecase.py
from core.usecase.boundary.dto import TodoInputData
from core.usecase.interactor.create_todo import TodoUseCase

def test_add_new_todo_successfully(spy_presenter, fake_repo):
    use_case = TodoUseCase(spy_presenter, fake_repo)
    input_data = TodoInputData(title="新しいタスク")

    use_case.execute(input_data)

    all_todos = fake_repo.find_all()
    assert len(all_todos) == 1
    assert all_todos[0].title == "新しいタスク"

    assert spy_presenter.called_times == 1
    assert spy_presenter.called_with_output_data.title == "新しいタスク"
```

---

## ✅ Presenter のテスト

`TodoPresenter` が `TodoViewModel` に表示用の文字列を渡せるかを検証します。

```python
# tests/unit/test_presenter.py
from core.usecase.boundary.dto import TodoOutputData, TodoViewModel
from interface_adapters.presenters.todo_presenter import TodoPresenter

def test_presenter_updates_view_model():
    vm = TodoViewModel()
    presenter = TodoPresenter(vm)
    output_data = TodoOutputData(id=1, title="テストタスク")

    presenter.present(output_data)

    assert "テストタスク" in vm.display_text
    assert "ID: 1" in vm.display_text
```

---

## ✅ Controller のテスト

Controller がユーザー入力を `TodoInputData` に変換して UseCase を呼んでいるかを確認します。

```python
# tests/unit/test_controller.py
from core.usecase.boundary.input_boundary import TodoInputBoundary
from core.usecase.boundary.dto import TodoInputData
from interface_adapters.controllers.todo_controller import TodoController

class SpyUseCase(TodoInputBoundary):
    def __init__(self):
        self.called_times = 0
        self.last_input_data: TodoInputData | None = None

    def execute(self, input_data: TodoInputData):
        self.called_times += 1
        self.last_input_data = input_data

def test_controller_calls_use_case_with_todoinputdata():
    spy_use_case = SpyUseCase()
    controller = TodoController(spy_use_case)

    controller.add_todo("買い物に行く")

    assert spy_use_case.called_times == 1
    assert spy_use_case.last_input_data.title == "買い物に行く"
```

---

## ✅ View のテスト

`ConsoleView` が入力と出力を正しく扱うかを検証します。
`monkeypatch` で `input()` を、`capsys` で `print()` をモックします。

```python
# tests/unit/test_view_console.py
from interface_adapters.views.view_console import ConsoleView
from core.usecase.boundary.dto import TodoViewModel

class SpyController:
    def __init__(self):
        self.called_times = 0
        self.last_title = None
    def add_todo(self, title: str):
        self.called_times += 1
        self.last_title = title

def test_view_calls_controller_and_renders(monkeypatch, capsys):
    monkeypatch.setattr("builtins.input", lambda _: "テスト入力")
    vm = TodoViewModel(display_text="初期表示")
    controller = SpyController()
    view = ConsoleView(controller, vm)

    view.run()

    assert controller.called_times == 1
    assert controller.last_title == "テスト入力"

    captured = capsys.readouterr()
    assert "初期表示" in captured.out
```

---

## ✅ Repository実装 のテスト

`InMemoryTodoRepository` がID採番や保存を正しく行っているかを検証します。

```python
# tests/unit/test_in_memory_todo_repository.py
from infrastructure.repositories.in_memory_todo_repository import InMemoryTodoRepository
from core.domain.todo import Todo

def test_in_memory_repo_assigns_incrementing_ids():
    repo = InMemoryTodoRepository()
    t1 = repo.save(Todo(id=0, title="一つ目"))
    t2 = repo.save(Todo(id=0, title="二つ目"))
    assert t1.id == 1
    assert t2.id == 2

def test_in_memory_repo_returns_all_items():
    repo = InMemoryTodoRepository()
    repo.save(Todo(id=0, title="A"))
    repo.save(Todo(id=0, title="B"))
    titles = [t.title for t in repo.find_all()]
    assert titles == ["A", "B"]
```

---

## 🧪 テストの実行方法

ターミナルで次のコマンドを実行します。

```bash
cd clean_architecture_todo
pytest -v
```

`-v` は「verbose」モードで、テスト名をすべて表示します。

結果例：

```
=================== test session starts ===================
collected 5 items

tests/unit/test_todo_usecase.py ...........         PASSED
tests/unit/test_presenter.py ..............         PASSED
tests/unit/test_controller.py .............         PASSED
tests/unit/test_view_console.py ...........         PASSED
tests/unit/test_in_memory_todo_repository.py ....    PASSED
==================== 5 passed in 0.20s =====================
```

---

## 🧠 まとめ：テストで見える「クリーンアーキテクチャの本質」

* **各層が完全に独立してテストできる**
* **UIやDBを使わずにロジックを検証できる**
* **テストが速く、原因特定も容易**
* **PresenterやRepositoryを差し替えてもテストは壊れない**

> テスト容易性は、「依存方向を内向きに限定した設計」から自然に生まれる副産物です。
> つまり、**良い設計は良いテストをもたらす**ということです。

---

## 🚀 次のステップ

次章では、ユースケースの追加（削除・更新）や、Web / GUI などの別Viewへの拡張に進みます。
テスト基盤はすでに完成しているため、新しい機能も同じように安全に検証できます。

