# 05 çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã®å¤‰æ›´ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ & ã‚µãƒ¼ãƒãƒ¼å´)

# ã‚¹ãƒ†ãƒƒãƒ—ï¼“ï¼šçµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã®å¤‰æ›´ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ & ã‚µãƒ¼ãƒãƒ¼å´)

ã‚¹ãƒ†ãƒƒãƒ—2ã§èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã‚’APIã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦æ”¹ä¿®ã—ã¾ã—ãŸã€‚
æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ä¸­é–“ã«ä½ç½®ã™ã‚‹ã€ŒçµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã€ã®æ”¹ä¿®ã§ã™ã€‚ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ä»Šå›ã®æ”¹ä¿®ã§æœ€ã‚‚è¤‡é›‘ãªå½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚

## ğŸ¯ èª²é¡Œ

çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ç¬¬5å·¡ï¼ˆMQTTï¼‰ã§ã¯WorldModelã‚’Subscribeï¼ˆå—ä¿¡ï¼‰ã—ã€ParkingPlanã‚’Publishï¼ˆé€ä¿¡ï¼‰ã—ã¦ã„ã¾ã—ãŸã€‚
ä»Šå›ã®èª²é¡Œã¯ã€ã“ã®MQTTã®å½¹å‰²ã‚’å‰Šé™¤ã—ã€ä»¥ä¸‹ã®2ã¤ã®æ©Ÿèƒ½ã‚’åŒæ™‚ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã™ã€‚

1. **REST ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ©Ÿèƒ½:** èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ ( `http://localhost:8001` ) ã« `GET /world_model` ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã€WorldModelã‚’åŒæœŸçš„ã«å–å¾—ã™ã‚‹ã€‚
2. **REST ã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½:** è»Šä¸¡åˆ¶å¾¡ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã® `GET /parking_plan` ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã€è¨ˆç®—ã—ãŸParkingPlanã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦æä¾›ã™ã‚‹ã€‚

## ğŸ”§ å®Ÿè£…æ–¹é‡

ã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½ã®å®Ÿç¾ã«ã¯ã€èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã¨åŒæ§˜ã« **FastAPI** ã‚’å°å…¥ã—ã¾ã™ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ©Ÿèƒ½ã®å®Ÿç¾ã«ã¯ã€Pythonã§æ¨™æº–çš„ã«ä½¿ã‚ã‚Œã‚‹HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ **requests** ã‚’å°å…¥ã—ã¾ã™ã€‚

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¦³ç‚¹ã§ã¯ã€ä»¥ä¸‹ã®å¤‰æ›´ã‚’è¡Œã„ã¾ã™ã€‚

1. MQTTã®Subscriber/Publisher Adapterã‚’å‰Šé™¤ã—ã¾ã™ã€‚
2. èªè­˜ã‚µãƒ¼ãƒ“ã‚¹APIã‚’å‘¼ã³å‡ºã™ãŸã‚ã®æ–°ã—ã„ **Infrastructure (Adapter)** ã¨ã—ã¦ `RecognitionClient` ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
3. `/parking_plan` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æä¾›ã™ã‚‹ **Interface (Adapter)** ã¨ã—ã¦ `FastAPI Controller` ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
4. UseCase (`CalculateParkingPlanUseCase`) ã‚’ä¿®æ­£ã—ã¾ã™ã€‚MQTTã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ã®ã§ã¯ãªãã€`RecognitionClient` ã‚’ä½¿ã£ã¦è‡ªã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸçš„ã«å–å¾—ï¼ˆãƒ—ãƒ«å‹ï¼‰ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
5. `main.py` ã§FastAPIã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆå¤‰æ›´ç‚¹ï¼‰

`planning_service/` é…ä¸‹ã®æ§‹æˆãŒä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã•ã‚Œã¾ã™ã€‚

```
planning_service/
â”œâ”€â”€ adapter/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ dto.py                 # (æ–°è¦) Pydanticãƒ¢ãƒ‡ãƒ« (DTO) ã‚’å®šç¾©
â”‚   â”œâ”€â”€ recognition_client.py  # (æ–°è¦) èªè­˜ã‚µãƒ¼ãƒ“ã‚¹APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â””â”€â”€ rest_api.py            # (æ–°è¦) FastAPIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ ... (å¤‰æ›´ãªã—)
â”œâ”€â”€ usecase/
â”‚   â””â”€â”€ calculate_parking_plan.py # (ä¿®æ­£) ãƒ‡ãƒ¼ã‚¿å–å¾—æ–¹æ³•ã‚’å¤‰æ›´
â””â”€â”€ main.py                    # (ä¿®æ­£) FastAPIã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•

```

## ğŸ“œ ã‚³ãƒ¼ãƒ‰å®Ÿè£… (Pydanticãƒ¢ãƒ‡ãƒ«)

ã¾ãšã€OpenAPIã® `schemas` ã«å¯¾å¿œã™ã‚‹Pydanticãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚WorldModel (å…¥åŠ›) ã¨ ParkingPlan (å‡ºåŠ›) ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚

`planning_service/adapter/dto.py`

```python
# CA: Infrastructure (Adapter)
# å‡¦ç†å†…å®¹: OpenAPIã® 'schemas' ã«åŸºã¥ãã€Pydanticãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã™ã‚‹ã€‚
# WorldModelã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦å—ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ç”¨ã€
# ParkingPlanã¯ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦å¿œç­”ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ç”¨ã€‚
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime
from uuid import UUID

# --- WorldModel (èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰å—ä¿¡) ---
# â€»èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®dto.pyã¨é‡è¤‡ã™ã‚‹ãŒã€
# ã‚µãƒ¼ãƒ“ã‚¹å¢ƒç•Œã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯æ•¢ãˆã¦å†å®šç¾©ã™ã‚‹ã€‚
class Point(BaseModel):
    x: float
    y: float

class Pose(BaseModel):
    x: float
    y: float
    theta: float

class Obstacle(BaseModel):
    id: int
    polygon: List[Point]

class ParkingSpot(BaseModel):
    id: int
    is_occupied: bool
    polygon: List[Point]

class WorldModel(BaseModel):
    timestamp: datetime
    obstacles: List[Obstacle]
    parking_spots: List[ParkingSpot]
    vehicle_pose: Pose

    class Config:
        from_attributes = True

# --- ParkingPlan (åˆ¶å¾¡ã‚µãƒ¼ãƒ“ã‚¹ã¸å¿œç­”) ---
class ParkingPlan(BaseModel):
    plan_id: UUID
    status: str # "success", "failure", "pending"
    path: List[Pose]

    class Config:
        from_attributes = True

```

## ğŸ“œ ã‚³ãƒ¼ãƒ‰å®Ÿè£… (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ - Recognition Client Adapter)

æ¬¡ã«ã€èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ ( `port:8001` ) ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®Adapterã‚’å®Ÿè£…ã—ã¾ã™ã€‚

`planning_service/adapter/recognition_client.py`

```python
# CA: Infrastructure (Adapter)
# å‡¦ç†å†…å®¹: èªè­˜ã‚µãƒ¼ãƒ“ã‚¹APIã¸ã®HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€‚
# requestsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã„ã€åŒæœŸçš„ã«WorldModelã‚’å–å¾—ã™ã‚‹ã€‚

import requests
from requests.exceptions import RequestException
from adapter.dto import WorldModel # DTOã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from typing import Optional

# èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ™ãƒ¼ã‚¹URL
RECOGNITION_SERVICE_URL = "<http://localhost:8001>"

class RecognitionClient:
    """
    èªè­˜ã‚µãƒ¼ãƒ“ã‚¹(Recognition Service)ã®REST APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    """
    def fetch_world_model(self) -> Optional[WorldModel]:
        """
        èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰GET /world_modelã‚’å‘¼ã³å‡ºã—ã€
        ç¾åœ¨ã®WorldModelã‚’å–å¾—ã™ã‚‹ã€‚
        """
        try:
            # CA: Infrastructure
            # å‡¦ç†å†…å®¹: åŒæœŸHTTP GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã€‚
            # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’5ç§’ã«è¨­å®šã€‚
            response = requests.get(
                f"{RECOGNITION_SERVICE_URL}/world_model",
                timeout=5.0
            )

            # CA: Infrastructure
            # å‡¦ç†å†…å®¹: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ200ç•ªå°ä»¥å¤–ãªã‚‰ä¾‹å¤–ã‚’ç™ºç”Ÿ
            response.raise_for_status()

            # CA: Infrastructure (Adapter) - Data Mapper
            # å‡¦ç†å†…å®¹: æˆåŠŸã—ãŸå ´åˆã€JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’WorldModel DTOã«ãƒ‘ãƒ¼ã‚¹ã—ã¦è¿”ã™
            # PydanticãŒè‡ªå‹•ã§ãƒ‡ãƒ¼ã‚¿å‹æ¤œè¨¼ã¨å¤‰æ›ã‚’è¡Œã†
            return WorldModel.model_validate(response.json())

        except RequestException as e:
            # CA: Infrastructure
            # å‡¦ç†å†…å®¹: æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€HTTPã‚¨ãƒ©ãƒ¼ãªã©
            print(f"Error fetching WorldModel: {e}")
            return None

```

## ğŸ“œ ã‚³ãƒ¼ãƒ‰å®Ÿè£… (UseCaseã®ä¿®æ­£)

UseCaseã¯ã€MQTTãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…ã¤ã®ã§ã¯ãªãã€è‡ªã‚‰ `RecognitionClient` ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

`planning_service/usecase/calculate_parking_plan.py`

```python
# CA: Application (UseCase)
# å‡¦ç†å†…å®¹: é§è»Šè¨ˆç”»ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã€‚
# MQTTã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿(push)ã§ã¯ãªãã€
# Client Adapter(pull)ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚ˆã†å¤‰æ›´ã€‚

# CA: Infrastructure (Adapter)
# å‡¦ç†å†…å®¹: ã‚¤ãƒ³ãƒ•ãƒ©å±¤ã®ã‚¢ãƒ€ãƒ—ã‚¿(ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from adapter.recognition_client import RecognitionClient
# (ä»®) Domainãƒ¢ãƒ‡ãƒ«ã¨DTOãŒåŒä¸€ã¨ä»®å®šã€‚
# æœ¬æ¥ã¯Domainãƒ¢ãƒ‡ãƒ«ã‚’è¿”ã™ã¹ãã€‚
from adapter.dto import ParkingPlan, WorldModel
from uuid import uuid4
from typing import List
from adapter.dto import Pose # (ä»®)

# (ä»®) æœ¬æ¥ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
class ParkingPlanResult(ParkingPlan):
    pass

class CalculateParkingPlanUseCase:
    """
    WorldModelã‚’å–å¾—ã—ã€é§è»Šè¨ˆç”»ã‚’è¨ˆç®—ã™ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
    """

    # CA: Application (UseCase)
    # å‡¦ç†å†…å®¹: UseCaseãŒã‚¤ãƒ³ãƒ•ãƒ©å±¤ã®ã‚¢ãƒ€ãƒ—ã‚¿ã«ä¾å­˜ã™ã‚‹
    # DI(ä¾å­˜æ€§æ³¨å…¥)ã«ã‚ˆã‚Šã€å‘¼ã³å‡ºã—å…ƒ(rest_api)ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹
    def __init__(self, recognition_client: RecognitionClient):
        self.recognition_client = recognition_client

    def handle(self) -> Optional[ParkingPlanResult]:
        """
        ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿè¡Œ
        """
        # 1. CA: Infrastructure (Adapter)
        # å‡¦ç†å†…å®¹: ã‚¢ãƒ€ãƒ—ã‚¿çµŒç”±ã§èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€ŒåŒæœŸçš„ã«ã€å‘¼ã³å‡ºã™ã€‚
        # ã“ã®å‘¼ã³å‡ºã—ãŒå®Œäº†ã™ã‚‹ã¾ã§ã€ä»¥é™ã®å‡¦ç†ã¯å¾…æ©Ÿ(ãƒ–ãƒ­ãƒƒã‚¯)ã•ã‚Œã‚‹ã€‚
        print("Fetching WorldModel from Recognition Service...")
        world_model: Optional[WorldModel] = self.recognition_client.fetch_world_model()

        if world_model is None:
            print("Failed to get WorldModel. Aborting planning.")
            return None

        # 2. CA: Application (UseCase) / Domain
        # å‡¦ç†å†…å®¹: WorldModelã‚’ä½¿ã£ãŸé§è»Šè¨ˆç”»ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯(ãƒ€ãƒŸãƒ¼)
        print(f"Calculating plan based on WorldModel (timestamp: {world_model.timestamp})")

        # (ãƒ€ãƒŸãƒ¼ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯)
        dummy_path: List[Pose] = [
            world_model.vehicle_pose,
            Pose(x=1.0, y=1.0, theta=0.5),
            Pose(x=2.0, y=2.0, theta=0.0)
        ]

        # 3. CA: Application (UseCase)
        # å‡¦ç†å†…å®¹: è¨ˆç®—çµæœ(ParkingPlan)ã‚’è¿”ã™
        result = ParkingPlanResult(
            plan_id=uuid4(),
            status="success",
            path=dummy_path
        )
        print(f"Parking plan calculated: {result.plan_id}")
        return result

```

## ğŸ“œ ã‚³ãƒ¼ãƒ‰å®Ÿè£… (ã‚µãƒ¼ãƒãƒ¼å´ - FastAPIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼)

UseCaseãŒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ãã®UseCaseã‚’å‘¼ã³å‡ºã™APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ `/parking_plan` ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

`planning_service/adapter/rest_api.py`

```python
# CA: Interface (Adapter)
# å‡¦ç†å†…å®¹: FastAPIã‚’ä½¿ç”¨ã—ã¦ '/parking_plan' ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã€‚

from fastapi import FastAPI, HTTPException
from adapter.dto import ParkingPlan # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®DTO
from usecase.calculate_parking_plan import CalculateParkingPlanUseCase
from adapter.recognition_client import RecognitionClient # ã‚¤ãƒ³ãƒ•ãƒ©å±¤ã®ã‚¢ãƒ€ãƒ—ã‚¿

# CA: Infrastructure (Adapter)
# å‡¦ç†å†…å®¹: FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
app = FastAPI(
    title="Planning Service API",
    description="Calculates and provides parking plans.",
    version="1.0.0"
)

# CA: Interface (Adapter) - Controller
# å‡¦ç†å†…å®¹: HTTP GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ '/parking_plan' ã«å¯¾å¿œã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
@app.get("/parking_plan", response_model=ParkingPlan)
def get_parking_plan_endpoint():
    """
    é§è»Šè¨ˆç”»ã‚’è¨ˆç®—ã—ã¦å–å¾—ã—ã¾ã™ã€‚
    ã“ã®APIã¯å†…éƒ¨ã§èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
    """
    # --- ä¾å­˜æ€§ã®æ³¨å…¥ (DI) ---
    # 1. CA: Infrastructure (Adapter)
    # å‡¦ç†å†…å®¹: èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    client = RecognitionClient()

    # 2. CA: Application (UseCase)
    # å‡¦ç†å†…å®¹: UseCaseã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ³¨å…¥ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    use_case = CalculateParkingPlanUseCase(recognition_client=client)
    # ---------------------------

    # 3. CA: Application (UseCase)
    # å‡¦ç†å†…å®¹: ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å®Ÿè¡Œ
    plan = use_case.handle()

    # 4. CA: Interface (Adapter) - Presenter
    # å‡¦ç†å†…å®¹: UseCaseã®å®Ÿè¡Œçµæœã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    if plan is None:
        # å‡¦ç†ãŒå¤±æ•—ã—ãŸå ´åˆ (WorldModelå–å¾—å¤±æ•—ãªã©)
        # HTTP 503 (Service Unavailable) ã‚’è¿”ã™
        raise HTTPException(
            status_code=503,
            detail="Failed to calculate plan (maybe recognition service is down?)"
        )

    # æˆåŠŸã—ãŸå ´åˆã€FastAPIãŒ 'plan' ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’JSONã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦è¿”ã™
    return plan

```

## ğŸ“œ ã‚³ãƒ¼ãƒ‰å®Ÿè£… ([main.py](http://main.py/))

æœ€å¾Œã«ã€MQTTã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã€FastAPIã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ (8001) ã¨é‡è¤‡ã—ãªã„ã‚ˆã†ã€ãƒãƒ¼ãƒˆ `8002` ã§å®Ÿè¡Œã—ã¾ã™ã€‚

`planning_service/main.py`

```python
# CA: Main / Infrastructure
# å‡¦ç†å†…å®¹: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€‚
# FastAPIã‚¢ãƒ—ãƒªã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹Uvicornã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã€‚

import uvicorn
# CA: Infrastructure (Adapter)
# å‡¦ç†å†…å®¹: adapter/rest_api.py ã§å®šç¾©ã—ãŸFastAPIã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from adapter.rest_api import app

if __name__ == "__main__":
    print("Starting Planning Service (REST API Server & Client)...")

    # CA: Infrastructure
    # å‡¦ç†å†…å®¹: Uvicornã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã€‚
    # port=8002      : çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒãƒ¼ãƒˆ8002ç•ªã§å®Ÿè¡Œã™ã‚‹
    uvicorn.run("adapter.rest_api:app", host="0.0.0.0", port=8002, reload=True)

    # --- ç¬¬5å·¡ã®MQTTé–¢é€£ã‚³ãƒ¼ãƒ‰ã¯å…¨ã¦å‰Šé™¤ ---

```

## ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ

çµŒè·¯è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã®UseCaseã¯ã€**ãƒ‡ãƒ¼ã‚¿ã‚’å¾…ã¤ï¼ˆå—å‹•çš„ï¼‰ç«‹å ´ã‹ã‚‰ã€è‡ªã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šã«è¡Œãï¼ˆèƒ½å‹•çš„ï¼‰ç«‹å ´ã«å¤‰ã‚ã‚Šã¾ã—ãŸã€‚**`use_case.handle()` ãŒå‘¼ã°ã‚Œã‚‹ã¨ã€ãã®å†…éƒ¨ã§ `recognition_client.fetch_world_model()` ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯åŒæœŸå‘¼ã³å‡ºã—ã§ã‚ã‚‹ãŸã‚ã€èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã¾ã§ã€`handle()` ãƒ¡ã‚½ãƒƒãƒ‰ã®å‡¦ç†ã¯ä¸€æ™‚åœæ­¢ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã—ã¾ã™ã€‚

ã“ã‚ŒãŒã€ç¬¬5å·¡ï¼ˆéåŒæœŸï¼‰ã¨ç¬¬6å·¡ï¼ˆåŒæœŸï¼‰ã®æ±ºå®šçš„ãªé•ã„ã§ã™ã€‚