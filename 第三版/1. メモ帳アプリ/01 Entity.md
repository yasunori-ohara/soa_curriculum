# 第1章：Entity（エンティティ）


## 🎯 この章の目的

この章では、クリーンアーキテクチャの最も内側に位置する「**Entity（エンティティ）**」を実装します。

Entityはアプリケーションの**ビジネスルールそのもの**を表す層です。  
外部の技術（データベース・UI・フレームワーク）に一切依存せず、  
アプリケーションの「核となる意味とルール」を定義します。

---

## 🧩 Entityとは

クリーンアーキテクチャの同心円で言うと、最も中心の円に位置します。

![クリーンアーキテクチャ](../クリーンアーキテクチャ.png)

この層は「ビジネスルール（Business Rules）」と呼ばれ、  
**技術的な詳細をすべて排除した純粋なロジック**だけを持ちます。

たとえば「メモ帳アプリ」を題材にする場合、  
Entityは「メモとは何か？」を定義する場所です。

- メモはタイトルと本文を持つ  
- メモは更新できる  
- メモは削除できる  
- メモはアプリやデータベースを知らない  

この層には「保存」や「表示」のような技術的要素は登場しません。


## 🧱 Entity層のファイル構成

```
project_root/
    └── domain/
        └── note.py ← Entity層の実装
```


## 🧭 クラスの設計方針

- Entityは**何物にも依存しない（Depend on Nothing）**
- 外部から使われるだけで、自分から他層を呼び出すことはない
- システムの「本質的なルール」を表現する
- 外部の技術が変わっても、この層のコードは変わらない

---

## 🧠 例題：メモアプリの Entity

このアプリケーションでは「メモ（Note）」というビジネス上の概念を表す Entity を作ります。

### ✳️ `domain/note.py`

```python
# --------------------------------------------------------------------
# [同心円図] Entities（最も内側の円） ← 外部技術を一切知らない
# [クラス図] 右上の「Entities」ボックス
# 役割：ビジネスルールの核（不変条件・操作）
# ポイント：
#   - import は Python標準のみ（他層への依存なし）
#   - IDの採番や保存の仕方は知らない（UseCase/Repositoryの責務）
# --------------------------------------------------------------------

class Note:
    """Noteエンティティ（ビジネス上の“メモ”の本質を表す）"""

    def __init__(self, id: int, title: str, content: str):
        """
        [ビジネス不変条件（Invariant）]
        - タイトルは空文字を許さない
        - ここでは保存先（DB/ファイル）や表示形式（HTML/JSON）を一切知らない
        """
        if not title:
            raise ValueError("タイトルは空にできません")
        self.id = id
        self.title = title
        self.content = content

    def update(self, new_title: str, new_content: str):
        """
        [ビジネス操作（Operation）]
        - “メモを編集できる”という行為を表す
        - 不変条件は常に満たす（タイトル空は禁止）
        """
        if not new_title:
            raise ValueError("タイトルは空にできません")
        self.title = new_title
        self.content = new_content

    def __repr__(self):
        # デバッグ・ログ向け（外部表示都合は扱わない）
        return f"Note(id={self.id}, title='{self.title}', content='{self.content[:10]}...')"

```
## ✅ 解説

このクラスには、以下の3つの特徴があります。

| 観点        | 内容                                 |
| --------- | ---------------------------------- |
| **依存の方向** | 他の層を import していない。Python標準機能だけで完結。 |
| **安定性**   | 最も安定しており、外側の変更に影響されない。             |
| **責務**    | 「メモという概念が持つ普遍的なルール」を表現する。          |


## 📎 用語ミニ解説（この章で出てくる概念だけ）

* **エンティティ（Entity）**：
  ビジネスの**意味とルールの中心**。DBやUIを知らない“純粋なオブジェクト”。
* **不変条件（Invariant）**：
  常に守られるべきルール（例：タイトルは空にできない）。
* **操作（Operation）**：
  ビジネス的に意味のある振る舞い（例：メモを編集する）。
* **（参考）値オブジェクト（Value Object）**：
  “タイトル”のように**意味がある値**に**妥当性**を閉じ込めた小さな型。
  *今回はシンプルさ優先で文字列のままにし、ルールをメソッド内で担保。*

## 🧪 テストのヒント（この章の範囲だけ）

> ここでは**Entity単体**を確認します（外部なし）。

```python
def test_note_update_ok():
    n = Note(id=1, title="初期", content="本文")
    n.update("変更後", "新しい本文")
    assert n.title == "変更後"
    assert n.content == "新しい本文"

def test_note_title_cannot_be_empty():
    try:
        Note(id=1, title="", content="本文")
        assert False, "例外が期待される"
    except ValueError as e:
        assert "タイトル" in str(e)
```

## ⚠️ よくあるNG（再掲＋1行補足）

| NG例                              | なぜNGか                                    |
| -------------------------------- | ---------------------------------------- |
| `save_to_database()` をEntityに書く  | **保存先を知らない**。DBは外側の責務                    |
| `display_on_screen()` をEntityに書く | **表示都合を知らない**。UIは外側の責務                   |
| ID採番の内部実装                        | **IDの割当は外側（UseCase/Repository）で決める**のが原則 |


## 📘 Entity層の理解ポイント

* **Entityは最も内側にある「ルールの心臓」**
* **外側のすべての層はこのルールを“利用する”だけ**
* **Entity自身は誰も知らない**（独立している）

---

## 🔄 次のステップ：UseCase層へ

Entityを作成したら、次はそのルールを使ってアプリケーションの動作を定義する層、
**UseCase（ユースケース）層** を実装します。

UseCase層では、Entityを組み合わせて「メモを追加する」「編集する」「削除する」といった操作を定義します。

ここで、**依存の方向と制御の流れ**を確認しておきましょう。

![クリーンアーキテクチャ・依存と制御](../クリーンアーキテクチャ・依存と制御.png)

