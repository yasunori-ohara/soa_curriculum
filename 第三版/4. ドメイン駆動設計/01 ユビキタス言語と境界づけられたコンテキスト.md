## 第1章：ユビキタス言語と境界づけられたコンテキスト（解説＋演習統合版）


## 🎯 この章の目的

1. **業務の言葉（ユビキタス言語）**を整理して、意味を統一する。
2. **言葉の区切り＝システムの区切り**という考え方を体験する。
3. **Bounded Context（境界づけられたコンテキスト）**を、自分で定義して図に描けるようになる。

---

## 🧭 1. なぜ“言葉”から始めるのか？

クリーンアーキテクチャでは「構造」を整えましたが、
DDDではまず「**意味**」を整えます。

ソフトウェア開発で起こる混乱の多くは、
コードではなく **言葉の誤解** から生まれます。

> 💬「予約を確定して」「削除しておきます」
> →「削除」と「キャンセル」の意味が違っていた！

このように、**同じ単語でも人によって違う意味**を持つことがあります。
DDDはこの問題を解決するために、「**言葉の整理と区切り**」を設計の中心に置きます。

---

## 🧩 2. ユビキタス言語（Ubiquitous Language）

### 🔍 定義

> プロジェクトのすべての人が、あらゆる場面（会話・設計・コード）で共有して使う言葉のこと。

「ユビキタス（Ubiquitous）」は“どこにでも通じる”という意味。
この言葉が**ソフトウェア設計の共通辞書**になります。

---

### 📘 例：会議室予約アプリの用語集（初期ドラフト）

| 用語                         | 意味             | 注意点・補足                   |
| -------------------------- | -------------- | ------------------------ |
| 予約（Reservation）            | 会議室と時間帯を確保した状態 | 仮予約や確定など状態を持つ            |
| 仮予約（Tentative Reservation） | 承認待ちの一時的な予約    | 状態遷移の1つ                  |
| 空き（Availability）           | 指定時間に他の予約がない状態 | 「空室」と混同注意                |
| 会議室（Room）                  | 利用可能な物理的な部屋    | 設備や定員を持つ                 |
| 会員（Member）                 | 登録済みの利用者       | 認証済みかどうかで状態が変わる          |
| 設備（Equipment）              | プロジェクターなど部屋の属性 | 予約対象ではない                 |
| 参加者数（Attendees）            | 予約に含まれる人数      | 定員との比較が必要                |
| 予約時間（TimeRange）            | 開始と終了のペア       | 終了時刻は含まない `[start, end)` |
| キャンセル（Cancel）              | 予約を無効化する行為     | 削除とは異なる（履歴は残す）           |
| 冪等性キー（Idempotency Key）     | 同一操作の再送防止      | API通信で使用                 |

> 📖 **ポイント**：
>
> * 意味を1行で言えること。
> * 他の言葉と混ざらないこと。
> * 会話・コード・テストのすべてで同じ語を使うこと。

---

### 🎓 演習①：自分の現場で言葉を拾う

| 言葉       | 出どころ（会話・資料など） | 簡単な意味         |
| -------- | ------------- | ------------- |
| （例）承認    | 会議予約フロー図      | 上長が確認して確定する行為 |
| （例）削除    | 管理画面ボタン       | DB上から物理削除する操作 |
| （例）キャンセル | お客様対応マニュアル    | 無効化して履歴を残す操作  |

> 💬 書き出すだけでOK。
> あとで意味の違いに気づくことが重要です。

---

## 🧱 3. 境界づけられたコンテキスト（Bounded Context）

### 🧠 定義

> 言葉の意味が統一される範囲。
> この範囲内では「予約」や「キャンセル」の意味が一意である。

つまり、**Bounded Context = 言葉の壁を立てること**です。

---

### 📊 コンテキスト分け（初期案）

| コンテキスト名                | 主な言葉               | 説明              |
| ---------------------- | ------------------ | --------------- |
| **Scheduling（予約管理）**   | 予約、仮予約、キャンセル、冪等性キー | 時間の整合性と重複禁止を扱う。 |
| **RoomCatalog（会議室台帳）** | 会議室、設備、定員、空き       | 部屋の属性や可用性を管理。   |
| **Identity（会員管理）**     | 会員、メール、認証          | 会員登録・本人確認。      |
| **Billing（請求管理）**      | 料金、キャンセル料、返金       | 金銭取引のルールを管理。    |

---

### 🎓 演習②：言葉をグルーピングしてみよう

| グループ名 | 言葉           | 何を扱う？      |
| ----- | ------------ | ---------- |
| 予約    | 予約、仮予約、キャンセル | 利用時間と部屋の関係 |
| 会議室   | 会議室、設備、定員    | 利用可能な空間情報  |
| 会員    | 会員、メール、承認    | 人と認証の情報    |
| 請求    | 料金、キャンセル料    | お金のやり取り    |

> 💡 グループの名前＝コンテキスト名になります。

---

## ⚖ 4. 言葉の衝突を見つける（境界の検出）

同じ単語が異なる意味を持つときは「**別のコンテキストに分ける**」合図です。

| 言葉     | コンテキストAの意味           | コンテキストBの意味          | 対応                |
| ------ | -------------------- | ------------------- | ----------------- |
| 「削除」   | DBから物理削除（Identity）   | 論理無効化（Scheduling）   | 名前を変える（例：「キャンセル」） |
| 「空き」   | 部屋の空き状態（RoomCatalog） | 時間の空き状態（Scheduling） | 境界を分けて明示する        |
| 「ユーザー」 | システムの利用者（Identity）   | 請求先（Billing）        | 別クラス・別命名にする       |

> ⚙ **結論：言葉が変われば、システムを分ける。**

---

## 📐 5. コンテキストマップを描く（関係性を明確化）

### 📊 図：会議室予約アプリのコンテキストマップ

```
+---------------------------+
  Scheduling Context          ←予約・キャンセルを扱う中核
  予約, 仮予約, キャンセル    
+------------+--------------+
             |
             | room_id
             ↓
+------------+--------------+
  RoomCatalog Context         ←会議室・設備管理
  会議室, 定員, 空き          
+------------+--------------+
             |
             | member_id
             ↓
+------------+--------------+
  Identity Context            ←会員情報管理
  会員, メール, 承認          
+---------------------------+
```

---

### 📦 関係性の種類（コンテキスト間のつながり方）

| 関係タイプ                          | 内容                  | 会議室予約例                             |
| ------------------------------ | ------------------- | ---------------------------------- |
| **依存（Uses）**                   | AがBを参照して使う          | Scheduling → RoomCatalog           |
| **公開API（Open Host Service）**   | 他コンテキストが呼び出せるAPIを提供 | RoomCatalog が「空き照会API」を持つ          |
| **翻訳層（Anti-Corruption Layer）** | 外部コンテキストとの変換を行う     | Scheduling が RoomCatalog の出力をDTO変換 |
| **共有カーネル（Shared Kernel）**      | 共通概念を共有             | TimeRange, Date などの共通型             |

> 🔍 依存はできるだけ一方向。
> 循環依存を避けると、SOAやマイクロサービスへ発展しやすくなります。

---

## 🧱 6. 言葉の境界とシステムの境界を一致させる

| 観点   | 技術的分割                         | DDD的分割                         |
| ---- | ----------------------------- | ------------------------------ |
| 分割基準 | 技術（UI・DB）                     | 意味（予約・会員・会議室）                  |
| 層構造  | Controller / UseCase / Entity | Context / Domain / Application |
| 再利用性 | 低い（密結合）                       | 高い（疎結合）                        |

> ⚙ DDDの考え方：
> **「構造でなく、言葉でシステムを分ける」**

---

## 🧩 7. 実際のフォルダ構成への反映（CAとの接続）

```
src/
├── scheduling/        ← Schedulingコンテキスト
│   ├── domain/        ← DDDのEntity・Value Object・Aggregate
│   ├── usecase/       ← アプリケーションサービス
│   ├── interface/     ← Controller, Presenter, Gateway
│   └── infrastructure/← DBやAPIの実装
├── room_catalog/
│   ├── domain/
│   └── ...
└── identity/
    ├── domain/
    └── ...
```

> 💡 DDDでは、このように「言葉単位のディレクトリ」で設計を分けます。
> つまり、**クリーンアーキを“コンテキストごと”に繰り返す構造**になります。

---

## 🎯 8. まとめ

| 要点                  | 内容                       |
| ------------------- | ------------------------ |
| **ユビキタス言語**         | チーム全員が共通して使う業務用語。        |
| **Bounded Context** | 言葉の意味が統一される範囲。システム分割の基準。 |
| **Context Map**     | 境界間の依存関係を可視化した図。         |
| **分割基準**            | 技術ではなく「意味」で分ける。          |
| **クリーンアーキとの接続**     | 各コンテキスト内でCAを実装する。        |
| **SOAとの接続**         | 各コンテキストが後に「1つのサービス」になる。  |

---

## 🧠 補足：小さく始めるコツ

* ExcelやMiroで「言葉ノート」を作る。
* 会議のたびに用語を見直し・更新する。
* 新機能追加時に「新しい言葉」が出てきたら要注意（＝新しい境界のサイン）。

---

## 🔜 次章予告：第2章「値オブジェクトとエンティティ」

次章では、この章で整理した「言葉の意味」をコードで守ります。

扱う内容：

* **TimeRange**（`start < end`を保証する不変条件）
* **Email**（形式検証を内蔵する型）
* **Capacity**（0以上を保証）
* それらを使った **Reservation, Room, Member** のエンティティ構築

また、実際に**テストを書いて意味を壊せないことを確認する演習**も行います。

