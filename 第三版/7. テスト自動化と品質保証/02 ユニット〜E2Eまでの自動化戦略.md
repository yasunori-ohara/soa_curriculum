## 第2章：ユニット〜E2Eまでの自動化戦略


## 🎯 この章の目的

1. 各レイヤ（Unit / Integration / Contract / E2E）の**役割と境界**を理解する
2. 効率的に自動テストを構築する「テストピラミッド」を学ぶ
3. Python／Web／APIなど、現場での自動テスト配置を具体的に設計できるようにする

---

## 🧩 1. テストピラミッドの考え方

📘 「テストピラミッド」とは、自動テストの理想的な構成バランスを図で表したものです。

```
   ▲
   │   E2Eテスト（全体動作）
   │   ───────────────────
   │   契約テスト（サービス間）
   │   ───────────────────
   │   統合テスト（モジュール間）
   │   ───────────────────
   │   ユニットテスト（個々の関数・クラス）
   ▼
```

💡 特徴：

* 下層ほど **数が多く・実行が速い**
* 上層ほど **数が少なく・実行が重い**

📘 原則：「**下層を厚く、上層を薄く**」
→ これにより、テスト全体の速度と信頼性を両立します。

---

## 🧩 2. ユニットテスト（Unit Test）

📘 **最小単位の検証**。
関数やクラス単位で、外部依存を持たないロジックをテストします。

💻 例（pytest）：

```python
# tests/test_price_calculator.py
from app.price import calculate_total

def test_calculate_total_with_discount():
    assert calculate_total(100, discount=0.2) == 80
```

💡 ポイント：

* テスト対象以外の要素（DB・API）は**モック化**する
* pytest・unittest・doctestなどが利用可能
* 実行時間が短く、CIの最初のラインで走らせる

---

## 🧩 3. 統合テスト（Integration Test）

📘 **複数モジュールの組み合わせ**をテストします。
主に「DB接続」「外部API呼び出し」「リポジトリとのやり取り」などを検証。

💻 例（pytest + sqlite + tmpdir）：

```python
# tests/integration/test_booking_repository.py
from app.repository import BookingRepository
from app.model import Booking

def test_save_and_load_booking(tmp_path):
    repo = BookingRepository(db_path=tmp_path / "test.db")
    b1 = Booking(id=1, user_id=10, room_id=3)
    repo.save(b1)
    loaded = repo.find(1)
    assert loaded.user_id == 10
```

💡 ポイント：

* 実際のI/O（ファイル・DB）を伴う
* スタブ／モックを部分的に使って依存関係を制御
* Docker Composeで「テストDB」を立てるケースも多い

---

## 🧩 4. 契約テスト（Contract Test）

📘 契約テストは、**マイクロサービス間のAPIの整合性を保証する**テストです。

💡 概念：

> Provider（提供側）と Consumer（利用側）が
> 事前に決めた「API契約（OpenAPIなど）」を満たしているかを自動検証する。

💻 例（pact-python）：

```python
# consumer側
from pact import Consumer, Provider

pact = Consumer('reservation_service').has_pact_with(Provider('member_service'))

@pact.given("member exists").upon_receiving("a get request").with_request(
    "GET", "/members/1"
).will_respond_with(200, body={"id": 1, "name": "Taro"})

def test_get_member_from_provider():
    with pact:
        result = requests.get("http://member-service/members/1")
        assert result.json()["name"] == "Taro"
```

💡 ポイント：

* OpenAPI契約を基準に**サービス間依存を検出**
* Provider（サーバー側）もConsumer（クライアント側）も独立検証可能
* GitHub Actionsなどで自動連携するとCI全体が安定する

---

## 🧩 5. E2Eテスト（End-to-End Test）

📘 システム全体を通したテスト。
UI操作・API連携・DB書き込みまでを含めて、**本番に近い流れ**を確認します。

💻 例（Playwright / Selenium）：

```python
# tests/e2e/test_reservation_flow.py
from playwright.sync_api import sync_playwright

def test_reservation_flow():
    with sync_playwright() as p:
        browser = p.chromium.launch()
        page = browser.new_page()
        page.goto("http://localhost:8080")
        page.fill("#title", "会議A")
        page.click("button#create")
        assert "会議A" in page.content()
        browser.close()
```

💡 ポイント：

* 実ブラウザやAPI経路を通すので、実行時間が長い
* **代表的なシナリオのみ**自動化対象にする
* デプロイ前後の「リグレッション確認」に最適

---

## 🧩 6. テスト間の依存をなくす

📘 悪い例：

> 「このテストは前のテストが成功してないと動かない」

💡 解決策：

* 各テストを**独立実行できる**ように設計する
* 依存データは **事前にモック／フィクスチャ**で準備する
* pytestの `fixture` や `tmp_path` を活用する

💻 例（pytest fixture）：

```python
import pytest
from app.user import User

@pytest.fixture
def user():
    return User(id=1, name="Taro")

def test_user_name(user):
    assert user.name == "Taro"
```

---

## 🧩 7. 自動化ピラミッドの比率目安

📘 実務では次のような比率がよく用いられます。

| テスト層 | 件数比率   | 実行速度 | 主な目的       |
| ---- | ------ | ---- | ---------- |
| ユニット | 約70%   | 高速   | 内部ロジック確認   |
| 統合   | 約20%   | 中速   | モジュール接続確認  |
| 契約   | 約5〜10% | 中速   | サービス間API整合 |
| E2E  | 数件〜数十件 | 低速   | シナリオ全体検証   |

💡 目標は「**テストが多いほど早くデプロイできる**」状態。
テストが遅いほど、開発スピードは確実に落ちます。

---

## 🧩 8. 自動テスト設計のベストプラクティス

| 観点   | ベストプラクティス                 |
| ---- | ------------------------- |
| 命名   | テストケースは仕様書のように読める名前にする    |
| 実行   | 並列化を前提に構成（pytest-xdistなど） |
| データ  | 固定ではなく、フィクスチャで動的生成        |
| ログ   | 成功も失敗も同じ形式で記録             |
| 再現性  | 同じ結果が何度でも得られることを確認        |
| CI連携 | 全テストを1クリックまたは1プッシュで自動実行   |

💡 自動テストは「技術」ではなく「設計思想」。
コードの品質管理を**チーム文化として定着させる**ことが最終ゴールです。

---

## ✅ まとめ

| 要点       | 内容             |
| -------- | -------------- |
| テストピラミッド | 下層を厚く、上層を薄く    |
| ユニットテスト  | 最速・最小の品質保証     |
| 統合テスト    | 現実接続を再現して確認    |
| 契約テスト    | サービス間のAPI保証    |
| E2Eテスト   | 実ユーザー目線で最終確認   |
| 成功の鍵     | 独立性・再現性・自動実行文化 |

---

## 🔜 次章予告：「第3章　契約テストとマイクロサービスCI統合」

次章では、マイクロサービス同士のAPI整合を保つ「契約テスト」を掘り下げ、
CIパイプライン（GitHub Actionsなど）に自動組み込みする方法を解説します。
「**コードを変えると自動で隣のサービスも検証される**」世界を実現します。


