## 第6章：AIによるテスト生成と自動修正


## 🎯 この章の目的

1. **AIを活用してテストコードを自動生成**する方法を理解する
2. **AIによるテスト修正・補完**の仕組みを学ぶ
3. **人とAIが協調する品質保証プロセス**を設計できるようにする

---

## 🧩 1. なぜAIによるテストが注目されているのか

📘 ソフトウェア開発では「コード変更量」に対して
「テスト更新」が追いつかないことが大きな課題です。

💡 現場で起きていること：

| 問題                   | 結果      |
| -------------------- | ------- |
| コードを修正してもテストを直す時間がない | テストが陳腐化 |
| 新機能追加時にテストケースを網羅できない | カバレッジ低下 |
| テストの書き方が人によってバラバラ    | 品質のばらつき |

AIによる自動テスト生成は、これを**継続的・自動的に補う**技術です。

---

## 🧩 2. AIテスト生成の3つの方式

| 方式         | 入力      | 出力           | 主な利用フェーズ  |
| ---------- | ------- | ------------ | --------- |
| **コード解析型** | ソースコード  | 関数・クラス単位のテスト | 単体テスト生成   |
| **差分解析型**  | Git変更履歴 | 差分部分の新規テスト   | 回帰テスト補完   |
| **自然言語型**  | 要件・仕様文  | 振る舞いテスト      | 受け入れテスト生成 |

💡 実際にはこれらを組み合わせて使うことで、
「テストを書くよりレビューする」スタイルに変わります。

---

## 🧩 3. コード解析型AIの例（pytest生成）

📘 関数やクラスの構造をAIが読み取り、
**pytest形式のテストスケルトン**を生成します。

💻 例：

```python
# 対象コード
def calculate_price(base, tax_rate):
    return base * (1 + tax_rate)
```

💡 AI生成例：

```python
# 自動生成されたpytest
import pytest
from app.price import calculate_price

def test_calculate_price_normal_case():
    assert calculate_price(100, 0.1) == 110

def test_calculate_price_zero_tax():
    assert calculate_price(100, 0) == 100

def test_calculate_price_negative_tax():
    assert calculate_price(100, -0.05) == 95
```

AIは型情報・戻り値・定数・条件分岐を解析して自動出力します。

---

## 🧩 4. 差分解析型AI ― 「変更された箇所だけテスト追加」

📘 コード変更時、AIがGit差分を解析して
**影響範囲に限定したテスト**を生成します。

💡 構成イメージ（テキスト図）：

```
Git Commit
  └─ 差分解析
       ├─ 変更ファイル特定
       ├─ 関数・クラス抽出
       └─ テスト補完生成（AI）
```

💡 生成されたテストは自動でPull Requestに提案され、
開発者は「採用 or 修正」するだけになります。

---

## 🧩 5. 自然言語型AI ― 要件からテストを作る

📘 要件仕様やユーザーストーリーを自然言語で入力し、
AIがテストケースを構造化して出力します。

💻 例：

**入力（要件文）**

> ユーザーがログインに成功したらダッシュボードに遷移する。

**出力（pytestスケルトン）**

```python
def test_login_redirect_to_dashboard(client):
    response = client.post("/login", data={"id": "user", "pw": "pass"})
    assert response.status_code == 302
    assert response.headers["Location"] == "/dashboard"
```

💡 この方式は、**BDD（振る舞い駆動開発）**と相性がよく、
Gherkin（Given-When-Then）形式にも展開できます。

---

## 🧩 6. AIによるテスト修正・自動更新

📘 コードが変更された際、AIが既存テストを比較・補正します。

💡 自動修正フロー：

```
1. Git差分を検出
2. 関連テストを抽出
3. テストコードと新コードを比較
4. 不整合箇所をAIが修正提案
```

💻 例：

```diff
- assert response.status_code == 200
+ assert response.status_code == 201  # 新仕様に合わせて修正
```

AIが「旧テストを自動パッチ化」する仕組みです。

---

## 🧩 7. 実践例：AIテスト生成をCIに組み込む

📘 生成を手動にせず、**CI/CDパイプラインに統合**します。

💻 例（GitHub Actions）：

```yaml
name: AI Test Generation
on:
  pull_request:
    types: [opened, synchronize]
jobs:
  generate-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run AI Test Generator
        run: python ai_test_generator.py --diff $(git diff HEAD~1)
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          title: "AI Generated Tests"
          commit-message: "auto: add missing tests"
```

💡 効果：

* コード変更時に自動で新テストを提案
* 人手レビューを中心にすることで、品質と速度を両立

---

## 🧩 8. AIテストの信頼性を高める方法

| 課題          | 対応策                             |
| ----------- | ------------------------------- |
| テスト精度が不安定   | AI提案を常に人がレビューする                 |
| 誤ったアサーション生成 | テスト実行結果をフィードバックして再学習            |
| 再現性がない      | 生成時にSeed値・プロンプト固定               |
| 学習データの偏り    | プロジェクト専用テストサンプルで微調整（ファインチューニング） |

💡 原則：
AIを「自動化ツール」ではなく「**補助開発者**」として扱うこと。

---

## 🧩 9. AI活用のベストプラクティス

| 項目     | ベストプラクティス                         |
| ------ | --------------------------------- |
| テスト生成  | コード変更ごとに自動提案                      |
| 修正反映   | PRコメントにAI提案を自動表示                  |
| 精度向上   | 人間レビューで良い例を蓄積し再学習                 |
| 運用     | 「生成→確認→採用」を短サイクルで回す               |
| セキュリティ | プライベートリポジトリではLLMをローカル実行（例：Ollama） |

💡 チーム文化として「AIが提案 → 人が判断」を定着させる。

---

## ✅ まとめ

| 要点   | 内容                       |
| ---- | ------------------------ |
| AI生成 | コード・差分・要件から自動テスト生成       |
| 自動修正 | 変更箇所をAIが検知しパッチ提案         |
| CI統合 | GitHub Actionsなどで自動運用    |
| 精度確保 | 人間レビューとSeed固定で安定化        |
| 成果   | テスト更新の属人性を排除し、品質維持コストを削減 |

---

## 🔜 次章予告：「第7章　品質メトリクスとテストカバレッジ」

次章では、テストの量・深さ・信頼性を**定量的に測定**する手法を学びます。
カバレッジ、欠陥密度、MTTRなどの指標を用い、
**「品質を数値で語れる」チーム**を目指します。


