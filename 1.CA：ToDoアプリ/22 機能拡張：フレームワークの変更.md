# 22 機能拡張：フレームワークの変更

# 🔄 Webフレームワークの差し替え：Flask → FastAPI（例）

## 🧭 この章の目的

この章では、Web UIを構築するフレームワークを **FlaskからFastAPIに差し替える**例を通じて、クリーンアーキテクチャの**技術独立性の強さ**を再確認します。

![クリーンアーキテクチャ](../クリーンアーキテクチャ.png)

## 🔁 なぜフレームワークの差し替えが「簡単」なのか？

> 💡 クリーンアーキテクチャを採用したからこそ、UI技術の変更が容易になっています。
> 
- `View`は最外層に位置し、**ControllerとViewModelにのみ依存**しています。
- `UseCase`や`Presenter`は、Webフレームワーク（FlaskやFastAPIなど）に一切依存していません。
- そのため、Flaskで書かれた `WebView` を FastAPI版に置き換えるだけで、**他の層には一切変更が不要**です。
- これは、技術選定の自由度が高く、将来の技術更新にも強い設計が実現されている証拠です。

---

## ✅ FastAPI版 View の構成（例）

```python
# --------------------------------------------------------------------
# View に相当（Web版：FastAPI）
#
# 責務：ユーザーとの直接的なやり取り（入力受付・画面表示）を担当する。
# 依存：<DS> ViewModel を知っており、Controller を呼び出す。
#
# 位置づけ（クラス図／同心円図）：
# - クラス図：Interface Adapters（View）
# - 同心円図：Framework & Drivers（最外層）
# --------------------------------------------------------------------

from fastapi import FastAPI, Request, Form
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from interface_adapters.controller import AddTodoController
from data_structures import TodoViewModel

class FastApiView:
    """
    FastAPI版のView。ルーティングとテンプレート描画を担当する。
    """

    def __init__(self, controller: AddTodoController, view_model: TodoViewModel):
        self._controller = controller
        self._view_model = view_model
        self.app = FastAPI()
        self.templates = Jinja2Templates(directory="templates")
        self._setup_routes()

    def _setup_routes(self):
        @self.app.get("/", response_class=HTMLResponse)
        async def get_form(request: Request):
            return self.templates.TemplateResponse("index.html", {
                "request": request,
                "display": self._view_model.display_text
            })

        @self.app.post("/", response_class=HTMLResponse)
        async def post_form(request: Request, title: str = Form(...)):
            self._controller.add_todo(title)
            return self.templates.TemplateResponse("index.html", {
                "request": request,
                "display": self._view_model.display_text
            })

    def run(self):
        import uvicorn
        uvicorn.run(self.app, host="127.0.0.1", port=8000)

```

---

## 🛡 このクラスの鉄則

> 技術は変わる、責務は変えない。
> 
- Viewは「表示」と「入力の橋渡し」に徹する
- Web技術（Flask, FastAPI, Djangoなど）に依存しても、責務は一貫して同じ
- 他の層は技術変更の影響を受けない

---

## 🔧 `main.py` での差し替え例（FastAPI版）

```python
# --- FastAPI版Viewを使う場合 ---
from ui.view_fastapi import FastApiView

# ...（Presenter, Controller, ViewModelなどの生成は同じ）

view = FastApiView(controller, view_model)
view.run()

```