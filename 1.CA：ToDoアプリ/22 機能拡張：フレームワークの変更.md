# 22 æ©Ÿèƒ½æ‹¡å¼µï¼šãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å¤‰æ›´

# ğŸ”„ Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å·®ã—æ›¿ãˆï¼šFlask â†’ FastAPI

## ğŸ§­ ã“ã®ç« ã®ç›®çš„

ã“ã®ç« ã§ã¯ã€Web UI ã‚’æ§‹ç¯‰ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ **Flask ã‹ã‚‰ FastAPI ã«å·®ã—æ›¿ãˆã‚‹**ä¾‹ã‚’é€šã˜ã¦ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã€ŒæŠ€è¡“ç‹¬ç«‹æ€§ã®å¼·ã•ã€ã‚’ç¢ºèªã—ã¾ã™ã€‚

ã“ã“ã§æ³¨ç›®ã—ãŸã„ã®ã¯ï¼š

* ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆUseCaseï¼‰
* è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã®æ•´å½¢ï¼ˆPresenterï¼‰
* ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆRepositoryï¼‰

â€¦ã¨ã„ã£ãŸå†…å´ã®å±¤ã¯ã€ä¸€åˆ‡å¤‰æ›´ã—ãªãã¦ã‚‚ã‚ˆã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚

![ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](../ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.png)

---

## ğŸ” ãªãœãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®å·®ã—æ›¿ãˆãŒã€Œç°¡å˜ã€ãªã®ã‹ï¼Ÿ

> ğŸ’¡ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ã€Œæœ€å¤–å±¤ã®è©³ç´°ã€ã«éãã¾ã›ã‚“ã€‚

* `View` ã¯æœ€å¤–å±¤ï¼ˆFrameworks & Driversï¼‰ã«ã‚ã‚‹ãŸã‚ã€å¤–éƒ¨æŠ€è¡“ãã®ã‚‚ã®ï¼ˆFlaskã§ã‚‚FastAPIã§ã‚‚OKï¼‰ã‚’è‡ªç”±ã«å·®ã—æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚
* `View` ãŒä¾å­˜ã—ã¦ã‚ˆã„ã®ã¯ **Controller ã¨ ViewModel ã ã‘**ã€‚
* `UseCase` ã‚„ `Presenter` ã¯ Web ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ä¾å­˜ã—ã¦ã„ã¾ã›ã‚“ã€‚
* ã¤ã¾ã‚Š Flaskç‰ˆã® `WebView` ã‚’ FastAPIç‰ˆã«ç½®ãæ›ãˆã¦ã‚‚ã€**UseCase / Presenter / Repository / Entity ã¯1è¡Œã‚‚å¤‰æ›´ä¸è¦**ã§ã™ã€‚

ã“ã‚Œã¯ã€å°†æ¥ã€Œåˆ¥ã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ç§»è¡Œã—ãŸã„ã€ã€ŒAPIã‚µãƒ¼ãƒãƒ¼ã¨åˆ¥ãƒ•ãƒ­ãƒ³ãƒˆã«ã—ãŸã„ã€ã¨ã„ã£ãŸè¦æ±‚ã«ã‚‚å¿œãˆã‚„ã™ã„æ§‹é€ ã«ãªã£ã¦ã„ã‚‹ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚

---

## ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

FastAPIç‰ˆã®Viewã¯ã€ä»–ã®Viewï¼ˆCLIç‰ˆ / GUIç‰ˆ / Flaskç‰ˆï¼‰ã¨åŒã˜ä¸¦ã³ã«è¿½åŠ ã—ã¾ã™ã€‚

```text
â”œâ”€ interface_adapters/
â”‚   â”œâ”€ presenters/
â”‚   â”‚   â””â”€ todo_presenter.py
â”‚   â”œâ”€ controllers/
â”‚   â”‚   â””â”€ todo_controller.py
â”‚   â””â”€ views/
â”‚       â”œâ”€ view_console.py        # CLIç‰ˆ View
â”‚       â”œâ”€ view_gui.py            # GUIç‰ˆ View (tkinter)
â”‚       â”œâ”€ view_web.py            # Webç‰ˆ View (Flask)
â”‚       â”œâ”€ view_fastapi.py        # Webç‰ˆ View (FastAPI) â† ã“ã®ç« ã§è¿½åŠ 
â”‚       â””â”€ templates/
â”‚           â””â”€ index.html         # FastAPIç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆJinja2ï¼‰
```

ãƒã‚¤ãƒ³ãƒˆã¯ã€**ã©ã®Viewã‚‚ Controller ã¨ ViewModel ã«ã ã‘ä¾å­˜ã™ã‚‹**ã¨ã„ã†å¯¾ç§°æ€§ã§ã™ã€‚
ã‚¢ãƒ—ãƒªã®ä¸­å¿ƒã§ã‚ã‚‹ `core/` ã‚„ `infrastructure/` ã«ã¯ä¸€åˆ‡è§¦ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

---

## âœ… FastAPIç‰ˆ View ã®å®Ÿè£…ä¾‹

ä¸‹è¨˜ã¯ Flaskç‰ˆ `WebView` ã¨åŒã˜è²¬å‹™ã‚’ FastAPI ã§å®Ÿç¾ã—ãŸã‚‚ã®ã§ã™ã€‚
é•ã„ã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆï¼HTTPã‚µãƒ¼ãƒãƒ¼ã®è©³ç´°ï¼‰ã ã‘ã§ã™ã€‚

```python
# --------------------------------------------------------------------
# File: interface_adapters/views/view_fastapi.py
# Layer: Interface Adaptersï¼ˆView - Webç‰ˆ / FastAPIï¼‰
#
# è²¬å‹™ï¼š
#   - HTTPçµŒç”±ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å—ã‘å–ã‚Šï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ï¼‰ã€
#     Controllerã«ã€ŒTODOã‚’è¿½åŠ ã—ã¦ã€ã¨ä¾é ¼ã™ã‚‹ã€‚
#   - PresenterãŒæ›´æ–°ã—ãŸViewModelã®å†…å®¹ã‚’HTMLã¨ã—ã¦è¿”ã™ã€‚
#
# ä¾å­˜ï¼š
#   - <I> TodoControllerï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ä¼é”å…ˆï¼‰
#   - <DS> TodoViewModelï¼ˆè¡¨ç¤ºç”¨ã®çŠ¶æ…‹ã‚’ä¿æŒï¼‰
#
# åŒå¿ƒå††å›³ã§ã®ä½ç½®ï¼š
#   - Frameworks & Driversï¼ˆæœ€å¤–å±¤ï¼‰
#   - FastAPIãªã©ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¾å­˜ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã«é–‰ã˜è¾¼ã‚ã‚‹ã€‚
#
# å‚™è€ƒï¼š
#   - FastAPIã¯éåŒæœŸI/Oã«å¯¾å¿œã—ã¦ã„ã‚‹ã®ã§ã€ãƒãƒ³ãƒ‰ãƒ©ã¯asyncã§æ›¸ã‘ã‚‹ã€‚
#   - ãã‚Œã§ã‚‚ã€Œä½•ã‚’ã™ã‚‹ã‹ã€ã¯ConsoleView/GuiViewã¨ã¾ã£ãŸãåŒã˜ã€‚
# --------------------------------------------------------------------

from fastapi import FastAPI, Request, Form
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates

from interface_adapters.controllers.todo_controller import TodoController
from core.usecase.boundary.dto import TodoViewModel


class FastApiView:
    """
    FastAPIç‰ˆã®Viewã€‚
    - HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦Controllerã«å‡¦ç†ã‚’ä¾é ¼ã—ã€
      PresenterãŒæ›´æ–°ã—ãŸViewModelã®å†…å®¹ã‚’HTMLã¨ã—ã¦è¿”ã™ã€‚
    - Webã‚µãƒ¼ãƒãƒ¼ï¼ˆFastAPI+uvicornï¼‰ã®èµ·å‹•ã‚‚æ‹…å½“ã™ã‚‹ã€‚
    """

    def __init__(self, controller: TodoController, view_model: TodoViewModel):
        """
        [ä¾å­˜é–¢ä¿‚]
        - controller: ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã‚’UseCaseã¾ã§æ©‹æ¸¡ã—ã™ã‚‹ä»²ä»‹å½¹
        - view_model: PresenterãŒæ›´æ–°ã—ç¶šã‘ã‚‹è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿
        """
        self._controller = controller
        self._view_model = view_model

        # FastAPIã‚¢ãƒ—ãƒªæœ¬ä½“
        self.app = FastAPI()

        # Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å ´æ‰€
        # ä¾‹: interface_adapters/views/templates/index.html
        self.templates = Jinja2Templates(directory="interface_adapters/views/templates")

        # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®š
        self._setup_routes()

    def _setup_routes(self):
        """
        "/" ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«GETã¨POSTã‚’ã¾ã¨ã‚ã‚‹ã€‚
        - GET  : ç¾åœ¨ã®ç”»é¢ã‚’è¡¨ç¤º
        - POST : å…¥åŠ›ã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã‚’Controllerã«æ¸¡ã—ã¦UseCaseã‚’å®Ÿè¡Œ
        """

        @self.app.get("/", response_class=HTMLResponse)
        async def get_form(request: Request):
            # ç¾åœ¨ã®ViewModelã®çŠ¶æ…‹ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æµã—è¾¼ã‚€
            return self.templates.TemplateResponse(
                "index.html",
                {
                    "request": request,
                    "display": self._view_model.display_text,
                },
            )

        @self.app.post("/", response_class=HTMLResponse)
        async def post_form(request: Request, title: str = Form(...)):
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆtitleï¼‰ã‚’Controllerã¸æ¸¡ã™
            self._controller.add_todo(title)

            # PresenterãŒViewModelã‚’æ›´æ–°ã—ã¦ã„ã‚‹å‰æã§ã€ãã®æœ€æ–°çŠ¶æ…‹ã‚’è¿”ã™
            return self.templates.TemplateResponse(
                "index.html",
                {
                    "request": request,
                    "display": self._view_model.display_text,
                },
            )

    def run(self):
        """
        FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã™ã‚‹ã€‚
        uvicornã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã€‚
        """
        import uvicorn
        uvicorn.run(self.app, host="127.0.0.1", port=8000, reload=True)
```

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¾‹ï¼š`interface_adapters/views/templates/index.html`

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>TODOã‚¢ãƒ—ãƒªï¼ˆFastAPIç‰ˆï¼‰</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.5;
            max-width: 480px;
        }
        form {
            margin-bottom: 1rem;
        }
        .msg {
            color: green;
            white-space: pre-wrap;
        }
        small {
            color: #777;
        }
    </style>
</head>
<body>
    <h1>TODOè¿½åŠ </h1>

    <form method="POST">
        <input
            type="text"
            name="title"
            placeholder="TODOã®ã‚¿ã‚¤ãƒˆãƒ«"
            required
            style="padding:0.5rem; width:70%;"
        />
        <button type="submit" style="padding:0.5rem 1rem;">è¿½åŠ </button>
    </form>

    <p class="msg">{{ display }}</p>

    <hr/>
    <small>
        ã“ã®ç”»é¢ã¯FastAPIç‰ˆã®Viewã§ã™ã€‚  
        ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆUseCaseï¼‰ã‚„æ°¸ç¶šåŒ–ï¼ˆRepositoryï¼‰ã«ã¯ä¸€åˆ‡è§¦ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
    </small>
</body>
</html>
```

---

## ğŸ›¡ ã“ã®ã‚¯ãƒ©ã‚¹ã®é‰„å‰‡

> æŠ€è¡“ã¯å¤‰ã‚ã‚‹ã€è²¬å‹™ã¯å¤‰ãˆãªã„ã€‚

* Viewã¯ã€Œè¡¨ç¤ºã€ã¨ã€Œå…¥åŠ›ã®æ©‹æ¸¡ã—ã€ã ã‘ã‚’è¡Œã†
* Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆFlask / FastAPI / Django / â€¦ï¼‰ã¯Viewå±¤ã«é–‰ã˜è¾¼ã‚ã‚‹
* Controllerãƒ»UseCaseãƒ»Presenterãƒ»Repositoryã«ã¯ã€ä¸€åˆ‡å¤‰æ›´ã‚’ä¼æ’­ã•ã›ãªã„

ã“ã‚ŒãŒã§ãã¦ã„ã‚Œã°ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯é¸å®šã®è‡ªç”±åº¦ã¯åœ§å€’çš„ã«é«˜ããªã‚Šã¾ã™ã€‚

---

## ğŸ”§ `main.py` ã§ã®å·®ã—æ›¿ãˆä¾‹ï¼ˆFastAPIç‰ˆï¼‰

`main.py` ã¯ã€ã‚¢ãƒ—ãƒªå…¨ä½“ã®éƒ¨å“ã‚’çµ„ã¿ç«‹ã¦ã‚‹å ´æ‰€ï¼ˆã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒˆï¼‰ã§ã™ã€‚
ConsoleViewãƒ»GuiViewãƒ»Flaskç‰ˆWebViewã¨åŒæ§˜ã«ã€FastAPIç‰ˆã‚‚åŒã˜æµã‚Œã§çµ„ã¿ç«‹ã¦ã‚‰ã‚Œã¾ã™ã€‚

```python
# main.py (FastAPIç‰ˆã§å‹•ã‹ã—ãŸã„å ´åˆã®ä¾‹)

from core.usecase.boundary.dto import TodoViewModel
from core.usecase.interactor.create_todo import TodoUseCase
from interface_adapters.presenters.todo_presenter import TodoPresenter
from interface_adapters.controllers.todo_controller import TodoController
from interface_adapters.views.view_fastapi import FastApiView
from infrastructure.repositories.in_memory_todo_repository import InMemoryTodoRepository


def main():
    # ViewModelï¼ˆPresenterã¨Viewã§å…±æœ‰ã•ã‚Œã‚‹è¡¨ç¤ºçŠ¶æ…‹ï¼‰
    view_model = TodoViewModel()

    # Repositoryï¼ˆTodoã‚’ä¿å­˜ã€‚ä»Šå›ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªå®Ÿè£…ï¼‰
    repository = InMemoryTodoRepository()

    # Presenterï¼ˆUseCaseã®çµæœã‚’ViewModelå‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ•´å½¢ã™ã‚‹ï¼‰
    presenter = TodoPresenter(view_model)

    # UseCaseï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯æœ¬ä½“ã€‚ã€ŒTODOã‚’è¿½åŠ ã™ã‚‹ã€ãªã©ï¼‰
    use_case = TodoUseCase(presenter, repository)

    # Controllerï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’UseCaseã«æ©‹æ¸¡ã—ã™ã‚‹ï¼‰
    controller = TodoController(use_case)

    # FastAPIç‰ˆ Viewï¼ˆHTTPçµŒç”±ã§Controllerã¨ViewModelã‚’ã¤ãªãï¼‰
    web_view = FastApiView(controller, view_model)

    # Webã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹
    web_view.run()


if __name__ == "__main__":
    main()
```

ã“ã“ã§ã‚‚ã‚„ã¯ã‚Šï¼š

* `core/` ã®ä¸­èº«ã¯ä¸€åˆ‡å¤‰æ›´ã—ã¦ã„ã¾ã›ã‚“
* Presenterã‚‚Repositoryã‚‚ãã®ã¾ã¾
* å·®ã—æ›¿ãˆã¦ã„ã‚‹ã®ã¯ **Viewã®å…·ä½“çš„ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å®Ÿè£…ã ã‘** ã§ã™

---

## ã¾ã¨ã‚

* Flaskç‰ˆã® `WebView` ã‚‚ã€FastAPIç‰ˆã® `FastApiView` ã‚‚ã€**è²¬å‹™ã¯åŒã˜**

  * HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ Controller ã‚’å‘¼ã³
  * PresenterãŒè©°ã‚ãŸ ViewModel ã®å†…å®¹ã‚’ HTML ã«åŸ‹ã‚è¾¼ã‚“ã§è¿”ã™

* ã¤ã¾ã‚Šã€Œã©ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã†ã‹ã€ã¯ã€**æœ€å¤–å±¤ã®éƒ½åˆ**ã§ã—ã‹ãªã„
  â†’ ã‚¢ãƒ—ãƒªã®æœ¬è³ªï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã€æ°¸ç¶šåŒ–ï¼‰ã®éƒ½åˆã§ã¯ãªã„

* ã“ã‚ŒãŒã€Œãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã‚¢ãƒ—ãƒªã‚’å¾“ã‚ã›ã‚‹ã®ã§ã¯ãªãã€ã‚¢ãƒ—ãƒªãŒãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’åˆ©ç”¨ã™ã‚‹ã€ã¨ã„ã†è€ƒãˆæ–¹ã§ã™ã€‚

