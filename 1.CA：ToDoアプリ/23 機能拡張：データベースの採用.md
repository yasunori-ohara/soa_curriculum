# 23 æ©Ÿèƒ½æ‹¡å¼µï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¡ç”¨

# ğŸ—„ ä¿å­˜å‡¦ç†ã®å·®ã—æ›¿ãˆï¼š`InMemoryTodoDataAccess` â†’ `PostgresTodoDataAccess`

## ğŸ§­ ã“ã®ç« ã®ç›®çš„

ã“ã®ç« ã§ã¯ã€ä¿å­˜å‡¦ç†ã‚’ **ãƒ¡ãƒ¢ãƒªä¸Šã®è¾æ›¸ã‹ã‚‰æœ¬ç‰©ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆPostgreSQLï¼‰ã«å·®ã—æ›¿ãˆã‚‹**æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

ã“ã®å·®ã—æ›¿ãˆã«ã‚ˆã£ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ°¸ç¶šçš„ãªãƒ‡ãƒ¼ã‚¿ä¿å­˜ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

![ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](../ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.png)

---

## ğŸ” ãªãœä¿å­˜å‡¦ç†ã®å·®ã—æ›¿ãˆãŒã€Œç°¡å˜ã€ãªã®ã‹ï¼Ÿ

> ğŸ’¡ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ãŸã‹ã‚‰ã“ãã€ä¿å­˜æŠ€è¡“ã®å¤‰æ›´ãŒå®¹æ˜“ã«ãªã£ã¦ã„ã¾ã™ã€‚
> 
- `UseCase` ã¯ `TodoDataAccessInterface` ã«ã®ã¿ä¾å­˜ã—ã¦ãŠã‚Šã€å…·ä½“çš„ãªä¿å­˜æ–¹æ³•ï¼ˆãƒ¡ãƒ¢ãƒªã‹DBã‹ï¼‰ã‚’çŸ¥ã‚Šã¾ã›ã‚“ã€‚
- `InMemoryTodoDataAccess` ã‚’ `PostgresTodoDataAccess` ã«ç½®ãæ›ãˆã‚‹ã ã‘ã§ã€**ä»–ã®å±¤ã«ã¯ä¸€åˆ‡å¤‰æ›´ãŒä¸è¦**ã§ã™ã€‚
- ã“ã‚Œã¯ã€æŠ€è¡“å¤‰æ›´ã«å¼·ãã€é•·æœŸé‹ç”¨ã«è€ãˆã‚‹è¨­è¨ˆãŒå®Ÿç¾ã•ã‚Œã¦ã„ã‚‹è¨¼æ‹ ã§ã™ã€‚

---

## âœ… PostgreSQLç‰ˆ DataAccess ã®æ§‹æˆï¼ˆSQLAlchemyä½¿ç”¨ï¼‰

```python
# --------------------------------------------------------------------
# File: adapters/data_access_postgres.py
# Layer: Interface Adaptersï¼ˆData Accessï¼‰
#
# ç›®çš„:
#   - TodoDataAccessInterface ã‚’ PostgreSQL ã§å®Ÿè£…ã™ã‚‹ã€‚
#   - SQLAlchemy ã‚’ä½¿ã£ã¦ DB ã«ä¿å­˜ãƒ»å–å¾—ã™ã‚‹ã€‚
#
# Cè¨€èªã¨ã®æ¯”è¼ƒ:
#   - DBã‚¢ã‚¯ã‚»ã‚¹ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«I/Oã€ã‚„ã€Œå¤–éƒ¨è£…ç½®ã¨ã®é€šä¿¡ã€ã«è¿‘ã„ã€‚
#   - SQLAlchemy ã¯ã€Œæ§‹é€ ä½“ã¨é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’ã¾ã¨ã‚ãŸORMãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã€‚
# --------------------------------------------------------------------

from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.orm import declarative_base, sessionmaker
from domain.todo import Todo
from boundaries import TodoDataAccessInterface

Base = declarative_base()

class TodoRecord(Base):
    """
    DBãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾å¿œã™ã‚‹ORMãƒ¢ãƒ‡ãƒ«ã€‚
    """
    __tablename__ = "todos"

    id = Column(Integer, primary_key=True)
    title = Column(String)
    completed = Column(Integer)  # 0 or 1

class PostgresTodoDataAccess(TodoDataAccessInterface):
    """
    PostgreSQLç‰ˆã®DataAccessã€‚SQLAlchemyã‚’ä½¿ã£ã¦DBæ“ä½œã‚’è¡Œã†ã€‚
    """

    def __init__(self, db_url="sqlite:///todo.db"):  # SQLiteã§ä»£ç”¨å¯èƒ½
        self.engine = create_engine(db_url, echo=False)
        Base.metadata.create_all(self.engine)
        self.Session = sessionmaker(bind=self.engine)

    def save(self, todo: Todo) -> Todo:
        session = self.Session()

        if todo.id == 0:
            # æ–°è¦è¿½åŠ 
            record = TodoRecord(title=todo.title, completed=int(todo.completed))
            session.add(record)
            session.commit()
            todo.id = record.id
        else:
            # æ›´æ–°
            record = session.query(TodoRecord).get(todo.id)
            if record:
                record.title = todo.title
                record.completed = int(todo.completed)
                session.commit()

        session.close()
        return todo

    def find_all(self) -> list[Todo]:
        session = self.Session()
        records = session.query(TodoRecord).all()
        todos = [Todo(id=r.id, title=r.title, completed=bool(r.completed)) for r in records]
        session.close()
        return todos

```

---

## ğŸ›¡ ã“ã®ã‚¯ãƒ©ã‚¹ã®é‰„å‰‡

> æŠ€è¡“ã‚’ä½¿ã„ã“ãªã›ã€ã ãŒãƒ­ã‚¸ãƒƒã‚¯ã«ã¯å£ã‚’å‡ºã™ãªã€‚
> 
- DataAccessã¯ã€Œä¿å­˜ãƒ»å–å¾—ã®æŠ€è¡“çš„å®Ÿè£…ã€ã«é›†ä¸­ã™ã‚‹
- ãƒ“ã‚¸ãƒã‚¹åˆ¤æ–­ã‚„è¡¨ç¤ºæ•´å½¢ã¯ä¸€åˆ‡è¡Œã‚ãªã„
- æŠ€è¡“ãŒå¤‰ã‚ã£ã¦ã‚‚ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®ˆã‚Œã°ä»–ã®å±¤ã¯ãã®ã¾ã¾ã§æ¸ˆã‚€

---

## ğŸ”§ `main.py` ã§ã®å·®ã—æ›¿ãˆä¾‹ï¼ˆPostgreSQLç‰ˆï¼‰

```python
# --- PostgreSQLç‰ˆDataAccessã‚’ä½¿ã†å ´åˆ ---
from adapters.data_access_postgres import PostgresTodoDataAccess

# ...ï¼ˆPresenter, Controller, ViewModelãªã©ã®ç”Ÿæˆã¯åŒã˜ï¼‰

data_access = PostgresTodoDataAccess()
use_case = TodoUseCase(presenter, data_access)

```